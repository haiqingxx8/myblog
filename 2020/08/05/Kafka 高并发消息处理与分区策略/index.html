<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/myblog/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/myblog/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/myblog/images/favicon-16x16.png">
  <link rel="mask-icon" href="/myblog/images/safari-pinned-tab.svg" color="#222">

<link rel="stylesheet" href="/myblog/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css2?family=Lato:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"haiqingxx8.github.io","root":"/myblog/","images":"/myblog/images","scheme":"Gemini","darkmode":false,"version":"8.24.0","exturl":false,"sidebar":{"position":"right","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12,"enable":true,"b2t":false,"scrollpercent":false,"onmobile":false},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":"default","show_result":true},"fold":{"enable":false,"height":500},"language":false,"highlight_theme":"normal"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":true,"nav":null,"count":true,"text":"评论","orderby":"latest","login":"登录","admin":"博主","page_text":"评论","comment_placeholder":"说点什么吧..."},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/myblog/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false,"labels":{"input_placeholder":"搜索文章...","hits_empty":"找不到您查询的内容: ${query}"}}}</script><script src="/myblog/js/config.js" defer></script>

    <meta name="description" content="深入分析 Kafka 消息队列在高并发系统中的应用，包括分区、消费组、偏移量管理和幂等性处理">
<meta property="og:type" content="article">
<meta property="og:title" content="Kafka 高并发消息处理与分区策略">
<meta property="og:url" content="https://haiqingxx8.github.io/2020/08/05/Kafka%20%E9%AB%98%E5%B9%B6%E5%8F%91%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86%E4%B8%8E%E5%88%86%E5%8C%BA%E7%AD%96%E7%95%A5/index.html">
<meta property="og:site_name" content="我的技术博客">
<meta property="og:description" content="深入分析 Kafka 消息队列在高并发系统中的应用，包括分区、消费组、偏移量管理和幂等性处理">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-08-05T01:30:00.000Z">
<meta property="article:modified_time" content="2025-08-14T16:03:58.544Z">
<meta property="article:author" content="haiqingxx8">
<meta property="article:tag" content="高并发">
<meta property="article:tag" content="Kafka">
<meta property="article:tag" content="分区策略">
<meta property="article:tag" content="Spring Boot">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://haiqingxx8.github.io/2020/08/05/Kafka%20%E9%AB%98%E5%B9%B6%E5%8F%91%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86%E4%B8%8E%E5%88%86%E5%8C%BA%E7%AD%96%E7%95%A5/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://haiqingxx8.github.io/2020/08/05/Kafka%20%E9%AB%98%E5%B9%B6%E5%8F%91%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86%E4%B8%8E%E5%88%86%E5%8C%BA%E7%AD%96%E7%95%A5/","path":"2020/08/05/Kafka 高并发消息处理与分区策略/","title":"Kafka 高并发消息处理与分区策略"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Kafka 高并发消息处理与分区策略 | 我的技术博客</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/myblog/js/utils.js" defer></script><script src="/myblog/js/motion.js" defer></script><script src="/myblog/js/sidebar.js" defer></script><script src="/myblog/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/myblog/js/third-party/search/local-search.js" defer></script>







  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





  <noscript>
    <link rel="stylesheet" href="/myblog/css/noscript.css">
  </noscript>
<link rel="alternate" href="/myblog/atom.xml" title="我的技术博客" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/myblog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">我的技术博客</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">记录技术学习心得，分享开发经验</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/myblog/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/myblog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-categories"><a href="/myblog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/myblog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-about"><a href="/myblog/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%83%8C%E6%99%AF"><span class="nav-number">1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kafka-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-number">2.</span> <span class="nav-text">Kafka 基本概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring-Boot-%E9%85%8D%E7%BD%AE-Kafka"><span class="nav-number">3.</span> <span class="nav-text">Spring Boot 配置 Kafka</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E7%94%9F%E4%BA%A7%E8%80%85%E7%A4%BA%E4%BE%8B"><span class="nav-number">4.</span> <span class="nav-text">消息生产者示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85%E7%A4%BA%E4%BE%8B%E4%B8%8E%E6%89%8B%E5%8A%A8%E6%8F%90%E4%BA%A4"><span class="nav-number">5.</span> <span class="nav-text">消费者示例与手动提交</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90"><span class="nav-number">6.</span> <span class="nav-text">深入分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E6%88%98%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF%E5%BA%94%E7%94%A8%E6%A1%88%E4%BE%8B"><span class="nav-number">7.</span> <span class="nav-text">实战业务场景应用案例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E7%94%B5%E5%95%86%E8%AE%A2%E5%8D%95%E5%A4%84%E7%90%86%E7%B3%BB%E7%BB%9F"><span class="nav-number">7.1.</span> <span class="nav-text">1. 电商订单处理系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E9%87%91%E8%9E%8D%E9%A3%8E%E6%8E%A7%E7%B3%BB%E7%BB%9F"><span class="nav-number">7.2.</span> <span class="nav-text">2. 金融风控系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%AE%9E%E6%97%B6%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E7%B3%BB%E7%BB%9F"><span class="nav-number">7.3.</span> <span class="nav-text">3. 实时数据分析系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%80%9A%E4%BF%A1%E4%B8%8E%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E6%9E%B6%E6%9E%84"><span class="nav-number">7.4.</span> <span class="nav-text">4. 微服务通信与事件驱动架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-Kafka-%E7%9B%91%E6%8E%A7%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-number">7.5.</span> <span class="nav-text">5. Kafka 监控与性能优化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">8.</span> <span class="nav-text">总结与最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E9%99%85%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF%E5%BA%94%E7%94%A8"><span class="nav-number">8.1.</span> <span class="nav-text">实际业务场景应用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%85%B3%E9%94%AE%E7%82%B9"><span class="nav-number">8.2.</span> <span class="nav-text">性能优化关键点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%E4%B8%8E%E5%AE%B9%E6%98%93%E5%BF%BD%E7%95%A5%E7%82%B9"><span class="nav-number">9.</span> <span class="nav-text">注意事项与容易忽略点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">10.</span> <span class="nav-text">总结</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="haiqingxx8"
      src="/myblog/images/headimg.jpeg">
  <p class="site-author-name" itemprop="name">haiqingxx8</p>
  <div class="site-description" itemprop="description">个人技术博客，专注于Java后端、前端开发、系统架构等技术分享</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/myblog/archives/">
          <span class="site-state-item-count">18</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/myblog/categories/">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/myblog/tags/">
        <span class="site-state-item-count">52</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://haiqingxx8.github.io/myblog/" title="GitHub → https:&#x2F;&#x2F;haiqingxx8.github.io&#x2F;myblog&#x2F;" rel="noopener me"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/yourusername" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;yourusername" rel="noopener me" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="/myblog/images/wechat-qr.png" title="WeChat → &#x2F;images&#x2F;wechat-qr.png" rel="noopener me"><i class="fab fa-weixin fa-fw"></i>WeChat</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://haiqingxx8.github.io/2020/08/05/Kafka%20%E9%AB%98%E5%B9%B6%E5%8F%91%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86%E4%B8%8E%E5%88%86%E5%8C%BA%E7%AD%96%E7%95%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/myblog/images/headimg.jpeg">
      <meta itemprop="name" content="haiqingxx8">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="我的技术博客">
      <meta itemprop="description" content="个人技术博客，专注于Java后端、前端开发、系统架构等技术分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Kafka 高并发消息处理与分区策略 | 我的技术博客">
      <meta itemprop="description" content="深入分析 Kafka 消息队列在高并发系统中的应用，包括分区、消费组、偏移量管理和幂等性处理">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Kafka 高并发消息处理与分区策略
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-08-05 09:30:00" itemprop="dateCreated datePublished" datetime="2020-08-05T09:30:00+08:00">2020-08-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/myblog/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">后端开发</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/myblog/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">消息队列</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

            <div class="post-description">深入分析 Kafka 消息队列在高并发系统中的应用，包括分区、消费组、偏移量管理和幂等性处理</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在大数据和高并发系统中，需要处理海量消息。</span></span><br><span class="line"><span class="comment">// Kafka 提供高吞吐量、分区消费、消费组机制，是处理日志、事件和异步任务的利器。</span></span><br><span class="line"><span class="comment">// 掌握分区策略、消费者均衡、偏移量管理以及幂等性处理，是保障系统可靠性的关键。</span></span><br></pre></td></tr></table></figure>

<h2 id="Kafka-基本概念"><a href="#Kafka-基本概念" class="headerlink" title="Kafka 基本概念"></a>Kafka 基本概念</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. Topic：消息主题，用于分类消息</span></span><br><span class="line"><span class="comment">// 2. Partition：主题分区，保证消息顺序和并发处理</span></span><br><span class="line"><span class="comment">// 3. Producer：消息生产者</span></span><br><span class="line"><span class="comment">// 4. Consumer：消息消费者</span></span><br><span class="line"><span class="comment">// 5. Consumer Group：消费者组，实现负载均衡和消息分发</span></span><br><span class="line"><span class="comment">// 6. Offset：偏移量，记录消费位置</span></span><br></pre></td></tr></table></figure>

<h2 id="Spring-Boot-配置-Kafka"><a href="#Spring-Boot-配置-Kafka" class="headerlink" title="Spring Boot 配置 Kafka"></a>Spring Boot 配置 Kafka</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableKafka</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KafkaConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ProducerFactory&lt;String, String&gt; <span class="title function_">producerFactory</span><span class="params">()</span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; props = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">&quot;localhost:9092&quot;</span>);</span><br><span class="line">        props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class);</span><br><span class="line">        props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class);</span><br><span class="line">        props.put(ProducerConfig.ACKS_CONFIG, <span class="string">&quot;all&quot;</span>); <span class="comment">// 全部副本确认</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultKafkaProducerFactory</span>&lt;&gt;(props);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> KafkaTemplate&lt;String, String&gt; <span class="title function_">kafkaTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">KafkaTemplate</span>&lt;&gt;(producerFactory());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ConcurrentKafkaListenerContainerFactory&lt;String, String&gt; <span class="title function_">kafkaListenerContainerFactory</span><span class="params">()</span>&#123;</span><br><span class="line">        ConcurrentKafkaListenerContainerFactory&lt;String, String&gt; factory = <span class="keyword">new</span> <span class="title class_">ConcurrentKafkaListenerContainerFactory</span>&lt;&gt;();</span><br><span class="line">        factory.setConsumerFactory(consumerFactory());</span><br><span class="line">        factory.setConcurrency(<span class="number">3</span>); <span class="comment">// 并发消费者数量</span></span><br><span class="line">        factory.getContainerProperties().setAckMode(ContainerProperties.AckMode.MANUAL_IMMEDIATE);</span><br><span class="line">        <span class="keyword">return</span> factory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ConsumerFactory&lt;String, String&gt; <span class="title function_">consumerFactory</span><span class="params">()</span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; props = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">&quot;localhost:9092&quot;</span>);</span><br><span class="line">        props.put(ConsumerConfig.GROUP_ID_CONFIG, <span class="string">&quot;order-group&quot;</span>);</span><br><span class="line">        props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);</span><br><span class="line">        props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);</span><br><span class="line">        props.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, <span class="literal">false</span>); <span class="comment">// 手动提交</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultKafkaConsumerFactory</span>&lt;&gt;(props);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="消息生产者示例"><a href="#消息生产者示例" class="headerlink" title="消息生产者示例"></a>消息生产者示例</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderKafkaProducer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OrderKafkaProducer</span><span class="params">(KafkaTemplate&lt;String, String&gt; kafkaTemplate)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.kafkaTemplate = kafkaTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendOrder</span><span class="params">(String orderJson)</span>&#123;</span><br><span class="line">        kafkaTemplate.send(<span class="string">&quot;order-topic&quot;</span>, orderJson);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="消费者示例与手动提交"><a href="#消费者示例与手动提交" class="headerlink" title="消费者示例与手动提交"></a>消费者示例与手动提交</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderKafkaConsumer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@KafkaListener(topics = &quot;order-topic&quot;, groupId = &quot;order-group&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">consume</span><span class="params">(ConsumerRecord&lt;String, String&gt; record, Acknowledgment ack)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">orderJson</span> <span class="operator">=</span> record.value();</span><br><span class="line">            processOrder(orderJson);</span><br><span class="line">            ack.acknowledge(); <span class="comment">// 手动提交偏移量</span></span><br><span class="line">        &#125; <span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            <span class="comment">// 处理异常，可选择重试或发送到死信主题</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processOrder</span><span class="params">(String orderJson)</span>&#123;</span><br><span class="line">        <span class="comment">// 解析订单，扣减库存，更新状态</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="深入分析"><a href="#深入分析" class="headerlink" title="深入分析"></a>深入分析</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 分区策略</span></span><br><span class="line"><span class="comment">//    - key 相同的消息会被发送到同一个分区，保证顺序性</span></span><br><span class="line"><span class="comment">//    - 高并发场景可增加分区数量，实现并行处理</span></span><br><span class="line"><span class="comment">// 2. 消费者组</span></span><br><span class="line"><span class="comment">//    - 每个分区只会被消费组中的一个消费者消费</span></span><br><span class="line"><span class="comment">//    - 实现负载均衡与消息均匀分发</span></span><br><span class="line"><span class="comment">// 3. 偏移量管理</span></span><br><span class="line"><span class="comment">//    - AUTO_COMMIT：自动提交，可能丢失或重复消费</span></span><br><span class="line"><span class="comment">//    - MANUAL_COMMIT：手动提交，保证精确一次</span></span><br><span class="line"><span class="comment">// 4. 幂等性处理</span></span><br><span class="line"><span class="comment">//    - 消费端需保证幂等，避免重复消费造成库存或状态异常</span></span><br><span class="line"><span class="comment">// 5. 异常处理与重试</span></span><br><span class="line"><span class="comment">//    - 消费失败可重试，或发送到死信主题</span></span><br><span class="line"><span class="comment">//    - 避免阻塞消费线程</span></span><br></pre></td></tr></table></figure>

<h2 id="实战业务场景应用案例"><a href="#实战业务场景应用案例" class="headerlink" title="实战业务场景应用案例"></a>实战业务场景应用案例</h2><h3 id="1-电商订单处理系统"><a href="#1-电商订单处理系统" class="headerlink" title="1. 电商订单处理系统"></a>1. 电商订单处理系统</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderProcessingService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ObjectMapper objectMapper;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StockService stockService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OrderRepository orderRepository;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OrderProcessingService</span><span class="params">(KafkaTemplate&lt;String, String&gt; kafkaTemplate, </span></span><br><span class="line"><span class="params">                                 ObjectMapper objectMapper,</span></span><br><span class="line"><span class="params">                                 StockService stockService,</span></span><br><span class="line"><span class="params">                                 OrderRepository orderRepository)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.kafkaTemplate = kafkaTemplate;</span><br><span class="line">        <span class="built_in">this</span>.objectMapper = objectMapper;</span><br><span class="line">        <span class="built_in">this</span>.stockService = stockService;</span><br><span class="line">        <span class="built_in">this</span>.orderRepository = orderRepository;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建订单并发送到Kafka</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> Order <span class="title function_">createOrder</span><span class="params">(OrderRequest request)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 创建订单实体</span></span><br><span class="line">        <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Order</span>();</span><br><span class="line">        order.setUserId(request.getUserId());</span><br><span class="line">        order.setAmount(request.getAmount());</span><br><span class="line">        order.setStatus(OrderStatus.CREATED);</span><br><span class="line">        order.setCreateTime(LocalDateTime.now());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 保存订单到数据库</span></span><br><span class="line">        <span class="type">Order</span> <span class="variable">savedOrder</span> <span class="operator">=</span> orderRepository.save(order);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 发送订单到Kafka，使用订单ID作为key确保相同订单的消息进入同一分区</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">orderJson</span> <span class="operator">=</span> objectMapper.writeValueAsString(savedOrder);</span><br><span class="line">            <span class="comment">// 使用订单ID作为key，确保同一订单的消息顺序性</span></span><br><span class="line">            kafkaTemplate.send(<span class="string">&quot;order-topic&quot;</span>, String.valueOf(savedOrder.getId()), orderJson)</span><br><span class="line">                .addCallback(<span class="keyword">new</span> <span class="title class_">ListenableFutureCallback</span>&lt;SendResult&lt;String, String&gt;&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(SendResult&lt;String, String&gt; result)</span> &#123;</span><br><span class="line">                        <span class="comment">// 记录发送成功日志，包含分区和偏移量信息</span></span><br><span class="line">                        log.info(<span class="string">&quot;订单消息发送成功: 订单ID=&#123;&#125;, 分区=&#123;&#125;, 偏移量=&#123;&#125;&quot;</span>, </span><br><span class="line">                                savedOrder.getId(), </span><br><span class="line">                                result.getRecordMetadata().partition(),</span><br><span class="line">                                result.getRecordMetadata().offset());</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(Throwable ex)</span> &#123;</span><br><span class="line">                        <span class="comment">// 发送失败处理，可以重试或记录失败日志</span></span><br><span class="line">                        log.error(<span class="string">&quot;订单消息发送失败: 订单ID=&#123;&#125;, 错误=&#123;&#125;&quot;</span>, savedOrder.getId(), ex.getMessage());</span><br><span class="line">                        <span class="comment">// 实际生产中可以添加重试机制或发送到死信队列</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;订单序列化失败&quot;</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(<span class="string">&quot;订单创建失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> savedOrder;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderConsumerService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ObjectMapper objectMapper;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StockService stockService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OrderRepository orderRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> NotificationService notificationService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OrderConsumerService</span><span class="params">(ObjectMapper objectMapper,</span></span><br><span class="line"><span class="params">                               StockService stockService,</span></span><br><span class="line"><span class="params">                               OrderRepository orderRepository,</span></span><br><span class="line"><span class="params">                               NotificationService notificationService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.objectMapper = objectMapper;</span><br><span class="line">        <span class="built_in">this</span>.stockService = stockService;</span><br><span class="line">        <span class="built_in">this</span>.orderRepository = orderRepository;</span><br><span class="line">        <span class="built_in">this</span>.notificationService = notificationService;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消费订单消息并处理</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@KafkaListener(topics = &quot;order-topic&quot;, groupId = &quot;order-processing-group&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processOrder</span><span class="params">(ConsumerRecord&lt;String, String&gt; record, Acknowledgment ack)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">orderJson</span> <span class="operator">=</span> record.value();</span><br><span class="line">        <span class="type">String</span> <span class="variable">orderIdStr</span> <span class="operator">=</span> record.key();</span><br><span class="line">        </span><br><span class="line">        log.info(<span class="string">&quot;接收到订单消息: 分区=&#123;&#125;, 偏移量=&#123;&#125;, 订单ID=&#123;&#125;&quot;</span>, </span><br><span class="line">                record.partition(), record.offset(), orderIdStr);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 解析订单JSON</span></span><br><span class="line">            <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> objectMapper.readValue(orderJson, Order.class);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2. 幂等性检查 - 防止重复处理</span></span><br><span class="line">            <span class="keyword">if</span> (isOrderAlreadyProcessed(order.getId())) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;订单已处理，跳过: 订单ID=&#123;&#125;&quot;</span>, order.getId());</span><br><span class="line">                ack.acknowledge();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 3. 检查库存</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">stockAvailable</span> <span class="operator">=</span> stockService.checkAndLockStock(order.getItems());</span><br><span class="line">            <span class="keyword">if</span> (!stockAvailable) &#123;</span><br><span class="line">                <span class="comment">// 库存不足，更新订单状态为失败</span></span><br><span class="line">                updateOrderStatus(order.getId(), OrderStatus.FAILED_INSUFFICIENT_STOCK);</span><br><span class="line">                notificationService.notifyUser(order.getUserId(), <span class="string">&quot;订单处理失败：库存不足&quot;</span>);</span><br><span class="line">                ack.acknowledge();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 4. 处理支付（实际中可能是另一个独立的消息流程）</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">paymentSuccess</span> <span class="operator">=</span> processPayment(order);</span><br><span class="line">            <span class="keyword">if</span> (!paymentSuccess) &#123;</span><br><span class="line">                <span class="comment">// 支付失败，释放库存锁定</span></span><br><span class="line">                stockService.releaseStockLock(order.getItems());</span><br><span class="line">                updateOrderStatus(order.getId(), OrderStatus.FAILED_PAYMENT);</span><br><span class="line">                notificationService.notifyUser(order.getUserId(), <span class="string">&quot;订单处理失败：支付问题&quot;</span>);</span><br><span class="line">                ack.acknowledge();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 5. 确认扣减库存</span></span><br><span class="line">            stockService.confirmStockDeduction(order.getItems());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 6. 更新订单状态为成功</span></span><br><span class="line">            updateOrderStatus(order.getId(), OrderStatus.COMPLETED);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 7. 发送订单确认通知</span></span><br><span class="line">            notificationService.notifyUser(order.getUserId(), <span class="string">&quot;订单处理成功：&quot;</span> + order.getId());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 8. 记录处理成功的订单ID（用于幂等性检查）</span></span><br><span class="line">            markOrderAsProcessed(order.getId());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 9. 手动提交偏移量</span></span><br><span class="line">            ack.acknowledge();</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// 异常处理策略</span></span><br><span class="line">            log.error(<span class="string">&quot;订单处理异常: 订单ID=&#123;&#125;, 错误=&#123;&#125;&quot;</span>, orderIdStr, e.getMessage(), e);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 根据异常类型决定是否重试</span></span><br><span class="line">            <span class="keyword">if</span> (isRetryableException(e)) &#123;</span><br><span class="line">                <span class="comment">// 不提交偏移量，消息会被重新消费</span></span><br><span class="line">                log.info(<span class="string">&quot;将重试处理订单: 订单ID=&#123;&#125;&quot;</span>, orderIdStr);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 不可重试的异常，发送到死信主题并确认原消息</span></span><br><span class="line">                sendToDeadLetterTopic(record);</span><br><span class="line">                ack.acknowledge();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 其他辅助方法...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-金融风控系统"><a href="#2-金融风控系统" class="headerlink" title="2. 金融风控系统"></a>2. 金融风控系统</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransactionMonitoringService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ObjectMapper objectMapper;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TransactionMonitoringService</span><span class="params">(KafkaTemplate&lt;String, String&gt; kafkaTemplate,</span></span><br><span class="line"><span class="params">                                       ObjectMapper objectMapper)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.kafkaTemplate = kafkaTemplate;</span><br><span class="line">        <span class="built_in">this</span>.objectMapper = objectMapper;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送交易事件到Kafka进行风控分析</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">monitorTransaction</span><span class="params">(Transaction transaction)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 添加元数据</span></span><br><span class="line">            transaction.setTimestamp(System.currentTimeMillis());</span><br><span class="line">            transaction.setSource(<span class="string">&quot;payment-service&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="type">String</span> <span class="variable">transactionJson</span> <span class="operator">=</span> objectMapper.writeValueAsString(transaction);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 使用用户ID作为key，确保同一用户的交易进入同一分区，便于风控分析</span></span><br><span class="line">            kafkaTemplate.send(<span class="string">&quot;transaction-events&quot;</span>, transaction.getUserId(), transactionJson);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;交易事件序列化失败&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FraudDetectionService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RiskScoringEngine riskEngine;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserProfileRepository userProfileRepo;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TransactionRepository transactionRepo;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ObjectMapper objectMapper;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 使用Caffeine缓存存储用户最近的交易历史</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Cache&lt;String, List&lt;Transaction&gt;&gt; userTransactionsCache;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FraudDetectionService</span><span class="params">(RiskScoringEngine riskEngine,</span></span><br><span class="line"><span class="params">                                UserProfileRepository userProfileRepo,</span></span><br><span class="line"><span class="params">                                TransactionRepository transactionRepo,</span></span><br><span class="line"><span class="params">                                KafkaTemplate&lt;String, String&gt; kafkaTemplate,</span></span><br><span class="line"><span class="params">                                ObjectMapper objectMapper)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.riskEngine = riskEngine;</span><br><span class="line">        <span class="built_in">this</span>.userProfileRepo = userProfileRepo;</span><br><span class="line">        <span class="built_in">this</span>.transactionRepo = transactionRepo;</span><br><span class="line">        <span class="built_in">this</span>.kafkaTemplate = kafkaTemplate;</span><br><span class="line">        <span class="built_in">this</span>.objectMapper = objectMapper;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 初始化缓存</span></span><br><span class="line">        <span class="built_in">this</span>.userTransactionsCache = Caffeine.newBuilder()</span><br><span class="line">            .maximumSize(<span class="number">10_000</span>)</span><br><span class="line">            .expireAfterWrite(<span class="number">30</span>, TimeUnit.MINUTES)</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 实时交易风控分析</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@KafkaListener(topics = &quot;transaction-events&quot;, groupId = &quot;fraud-detection-group&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">analyzeTransaction</span><span class="params">(ConsumerRecord&lt;String, String&gt; record, Acknowledgment ack)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 解析交易数据</span></span><br><span class="line">            <span class="type">Transaction</span> <span class="variable">transaction</span> <span class="operator">=</span> objectMapper.readValue(record.value(), Transaction.class);</span><br><span class="line">            <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> record.key();</span><br><span class="line">            </span><br><span class="line">            log.info(<span class="string">&quot;接收到交易事件: 用户ID=&#123;&#125;, 交易ID=&#123;&#125;, 金额=&#123;&#125;&quot;</span>, </span><br><span class="line">                    userId, transaction.getId(), transaction.getAmount());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2. 获取用户画像数据</span></span><br><span class="line">            <span class="type">UserProfile</span> <span class="variable">userProfile</span> <span class="operator">=</span> userProfileRepo.findById(userId)</span><br><span class="line">                .orElseGet(() -&gt; createDefaultUserProfile(userId));</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 3. 获取用户最近交易历史（从缓存或数据库）</span></span><br><span class="line">            List&lt;Transaction&gt; recentTransactions = getUserRecentTransactions(userId);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 4. 添加当前交易到历史记录</span></span><br><span class="line">            recentTransactions.add(transaction);</span><br><span class="line">            userTransactionsCache.put(userId, recentTransactions);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 5. 执行风控规则</span></span><br><span class="line">            <span class="type">RiskAssessment</span> <span class="variable">riskAssessment</span> <span class="operator">=</span> riskEngine.assessRisk(transaction, userProfile, recentTransactions);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 6. 处理风控结果</span></span><br><span class="line">            <span class="keyword">if</span> (riskAssessment.getRiskLevel() &gt;= RiskLevel.HIGH.getValue()) &#123;</span><br><span class="line">                <span class="comment">// 高风险交易处理</span></span><br><span class="line">                handleHighRiskTransaction(transaction, riskAssessment);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (riskAssessment.getRiskLevel() &gt;= RiskLevel.MEDIUM.getValue()) &#123;</span><br><span class="line">                <span class="comment">// 中风险交易处理</span></span><br><span class="line">                handleMediumRiskTransaction(transaction, riskAssessment);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 低风险交易处理</span></span><br><span class="line">                handleLowRiskTransaction(transaction);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 7. 保存风控结果</span></span><br><span class="line">            saveRiskAssessmentResult(transaction.getId(), riskAssessment);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 8. 更新用户画像</span></span><br><span class="line">            updateUserRiskProfile(userId, transaction, riskAssessment);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 9. 确认消息处理完成</span></span><br><span class="line">            ack.acknowledge();</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;交易风控分析异常&quot;</span>, e);</span><br><span class="line">            <span class="comment">// 根据异常类型决定是否重试</span></span><br><span class="line">            <span class="keyword">if</span> (shouldRetry(e)) &#123;</span><br><span class="line">                <span class="comment">// 不确认，将重试</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 发送到死信队列并确认</span></span><br><span class="line">                sendToDeadLetterTopic(record);</span><br><span class="line">                ack.acknowledge();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理高风险交易</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleHighRiskTransaction</span><span class="params">(Transaction transaction, RiskAssessment assessment)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 阻断交易</span></span><br><span class="line">        kafkaTemplate.send(<span class="string">&quot;transaction-responses&quot;</span>, transaction.getId(), </span><br><span class="line">                createTransactionResponse(transaction, <span class="literal">false</span>, <span class="string">&quot;疑似欺诈交易&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 触发欺诈警报</span></span><br><span class="line">        <span class="type">FraudAlert</span> <span class="variable">alert</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FraudAlert</span>();</span><br><span class="line">        alert.setTransactionId(transaction.getId());</span><br><span class="line">        alert.setUserId(transaction.getUserId());</span><br><span class="line">        alert.setAmount(transaction.getAmount());</span><br><span class="line">        alert.setRiskScore(assessment.getRiskScore());</span><br><span class="line">        alert.setRiskFactors(assessment.getRiskFactors());</span><br><span class="line">        alert.setTimestamp(System.currentTimeMillis());</span><br><span class="line">        </span><br><span class="line">        kafkaTemplate.send(<span class="string">&quot;fraud-alerts&quot;</span>, alert.getUserId(), objectMapper.writeValueAsString(alert));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 记录事件</span></span><br><span class="line">        log.warn(<span class="string">&quot;检测到高风险交易: 交易ID=&#123;&#125;, 用户ID=&#123;&#125;, 风险分数=&#123;&#125;&quot;</span>, </span><br><span class="line">                transaction.getId(), transaction.getUserId(), assessment.getRiskScore());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 其他辅助方法...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-实时数据分析系统"><a href="#3-实时数据分析系统" class="headerlink" title="3. 实时数据分析系统"></a>3. 实时数据分析系统</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserEventTrackingService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ObjectMapper objectMapper;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserEventTrackingService</span><span class="params">(KafkaTemplate&lt;String, String&gt; kafkaTemplate,</span></span><br><span class="line"><span class="params">                                   ObjectMapper objectMapper)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.kafkaTemplate = kafkaTemplate;</span><br><span class="line">        <span class="built_in">this</span>.objectMapper = objectMapper;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 跟踪用户事件并发送到Kafka</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">trackEvent</span><span class="params">(UserEvent event)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 添加元数据</span></span><br><span class="line">            <span class="keyword">if</span> (event.getTimestamp() == <span class="number">0</span>) &#123;</span><br><span class="line">                event.setTimestamp(System.currentTimeMillis());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="type">String</span> <span class="variable">eventJson</span> <span class="operator">=</span> objectMapper.writeValueAsString(event);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 使用事件类型作为key，相同类型的事件会进入同一分区</span></span><br><span class="line">            kafkaTemplate.send(<span class="string">&quot;user-events&quot;</span>, event.getEventType(), eventJson);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;用户事件序列化失败&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RealTimeAnalyticsService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ObjectMapper objectMapper;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisTemplate&lt;String, String&gt; redisTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 使用Caffeine缓存作为本地计数器</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Cache&lt;String, AtomicLong&gt; localCounters;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RealTimeAnalyticsService</span><span class="params">(ObjectMapper objectMapper,</span></span><br><span class="line"><span class="params">                                   RedisTemplate&lt;String, String&gt; redisTemplate,</span></span><br><span class="line"><span class="params">                                   KafkaTemplate&lt;String, String&gt; kafkaTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.objectMapper = objectMapper;</span><br><span class="line">        <span class="built_in">this</span>.redisTemplate = redisTemplate;</span><br><span class="line">        <span class="built_in">this</span>.kafkaTemplate = kafkaTemplate;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 初始化本地计数器缓存</span></span><br><span class="line">        <span class="built_in">this</span>.localCounters = Caffeine.newBuilder()</span><br><span class="line">            .maximumSize(<span class="number">10_000</span>)</span><br><span class="line">            .expireAfterWrite(<span class="number">1</span>, TimeUnit.MINUTES)</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 实时分析用户事件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@KafkaListener(topics = &quot;user-events&quot;, groupId = &quot;analytics-service-group&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processUserEvent</span><span class="params">(ConsumerRecord&lt;String, String&gt; record, Acknowledgment ack)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 解析用户事件</span></span><br><span class="line">            <span class="type">UserEvent</span> <span class="variable">event</span> <span class="operator">=</span> objectMapper.readValue(record.value(), UserEvent.class);</span><br><span class="line">            <span class="type">String</span> <span class="variable">eventType</span> <span class="operator">=</span> record.key();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2. 增加事件计数</span></span><br><span class="line">            incrementEventCounter(eventType);</span><br><span class="line">            incrementUserEventCounter(event.getUserId(), eventType);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 3. 会话分析</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;page_view&quot;</span>.equals(eventType)) &#123;</span><br><span class="line">                updateUserSession(event);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 4. 实时热点检测</span></span><br><span class="line">            detectHotContent(event);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 5. 用户行为序列分析</span></span><br><span class="line">            analyzeUserBehaviorSequence(event);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 6. 确认消息处理完成</span></span><br><span class="line">            ack.acknowledge();</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;用户事件处理异常&quot;</span>, e);</span><br><span class="line">            <span class="comment">// 大多数分析场景可以容忍少量数据丢失，直接确认</span></span><br><span class="line">            ack.acknowledge();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 增加事件计数器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">incrementEventCounter</span><span class="params">(String eventType)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 更新本地计数器</span></span><br><span class="line">        <span class="type">AtomicLong</span> <span class="variable">localCounter</span> <span class="operator">=</span> localCounters.get(eventType, k -&gt; <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">0</span>));</span><br><span class="line">        <span class="type">long</span> <span class="variable">localCount</span> <span class="operator">=</span> localCounter.incrementAndGet();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 当本地计数达到阈值时，批量更新Redis</span></span><br><span class="line">        <span class="keyword">if</span> (localCount % <span class="number">100</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">redisKey</span> <span class="operator">=</span> <span class="string">&quot;event:count:&quot;</span> + eventType;</span><br><span class="line">            redisTemplate.opsForValue().increment(redisKey, localCount);</span><br><span class="line">            localCounter.set(<span class="number">0</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 3. 发布计数更新事件</span></span><br><span class="line">            <span class="type">CounterUpdate</span> <span class="variable">update</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CounterUpdate</span>(eventType, <span class="string">&quot;event_count&quot;</span>, localCount);</span><br><span class="line">            kafkaTemplate.send(<span class="string">&quot;analytics-updates&quot;</span>, eventType, objectMapper.writeValueAsString(update));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 检测热点内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">detectHotContent</span><span class="params">(UserEvent event)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;content_view&quot;</span>.equals(event.getEventType()) &amp;&amp; event.getProperties().containsKey(<span class="string">&quot;contentId&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">contentId</span> <span class="operator">=</span> event.getProperties().get(<span class="string">&quot;contentId&quot;</span>).toString();</span><br><span class="line">            <span class="type">String</span> <span class="variable">redisKey</span> <span class="operator">=</span> <span class="string">&quot;content:views:&quot;</span> + contentId;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 1. 增加内容查看计数</span></span><br><span class="line">            <span class="type">Long</span> <span class="variable">viewCount</span> <span class="operator">=</span> redisTemplate.opsForValue().increment(redisKey);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2. 设置过期时间（滑动窗口）</span></span><br><span class="line">            redisTemplate.expire(redisKey, <span class="number">10</span>, TimeUnit.MINUTES);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 3. 检查是否达到热点阈值</span></span><br><span class="line">            <span class="keyword">if</span> (viewCount != <span class="literal">null</span> &amp;&amp; viewCount &gt; <span class="number">1000</span> &amp;&amp; viewCount % <span class="number">100</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="type">HotContent</span> <span class="variable">hotContent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotContent</span>();</span><br><span class="line">                hotContent.setContentId(contentId);</span><br><span class="line">                hotContent.setViewCount(viewCount);</span><br><span class="line">                hotContent.setTimestamp(System.currentTimeMillis());</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 发布热点内容事件</span></span><br><span class="line">                kafkaTemplate.send(<span class="string">&quot;hot-content&quot;</span>, contentId, objectMapper.writeValueAsString(hotContent));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 其他辅助方法...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-微服务通信与事件驱动架构"><a href="#4-微服务通信与事件驱动架构" class="headerlink" title="4. 微服务通信与事件驱动架构"></a>4. 微服务通信与事件驱动架构</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderDomainEventPublisher</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ObjectMapper objectMapper;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OrderDomainEventPublisher</span><span class="params">(KafkaTemplate&lt;String, String&gt; kafkaTemplate,</span></span><br><span class="line"><span class="params">                                    ObjectMapper objectMapper)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.kafkaTemplate = kafkaTemplate;</span><br><span class="line">        <span class="built_in">this</span>.objectMapper = objectMapper;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发布订单领域事件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">publishOrderEvent</span><span class="params">(OrderDomainEvent event)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 添加元数据</span></span><br><span class="line">            event.setEventId(UUID.randomUUID().toString());</span><br><span class="line">            event.setTimestamp(System.currentTimeMillis());</span><br><span class="line">            event.setVersion(<span class="string">&quot;1.0&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="type">String</span> <span class="variable">eventJson</span> <span class="operator">=</span> objectMapper.writeValueAsString(event);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2. 发送事件到对应主题</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">topic</span> <span class="operator">=</span> <span class="string">&quot;order-events&quot;</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 3. 使用订单ID作为key，确保同一订单的事件顺序性</span></span><br><span class="line">            kafkaTemplate.send(topic, event.getOrderId(), eventJson)</span><br><span class="line">                .addCallback(<span class="keyword">new</span> <span class="title class_">ListenableFutureCallback</span>&lt;SendResult&lt;String, String&gt;&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(SendResult&lt;String, String&gt; result)</span> &#123;</span><br><span class="line">                        log.debug(<span class="string">&quot;领域事件发布成功: 事件类型=&#123;&#125;, 订单ID=&#123;&#125;, 分区=&#123;&#125;, 偏移量=&#123;&#125;&quot;</span>, </span><br><span class="line">                                event.getEventType(), event.getOrderId(), </span><br><span class="line">                                result.getRecordMetadata().partition(),</span><br><span class="line">                                result.getRecordMetadata().offset());</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(Throwable ex)</span> &#123;</span><br><span class="line">                        log.error(<span class="string">&quot;领域事件发布失败: 事件类型=&#123;&#125;, 订单ID=&#123;&#125;, 错误=&#123;&#125;&quot;</span>, </span><br><span class="line">                                event.getEventType(), event.getOrderId(), ex.getMessage());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;领域事件序列化失败&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InventoryRepository inventoryRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ObjectMapper objectMapper;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">InventoryService</span><span class="params">(InventoryRepository inventoryRepository,</span></span><br><span class="line"><span class="params">                           KafkaTemplate&lt;String, String&gt; kafkaTemplate,</span></span><br><span class="line"><span class="params">                           ObjectMapper objectMapper)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.inventoryRepository = inventoryRepository;</span><br><span class="line">        <span class="built_in">this</span>.kafkaTemplate = kafkaTemplate;</span><br><span class="line">        <span class="built_in">this</span>.objectMapper = objectMapper;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监听订单创建事件并处理库存</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@KafkaListener(topics = &quot;order-events&quot;, groupId = &quot;inventory-service-group&quot;,</span></span><br><span class="line"><span class="meta">                  containerFactory = &quot;orderEventsKafkaListenerContainerFactory&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleOrderEvent</span><span class="params">(ConsumerRecord&lt;String, String&gt; record, Acknowledgment ack)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 解析事件</span></span><br><span class="line">            <span class="type">OrderDomainEvent</span> <span class="variable">event</span> <span class="operator">=</span> objectMapper.readValue(record.value(), OrderDomainEvent.class);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2. 只处理关心的事件类型</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;ORDER_CREATED&quot;</span>.equals(event.getEventType())) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;接收到订单创建事件: 订单ID=&#123;&#125;&quot;</span>, event.getOrderId());</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 3. 提取订单项</span></span><br><span class="line">                List&lt;OrderItem&gt; orderItems = event.getOrderItems();</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 4. 检查并扣减库存</span></span><br><span class="line">                <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> reserveInventory(orderItems);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 5. 发布库存处理结果事件</span></span><br><span class="line">                publishInventoryEvent(event.getOrderId(), success);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 6. 确认消息处理完成</span></span><br><span class="line">            ack.acknowledge();</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;处理订单事件异常&quot;</span>, e);</span><br><span class="line">            <span class="comment">// 根据异常类型决定是否重试</span></span><br><span class="line">            <span class="keyword">if</span> (isRetryableException(e)) &#123;</span><br><span class="line">                <span class="comment">// 不确认，将重试</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 确认并记录失败</span></span><br><span class="line">                ack.acknowledge();</span><br><span class="line">                recordFailedEvent(record);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 预留库存</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">reserveInventory</span><span class="params">(List&lt;OrderItem&gt; orderItems)</span> &#123;</span><br><span class="line">        <span class="comment">// 实现库存预留逻辑</span></span><br><span class="line">        <span class="keyword">for</span> (OrderItem item : orderItems) &#123;</span><br><span class="line">            <span class="type">Inventory</span> <span class="variable">inventory</span> <span class="operator">=</span> inventoryRepository.findByProductIdWithLock(item.getProductId());</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (inventory == <span class="literal">null</span> || inventory.getAvailableQuantity() &lt; item.getQuantity()) &#123;</span><br><span class="line">                <span class="comment">// 库存不足，回滚事务</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InsufficientInventoryException</span>(<span class="string">&quot;库存不足: 产品ID=&quot;</span> + item.getProductId());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 扣减可用库存</span></span><br><span class="line">            inventory.setAvailableQuantity(inventory.getAvailableQuantity() - item.getQuantity());</span><br><span class="line">            inventory.setReservedQuantity(inventory.getReservedQuantity() + item.getQuantity());</span><br><span class="line">            inventoryRepository.save(inventory);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发布库存事件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">publishInventoryEvent</span><span class="params">(String orderId, <span class="type">boolean</span> success)</span> &#123;</span><br><span class="line">        <span class="type">InventoryEvent</span> <span class="variable">event</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InventoryEvent</span>();</span><br><span class="line">        event.setOrderId(orderId);</span><br><span class="line">        event.setEventType(success ? <span class="string">&quot;INVENTORY_RESERVED&quot;</span> : <span class="string">&quot;INVENTORY_RESERVATION_FAILED&quot;</span>);</span><br><span class="line">        event.setTimestamp(System.currentTimeMillis());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            kafkaTemplate.send(<span class="string">&quot;inventory-events&quot;</span>, orderId, objectMapper.writeValueAsString(event));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;库存事件序列化失败&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 其他辅助方法...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-Kafka-监控与性能优化"><a href="#5-Kafka-监控与性能优化" class="headerlink" title="5. Kafka 监控与性能优化"></a>5. Kafka 监控与性能优化</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KafkaAdvancedConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ProducerFactory&lt;String, String&gt; <span class="title function_">producerFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; props = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">&quot;kafka1:9092,kafka2:9092,kafka3:9092&quot;</span>);</span><br><span class="line">        props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class);</span><br><span class="line">        props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 可靠性配置</span></span><br><span class="line">        props.put(ProducerConfig.ACKS_CONFIG, <span class="string">&quot;all&quot;</span>); <span class="comment">// 所有副本确认</span></span><br><span class="line">        props.put(ProducerConfig.RETRIES_CONFIG, <span class="number">3</span>);  <span class="comment">// 重试次数</span></span><br><span class="line">        props.put(ProducerConfig.RETRY_BACKOFF_MS_CONFIG, <span class="number">100</span>); <span class="comment">// 重试间隔</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 性能优化配置</span></span><br><span class="line">        props.put(ProducerConfig.BATCH_SIZE_CONFIG, <span class="number">16384</span>); <span class="comment">// 批次大小</span></span><br><span class="line">        props.put(ProducerConfig.LINGER_MS_CONFIG, <span class="number">5</span>); <span class="comment">// 等待时间，增加批量效果</span></span><br><span class="line">        props.put(ProducerConfig.BUFFER_MEMORY_CONFIG, <span class="number">33554432</span>); <span class="comment">// 缓冲区大小</span></span><br><span class="line">        props.put(ProducerConfig.COMPRESSION_TYPE_CONFIG, <span class="string">&quot;snappy&quot;</span>); <span class="comment">// 启用压缩</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 幂等性配置</span></span><br><span class="line">        props.put(ProducerConfig.ENABLE_IDEMPOTENCE_CONFIG, <span class="literal">true</span>); <span class="comment">// 启用幂等性</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultKafkaProducerFactory</span>&lt;&gt;(props);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ConsumerFactory&lt;String, String&gt; <span class="title function_">consumerFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; props = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">&quot;kafka1:9092,kafka2:9092,kafka3:9092&quot;</span>);</span><br><span class="line">        props.put(ConsumerConfig.GROUP_ID_CONFIG, <span class="string">&quot;my-consumer-group&quot;</span>);</span><br><span class="line">        props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);</span><br><span class="line">        props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 消费者配置</span></span><br><span class="line">        props.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, <span class="literal">false</span>); <span class="comment">// 禁用自动提交</span></span><br><span class="line">        props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, <span class="string">&quot;earliest&quot;</span>); <span class="comment">// 从最早的消息开始消费</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 性能优化配置</span></span><br><span class="line">        props.put(ConsumerConfig.FETCH_MIN_BYTES_CONFIG, <span class="number">1024</span>); <span class="comment">// 最小获取字节数</span></span><br><span class="line">        props.put(ConsumerConfig.FETCH_MAX_WAIT_MS_CONFIG, <span class="number">500</span>); <span class="comment">// 最大等待时间</span></span><br><span class="line">        props.put(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, <span class="number">500</span>); <span class="comment">// 单次拉取最大记录数</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultKafkaConsumerFactory</span>&lt;&gt;(props);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ConcurrentKafkaListenerContainerFactory&lt;String, String&gt; <span class="title function_">kafkaListenerContainerFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        ConcurrentKafkaListenerContainerFactory&lt;String, String&gt; factory = <span class="keyword">new</span> <span class="title class_">ConcurrentKafkaListenerContainerFactory</span>&lt;&gt;();</span><br><span class="line">        factory.setConsumerFactory(consumerFactory());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 并发配置</span></span><br><span class="line">        factory.setConcurrency(<span class="number">3</span>); <span class="comment">// 每个主题的消费者线程数</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 批量消费配置</span></span><br><span class="line">        factory.setBatchListener(<span class="literal">true</span>); <span class="comment">// 启用批量监听</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 错误处理</span></span><br><span class="line">        factory.setErrorHandler(<span class="keyword">new</span> <span class="title class_">SeekToCurrentErrorHandler</span>(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">DeadLetterPublishingRecoverer</span>(kafkaTemplate()), </span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">FixedBackOff</span>(<span class="number">1000L</span>, <span class="number">3</span>))); <span class="comment">// 重试3次，间隔1秒</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 手动提交配置</span></span><br><span class="line">        factory.getContainerProperties().setAckMode(ContainerProperties.AckMode.MANUAL_IMMEDIATE);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> factory;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> KafkaTemplate&lt;String, String&gt; <span class="title function_">kafkaTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">KafkaTemplate</span>&lt;&gt;(producerFactory());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KafkaMonitoringService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> KafkaAdmin kafkaAdmin;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MeterRegistry meterRegistry;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">KafkaMonitoringService</span><span class="params">(KafkaAdmin kafkaAdmin, </span></span><br><span class="line"><span class="params">                                 MeterRegistry meterRegistry,</span></span><br><span class="line"><span class="params">                                 KafkaTemplate&lt;String, String&gt; kafkaTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.kafkaAdmin = kafkaAdmin;</span><br><span class="line">        <span class="built_in">this</span>.meterRegistry = meterRegistry;</span><br><span class="line">        <span class="built_in">this</span>.kafkaTemplate = kafkaTemplate;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 初始化监控指标</span></span><br><span class="line">        initializeMetrics();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化Kafka监控指标</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initializeMetrics</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 生产者指标</span></span><br><span class="line">        kafkaTemplate.metrics().forEach((name, metric) -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (name.name().contains(<span class="string">&quot;record-send-rate&quot;</span>) || </span><br><span class="line">                name.name().contains(<span class="string">&quot;request-latency-avg&quot;</span>) ||</span><br><span class="line">                name.name().contains(<span class="string">&quot;record-error-rate&quot;</span>)) &#123;</span><br><span class="line">                meterRegistry.gauge(<span class="string">&quot;kafka.producer.&quot;</span> + name.name(), </span><br><span class="line">                        metric, m -&gt; m.metricValue());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 自定义消费者延迟指标</span></span><br><span class="line">        Gauge.builder(<span class="string">&quot;kafka.consumer.lag&quot;</span>, <span class="built_in">this</span>, KafkaMonitoringService::calculateConsumerLag)</span><br><span class="line">            .tag(<span class="string">&quot;group&quot;</span>, <span class="string">&quot;my-consumer-group&quot;</span>)</span><br><span class="line">            .tag(<span class="string">&quot;topic&quot;</span>, <span class="string">&quot;important-topic&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算消费者延迟</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> <span class="title function_">calculateConsumerLag</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 实现消费者延迟计算逻辑</span></span><br><span class="line">            <span class="comment">// 1. 获取主题最新偏移量</span></span><br><span class="line">            <span class="comment">// 2. 获取消费者组当前偏移量</span></span><br><span class="line">            <span class="comment">// 3. 计算差值</span></span><br><span class="line">            <span class="keyword">return</span> getTopicEndOffsets() - getConsumerGroupOffsets();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;计算消费者延迟异常&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监控Kafka集群健康状态</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Scheduled(fixedRate = 60000)</span> <span class="comment">// 每分钟执行一次</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">monitorClusterHealth</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 检查Broker可用性</span></span><br><span class="line">            Map&lt;String, Object&gt; configs = kafkaAdmin.getConfigurationProperties();</span><br><span class="line">            <span class="type">String</span> <span class="variable">bootstrapServers</span> <span class="operator">=</span> (String) configs.get(AdminClientConfig.BOOTSTRAP_SERVERS_CONFIG);</span><br><span class="line">            </span><br><span class="line">            <span class="type">AdminClient</span> <span class="variable">adminClient</span> <span class="operator">=</span> AdminClient.create(configs);</span><br><span class="line">            <span class="type">DescribeClusterResult</span> <span class="variable">clusterResult</span> <span class="operator">=</span> adminClient.describeCluster();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2. 获取集群节点信息</span></span><br><span class="line">            Collection&lt;Node&gt; nodes = clusterResult.nodes().get(<span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line">            <span class="type">Node</span> <span class="variable">controller</span> <span class="operator">=</span> clusterResult.controller().get(<span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 3. 记录集群状态</span></span><br><span class="line">            log.info(<span class="string">&quot;Kafka集群状态: 节点数量=&#123;&#125;, 控制器ID=&#123;&#125;&quot;</span>, nodes.size(), controller.id());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 4. 检查主题状态</span></span><br><span class="line">            checkTopicsHealth(adminClient);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 5. 检查消费者组状态</span></span><br><span class="line">            checkConsumerGroupsHealth(adminClient);</span><br><span class="line">            </span><br><span class="line">            adminClient.close();</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;监控Kafka集群健康状态异常&quot;</span>, e);</span><br><span class="line">            <span class="comment">// 触发告警</span></span><br><span class="line">            sendHealthAlert(<span class="string">&quot;Kafka集群监控异常: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 检查主题健康状态</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkTopicsHealth</span><span class="params">(AdminClient adminClient)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1. 获取所有主题</span></span><br><span class="line">        <span class="type">ListTopicsResult</span> <span class="variable">topicsResult</span> <span class="operator">=</span> adminClient.listTopics();</span><br><span class="line">        Set&lt;String&gt; topics = topicsResult.names().get(<span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 检查关键主题的分区和副本状态</span></span><br><span class="line">        <span class="keyword">for</span> (String topic : topics) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isImportantTopic(topic)) &#123;</span><br><span class="line">                <span class="type">DescribeTopicResult</span> <span class="variable">topicResult</span> <span class="operator">=</span> adminClient.describeTopics(</span><br><span class="line">                        Collections.singleton(topic)).values().get(topic);</span><br><span class="line">                <span class="type">TopicDescription</span> <span class="variable">topicDesc</span> <span class="operator">=</span> topicResult.get(<span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 3. 检查分区数量</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">partitionCount</span> <span class="operator">=</span> topicDesc.partitions().size();</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 4. 检查每个分区的副本状态</span></span><br><span class="line">                <span class="keyword">for</span> (TopicPartitionInfo partition : topicDesc.partitions()) &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">replicaCount</span> <span class="operator">=</span> partition.replicas().size();</span><br><span class="line">                    <span class="type">int</span> <span class="variable">isrCount</span> <span class="operator">=</span> partition.isr().size();</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 5. 检查ISR是否小于副本数，表示有副本不同步</span></span><br><span class="line">                    <span class="keyword">if</span> (isrCount &lt; replicaCount) &#123;</span><br><span class="line">                        log.warn(<span class="string">&quot;主题副本不同步: 主题=&#123;&#125;, 分区=&#123;&#125;, 副本数=&#123;&#125;, ISR数=&#123;&#125;&quot;</span>, </span><br><span class="line">                                topic, partition.partition(), replicaCount, isrCount);</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// 触发告警</span></span><br><span class="line">                        sendHealthAlert(String.format(</span><br><span class="line">                                <span class="string">&quot;Kafka主题副本不同步: 主题=%s, 分区=%d, 副本数=%d, ISR数=%d&quot;</span>, </span><br><span class="line">                                topic, partition.partition(), replicaCount, isrCount));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 其他辅助方法...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结与最佳实践"><a href="#总结与最佳实践" class="headerlink" title="总结与最佳实践"></a>总结与最佳实践</h2><p>通过本文的深入分析，我们了解了Kafka在高并发消息处理中的核心机制和分区策略。以下是一些关键的最佳实践总结：</p>
<h3 id="实际业务场景应用"><a href="#实际业务场景应用" class="headerlink" title="实际业务场景应用"></a>实际业务场景应用</h3><ol>
<li><p><strong>电商订单处理系统</strong></p>
<ul>
<li>使用订单ID作为消息key确保同一订单的消息顺序性</li>
<li>实现幂等性处理避免重复消费</li>
<li>采用手动确认模式确保消息可靠处理</li>
<li>针对不同异常类型采用不同的重试策略</li>
</ul>
</li>
<li><p><strong>金融风控系统</strong></p>
<ul>
<li>利用Kafka实现实时交易监控和风险评估</li>
<li>使用用户ID作为key将同一用户的交易路由到同一分区</li>
<li>结合本地缓存和消息队列实现高效的风控分析</li>
<li>针对不同风险级别采用不同的处理策略</li>
</ul>
</li>
<li><p><strong>实时数据分析系统</strong></p>
<ul>
<li>使用Kafka作为事件流处理的核心组件</li>
<li>实现本地计数器与分布式计数器的结合</li>
<li>通过事件类型分区实现高效的并行处理</li>
<li>热点内容检测与实时推送</li>
</ul>
</li>
<li><p><strong>微服务通信与事件驱动架构</strong></p>
<ul>
<li>使用领域事件实现服务间的松耦合通信</li>
<li>确保事件的顺序性和可靠性</li>
<li>实现基于事件的一致性处理</li>
<li>服务间的异步协作与状态同步</li>
</ul>
</li>
<li><p><strong>Kafka监控与性能优化</strong></p>
<ul>
<li>生产者和消费者的高级配置优化</li>
<li>实时监控Kafka集群健康状态</li>
<li>消费者延迟监控与告警</li>
<li>主题分区和副本健康检查</li>
</ul>
</li>
</ol>
<h3 id="性能优化关键点"><a href="#性能优化关键点" class="headerlink" title="性能优化关键点"></a>性能优化关键点</h3><ol>
<li><p><strong>分区数量优化</strong></p>
<ul>
<li>分区数应根据预期吞吐量和消费者数量合理设置</li>
<li>过多分区会增加broker负担，过少分区会限制并行度</li>
<li>建议：分区数 &#x3D; min(吞吐量&#x2F;单分区吞吐量, 消费者数量 * 3)</li>
</ul>
</li>
<li><p><strong>生产者批处理优化</strong></p>
<ul>
<li>适当增加<code>batch.size</code>和<code>linger.ms</code>提高批处理效率</li>
<li>启用压缩减少网络传输开销</li>
<li>根据可靠性需求设置适当的<code>acks</code>值</li>
</ul>
</li>
<li><p><strong>消费者并发优化</strong></p>
<ul>
<li>合理设置消费者数量，通常不超过分区数</li>
<li>调整<code>fetch.min.bytes</code>和<code>fetch.max.wait.ms</code>平衡延迟和吞吐量</li>
<li>使用批量消费提高处理效率</li>
</ul>
</li>
<li><p><strong>可靠性与吞吐量权衡</strong></p>
<ul>
<li>高可靠性：设置<code>acks=all</code>，适当的副本数，禁用自动提交</li>
<li>高吞吐量：批处理，压缩，适当增加<code>buffer.memory</code></li>
<li>根据业务场景选择合适的配置组合</li>
</ul>
</li>
<li><p><strong>监控告警机制</strong></p>
<ul>
<li>监控消费者延迟（Consumer Lag）</li>
<li>监控broker健康状态和分区副本同步状态</li>
<li>设置关键指标的告警阈值</li>
<li>定期检查主题和消费者组状态</li>
</ul>
</li>
</ol>
<p>通过本文的学习，你应该能够理解Kafka的核心工作原理，掌握分区策略的设计思想，并能在实际业务场景中合理应用Kafka实现高并发、高可靠的消息处理系统。无论是构建实时数据管道、事件驱动架构，还是微服务通信，Kafka都能提供强大的支持。</p>
<h2 id="注意事项与容易忽略点"><a href="#注意事项与容易忽略点" class="headerlink" title="注意事项与容易忽略点"></a>注意事项与容易忽略点</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 分区数量对并发有直接影响，过少可能成为瓶颈</span></span><br><span class="line"><span class="comment">// 2. 手动提交偏移量要谨慎，避免重复提交或未提交</span></span><br><span class="line"><span class="comment">// 3. 消费者幂等性设计，避免重复扣减库存或重复发通知</span></span><br><span class="line"><span class="comment">// 4. 异常处理策略，防止阻塞消费线程</span></span><br><span class="line"><span class="comment">// 5. Broker 配置，确保高可用副本和持久化消息</span></span><br><span class="line"><span class="comment">// 6. 消费者均衡，新增或删除消费者会触发再平衡，可能短暂重复消费</span></span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Kafka 提供高吞吐量、可扩展的分区机制和消费组负载均衡</span></span><br><span class="line"><span class="comment">// 配合 Spring Boot 的 KafkaTemplate 和 @KafkaListener，可快速构建高并发异步系统</span></span><br><span class="line"><span class="comment">// 深入理解分区、偏移量、幂等性和异常处理策略，是可靠消息系统的关键</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 实际业务场景应用：</span></span><br><span class="line"><span class="comment">// 1. 电商订单处理：异步订单处理、库存管理、支付通知</span></span><br><span class="line"><span class="comment">// 2. 金融风控系统：实时交易监控、风险评估、异常检测</span></span><br><span class="line"><span class="comment">// 3. 实时数据分析：用户行为分析、会话跟踪、热点检测</span></span><br><span class="line"><span class="comment">// 4. 微服务通信：事件驱动架构、领域事件发布、服务解耦</span></span><br><span class="line"><span class="comment">// 5. 系统监控：性能指标收集、消费者延迟监控、集群健康检查</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 性能优化关键点：</span></span><br><span class="line"><span class="comment">// 1. 合理的分区数量和分区策略</span></span><br><span class="line"><span class="comment">// 2. 生产者批处理和压缩配置</span></span><br><span class="line"><span class="comment">// 3. 消费者并发和批量处理</span></span><br><span class="line"><span class="comment">// 4. 可靠性与吞吐量的权衡</span></span><br><span class="line"><span class="comment">// 5. 完善的监控和告警机制</span></span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/myblog/tags/%E9%AB%98%E5%B9%B6%E5%8F%91/" rel="tag"># 高并发</a>
              <a href="/myblog/tags/Kafka/" rel="tag"># Kafka</a>
              <a href="/myblog/tags/%E5%88%86%E5%8C%BA%E7%AD%96%E7%95%A5/" rel="tag"># 分区策略</a>
              <a href="/myblog/tags/Spring-Boot/" rel="tag"># Spring Boot</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/myblog/2020/07/12/Spring%20Boot%20%E4%B8%8E%20RabbitMQ%20%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%AE%9E%E6%88%98/" rel="prev" title="Spring Boot 与 RabbitMQ 消息队列实战">
                  <i class="fa fa-angle-left"></i> Spring Boot 与 RabbitMQ 消息队列实战
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/myblog/2020/09/12/Elasticsearch%20%E6%90%9C%E7%B4%A2%E4%BC%98%E5%8C%96%E4%B8%8E%E9%AB%98%E6%95%88%E8%81%9A%E5%90%88/" rel="next" title="Elasticsearch 搜索优化与高效聚合">
                  Elasticsearch 搜索优化与高效聚合 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">haiqingxx8</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
