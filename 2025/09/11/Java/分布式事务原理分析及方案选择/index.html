<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/myblog/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/myblog/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/myblog/images/favicon-16x16.png">
  <link rel="mask-icon" href="/myblog/images/safari-pinned-tab.svg" color="#222">

<link rel="stylesheet" href="/myblog/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css2?family=Lato:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"haiqingxx8.github.io","root":"/myblog/","images":"/myblog/images","scheme":"Gemini","darkmode":false,"version":"8.24.0","exturl":false,"sidebar":{"position":"right","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12,"enable":true,"b2t":false,"scrollpercent":false,"onmobile":false},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":"default","show_result":true},"fold":{"enable":false,"height":500},"language":false,"highlight_theme":"normal"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":true,"nav":null,"count":true,"text":"评论","orderby":"latest","login":"登录","admin":"博主","page_text":"评论","comment_placeholder":"说点什么吧..."},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/myblog/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false,"labels":{"input_placeholder":"搜索文章...","hits_empty":"找不到您查询的内容: ${query}"}}}</script><script src="/myblog/js/config.js" defer></script>

    <meta name="description" content="系统化解析分布式事务（XA&#x2F;TCC&#x2F;Saga&#x2F;Outbox&#x2F;事务消息&#x2F;CDC&#x2F;最大努力），覆盖实现原理、优缺点、工程落地（幂等、状态机、对账、重试、监控），附上可运行的代码示例和表结构。">
<meta property="og:type" content="article">
<meta property="og:title" content="分布式事务原理分析及方案选择">
<meta property="og:url" content="https://haiqingxx8.github.io/2025/09/11/Java/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90%E5%8F%8A%E6%96%B9%E6%A1%88%E9%80%89%E6%8B%A9/index.html">
<meta property="og:site_name" content="我的技术博客">
<meta property="og:description" content="系统化解析分布式事务（XA&#x2F;TCC&#x2F;Saga&#x2F;Outbox&#x2F;事务消息&#x2F;CDC&#x2F;最大努力），覆盖实现原理、优缺点、工程落地（幂等、状态机、对账、重试、监控），附上可运行的代码示例和表结构。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-09-11T03:20:00.000Z">
<meta property="article:modified_time" content="2025-10-29T15:43:04.579Z">
<meta property="article:author" content="haiqingxx8">
<meta property="article:tag" content="分布式事务">
<meta property="article:tag" content="XA">
<meta property="article:tag" content="TCC">
<meta property="article:tag" content="Saga">
<meta property="article:tag" content="Outbox">
<meta property="article:tag" content="事务消息">
<meta property="article:tag" content="CDC">
<meta property="article:tag" content="幂等">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://haiqingxx8.github.io/2025/09/11/Java/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90%E5%8F%8A%E6%96%B9%E6%A1%88%E9%80%89%E6%8B%A9/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://haiqingxx8.github.io/2025/09/11/Java/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90%E5%8F%8A%E6%96%B9%E6%A1%88%E9%80%89%E6%8B%A9/","path":"2025/09/11/Java/分布式事务原理分析及方案选择/","title":"分布式事务原理分析及方案选择"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>分布式事务原理分析及方案选择 | 我的技术博客</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/myblog/js/utils.js" defer></script><script src="/myblog/js/motion.js" defer></script><script src="/myblog/js/sidebar.js" defer></script><script src="/myblog/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/myblog/js/third-party/search/local-search.js" defer></script>







  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





  <noscript>
    <link rel="stylesheet" href="/myblog/css/noscript.css">
  </noscript>
<link rel="alternate" href="/myblog/atom.xml" title="我的技术博客" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/myblog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">我的技术博客</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">记录技术学习心得，分享开发经验</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/myblog/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/myblog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-categories"><a href="/myblog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/myblog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-about"><a href="/myblog/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E8%83%8C%E6%99%AF%E4%B8%8E%E9%97%AE%E9%A2%98%E5%AE%9A%E4%B9%89"><span class="nav-number">1.</span> <span class="nav-text">1. 背景与问题定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E6%96%B9%E6%A1%88%E6%80%BB%E8%A7%88%E4%B8%8E%E9%80%89%E6%8B%A9%E5%BB%BA%E8%AE%AE"><span class="nav-number">2.</span> <span class="nav-text">2. 方案总览与选择建议</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-XA-2PC-%E5%8E%9F%E7%90%86%E4%B8%8E%E7%A4%BA%E4%BE%8B"><span class="nav-number">3.</span> <span class="nav-text">3. XA&#x2F;2PC 原理与示例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%90%86"><span class="nav-number">3.1.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="nav-number">3.2.</span> <span class="nav-text">优缺点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Boot-Atomikos-%E7%A4%BA%E4%BE%8B"><span class="nav-number">3.3.</span> <span class="nav-text">Spring Boot + Atomikos 示例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-TCC-%E5%8E%9F%E7%90%86%E4%B8%8E%E7%A4%BA%E4%BE%8B"><span class="nav-number">4.</span> <span class="nav-text">4. TCC 原理与示例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%90%86-2"><span class="nav-number">4.1.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9-2"><span class="nav-number">4.2.</span> <span class="nav-text">优缺点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A1%A8%E7%BB%93%E6%9E%84%EF%BC%88%E7%A4%BA%E4%BE%8B%EF%BC%89"><span class="nav-number">4.3.</span> <span class="nav-text">表结构（示例）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B8%8E%E6%9C%8D%E5%8A%A1"><span class="nav-number">4.4.</span> <span class="nav-text">控制器与服务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-Saga-%E5%8E%9F%E7%90%86%E4%B8%8E%E7%A4%BA%E4%BE%8B"><span class="nav-number">5.</span> <span class="nav-text">5. Saga 原理与示例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%90%86-3"><span class="nav-number">5.1.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%88Orchestrator-%E7%AE%80%E5%8C%96%E7%89%88%EF%BC%89"><span class="nav-number">5.2.</span> <span class="nav-text">示例（Orchestrator 简化版）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-Outbox-%E5%8E%9F%E7%90%86%E4%B8%8E%E7%A4%BA%E4%BE%8B%EF%BC%88%E6%9C%AC%E5%9C%B0%E4%BA%8B%E5%8A%A1-%E5%BC%82%E6%AD%A5%E6%8A%95%E9%80%92%EF%BC%89"><span class="nav-number">6.</span> <span class="nav-text">6. Outbox 原理与示例（本地事务 + 异步投递）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%90%86-4"><span class="nav-number">6.1.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A1%A8%E7%BB%93%E6%9E%84%E4%B8%8E%E7%B4%A2%E5%BC%95"><span class="nav-number">6.2.</span> <span class="nav-text">表结构与索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%9A%E5%8A%A1%E5%86%99%E5%85%A5%EF%BC%88%E5%90%8C%E4%B8%80%E4%BA%8B%E5%8A%A1%EF%BC%89"><span class="nav-number">6.3.</span> <span class="nav-text">业务写入（同一事务）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%95%E9%80%92%E5%99%A8%EF%BC%88Relay%EF%BC%89"><span class="nav-number">6.4.</span> <span class="nav-text">投递器（Relay）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B6%88%E8%B4%B9%E7%AB%AF%E5%B9%82%E7%AD%89"><span class="nav-number">6.5.</span> <span class="nav-text">消费端幂等</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF-%E5%8E%9F%E7%90%86%E4%B8%8E%E7%A4%BA%E4%BE%8B%EF%BC%88RocketMQ%EF%BC%89"><span class="nav-number">7.</span> <span class="nav-text">7. 事务消息 原理与示例（RocketMQ）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%90%86-5"><span class="nav-number">7.1.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B"><span class="nav-number">7.2.</span> <span class="nav-text">示例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-CDC-%E5%8E%9F%E7%90%86%E4%B8%8E%E7%A4%BA%E4%BE%8B%EF%BC%88Debezium%EF%BC%89"><span class="nav-number">8.</span> <span class="nav-text">8. CDC 原理与示例（Debezium）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%90%86-6"><span class="nav-number">8.1.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Connector-%E9%85%8D%E7%BD%AE%EF%BC%88%E7%A4%BA%E4%BE%8B%EF%BC%89"><span class="nav-number">8.2.</span> <span class="nav-text">Connector 配置（示例）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-%E6%9C%80%E5%A4%A7%E5%8A%AA%E5%8A%9B%E9%80%9A%E7%9F%A5%E4%B8%8E%E9%87%8D%E8%AF%95"><span class="nav-number">9.</span> <span class="nav-text">9. 最大努力通知与重试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%90%86-7"><span class="nav-number">9.1.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B-2"><span class="nav-number">9.2.</span> <span class="nav-text">示例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-%E5%B9%82%E7%AD%89%E4%B8%8E%E5%8E%BB%E9%87%8D%EF%BC%88%E7%AB%AF%E5%88%B0%E7%AB%AF%EF%BC%89"><span class="nav-number">10.</span> <span class="nav-text">10. 幂等与去重（端到端）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-%E4%B8%80%E8%87%B4%E6%80%A7%E7%AD%89%E7%BA%A7%E4%B8%8E%E9%9A%94%E7%A6%BB%E7%AD%96%E7%95%A5"><span class="nav-number">11.</span> <span class="nav-text">11. 一致性等级与隔离策略</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-%E7%9B%91%E6%8E%A7%E4%B8%8E%E5%AF%B9%E8%B4%A6"><span class="nav-number">12.</span> <span class="nav-text">12. 监控与对账</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#13-%E9%80%89%E5%9E%8B%E9%80%9F%E6%9F%A5%EF%BC%88%E7%BB%8F%E9%AA%8C%E6%B3%95%E5%88%99%EF%BC%89"><span class="nav-number">13.</span> <span class="nav-text">13. 选型速查（经验法则）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-%E5%B8%B8%E8%A7%81%E5%9D%91%E4%B8%8E%E8%A7%84%E9%81%BF"><span class="nav-number">14.</span> <span class="nav-text">14. 常见坑与规避</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#15-%E6%80%BB%E7%BB%93"><span class="nav-number">15.</span> <span class="nav-text">15. 总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%99%84%E5%BD%95%EF%BC%9A%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E6%B7%B1%E8%AE%B2%EF%BC%88XA-TCC-Saga-Outbox-%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF-CDC-%E6%9C%80%E5%A4%A7%E5%8A%AA%E5%8A%9B%EF%BC%89"><span class="nav-number">16.</span> <span class="nav-text">附录：实现原理深讲（XA &#x2F; TCC &#x2F; Saga &#x2F; Outbox &#x2F; 事务消息 &#x2F; CDC &#x2F; 最大努力）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#A1-XA-2PC-%E6%B7%B1%E8%AE%B2"><span class="nav-number">16.1.</span> <span class="nav-text">A1. XA&#x2F;2PC 深讲</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#A2-TCC-%E6%B7%B1%E8%AE%B2"><span class="nav-number">16.2.</span> <span class="nav-text">A2. TCC 深讲</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#A3-Saga-%E6%B7%B1%E8%AE%B2"><span class="nav-number">16.3.</span> <span class="nav-text">A3. Saga 深讲</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#A4-Outbox-%E6%B7%B1%E8%AE%B2"><span class="nav-number">16.4.</span> <span class="nav-text">A4. Outbox 深讲</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#A5-%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF%EF%BC%88RocketMQ%EF%BC%89%E6%B7%B1%E8%AE%B2"><span class="nav-number">16.5.</span> <span class="nav-text">A5. 事务消息（RocketMQ）深讲</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#A6-CDC-%E6%B7%B1%E8%AE%B2"><span class="nav-number">16.6.</span> <span class="nav-text">A6. CDC 深讲</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#A7-%E6%9C%80%E5%A4%A7%E5%8A%AA%E5%8A%9B%E9%80%9A%E7%9F%A5-%E6%B7%B1%E8%AE%B2"><span class="nav-number">16.7.</span> <span class="nav-text">A7. 最大努力通知 深讲</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#A8-%E9%80%9A%E7%94%A8%E5%B7%A5%E7%A8%8B-Checklist%EF%BC%88%E6%89%A7%E8%A1%8C%E5%89%8D%E5%90%8E%EF%BC%89"><span class="nav-number">16.8.</span> <span class="nav-text">A8. 通用工程 Checklist（执行前后）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#16-%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82%EF%BC%88%E8%AF%AD%E8%A8%80%E6%8F%8F%E8%BF%B0%E7%89%88%EF%BC%89"><span class="nav-number">17.</span> <span class="nav-text">16. 实现细节（语言描述版）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#16-1-XA-%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%EF%BC%88%E4%B8%80%E6%AC%A1%E8%AF%B7%E6%B1%82%E7%9A%84%E8%AF%AD%E8%A8%80%E6%97%B6%E5%BA%8F%EF%BC%89"><span class="nav-number">17.1.</span> <span class="nav-text">16.1 XA &#x2F; 两阶段提交（一次请求的语言时序）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#16-2-TCC%EF%BC%88Try-Confirm-Cancel%EF%BC%89"><span class="nav-number">17.2.</span> <span class="nav-text">16.2 TCC（Try-Confirm-Cancel）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#16-3-Saga%EF%BC%88%E7%BC%96%E6%8E%92%E4%B8%8E%E8%A1%A5%E5%81%BF%EF%BC%89"><span class="nav-number">17.3.</span> <span class="nav-text">16.3 Saga（编排与补偿）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#16-4-Outbox%EF%BC%88%E6%9C%AC%E5%9C%B0%E4%BA%8B%E5%8A%A1-%E5%BC%82%E6%AD%A5%E6%8A%95%E9%80%92%EF%BC%89"><span class="nav-number">17.4.</span> <span class="nav-text">16.4 Outbox（本地事务 + 异步投递）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#16-5-%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF%EF%BC%88%E4%BB%A5-RocketMQ-%E4%B8%BA%E4%BE%8B%EF%BC%89"><span class="nav-number">17.5.</span> <span class="nav-text">16.5 事务消息（以 RocketMQ 为例）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#16-6-CDC%EF%BC%88%E5%8F%98%E6%9B%B4%E6%95%B0%E6%8D%AE%E6%8D%95%E8%8E%B7%EF%BC%89"><span class="nav-number">17.6.</span> <span class="nav-text">16.6 CDC（变更数据捕获）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#16-7-%E6%9C%80%E5%A4%A7%E5%8A%AA%E5%8A%9B%E9%80%9A%E7%9F%A5"><span class="nav-number">17.7.</span> <span class="nav-text">16.7 最大努力通知</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#16-8-%E7%AB%AF%E5%88%B0%E7%AB%AF%E5%B9%82%E7%AD%89%EF%BC%88%E5%A6%82%E4%BD%95%E5%9C%A8%E8%AF%AD%E8%A8%80%E5%B1%82%E9%9D%A2%E8%90%BD%E5%9C%B0%EF%BC%89"><span class="nav-number">17.8.</span> <span class="nav-text">16.8 端到端幂等（如何在语言层面落地）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#16-9-%E8%BF%90%E7%BB%B4%E4%B8%8E%E5%BA%94%E6%80%A5%EF%BC%88%E8%AF%AD%E8%A8%80%E6%B8%85%E5%8D%95%EF%BC%89"><span class="nav-number">17.9.</span> <span class="nav-text">16.9 运维与应急（语言清单）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#17-%E6%9E%B6%E6%9E%84%E5%9B%BE%E4%B8%8E%E6%95%B0%E6%8D%AE%E6%B5%81%E8%AF%A6%E8%A7%A3"><span class="nav-number">18.</span> <span class="nav-text">17. 架构图与数据流详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#17-1-XA-2PC-%E6%9E%B6%E6%9E%84%E5%9B%BE%E6%8F%8F%E8%BF%B0"><span class="nav-number">18.1.</span> <span class="nav-text">17.1 XA&#x2F;2PC 架构图描述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#17-2-TCC-%E6%9E%B6%E6%9E%84%E5%9B%BE%E6%8F%8F%E8%BF%B0"><span class="nav-number">18.2.</span> <span class="nav-text">17.2 TCC 架构图描述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#17-3-Saga-%E6%9E%B6%E6%9E%84%E5%9B%BE%E6%8F%8F%E8%BF%B0"><span class="nav-number">18.3.</span> <span class="nav-text">17.3 Saga 架构图描述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#17-4-Outbox-%E6%9E%B6%E6%9E%84%E5%9B%BE%E6%8F%8F%E8%BF%B0"><span class="nav-number">18.4.</span> <span class="nav-text">17.4 Outbox 架构图描述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#17-5-%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF%E6%9E%B6%E6%9E%84%E5%9B%BE%E6%8F%8F%E8%BF%B0"><span class="nav-number">18.5.</span> <span class="nav-text">17.5 事务消息架构图描述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#17-6-CDC-%E6%9E%B6%E6%9E%84%E5%9B%BE%E6%8F%8F%E8%BF%B0"><span class="nav-number">18.6.</span> <span class="nav-text">17.6 CDC 架构图描述</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#18-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E4%B8%8E%E8%B0%83%E4%BC%98%E5%AE%9E%E8%B7%B5"><span class="nav-number">19.</span> <span class="nav-text">18. 性能优化与调优实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#18-1-XA-2PC-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-number">19.1.</span> <span class="nav-text">18.1 XA&#x2F;2PC 性能优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#18-2-TCC-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-number">19.2.</span> <span class="nav-text">18.2 TCC 性能优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#18-3-Outbox-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-number">19.3.</span> <span class="nav-text">18.3 Outbox 性能优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#18-4-CDC-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-number">19.4.</span> <span class="nav-text">18.4 CDC 性能优化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#19-%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86%E4%B8%8E%E5%AE%B9%E7%81%BE%E5%AE%9E%E8%B7%B5"><span class="nav-number">20.</span> <span class="nav-text">19. 故障处理与容灾实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#19-1-%E5%B8%B8%E8%A7%81%E6%95%85%E9%9A%9C%E5%9C%BA%E6%99%AF%E4%B8%8E%E5%A4%84%E7%90%86"><span class="nav-number">20.1.</span> <span class="nav-text">19.1 常见故障场景与处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#19-2-%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%E6%A3%80%E6%9F%A5%E4%B8%8E%E4%BF%AE%E5%A4%8D"><span class="nav-number">20.2.</span> <span class="nav-text">19.2 数据一致性检查与修复</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#19-3-%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6%E4%BD%93%E7%B3%BB"><span class="nav-number">20.3.</span> <span class="nav-text">19.3 监控告警体系</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#20-%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%94%E8%A1%A8%E6%A0%BC%E4%B8%8E%E9%80%89%E5%9E%8B%E5%86%B3%E7%AD%96%E6%A0%91"><span class="nav-number">21.</span> <span class="nav-text">20. 方案对比表格与选型决策树</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#20-1-%E8%AF%A6%E7%BB%86%E5%AF%B9%E6%AF%94%E8%A1%A8%E6%A0%BC"><span class="nav-number">21.1.</span> <span class="nav-text">20.1 详细对比表格</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#20-2-%E9%80%89%E5%9E%8B%E5%86%B3%E7%AD%96%E6%A0%91"><span class="nav-number">21.2.</span> <span class="nav-text">20.2 选型决策树</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#20-3-%E9%80%89%E5%9E%8B%E5%BB%BA%E8%AE%AE%E7%9F%A9%E9%98%B5"><span class="nav-number">21.3.</span> <span class="nav-text">20.3 选型建议矩阵</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#20-4-%E5%AE%9E%E6%96%BD%E8%B7%AF%E5%BE%84%E5%BB%BA%E8%AE%AE"><span class="nav-number">21.4.</span> <span class="nav-text">20.4 实施路径建议</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#21-%E6%80%BB%E7%BB%93%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">22.</span> <span class="nav-text">21. 总结与最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#21-1-%E6%A0%B8%E5%BF%83%E5%8E%9F%E5%88%99"><span class="nav-number">22.1.</span> <span class="nav-text">21.1 核心原则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#21-2-%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5%E8%A6%81%E7%82%B9"><span class="nav-number">22.2.</span> <span class="nav-text">21.2 工程实践要点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#21-3-%E9%80%89%E5%9E%8B%E9%80%9F%E6%9F%A5"><span class="nav-number">22.3.</span> <span class="nav-text">21.3 选型速查</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="haiqingxx8"
      src="/myblog/images/headimg.jpeg">
  <p class="site-author-name" itemprop="name">haiqingxx8</p>
  <div class="site-description" itemprop="description">个人技术博客，专注于Java后端、前端开发、系统架构等技术分享</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/myblog/archives/">
          <span class="site-state-item-count">36</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/myblog/categories/">
        <span class="site-state-item-count">41</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/myblog/tags/">
        <span class="site-state-item-count">131</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://haiqingxx8.github.io/myblog/" title="GitHub → https:&#x2F;&#x2F;haiqingxx8.github.io&#x2F;myblog&#x2F;" rel="noopener me"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/yourusername" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;yourusername" rel="noopener me" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="/myblog/images/wechat-qr.png" title="WeChat → &#x2F;images&#x2F;wechat-qr.png" rel="noopener me"><i class="fab fa-weixin fa-fw"></i>WeChat</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://haiqingxx8.github.io/2025/09/11/Java/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90%E5%8F%8A%E6%96%B9%E6%A1%88%E9%80%89%E6%8B%A9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/myblog/images/headimg.jpeg">
      <meta itemprop="name" content="haiqingxx8">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="我的技术博客">
      <meta itemprop="description" content="个人技术博客，专注于Java后端、前端开发、系统架构等技术分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="分布式事务原理分析及方案选择 | 我的技术博客">
      <meta itemprop="description" content="系统化解析分布式事务（XA&#x2F;TCC&#x2F;Saga&#x2F;Outbox&#x2F;事务消息&#x2F;CDC&#x2F;最大努力），覆盖实现原理、优缺点、工程落地（幂等、状态机、对账、重试、监控），附上可运行的代码示例和表结构。">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          分布式事务原理分析及方案选择
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-09-11 11:20:00" itemprop="dateCreated datePublished" datetime="2025-09-11T11:20:00+08:00">2025-09-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/myblog/categories/%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">架构</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

            <div class="post-description">系统化解析分布式事务（XA/TCC/Saga/Outbox/事务消息/CDC/最大努力），覆盖实现原理、优缺点、工程落地（幂等、状态机、对账、重试、监控），附上可运行的代码示例和表结构。</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="1-背景与问题定义">1. 背景与问题定义</h2>
<ul>
<li>问题：跨服务/跨库操作需要整体一致性，但在分布式环境（网络抖动、进程崩溃、时钟漂移、依赖不可用）下容易出现“部分成功、部分失败”。</li>
<li>目标：在可接受的时间窗口内达成数据一致（强一致或最终一致），失败可自动补偿或人工对账，兼顾高并发与可用性。</li>
<li>典型场景：订单-库存-账户扣减；支付完成后的发货/积分/营销联动；券码核销与回补；账务出入金等。</li>
</ul>
<h2 id="2-方案总览与选择建议">2. 方案总览与选择建议</h2>
<ul>
<li>XA/2PC：事务管理器协调多个资源，强一致，代价是性能和可用性，云原生受限。</li>
<li>TCC：业务拆分为 Try/Confirm/Cancel，显式补偿、强约束，侵入业务、维护成本高。</li>
<li>Saga：编排长事务，失败触发反向补偿，解耦可扩展，但补偿逻辑复杂、收敛慢。</li>
<li>Outbox：本地事务+消息表，异步投递到 MQ，高吞吐、工程实践成熟，最终一致。</li>
<li>事务消息：消息中间件提供事务（如 RocketMQ 半消息），一致性更强但耦合更高。</li>
<li>CDC：订阅 binlog 进行数据传播，零侵入、数据汇聚友好，但链路更长、幂等与乱序处理要求高。</li>
<li>最大努力通知：失败重试逐步达成一致，简单易落地，但短时不一致需业务容忍。</li>
</ul>
<p>经验法则：</p>
<ul>
<li>强约束核心链路（账务/库存）：优先 TCC；参与者少且可改造。</li>
<li>跨域系统协同、解耦：优先 Outbox 或 事务消息；吞吐高、落地快。</li>
<li>数据同步/物化视图：CDC。</li>
<li>小型/历史包袱重：最大努力通知 + 对账，逐步演进。</li>
</ul>
<hr>
<h2 id="3-XA-2PC-原理与示例">3. XA/2PC 原理与示例</h2>
<h3 id="原理">原理</h3>
<ul>
<li>事务管理器（TM）协调多个资源管理器（RM），两阶段提交：<code>prepare</code> → <code>commit/rollback</code>。</li>
<li>数据库或中间件需支持 XA 接口，跨资源参与同一全局事务。</li>
</ul>
<p><strong>XA接口详解：</strong><br>
XA接口是X/Open组织定义的分布式事务处理标准，定义了事务管理器（TM）和资源管理器（RM）之间的接口规范。</p>
<p>核心接口XAResource包含以下关键方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">XAResource</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">start</span><span class="params">(Xid xid, <span class="type">int</span> flags)</span>;     <span class="comment">// 开始事务分支</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">end</span><span class="params">(Xid xid, <span class="type">int</span> flags)</span>;       <span class="comment">// 结束事务分支  </span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">prepare</span><span class="params">(Xid xid)</span>;               <span class="comment">// 准备提交（第一阶段）</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">commit</span><span class="params">(Xid xid, <span class="type">boolean</span> onePhase)</span>; <span class="comment">// 提交事务（第二阶段）</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">rollback</span><span class="params">(Xid xid)</span>;             <span class="comment">// 回滚事务</span></span><br><span class="line">    Xid[] recover(<span class="type">int</span> flag);            <span class="comment">// 恢复未完成事务</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Spring对XA/2PC的支持：</strong><br>
Spring通过JtaTransactionManager提供对分布式事务的支持，需要配合第三方JTA实现（如Atomikos）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JtaConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JtaTransactionManager <span class="title function_">transactionManager</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JtaTransactionManager</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AtomikosDataSourceBean <span class="title function_">dataSource1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">AtomikosDataSourceBean</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomikosDataSourceBean</span>();</span><br><span class="line">        ds.setUniqueResourceName(<span class="string">&quot;dataSource1&quot;</span>);</span><br><span class="line">        ds.setXaDataSourceClassName(<span class="string">&quot;com.mysql.cj.jdbc.MysqlXADataSource&quot;</span>);</span><br><span class="line">        ds.setXaProperties(getXaProperties(<span class="string">&quot;db1&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> ds;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span>  </span><br><span class="line">    <span class="keyword">public</span> AtomikosDataSourceBean <span class="title function_">dataSource2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">AtomikosDataSourceBean</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomikosDataSourceBean</span>();</span><br><span class="line">        ds.setUniqueResourceName(<span class="string">&quot;dataSource2&quot;</span>);</span><br><span class="line">        ds.setXaDataSourceClassName(<span class="string">&quot;com.mysql.cj.jdbc.MysqlXADataSource&quot;</span>);</span><br><span class="line">        ds.setXaProperties(getXaProperties(<span class="string">&quot;db2&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> ds;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用分布式事务</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Transactional</span> <span class="comment">// Spring自动使用JTA事务管理器</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createOrder</span><span class="params">(Order order)</span> &#123;</span><br><span class="line">        <span class="comment">// 操作数据库1：创建订单</span></span><br><span class="line">        orderRepository.save(order);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 操作数据库2：扣减库存  </span></span><br><span class="line">        inventoryRepository.updateStock(order.getProductId(), order.getQuantity());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果任一操作失败，整个事务回滚</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="优缺点">优缺点</h3>
<ul>
<li>优点：语义直观、强一致性。</li>
<li>缺点：长事务与全局锁影响吞吐；单点协调影响可用性；微服务/云原生场景受限。</li>
</ul>
<h3 id="Spring-Boot-Atomikos-示例">Spring Boot + Atomikos 示例</h3>
<p>依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- pom.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jta-atomikos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>配置两个 XA 数据源：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DataSourceConfig.java</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceConfig</span> &#123;</span><br><span class="line">  <span class="meta">@Bean(name = &quot;ds1&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> DataSource <span class="title function_">ds1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">MysqlXADataSource</span> <span class="variable">xa</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MysqlXADataSource</span>();</span><br><span class="line">    xa.setUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/order_db?useSSL=false&quot;</span>);</span><br><span class="line">    xa.setUser(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">    xa.setPassword(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">    <span class="type">AtomikosDataSourceBean</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomikosDataSourceBean</span>();</span><br><span class="line">    ds.setXaDataSource(xa);</span><br><span class="line">    ds.setUniqueResourceName(<span class="string">&quot;orderDB&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> ds;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Bean(name = &quot;ds2&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> DataSource <span class="title function_">ds2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">MysqlXADataSource</span> <span class="variable">xa</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MysqlXADataSource</span>();</span><br><span class="line">    xa.setUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/inventory_db?useSSL=false&quot;</span>);</span><br><span class="line">    xa.setUser(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">    xa.setPassword(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">    <span class="type">AtomikosDataSourceBean</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomikosDataSourceBean</span>();</span><br><span class="line">    ds.setXaDataSource(xa);</span><br><span class="line">    ds.setUniqueResourceName(<span class="string">&quot;inventoryDB&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> ds;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>跨库事务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DualTxService.java</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DualTxService</span> &#123;</span><br><span class="line">  <span class="meta">@Autowired</span> JdbcTemplate orderJdbc;</span><br><span class="line">  <span class="meta">@Autowired</span> JdbcTemplate inventoryJdbc;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Transactional</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">placeOrder</span><span class="params">(String orderId, String sku, <span class="type">int</span> qty)</span> &#123;</span><br><span class="line">    orderJdbc.update(<span class="string">&quot;INSERT INTO orders(id, sku, qty, status) VALUES(?,?,?,?)&quot;</span>,</span><br><span class="line">                     orderId, sku, qty, <span class="string">&quot;PENDING&quot;</span>);</span><br><span class="line">    inventoryJdbc.update(<span class="string">&quot;UPDATE stock SET reserved = reserved + ? WHERE sku = ?&quot;</span>, qty, sku);</span><br><span class="line">    orderJdbc.update(<span class="string">&quot;UPDATE orders SET status = ? WHERE id = ?&quot;</span>, <span class="string">&quot;SUCC&quot;</span>, orderId);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意事项：XA 事务要避开热路径；谨慎使用死锁超时；生产上建议仅少量内部系统或过渡期使用。</p>
<hr>
<h2 id="4-TCC-原理与示例">4. TCC 原理与示例</h2>
<h3 id="原理-2">原理</h3>
<ul>
<li>将一个业务操作拆为三步：Try（预留/冻结资源）→ Confirm（确认执行）→ Cancel（取消释放）。</li>
<li>所有参与方需要实现 T/C 接口且保证幂等；状态机限制合法跃迁。</li>
</ul>
<h3 id="优缺点-2">优缺点</h3>
<ul>
<li>优点：显式补偿、资源预留、适合强约束链路。</li>
<li>缺点：侵入业务，需要为每个参与者实现接口与状态机；维护成本高。</li>
</ul>
<h3 id="表结构（示例）">表结构（示例）</h3>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 冻结记录表（库存/余额等）</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> tcc_freeze (</span><br><span class="line">  id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">  biz_key <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">UNIQUE</span>,</span><br><span class="line">  sku <span class="type">VARCHAR</span>(<span class="number">64</span>),</span><br><span class="line">  qty <span class="type">INT</span>,</span><br><span class="line">  status ENUM(<span class="string">&#x27;INIT&#x27;</span>,<span class="string">&#x27;TRY_OK&#x27;</span>,<span class="string">&#x27;CONFIRM_OK&#x27;</span>,<span class="string">&#x27;CANCEL_OK&#x27;</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">  expire_at DATETIME,</span><br><span class="line">  version <span class="type">INT</span> <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">  created_at DATETIME,</span><br><span class="line">  updated_at DATETIME</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h3 id="控制器与服务">控制器与服务</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// InventoryTccController.java</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/tcc/inventory&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryTccController</span> &#123;</span><br><span class="line">  <span class="meta">@Autowired</span> InventoryTccService service;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@PostMapping(&quot;/try&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> R <span class="title function_">tryReserve</span><span class="params">(<span class="meta">@RequestBody</span> TryReq req)</span> &#123;</span><br><span class="line">    service.tryReserve(req.getBizKey(), req.getSku(), req.getQty(), req.getExpireAt());</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@PostMapping(&quot;/confirm&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> R <span class="title function_">confirm</span><span class="params">(<span class="meta">@RequestBody</span> ConfirmReq req)</span> &#123;</span><br><span class="line">    service.confirm(req.getBizKey());</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@PostMapping(&quot;/cancel&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> R <span class="title function_">cancel</span><span class="params">(<span class="meta">@RequestBody</span> CancelReq req)</span> &#123;</span><br><span class="line">    service.cancel(req.getBizKey());</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// InventoryTccService.java</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InventoryTccService</span> &#123;</span><br><span class="line">  <span class="meta">@Autowired</span> JdbcTemplate jdbc;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">tryReserve</span><span class="params">(String bizKey, String sku, <span class="type">int</span> qty, LocalDateTime expireAt)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 幂等检查</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">cnt</span> <span class="operator">=</span> jdbc.queryForObject(<span class="string">&quot;SELECT COUNT(*) FROM tcc_freeze WHERE biz_key=?&quot;</span>, Integer.class, bizKey);</span><br><span class="line">    <span class="keyword">if</span> (cnt != <span class="literal">null</span> &amp;&amp; cnt &gt; <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 🔧 先检查并冻结库存</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">stockUpdated</span> <span class="operator">=</span> jdbc.update(</span><br><span class="line">        <span class="string">&quot;UPDATE stock SET available=available-?, frozen=frozen+? WHERE sku=? AND available&gt;=?&quot;</span>, </span><br><span class="line">        qty, qty, sku, qty);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (stockUpdated != <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InsufficientStockException</span>(<span class="string">&quot;库存不足或商品不存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 🔧 库存冻结成功后，插入冻结记录</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">recordInserted</span> <span class="operator">=</span> jdbc.update(</span><br><span class="line">        <span class="string">&quot;INSERT INTO tcc_freeze(biz_key, sku, qty, status, expire_at, created_at) VALUES(?,?,?,?,?,NOW())&quot;</span>,</span><br><span class="line">        bizKey, sku, qty, <span class="string">&quot;TRY_OK&quot;</span>, Timestamp.valueOf(expireAt));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (recordInserted != <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;冻结记录插入失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Transactional</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(String bizKey)</span> &#123;</span><br><span class="line">    <span class="comment">// 幂等与合法跃迁</span></span><br><span class="line">    Map&lt;String,Object&gt; row = jdbc.queryForMap(<span class="string">&quot;SELECT * FROM tcc_freeze WHERE biz_key=?&quot;</span>, bizKey);</span><br><span class="line">    <span class="type">String</span> <span class="variable">status</span> <span class="operator">=</span> (String) row.get(<span class="string">&quot;status&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;CONFIRM_OK&quot;</span>.equals(status)) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="string">&quot;TRY_OK&quot;</span>.equals(status)) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;非法状态&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">sku</span> <span class="operator">=</span> (String)row.get(<span class="string">&quot;sku&quot;</span>); <span class="type">int</span> <span class="variable">qty</span> <span class="operator">=</span> (<span class="type">int</span>)row.get(<span class="string">&quot;qty&quot;</span>);</span><br><span class="line">    jdbc.update(<span class="string">&quot;UPDATE stock SET available=available-?, frozen=frozen-? WHERE sku=?&quot;</span>, qty, qty, sku);</span><br><span class="line">    jdbc.update(<span class="string">&quot;UPDATE tcc_freeze SET status=&#x27;CONFIRM_OK&#x27;, updated_at=NOW() WHERE biz_key=?&quot;</span>, bizKey);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Transactional</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cancel</span><span class="params">(String bizKey)</span> &#123;</span><br><span class="line">    Map&lt;String,Object&gt; row = jdbc.queryForMap(<span class="string">&quot;SELECT * FROM tcc_freeze WHERE biz_key=?&quot;</span>, bizKey);</span><br><span class="line">    <span class="type">String</span> <span class="variable">status</span> <span class="operator">=</span> (String) row.get(<span class="string">&quot;status&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;CANCEL_OK&quot;</span>.equals(status)) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="string">&quot;TRY_OK&quot;</span>.equals(status)) <span class="keyword">return</span>; <span class="comment">// 已确认则按业务决定是否拒绝取消</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">sku</span> <span class="operator">=</span> (String)row.get(<span class="string">&quot;sku&quot;</span>); <span class="type">int</span> <span class="variable">qty</span> <span class="operator">=</span> (<span class="type">int</span>)row.get(<span class="string">&quot;qty&quot;</span>);</span><br><span class="line">    jdbc.update(<span class="string">&quot;UPDATE stock SET frozen=frozen-? WHERE sku=?&quot;</span>, qty, sku);</span><br><span class="line">    jdbc.update(<span class="string">&quot;UPDATE tcc_freeze SET status=&#x27;CANCEL_OK&#x27;, updated_at=NOW() WHERE biz_key=?&quot;</span>, bizKey);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="5-Saga-原理与示例">5. Saga 原理与示例</h2>
<h3 id="原理-3">原理</h3>
<ul>
<li>Orchestrator 编排：正向按步骤执行，任一步失败触发对应的反向补偿；记录流程状态。</li>
<li>Choreography 事件驱动：各服务通过事件触发后续步骤，失败事件触发补偿。</li>
</ul>
<h3 id="示例（Orchestrator-简化版）">示例（Orchestrator 简化版）</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SagaOrchestrator.java</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SagaOrchestrator</span> &#123;</span><br><span class="line">  <span class="meta">@Autowired</span> OrderService order;</span><br><span class="line">  <span class="meta">@Autowired</span> InventoryService inv;</span><br><span class="line">  <span class="meta">@Autowired</span> BalanceService bal;</span><br><span class="line">  <span class="meta">@Autowired</span> SagaRepository sagaRepo;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">placeOrderSaga</span><span class="params">(String orderId, String sku, <span class="type">int</span> qty, String userId)</span> &#123;</span><br><span class="line">    <span class="type">SagaContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SagaContext</span>(orderId);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      order.create(orderId, sku, qty);          <span class="comment">// Step1</span></span><br><span class="line">      ctx.addStep(<span class="string">&quot;ORDER_CREATE&quot;</span>);</span><br><span class="line"></span><br><span class="line">      inv.reserve(orderId, sku, qty);          <span class="comment">// Step2</span></span><br><span class="line">      ctx.addStep(<span class="string">&quot;INVENTORY_RESERVE&quot;</span>);</span><br><span class="line"></span><br><span class="line">      bal.freeze(orderId, userId, price(sku, qty)); <span class="comment">// Step3</span></span><br><span class="line">      ctx.addStep(<span class="string">&quot;BALANCE_FREEZE&quot;</span>);</span><br><span class="line"></span><br><span class="line">      order.markPaid(orderId);                  <span class="comment">// Step4</span></span><br><span class="line">      ctx.addStep(<span class="string">&quot;PAY_CONFIRM&quot;</span>);</span><br><span class="line"></span><br><span class="line">      sagaRepo.save(ctx.success());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      compensate(ctx); <span class="comment">// 逆序补偿</span></span><br><span class="line">      sagaRepo.save(ctx.fail(e.getMessage()));</span><br><span class="line">      <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">compensate</span><span class="params">(SagaContext ctx)</span> &#123;</span><br><span class="line">    List&lt;String&gt; steps = ctx.getSteps();</span><br><span class="line">    Collections.reverse(steps);</span><br><span class="line">    <span class="keyword">for</span> (String s : steps) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (s) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;BALANCE_FREEZE&quot;</span>: bal.unfreeze(ctx.getOrderId()); <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;INVENTORY_RESERVE&quot;</span>: inv.release(ctx.getOrderId()); <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;ORDER_CREATE&quot;</span>: order.close(ctx.getOrderId()); <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要点：</p>
<ul>
<li>每步正向/反向都需幂等；状态记录与非法跃迁保护；必要时熔断与人工介入。</li>
</ul>
<hr>
<h2 id="6-Outbox-原理与示例（本地事务-异步投递）">6. Outbox 原理与示例（本地事务 + 异步投递）</h2>
<h3 id="原理-4">原理</h3>
<ul>
<li>在同一本地事务内同时写业务表与消息表（outbox_message），提交成功后由异步投递器（Relay）将消息投递到 MQ；下游幂等消费。</li>
</ul>
<h3 id="表结构与索引">表结构与索引</h3>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> outbox_message (</span><br><span class="line">  id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">  biz_key <span class="type">VARCHAR</span>(<span class="number">64</span>),</span><br><span class="line">  topic <span class="type">VARCHAR</span>(<span class="number">64</span>),</span><br><span class="line">  payload JSON,</span><br><span class="line">  status ENUM(<span class="string">&#x27;PENDING&#x27;</span>,<span class="string">&#x27;DONE&#x27;</span>,<span class="string">&#x27;RETRY&#x27;</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">  retry <span class="type">INT</span> <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">  next_retry_at DATETIME,</span><br><span class="line">  created_at DATETIME,</span><br><span class="line">  shard_key <span class="type">VARCHAR</span>(<span class="number">64</span>),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY uk_biz_key (biz_key),</span><br><span class="line">  KEY idx_status_next (status, next_retry_at),</span><br><span class="line">  KEY idx_created_at (created_at)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h3 id="业务写入（同一事务）">业务写入（同一事务）</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// OrderService.java</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">  <span class="meta">@Autowired</span> JdbcTemplate jdbc;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Transactional</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">paySuccess</span><span class="params">(String orderId, BigDecimal amount)</span> &#123;</span><br><span class="line">    jdbc.update(<span class="string">&quot;UPDATE orders SET status=&#x27;PAID&#x27; WHERE id=?&quot;</span>, orderId);</span><br><span class="line">    jdbc.update(<span class="string">&quot;INSERT INTO outbox_message(biz_key, topic, payload, status, created_at) VALUES(?,?,?,?,NOW())&quot;</span>,</span><br><span class="line">      orderId, <span class="string">&quot;order.pay&quot;</span>, toJson(Map.of(<span class="string">&quot;orderId&quot;</span>, orderId, <span class="string">&quot;amount&quot;</span>, amount)), <span class="string">&quot;PENDING&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="投递器（Relay）">投递器（Relay）</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// OutboxRelayJob.java</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OutboxRelayJob</span> &#123;</span><br><span class="line">  <span class="meta">@Autowired</span> JdbcTemplate jdbc;</span><br><span class="line">  <span class="meta">@Autowired</span> MqProducer mq;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Scheduled(fixedDelay = 2000)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">relay</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Map&lt;String,Object&gt;&gt; rows = jdbc.queryForList(</span><br><span class="line">      <span class="string">&quot;SELECT * FROM outbox_message WHERE status=&#x27;PENDING&#x27; OR (status=&#x27;RETRY&#x27; AND next_retry_at&lt;=NOW()) LIMIT 200&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (Map&lt;String,Object&gt; r : rows) &#123;</span><br><span class="line">      <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> String.valueOf(r.get(<span class="string">&quot;id&quot;</span>)); <span class="type">String</span> <span class="variable">topic</span> <span class="operator">=</span> (String) r.get(<span class="string">&quot;topic&quot;</span>);</span><br><span class="line">      <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> r.get(<span class="string">&quot;payload&quot;</span>).toString(); <span class="type">String</span> <span class="variable">bizKey</span> <span class="operator">=</span> (String) r.get(<span class="string">&quot;biz_key&quot;</span>);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        mq.send(topic, payload, bizKey); <span class="comment">// 生产者幂等键</span></span><br><span class="line">        jdbc.update(<span class="string">&quot;UPDATE outbox_message SET status=&#x27;DONE&#x27; WHERE id=?&quot;</span>, id);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">retry</span> <span class="operator">=</span> (<span class="type">int</span>) r.get(<span class="string">&quot;retry&quot;</span>) + <span class="number">1</span>;</span><br><span class="line">        jdbc.update(<span class="string">&quot;UPDATE outbox_message SET status=&#x27;RETRY&#x27;, retry=?, next_retry_at=DATE_ADD(NOW(), INTERVAL ? SECOND) WHERE id=?&quot;</span>,</span><br><span class="line">          retry, Math.min(<span class="number">30</span> * retry, <span class="number">600</span>), id);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="消费端幂等">消费端幂等</h3>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> consume_record (</span><br><span class="line">  id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">  biz_key <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">UNIQUE</span>,</span><br><span class="line">  topic <span class="type">VARCHAR</span>(<span class="number">64</span>),</span><br><span class="line">  created_at DATETIME</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Consumer.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String topic, String bizKey, String payload)</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    jdbc.update(<span class="string">&quot;INSERT INTO consume_record(biz_key, topic, created_at) VALUES(?,?,NOW())&quot;</span>, bizKey, topic);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (DuplicateKeyException e) &#123; <span class="keyword">return</span>; &#125; <span class="comment">// 幂等拒绝</span></span><br><span class="line">  <span class="comment">// 正常处理</span></span><br><span class="line">  process(payload);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="7-事务消息-原理与示例（RocketMQ）">7. 事务消息 原理与示例（RocketMQ）</h2>
<h3 id="原理-5">原理</h3>
<ul>
<li>生产半消息 → 执行业务本地事务 → Broker 回查决定消息可见性；可实现端到端一致性。</li>
</ul>
<h3 id="示例">示例</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TxProducer.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TxProducer</span> &#123;</span><br><span class="line">  TransactionMQProducer producer;</span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">TxProducer</span><span class="params">()</span> &#123;</span><br><span class="line">    producer = <span class="keyword">new</span> <span class="title class_">TransactionMQProducer</span>(<span class="string">&quot;txGroup&quot;</span>);</span><br><span class="line">    producer.setNamesrvAddr(<span class="string">&quot;localhost:9876&quot;</span>);</span><br><span class="line">    producer.setTransactionListener(<span class="keyword">new</span> <span class="title class_">TransactionListener</span>() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> LocalTransactionState <span class="title function_">executeLocalTransaction</span><span class="params">(Message msg, Object arg)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// 本地事务：写订单、扣减余额等</span></span><br><span class="line">          doLocalTx(msg);</span><br><span class="line">          <span class="keyword">return</span> LocalTransactionState.COMMIT_MESSAGE;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          <span class="keyword">return</span> LocalTransactionState.ROLLBACK_MESSAGE;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> LocalTransactionState <span class="title function_">checkLocalTransaction</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> checkTxState(msg) ? LocalTransactionState.COMMIT_MESSAGE : LocalTransactionState.ROLLBACK_MESSAGE;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">send</span><span class="params">(String topic, String body)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    producer.start();</span><br><span class="line">    <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(topic, body.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">    producer.sendMessageInTransaction(msg, <span class="literal">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>消费者幂等同 Outbox 的消费履历表方式一致。</p>
<hr>
<h2 id="8-CDC-原理与示例（Debezium）">8. CDC 原理与示例（Debezium）</h2>
<h3 id="原理-6">原理</h3>
<ul>
<li>订阅数据库 binlog，将变更流式推送至 Kafka 等，下游消费并幂等处理。</li>
</ul>
<h3 id="Connector-配置（示例）">Connector 配置（示例）</h3>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mysql-orders-connector&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;config&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;connector.class&quot;</span><span class="punctuation">:</span> <span class="string">&quot;io.debezium.connector.mysql.MySqlConnector&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;database.hostname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mysql&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;database.port&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3306&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;database.user&quot;</span><span class="punctuation">:</span> <span class="string">&quot;debezium&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;database.password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dbz&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;database.server.id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;184054&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;database.server.name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dbserver1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;database.include.list&quot;</span><span class="punctuation">:</span> <span class="string">&quot;order_db&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;table.include.list&quot;</span><span class="punctuation">:</span> <span class="string">&quot;order_db.orders&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;include.schema.changes&quot;</span><span class="punctuation">:</span> <span class="string">&quot;false&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;snapshot.mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;initial&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>下游消费幂等：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CdcConsumer.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">consume</span><span class="params">(ChangeEvent evt)</span> &#123;</span><br><span class="line">  <span class="type">String</span> <span class="variable">bizKey</span> <span class="operator">=</span> evt.key();</span><br><span class="line">  <span class="keyword">try</span> &#123; jdbc.update(<span class="string">&quot;INSERT INTO consume_record(biz_key, topic, created_at) VALUES(?,?,NOW())&quot;</span>, bizKey, <span class="string">&quot;cdc&quot;</span>); &#125;</span><br><span class="line">  <span class="keyword">catch</span> (DuplicateKeyException e) &#123; <span class="keyword">return</span>; &#125;</span><br><span class="line">  applyChange(evt.payload()); <span class="comment">// 按版本或时间戳去重更新</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="9-最大努力通知与重试">9. 最大努力通知与重试</h2>
<h3 id="原理-7">原理</h3>
<ul>
<li>失败后通过有界重试与回补任务逐步达成一致；需要良好的幂等与对账。</li>
</ul>
<h3 id="示例-2">示例</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NotifyJob</span> &#123;</span><br><span class="line">  <span class="meta">@Autowired</span> JdbcTemplate jdbc; <span class="meta">@Autowired</span> HttpClient http;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Scheduled(fixedDelay = 5000)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">push</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Map&lt;String,Object&gt;&gt; list = jdbc.queryForList(<span class="string">&quot;SELECT * FROM notify WHERE status=&#x27;PENDING&#x27; OR (status=&#x27;RETRY&#x27; AND next_retry_at&lt;=NOW()) LIMIT 100&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (Map&lt;String,Object&gt; r : list) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        http.post((String)r.get(<span class="string">&quot;url&quot;</span>), r.get(<span class="string">&quot;body&quot;</span>).toString());</span><br><span class="line">        jdbc.update(<span class="string">&quot;UPDATE notify SET status=&#x27;DONE&#x27; WHERE id=?&quot;</span>, r.get(<span class="string">&quot;id&quot;</span>));</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">retry</span> <span class="operator">=</span> (<span class="type">int</span>)r.get(<span class="string">&quot;retry&quot;</span>) + <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">backoff</span> <span class="operator">=</span> Math.min(<span class="number">60</span> * retry, <span class="number">3600</span>);</span><br><span class="line">        jdbc.update(<span class="string">&quot;UPDATE notify SET status=&#x27;RETRY&#x27;, retry=?, next_retry_at=DATE_ADD(NOW(), INTERVAL ? SECOND) WHERE id=?&quot;</span>,</span><br><span class="line">          retry, backoff, r.get(<span class="string">&quot;id&quot;</span>));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="10-幂等与去重（端到端）">10. 幂等与去重（端到端）</h2>
<ul>
<li>幂等键：<code>requestId</code> 或 <code>biz_key</code>，需全链路传递；生产者侧去重，消费者侧唯一约束。</li>
<li>读-校验-写前校验：重复请求返回已处理状态。</li>
</ul>
<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> idempotent_record (</span><br><span class="line">  id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">  biz_key <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">UNIQUE</span>,</span><br><span class="line">  <span class="keyword">result</span> <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">  created_at DATETIME</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">handleOnce</span><span class="params">(String bizKey)</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123; jdbc.update(<span class="string">&quot;INSERT INTO idempotent_record(biz_key, result, created_at) VALUES(?,?,NOW())&quot;</span>, bizKey, <span class="string">&quot;INIT&quot;</span>); &#125;</span><br><span class="line">  <span class="keyword">catch</span> (DuplicateKeyException e) &#123; <span class="keyword">return</span> <span class="string">&quot;ALREADY&quot;</span>; &#125;</span><br><span class="line">  <span class="comment">// 真正处理</span></span><br><span class="line">  doBusiness();</span><br><span class="line">  jdbc.update(<span class="string">&quot;UPDATE idempotent_record SET result=&#x27;SUCC&#x27; WHERE biz_key=?&quot;</span>, bizKey);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;SUCC&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="11-一致性等级与隔离策略">11. 一致性等级与隔离策略</h2>
<ul>
<li>强一致（TCC、XA）：适合核心资金/库存；需控制并发与锁粒度。</li>
<li>最终一致（Outbox、CDC、事务消息、最大努力）：适合跨域协同；窗口可控、吞吐高。</li>
</ul>
<hr>
<h2 id="12-监控与对账">12. 监控与对账</h2>
<ul>
<li>监控：生产/消费时延、重试/死信量、回查频率、投递成功率、幂等拒绝率。</li>
<li>对账：每日校对“业务状态 vs 消息状态 vs 消费履历”，自动修复差异并落地审计。</li>
</ul>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReconcileJob</span> &#123;</span><br><span class="line">  <span class="meta">@Autowired</span> JdbcTemplate jdbc;</span><br><span class="line">  <span class="meta">@Scheduled(cron = &quot;0 0 2 * * *&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reconcile</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Map&lt;String,Object&gt;&gt; diff = jdbc.queryForList(</span><br><span class="line">      <span class="string">&quot;SELECT o.id FROM orders o LEFT JOIN consume_record c ON o.id=c.biz_key WHERE o.status=&#x27;PAID&#x27; AND c.id IS NULL&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (Map&lt;String,Object&gt; r : diff) &#123;</span><br><span class="line">      <span class="comment">// 发现差异 → 重投或入人工队列</span></span><br><span class="line">      reDispatch(String.valueOf(r.get(<span class="string">&quot;id&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="13-选型速查（经验法则）">13. 选型速查（经验法则）</h2>
<ul>
<li>账务/库存强约束：TCC 优先；参与方少。</li>
<li>跨系统协同与解耦：Outbox 或 事务消息；高吞吐。</li>
<li>数据汇聚与物化视图：CDC。</li>
<li>历史包袱重：最大努力 + 对账；渐进演进。</li>
<li>谨慎使用 XA 作为常态路径，仅限少量内部系统或过渡期。</li>
</ul>
<hr>
<h2 id="14-常见坑与规避">14. 常见坑与规避</h2>
<ul>
<li>把分布式锁当事务：锁只能互斥；需叠加幂等/状态机与补偿。</li>
<li>无幂等键：重复到达导致错乱；消费者唯一约束/去重表必备。</li>
<li>死信不治理：死信队列必须值守与自动回补。</li>
<li>超时与回查风暴：限流与熔断；灾难重试与正常流量隔离。</li>
<li>无对账：没有对账就没有最终一致性保证。</li>
</ul>
<hr>
<h2 id="15-总结">15. 总结</h2>
<ul>
<li>没有银弹：按一致性目标、链路复杂度与团队能力选型。</li>
<li>优先“本地事务短小 + 异步解耦”（Outbox/CDC）；强约束采用 TCC；Saga 解决长链路最终一致。</li>
<li>以幂等、状态机、监控/对账为底座；故障即补偿，演练即可靠。</li>
</ul>
<hr>
<h2 id="附录：实现原理深讲（XA-TCC-Saga-Outbox-事务消息-CDC-最大努力）">附录：实现原理深讲（XA / TCC / Saga / Outbox / 事务消息 / CDC / 最大努力）</h2>
<h3 id="A1-XA-2PC-深讲">A1. XA/2PC 深讲</h3>
<ul>
<li>关键组件：
<ul>
<li><code>TM</code>（Transaction Manager）：维护全局事务状态（XID），协调各 <code>RM</code>。</li>
<li><code>RM</code>（Resource Manager）：数据库/消息等，提供 <code>XAResource</code> 接口（<code>start</code>/<code>end</code>/<code>prepare</code>/<code>commit</code>/<code>rollback</code>）。</li>
<li><code>XID</code>：全局事务 ID，用于标识分支事务。</li>
</ul>
</li>
<li>两阶段时序：
<ol>
<li>客户端开始全局事务（<code>begin</code>），TM 生成 <code>XID</code>。</li>
<li>子服务执行业务，TM 将对应数据源 <code>enlist</code> 为分支事务（<code>XA start</code>）。</li>
<li>全部分支结束后，TM 发起 <code>prepare</code>，RM 写入预提交日志并锁定资源。</li>
<li>若全部 <code>prepare=OK</code>，TM 发起 <code>commit</code>；任一失败则 <code>rollback</code>。</li>
</ol>
</li>
<li>失败与恢复：
<ul>
<li>TM/RM 宕机：通过预提交日志与恢复管理器回放；存在启发式（Heuristic）提交/回滚风险。</li>
<li>网络分区：需要超时与回查；长时间 <code>prepared</code> 会持锁影响吞吐。</li>
</ul>
</li>
<li>并发与锁：
<ul>
<li>典型基于两阶段锁（2PL），在 <code>prepare</code> 后资源保留直至 <code>commit</code>。</li>
<li>需严格控制事务粒度与超时时间，避免热点长锁。</li>
</ul>
</li>
<li>参数建议：
<ul>
<li>事务超时、最大 <code>prepared</code> 保留时间、<code>RM</code> 重试策略、回查频率。</li>
</ul>
</li>
</ul>
<h3 id="A2-TCC-深讲">A2. TCC 深讲</h3>
<ul>
<li>语义设计：
<ul>
<li><code>Try</code>：校验与预留（冻结）资源，不改变最终业务状态；可设置过期时间。</li>
<li><code>Confirm</code>：确认执行（扣减/落账），最终生效；必须幂等。</li>
<li><code>Cancel</code>：释放资源，回到初始状态；必须幂等。</li>
</ul>
</li>
<li>状态机（示例）：<code>INIT → TRY_OK → CONFIRM_OK / CANCEL_OK</code>，禁止非法跃迁（如 <code>CANCEL_OK → CONFIRM_OK</code>）。</li>
<li>幂等与 Barrier 模式：
<ul>
<li>为每个阶段设计幂等键（<code>biz_key + phase</code>），唯一约束保障“至多一次”。</li>
<li><code>Barrier</code> 表（示例）：<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> tcc_barrier (</span><br><span class="line">  id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">  biz_key <span class="type">VARCHAR</span>(<span class="number">64</span>),</span><br><span class="line">  phase ENUM(<span class="string">&#x27;TRY&#x27;</span>,<span class="string">&#x27;CONFIRM&#x27;</span>,<span class="string">&#x27;CANCEL&#x27;</span>),</span><br><span class="line">  created_at DATETIME,</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY uk_biz_phase (biz_key, phase)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
</li>
<li>处理逻辑：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">barrierHandle</span><span class="params">(String bizKey, String phase, Runnable action)</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    jdbc.update(<span class="string">&quot;INSERT INTO tcc_barrier(biz_key, phase, created_at) VALUES(?,?,NOW())&quot;</span>, bizKey, phase);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (DuplicateKeyException e) &#123; <span class="keyword">return</span>; &#125; <span class="comment">// 已处理 → 幂等返回</span></span><br><span class="line">  action.run(); <span class="comment">// 执行该阶段具体逻辑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>并发控制：
<ul>
<li><code>Try</code> 阶段使用行级锁或乐观版本控制；<code>Confirm/Cancel</code> 保证对同一 <code>biz_key</code> 的操作串行化（唯一约束可避免并发重复）。</li>
</ul>
</li>
<li>超时与回滚：
<ul>
<li>定时扫描 <code>expire_at</code> 自动 <code>Cancel</code>；对锁/冻结占用进行释放。</li>
</ul>
</li>
</ul>
<h3 id="A3-Saga-深讲">A3. Saga 深讲</h3>
<ul>
<li>Orchestrator vs Choreography：
<ul>
<li>Orchestrator 维护集中式流程图与状态表；易观察、便于注入熔断与人工节点。</li>
<li>Choreography 通过事件触发链式反应；耦合低，但可观测性与补偿编排复杂。</li>
</ul>
</li>
<li>时序与日志：
<ul>
<li><code>saga_log</code> 记录每步执行/补偿状态，含 <code>step</code>、<code>status</code>、<code>payload</code>、<code>error</code>；可断点续跑。</li>
</ul>
</li>
<li>失败补偿策略：
<ul>
<li>逆序补偿（<code>SUCC</code> 步骤按逆序执行对应 <code>COMP</code>）；补偿幂等。</li>
<li>检测补偿死循环与异常风暴，必要时熔断并转入人工。</li>
</ul>
</li>
<li>一致性与隔离：
<ul>
<li>基于业务可接受的最终一致；对于不可补偿的步骤需谨慎设计（例如副作用写外部系统时先写 <code>Outbox</code> 再发事件）。</li>
</ul>
</li>
</ul>
<h3 id="A4-Outbox-深讲">A4. Outbox 深讲</h3>
<ul>
<li>写入与提交：
<ul>
<li>同一事务写业务表与 <code>outbox_message</code>，保证“业务状态与消息持久化”原子性。</li>
<li>投递与提交解耦，通过轮询与有界重试保证“至少一次投递”。</li>
</ul>
</li>
<li>投递器策略：
<ul>
<li>批量拉取、指数退避、分片（<code>shard_key</code>）均衡、并发通道隔离热点。</li>
</ul>
</li>
<li>生产者幂等：
<ul>
<li><code>biz_key</code> 作为去重键；Kafka 可利用幂等生产（<code>enable.idempotence=true</code>）。</li>
</ul>
</li>
<li>消费者幂等：
<ul>
<li>唯一约束表记录消费履历；重复到达直接 ACK。</li>
</ul>
</li>
<li>归档与对账：
<ul>
<li><code>DONE</code> 数据按保留期归档；每日校对业务状态与消息状态差异，自动修复或入人工队列。</li>
</ul>
</li>
</ul>
<h3 id="A5-事务消息（RocketMQ）深讲">A5. 事务消息（RocketMQ）深讲</h3>
<ul>
<li>半消息协议：
<ol>
<li>发送半消息（不可见）。</li>
<li>执行本地事务（成功 → <code>COMMIT</code>；失败 → <code>ROLLBACK</code>）。</li>
<li>Broker 定期回查不确定状态消息，生产者返回事务状态。</li>
</ol>
</li>
<li>边界条件与建议：
<ul>
<li>设计合理的回查频率与上限；生产者侧幂等键；本地事务要可回查（如查询订单状态）。</li>
<li>异常场景下需要人工对账与补偿通道。</li>
</ul>
</li>
</ul>
<h3 id="A6-CDC-深讲">A6. CDC 深讲</h3>
<ul>
<li>快照与增量：
<ul>
<li>初始快照读取全量 → 增量订阅 binlog（<code>INSERT/UPDATE/DELETE</code> 事件）。</li>
</ul>
</li>
<li>事件结构与边界：
<ul>
<li>事件包含 <code>source</code>、<code>op</code>、<code>before/after</code>；跨分片与主从切换需注意 <code>server.id</code> 与位点。</li>
</ul>
</li>
<li>有序性与乱序：
<ul>
<li>按主键分区消费；基于版本号/时间戳做幂等更新；乱序与重复要容忍。</li>
</ul>
</li>
<li>Schema 演进：
<ul>
<li>兼容字段变更；为下游设计向后兼容的 Avro/JSON Schema；DDL 变更要审慎。</li>
</ul>
</li>
<li>延迟与监控：
<ul>
<li>监控 <code>source lag</code>、重放量、失败比；必要时限流与背压。</li>
</ul>
</li>
</ul>
<h3 id="A7-最大努力通知-深讲">A7. 最大努力通知 深讲</h3>
<ul>
<li>设计原则：
<ul>
<li>保持简单与可控：有界重试、抖动、优先级队列隔离灾难重试与正常流量。</li>
</ul>
</li>
<li>死信与人工：
<ul>
<li>达到最大重试次数入死信队列；提供人工处理与回补 SOP。</li>
</ul>
</li>
<li>幂等：
<ul>
<li>通知体包含幂等键；服务端以唯一约束/版本号保证重复到达安全。</li>
</ul>
</li>
</ul>
<h3 id="A8-通用工程-Checklist（执行前后）">A8. 通用工程 Checklist（执行前后）</h3>
<ul>
<li>前：幂等键全链路传递；状态机与非法跃迁保护；监控与告警项齐备；对账任务到位。</li>
<li>中：有界重试与抖动；限流与熔断；死信治理；隔离灾难流量。</li>
<li>后：日报/周报对账；差异自动修复与审计；容量与归档策略执行。</li>
</ul>
<hr>
<h2 id="16-实现细节（语言描述版）">16. 实现细节（语言描述版）</h2>
<p>以下用纯“语言描述”方式，给出各方案在一次典型业务请求中的时序、失败场景与处理原则，帮助你在无代码的情况下把握实现要点。</p>
<h3 id="16-1-XA-两阶段提交（一次请求的语言时序）">16.1 XA / 两阶段提交（一次请求的语言时序）</h3>
<ul>
<li>开始：业务入口开启一个全局事务，事务管理器生成全局事务 ID，并把参与的数据库连接登记为分支事务。</li>
<li>正常执行：每个分支在本地执行增删改查，达到“准备提交”的状态后，向事务管理器声明“我可以提交了”。</li>
<li>阶段一（准备）：事务管理器向所有分支发出“准备”指令，资源管理器把变更写入预提交日志、锁住涉及的行或页，并返回“准备成功/失败”。</li>
<li>阶段二（提交/回滚）：若所有分支均“准备成功”，事务管理器向所有分支下达“提交”；任何一个分支“准备失败”，则向所有分支下达“回滚”。</li>
<li>宕机与恢复：若在阶段二发生故障，资源管理器会在重启后根据预提交日志进行提交或回滚；事务管理器会对处于“不确定状态”的事务进行回查。</li>
<li>处理原则：
<ul>
<li>超时与回查必须配置，否则长时间的“准备态”会持锁影响吞吐。</li>
<li>避免把热点写入路径长期置于 XA 事务中；仅用于少量内部、强一致的场景或过渡期。</li>
</ul>
</li>
</ul>
<h3 id="16-2-TCC（Try-Confirm-Cancel）">16.2 TCC（Try-Confirm-Cancel）</h3>
<ul>
<li>开始：业务入口为该请求生成一个唯一业务键（例如订单号），所有参与方在后续阶段用它做幂等。</li>
<li>Try 阶段：各参与方校验可用资源，并在本地记录一条“冻结记录”（包含数量、过期时间、状态），同时把实际资源标记为“冻结+N”。</li>
<li>Confirm 阶段：当整体业务判定成功，参与方将“冻结记录”状态置为“已确认”，把冻结资源扣减到“已用”，对应可用数量减少。</li>
<li>Cancel 阶段：当整体业务判定失败或超时，参与方把“冻结记录”状态置为“已取消”，把冻结的资源释放回可用。</li>
<li>并发与幂等：同一业务键的 Try/Confirm/Cancel 必须可重放且无副作用；通过唯一约束或 Barrier 表拦截重复阶段。</li>
<li>处理原则：
<ul>
<li>Try 不改变最终状态，只做占位；Confirm/Cancel 必须是幂等且互斥的合法跃迁。</li>
<li>为冻结记录设置过期时间，并用定时任务自动执行 Cancel，避免资源长期占用。</li>
</ul>
</li>
</ul>
<h3 id="16-3-Saga（编排与补偿）">16.3 Saga（编排与补偿）</h3>
<ul>
<li>开始：编排器接到请求后，把业务拆成多个步骤（如“建单→预留库存→冻结余额→确认支付”），并为每步定义对应的补偿操作（如“关单→释放库存→解冻余额”）。</li>
<li>正向执行：从第一步开始依次执行，每步成功后把状态写入“Saga 日志”；继续到下一步。</li>
<li>失败触发：一旦某步失败，编排器根据“已成功的步骤列表”按逆序执行补偿操作，并记录补偿结果。</li>
<li>恢复与重跑：编排器或任务重启后，可根据“Saga 日志”恢复上下文并继续正向或补偿；必要时进入人工队列。</li>
<li>处理原则：
<ul>
<li>每个正向/补偿操作都必须幂等；对不可补偿的步骤要前置本地持久化（如 Outbox）再投递事件。</li>
<li>控制补偿风暴：设置最大补偿次数与熔断策略，失败即转人工。</li>
</ul>
</li>
</ul>
<h3 id="16-4-Outbox（本地事务-异步投递）">16.4 Outbox（本地事务 + 异步投递）</h3>
<ul>
<li>开始：业务在同一个本地事务中既更新业务表，也写入一条消息到 Outbox 表（包含主题、载荷、业务键、状态）。</li>
<li>提交：事务成功提交后，消息处于“待投递”状态；如果事务失败，消息不会写入（从根源保证“业务未成功就不会发消息”）。</li>
<li>投递：后台投递器按一定频率扫描“待投递/待重试”的消息，调用 MQ 发送；成功则标记“已完成”，失败则更新“重试次数与下次投递时间”。</li>
<li>消费：下游消费者用“业务键唯一约束”记录消费履历；如果已消费，直接返回；否则执行业务并插入履历。</li>
<li>对账与归档：定时比对“业务状态 vs 消息状态 vs 消费履历”，发现差异重投或人工处理；完成的消息按保留期归档。</li>
<li>处理原则：
<ul>
<li>生产侧与消费侧都必须有幂等键与唯一约束；投递器采用指数退避与分片，避免热点与雪崩。</li>
<li>把 Outbox 放在“短事务”里，避免锁时间过长；对死信队列进行治理。</li>
</ul>
</li>
</ul>
<h3 id="16-5-事务消息（以-RocketMQ-为例）">16.5 事务消息（以 RocketMQ 为例）</h3>
<ul>
<li>开始：生产者先发送一条“半消息”，该消息不可见于消费者。</li>
<li>本地事务：生产者执行业务本地事务（如落订单、扣余额）；成功后向 Broker 返回“提交”，失败返回“回滚”。</li>
<li>回查：当生产者返回状态不明确或长时间未回应时，Broker 会对该消息触发事务回查；生产者依据本地事务结果返回最终状态。</li>
<li>可见与消费：Broker 将“提交成功”的消息投递给消费者；消费者按幂等规则处理并记录履历。</li>
<li>处理原则：
<ul>
<li>生产者需实现可靠的事务状态查询接口，保证回查能得到确定结果。</li>
<li>配置合理的回查频率与上限，避免回查风暴；消费者幂等与对账必不可少。</li>
</ul>
</li>
</ul>
<h3 id="16-6-CDC（变更数据捕获）">16.6 CDC（变更数据捕获）</h3>
<ul>
<li>初始阶段：连接器对目标库进行一次“快照”，读取表的初始全量数据并输出到消息流或主题。</li>
<li>增量阶段：连接器持续订阅数据库 binlog，将后续的增删改事件按主键或分区有序推送到下游。</li>
<li>下游应用：消费者读取事件，根据主键/版本号进行幂等更新，构建物化视图或触发业务联动。</li>
<li>监控与演进：监控延迟与重放速率；针对表结构变更做兼容的 schema 管理与灰度。</li>
<li>处理原则：
<ul>
<li>保证事件按主键有序消费；对乱序与重复要容忍并以版本号/时间戳做幂等覆盖。</li>
<li>谨慎处理 DDL 与分片/主从切换，确保位点一致与恢复路径明确。</li>
</ul>
</li>
</ul>
<h3 id="16-7-最大努力通知">16.7 最大努力通知</h3>
<ul>
<li>推送：一个定时任务或事件触发器向下游服务（HTTP/MQ）发送通知，携带幂等键与业务载荷。</li>
<li>失败重试：如果响应失败或超时，记录重试次数与下次执行时间，按指数退避继续尝试。</li>
<li>死信与人工：达到最大重试次数后，推送到死信队列，交由人工或专用回补任务处理。</li>
<li>处理原则：
<ul>
<li>发送方与接收方都必须具备幂等与唯一约束；把灾难重试与正常流量隔离在不同队列/线程池。</li>
<li>以对账与人工 SOP 兜底：进入死信后可人工补偿或改派。</li>
</ul>
</li>
</ul>
<h3 id="16-8-端到端幂等（如何在语言层面落地）">16.8 端到端幂等（如何在语言层面落地）</h3>
<ul>
<li>幂等键设计：为每个业务请求分配不可重复的业务键（订单号、流水号）；生产者、传输层、消费者全链路透传。</li>
<li>生产侧：把业务键作为消息去重键，失败可重试但绝不产生新的业务键。</li>
<li>消费侧：以“唯一约束表或去重表”记录已处理的业务键；重复到达直接返回。</li>
<li>接口语义：所有分布式入口都以“读→写前校验→写”的方式实现一次性处理；返回值区分“已处理/新处理”。</li>
</ul>
<h3 id="16-9-运维与应急（语言清单）">16.9 运维与应急（语言清单）</h3>
<ul>
<li>监控面板：生产/消费时延、重试次数、死信量、回查频率、投递成功率、幂等拒绝率、CDC lag。</li>
<li>日志与审计：Outbox 状态流转、事务消息回查结果、Saga 正向/补偿步骤、TCC 阶段状态变更、CDC 位点。</li>
<li>对账与回补：每日对账任务比对三方状态差异；自动重投、转人工队列或出具审计报告。</li>
<li>灾难演练：补偿风暴限流、熔断策略验证、死信治理流程演练；确保应急 SOP 可执行。</li>
</ul>
<hr>
<h2 id="17-架构图与数据流详解">17. 架构图与数据流详解</h2>
<h3 id="17-1-XA-2PC-架构图描述">17.1 XA/2PC 架构图描述</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[客户端] → [事务管理器TM] → [资源管理器RM1(订单DB)]</span><br><span class="line">                ↓              [资源管理器RM2(库存DB)]</span><br><span class="line">            [全局事务日志]      [资源管理器RM3(账户DB)]</span><br><span class="line"></span><br><span class="line">时序流程：</span><br><span class="line">1. 客户端 → TM：开启全局事务，获得XID</span><br><span class="line">2. TM → RM1/2/3：注册分支事务，执行业务SQL</span><br><span class="line">3. TM → RM1/2/3：发送prepare指令</span><br><span class="line">4. RM1/2/3 → TM：返回prepared状态</span><br><span class="line">5. TM → RM1/2/3：发送commit/rollback指令</span><br><span class="line">6. RM1/2/3 → TM：返回完成状态</span><br></pre></td></tr></table></figure>
<p><strong>关键组件详解：</strong></p>
<ul>
<li><strong>事务管理器（TM）</strong>：维护全局事务状态表，协调各RM的两阶段提交</li>
<li><strong>资源管理器（RM）</strong>：数据库/MQ等，实现XAResource接口</li>
<li><strong>全局事务日志</strong>：记录事务状态变迁，用于故障恢复</li>
<li><strong>XID（事务标识）</strong>：全局唯一，包含格式标识符、全局事务ID、分支限定符</li>
</ul>
<h3 id="17-2-TCC-架构图描述">17.2 TCC 架构图描述</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[业务入口] → [TCC协调器] → [参与者A-库存服务]</span><br><span class="line">                ↓              [参与者B-账户服务]</span><br><span class="line">            [TCC事务日志]      [参与者C-订单服务]</span><br><span class="line"></span><br><span class="line">每个参与者内部：</span><br><span class="line">[Try接口] → [业务资源冻结表] → [Confirm接口] → [业务主表更新]</span><br><span class="line">              ↓                    ↓</span><br><span class="line">          [Cancel接口] ← [资源释放] ← [状态机校验]</span><br></pre></td></tr></table></figure>
<p><strong>状态机设计：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INIT → TRY_OK → CONFIRM_OK (成功路径)</span><br><span class="line">         ↓</span><br><span class="line">    CANCEL_OK (失败路径)</span><br></pre></td></tr></table></figure>
<p><strong>核心表结构：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- TCC事务主表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> tcc_transaction (</span><br><span class="line">  id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">  tx_id <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">UNIQUE</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">  status ENUM(<span class="string">&#x27;INIT&#x27;</span>,<span class="string">&#x27;TRYING&#x27;</span>,<span class="string">&#x27;CONFIRMING&#x27;</span>,<span class="string">&#x27;CANCELING&#x27;</span>,<span class="string">&#x27;CONFIRMED&#x27;</span>,<span class="string">&#x27;CANCELED&#x27;</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">  participants JSON, <span class="comment">-- 参与者列表</span></span><br><span class="line">  created_at DATETIME,</span><br><span class="line">  updated_at DATETIME,</span><br><span class="line">  expire_at DATETIME,</span><br><span class="line">  INDEX idx_status_expire (status, expire_at)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- TCC参与者表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> tcc_participant (</span><br><span class="line">  id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">  tx_id <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">  participant_id <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">  try_url <span class="type">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">  confirm_url <span class="type">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">  cancel_url <span class="type">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">  status ENUM(<span class="string">&#x27;INIT&#x27;</span>,<span class="string">&#x27;TRY_OK&#x27;</span>,<span class="string">&#x27;CONFIRM_OK&#x27;</span>,<span class="string">&#x27;CANCEL_OK&#x27;</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">  retry_count <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY uk_tx_participant (tx_id, participant_id)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h3 id="17-3-Saga-架构图描述">17.3 Saga 架构图描述</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Saga编排器] → [步骤1-创建订单] → [步骤2-预留库存] → [步骤3-冻结余额]</span><br><span class="line">     ↓              ↓                  ↓                  ↓</span><br><span class="line">[Saga状态机] → [补偿1-关闭订单] ← [补偿2-释放库存] ← [补偿3-解冻余额]</span><br><span class="line">     ↓</span><br><span class="line">[Saga执行日志]</span><br></pre></td></tr></table></figure>
<p><strong>Saga状态机：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">STARTED → STEP1_OK → STEP2_OK → STEP3_OK → COMPLETED</span><br><span class="line">            ↓          ↓          ↓</span><br><span class="line">        COMP1_OK ← COMP2_OK ← COMP3_OK ← COMPENSATING</span><br><span class="line">            ↓</span><br><span class="line">        COMPENSATED</span><br></pre></td></tr></table></figure>
<p><strong>Saga执行表：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> saga_execution (</span><br><span class="line">  id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">  saga_id <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">UNIQUE</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">  saga_type <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">  status ENUM(<span class="string">&#x27;STARTED&#x27;</span>,<span class="string">&#x27;RUNNING&#x27;</span>,<span class="string">&#x27;COMPLETED&#x27;</span>,<span class="string">&#x27;COMPENSATING&#x27;</span>,<span class="string">&#x27;COMPENSATED&#x27;</span>,<span class="string">&#x27;FAILED&#x27;</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">  current_step <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">  total_steps <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">  context JSON, <span class="comment">-- 执行上下文</span></span><br><span class="line">  created_at DATETIME,</span><br><span class="line">  updated_at DATETIME</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE TABLE</span> saga_step_log (</span><br><span class="line">  id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">  saga_id <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">  step_index <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">  step_name <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">  step_type ENUM(<span class="string">&#x27;FORWARD&#x27;</span>,<span class="string">&#x27;COMPENSATE&#x27;</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">  status ENUM(<span class="string">&#x27;PENDING&#x27;</span>,<span class="string">&#x27;SUCCESS&#x27;</span>,<span class="string">&#x27;FAILED&#x27;</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">  request_data JSON,</span><br><span class="line">  response_data JSON,</span><br><span class="line">  error_msg TEXT,</span><br><span class="line">  executed_at DATETIME,</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY uk_saga_step (saga_id, step_index, step_type)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h3 id="17-4-Outbox-架构图描述">17.4 Outbox 架构图描述</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[业务服务] → [本地数据库] → [Outbox表]</span><br><span class="line">                ↓              ↓</span><br><span class="line">            [业务表]    [投递器Relay] → [消息队列MQ] → [下游消费者]</span><br><span class="line">                              ↓                          ↓</span><br><span class="line">                        [投递状态更新]              [消费履历表]</span><br></pre></td></tr></table></figure>
<p><strong>数据流详解：</strong></p>
<ol>
<li><strong>写入阶段</strong>：同一事务内更新业务表+Outbox表</li>
<li><strong>投递阶段</strong>：Relay扫描PENDING消息，投递到MQ</li>
<li><strong>消费阶段</strong>：消费者幂等处理，记录消费履历</li>
<li><strong>对账阶段</strong>：比对业务状态vs消息状态vs消费履历</li>
</ol>
<p><strong>完整表结构：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 业务表（示例：订单表）</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders (</span><br><span class="line">  id <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">  user_id <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">  amount <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">  status ENUM(<span class="string">&#x27;PENDING&#x27;</span>,<span class="string">&#x27;PAID&#x27;</span>,<span class="string">&#x27;SHIPPED&#x27;</span>,<span class="string">&#x27;COMPLETED&#x27;</span>,<span class="string">&#x27;CANCELED&#x27;</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">  created_at DATETIME,</span><br><span class="line">  updated_at DATETIME</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Outbox消息表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> outbox_message (</span><br><span class="line">  id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">  biz_key <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">  topic <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">  payload JSON <span class="keyword">NOT NULL</span>,</span><br><span class="line">  status ENUM(<span class="string">&#x27;PENDING&#x27;</span>,<span class="string">&#x27;SENT&#x27;</span>,<span class="string">&#x27;FAILED&#x27;</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">  retry_count <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">  max_retry <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">3</span>,</span><br><span class="line">  next_retry_at DATETIME,</span><br><span class="line">  created_at DATETIME,</span><br><span class="line">  updated_at DATETIME,</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY uk_biz_key (biz_key),</span><br><span class="line">  INDEX idx_status_retry (status, next_retry_at)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 消费履历表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> consume_record (</span><br><span class="line">  id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT,</span><br><span class="line">  biz_key <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">UNIQUE</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">  topic <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">  consumer_group <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">  payload JSON,</span><br><span class="line">  consumed_at DATETIME,</span><br><span class="line">  INDEX idx_topic_group (topic, consumer_group)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h3 id="17-5-事务消息架构图描述">17.5 事务消息架构图描述</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[生产者] → [半消息] → [RocketMQ Broker] → [消费者]</span><br><span class="line">    ↓          ↓            ↓              ↓</span><br><span class="line">[本地事务] → [事务状态] → [回查机制] → [消费履历]</span><br></pre></td></tr></table></figure>
<p><strong>RocketMQ事务消息流程：</strong></p>
<ol>
<li><strong>发送半消息</strong>：消息对消费者不可见</li>
<li><strong>执行本地事务</strong>：更新业务数据</li>
<li><strong>提交/回滚消息</strong>：根据本地事务结果决定</li>
<li><strong>回查机制</strong>：Broker定期回查未决事务状态</li>
<li><strong>消费确认</strong>：消费者幂等处理并确认</li>
</ol>
<p><strong>生产者配置示例：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RocketMQTransactionConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TransactionMQProducer <span class="title function_">transactionProducer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">TransactionMQProducer</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransactionMQProducer</span>(<span class="string">&quot;tx_producer_group&quot;</span>);</span><br><span class="line">        producer.setNamesrvAddr(<span class="string">&quot;localhost:9876&quot;</span>);</span><br><span class="line">        producer.setSendMsgTimeout(<span class="number">10000</span>);</span><br><span class="line">        producer.setRetryTimesWhenSendFailed(<span class="number">3</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 设置事务监听器</span></span><br><span class="line">        producer.setTransactionListener(<span class="keyword">new</span> <span class="title class_">TransactionListener</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> LocalTransactionState <span class="title function_">executeLocalTransaction</span><span class="params">(Message msg, Object arg)</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 执行本地事务</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">bizKey</span> <span class="operator">=</span> msg.getKeys();</span><br><span class="line">                    <span class="type">BusinessContext</span> <span class="variable">context</span> <span class="operator">=</span> (BusinessContext) arg;</span><br><span class="line">                    businessService.executeTransaction(bizKey, context);</span><br><span class="line">                    <span class="keyword">return</span> LocalTransactionState.COMMIT_MESSAGE;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;本地事务执行失败&quot;</span>, e);</span><br><span class="line">                    <span class="keyword">return</span> LocalTransactionState.ROLLBACK_MESSAGE;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> LocalTransactionState <span class="title function_">checkLocalTransaction</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">bizKey</span> <span class="operator">=</span> msg.getKeys();</span><br><span class="line">                <span class="type">TransactionStatus</span> <span class="variable">status</span> <span class="operator">=</span> businessService.checkTransactionStatus(bizKey);</span><br><span class="line">                <span class="keyword">switch</span> (status) &#123;</span><br><span class="line">                    <span class="keyword">case</span> SUCCESS:</span><br><span class="line">                        <span class="keyword">return</span> LocalTransactionState.COMMIT_MESSAGE;</span><br><span class="line">                    <span class="keyword">case</span> FAILED:</span><br><span class="line">                        <span class="keyword">return</span> LocalTransactionState.ROLLBACK_MESSAGE;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">return</span> LocalTransactionState.UNKNOW;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> producer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="17-6-CDC-架构图描述">17.6 CDC 架构图描述</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[源数据库] → [Binlog] → [Debezium Connector] → [Kafka] → [下游应用]</span><br><span class="line">     ↓          ↓            ↓                  ↓         ↓</span><br><span class="line">[业务表] → [变更事件] → [事件转换] → [消息分区] → [幂等消费]</span><br></pre></td></tr></table></figure>
<p><strong>CDC数据流：</strong></p>
<ol>
<li><strong>变更捕获</strong>：监听数据库binlog</li>
<li><strong>事件转换</strong>：将binlog转换为结构化事件</li>
<li><strong>消息投递</strong>：按主键分区投递到Kafka</li>
<li><strong>下游消费</strong>：应用消费事件并幂等处理</li>
</ol>
<p><strong>Debezium配置详解：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mysql-connector&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;config&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;connector.class&quot;</span><span class="punctuation">:</span> <span class="string">&quot;io.debezium.connector.mysql.MySqlConnector&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;database.hostname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mysql-server&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;database.port&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3306&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;database.user&quot;</span><span class="punctuation">:</span> <span class="string">&quot;debezium&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;database.password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dbz&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;database.server.id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;184054&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;database.server.name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mysql-server&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;database.include.list&quot;</span><span class="punctuation">:</span> <span class="string">&quot;inventory,orders&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;table.include.list&quot;</span><span class="punctuation">:</span> <span class="string">&quot;inventory.products,orders.order_items&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;database.history.kafka.bootstrap.servers&quot;</span><span class="punctuation">:</span> <span class="string">&quot;kafka:9092&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;database.history.kafka.topic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dbhistory.inventory&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;include.schema.changes&quot;</span><span class="punctuation">:</span> <span class="string">&quot;true&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;snapshot.mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;initial&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;snapshot.locking.mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;minimal&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;event.processing.failure.handling.mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;warn&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;inconsistent.schema.handling.mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;warn&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;transforms&quot;</span><span class="punctuation">:</span> <span class="string">&quot;route&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;transforms.route.type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.kafka.connect.transforms.RegexRouter&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;transforms.route.regex&quot;</span><span class="punctuation">:</span> <span class="string">&quot;([^.]+)\\.([^.]+)\\.([^.]+)&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;transforms.route.replacement&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$3&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="18-性能优化与调优实践">18. 性能优化与调优实践</h2>
<h3 id="18-1-XA-2PC-性能优化">18.1 XA/2PC 性能优化</h3>
<p><strong>瓶颈分析：</strong></p>
<ul>
<li>两阶段锁导致资源长时间占用</li>
<li>网络往返次数多（2*N+1次，N为参与者数量）</li>
<li>单点TM成为性能瓶颈</li>
</ul>
<p><strong>优化策略：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 连接池优化</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XADataSourceConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AtomikosDataSourceBean <span class="title function_">dataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">AtomikosDataSourceBean</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomikosDataSourceBean</span>();</span><br><span class="line">        ds.setMinPoolSize(<span class="number">10</span>);</span><br><span class="line">        ds.setMaxPoolSize(<span class="number">50</span>);</span><br><span class="line">        ds.setBorrowConnectionTimeout(<span class="number">30</span>);</span><br><span class="line">        ds.setReapTimeout(<span class="number">20</span>);</span><br><span class="line">        ds.setMaxIdleTime(<span class="number">60</span>);</span><br><span class="line">        ds.setTestQuery(<span class="string">&quot;SELECT 1&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ds;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 事务超时控制</span></span><br><span class="line"><span class="meta">@Transactional(timeout = 30)</span> <span class="comment">// 30秒超时</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processXATransaction</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 业务逻辑</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 批量操作优化</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">batchProcess</span><span class="params">(List&lt;Order&gt; orders)</span> &#123;</span><br><span class="line">    <span class="comment">// 分批处理，避免长事务</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">batchSize</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; orders.size(); i += batchSize) &#123;</span><br><span class="line">        List&lt;Order&gt; batch = orders.subList(i, Math.min(i + batchSize, orders.size()));</span><br><span class="line">        processBatch(batch);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="18-2-TCC-性能优化">18.2 TCC 性能优化</h3>
<p><strong>瓶颈分析：</strong></p>
<ul>
<li>三阶段网络调用开销</li>
<li>资源冻结期间的并发限制</li>
<li>状态查询的数据库压力</li>
</ul>
<p><strong>优化策略：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 异步化Confirm/Cancel</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncTccService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ThreadPoolTaskExecutor tccExecutor;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">asyncConfirm</span><span class="params">(List&lt;String&gt; bizKeys)</span> &#123;</span><br><span class="line">        bizKeys.forEach(bizKey -&gt; </span><br><span class="line">            tccExecutor.submit(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    confirmService.confirm(bizKey);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="comment">// 记录失败，后续重试</span></span><br><span class="line">                    retryService.addRetryTask(bizKey, <span class="string">&quot;CONFIRM&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 资源预留优化</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OptimizedInventoryService</span> &#123;</span><br><span class="line">    <span class="comment">// 使用Redis进行快速资源检查</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, String&gt; redis;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryReserve</span><span class="params">(String sku, <span class="type">int</span> quantity)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;inventory:&quot;</span> + sku;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> </span><br><span class="line">            <span class="string">&quot;local current = redis.call(&#x27;get&#x27;, KEYS[1]) &quot;</span> +</span><br><span class="line">            <span class="string">&quot;if current and tonumber(current) &gt;= tonumber(ARGV[1]) then &quot;</span> +</span><br><span class="line">            <span class="string">&quot;  redis.call(&#x27;decrby&#x27;, KEYS[1], ARGV[1]) &quot;</span> +</span><br><span class="line">            <span class="string">&quot;  return 1 &quot;</span> +</span><br><span class="line">            <span class="string">&quot;else &quot;</span> +</span><br><span class="line">            <span class="string">&quot;  return 0 &quot;</span> +</span><br><span class="line">            <span class="string">&quot;end&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> redis.execute(RedisScript.of(script, Long.class), </span><br><span class="line">                                  Collections.singletonList(key), </span><br><span class="line">                                  String.valueOf(quantity));</span><br><span class="line">        <span class="keyword">return</span> result != <span class="literal">null</span> &amp;&amp; result == <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 状态机缓存</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TccStateCache</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, String&gt; redis;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">STATE_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;tcc:state:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CACHE_TTL</span> <span class="operator">=</span> <span class="number">3600</span>; <span class="comment">// 1小时</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cacheState</span><span class="params">(String bizKey, String state)</span> &#123;</span><br><span class="line">        redis.opsForValue().set(STATE_PREFIX + bizKey, state, CACHE_TTL, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getState</span><span class="params">(String bizKey)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redis.opsForValue().get(STATE_PREFIX + bizKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="18-3-Outbox-性能优化">18.3 Outbox 性能优化</h3>
<p><strong>瓶颈分析：</strong></p>
<ul>
<li>投递器扫描数据库的性能开销</li>
<li>大量消息的存储和查询压力</li>
<li>重试机制的指数退避延迟</li>
</ul>
<p><strong>优化策略：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 分片投递器</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShardedOutboxRelay</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SHARD_COUNT</span> <span class="operator">=</span> <span class="number">8</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(fixedDelay = 1000)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">relayMessages</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 并行处理多个分片</span></span><br><span class="line">        IntStream.range(<span class="number">0</span>, SHARD_COUNT)</span><br><span class="line">                .parallel()</span><br><span class="line">                .forEach(<span class="built_in">this</span>::processShardMessages);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processShardMessages</span><span class="params">(<span class="type">int</span> shardId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;SELECT * FROM outbox_message &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;WHERE status IN (&#x27;PENDING&#x27;, &#x27;RETRY&#x27;) &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;AND (next_retry_at IS NULL OR next_retry_at &lt;= NOW()) &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;AND MOD(id, ?) = ? &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;ORDER BY created_at LIMIT 100&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        List&lt;OutboxMessage&gt; messages = jdbc.query(sql, </span><br><span class="line">                                                 <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;SHARD_COUNT, shardId&#125;,</span><br><span class="line">                                                 messageRowMapper);</span><br><span class="line">        </span><br><span class="line">        messages.forEach(<span class="built_in">this</span>::sendMessage);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 批量投递优化</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BatchOutboxService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">batchSend</span><span class="params">(List&lt;OutboxMessage&gt; messages)</span> &#123;</span><br><span class="line">        <span class="comment">// 按topic分组批量发送</span></span><br><span class="line">        Map&lt;String, List&lt;OutboxMessage&gt;&gt; grouped = messages.stream()</span><br><span class="line">                .collect(Collectors.groupingBy(OutboxMessage::getTopic));</span><br><span class="line">        </span><br><span class="line">        grouped.forEach((topic, msgs) -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 批量发送到MQ</span></span><br><span class="line">                List&lt;Message&gt; mqMessages = msgs.stream()</span><br><span class="line">                        .map(<span class="built_in">this</span>::convertToMQMessage)</span><br><span class="line">                        .collect(Collectors.toList());</span><br><span class="line">                </span><br><span class="line">                mqProducer.batchSend(topic, mqMessages);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 批量更新状态</span></span><br><span class="line">                List&lt;Long&gt; ids = msgs.stream()</span><br><span class="line">                        .map(OutboxMessage::getId)</span><br><span class="line">                        .collect(Collectors.toList());</span><br><span class="line">                batchUpdateStatus(ids, <span class="string">&quot;SENT&quot;</span>);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">// 单独处理失败的消息</span></span><br><span class="line">                msgs.forEach(<span class="built_in">this</span>::handleSendFailure);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 消息归档策略</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OutboxArchiveJob</span> &#123;</span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0 0 2 * * *&quot;)</span> <span class="comment">// 每天凌晨2点执行</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">archiveMessages</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">cutoff</span> <span class="operator">=</span> LocalDateTime.now().minusDays(<span class="number">7</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 分批归档已完成的消息</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">batchSize</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">archived</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            archived = jdbc.update(</span><br><span class="line">                <span class="string">&quot;INSERT INTO outbox_message_archive &quot;</span> +</span><br><span class="line">                <span class="string">&quot;SELECT * FROM outbox_message &quot;</span> +</span><br><span class="line">                <span class="string">&quot;WHERE status = &#x27;SENT&#x27; AND updated_at &lt; ? &quot;</span> +</span><br><span class="line">                <span class="string">&quot;LIMIT ?&quot;</span>,</span><br><span class="line">                cutoff, batchSize);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (archived &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                jdbc.update(</span><br><span class="line">                    <span class="string">&quot;DELETE FROM outbox_message &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;WHERE status = &#x27;SENT&#x27; AND updated_at &lt; ? &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;LIMIT ?&quot;</span>,</span><br><span class="line">                    cutoff, batchSize);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (archived &gt; <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="18-4-CDC-性能优化">18.4 CDC 性能优化</h3>
<p><strong>瓶颈分析：</strong></p>
<ul>
<li>Binlog解析和转换的CPU开销</li>
<li>大表初始快照的时间和资源消耗</li>
<li>下游消费延迟导致的积压</li>
</ul>
<p><strong>优化策略：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Debezium Connector优化配置</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">&quot;optimized-mysql-connector&quot;</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line">  <span class="comment"># 连接优化</span></span><br><span class="line">  <span class="attr">database.connectionTimeZone:</span> <span class="string">&quot;UTC&quot;</span></span><br><span class="line">  <span class="attr">connect.timeout.ms:</span> <span class="number">30000</span></span><br><span class="line">  <span class="attr">connect.keep.alive:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">connect.keep.alive.interval.ms:</span> <span class="number">60000</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 快照优化</span></span><br><span class="line">  <span class="attr">snapshot.mode:</span> <span class="string">&quot;when_needed&quot;</span></span><br><span class="line">  <span class="attr">snapshot.locking.mode:</span> <span class="string">&quot;minimal&quot;</span></span><br><span class="line">  <span class="attr">snapshot.fetch.size:</span> <span class="number">10240</span></span><br><span class="line">  <span class="attr">snapshot.max.threads:</span> <span class="number">4</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Binlog优化</span></span><br><span class="line">  <span class="attr">binlog.buffer.size:</span> <span class="number">32768</span></span><br><span class="line">  <span class="attr">max.batch.size:</span> <span class="number">2048</span></span><br><span class="line">  <span class="attr">max.queue.size:</span> <span class="number">8192</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 事件过滤</span></span><br><span class="line">  <span class="attr">column.exclude.list:</span> <span class="string">&quot;inventory.products.description,orders.order_items.internal_notes&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 性能监控</span></span><br><span class="line">  <span class="attr">enable.time.adjuster:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">tombstones.on.delete:</span> <span class="literal">false</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 错误处理</span></span><br><span class="line">  <span class="attr">errors.tolerance:</span> <span class="string">&quot;all&quot;</span></span><br><span class="line">  <span class="attr">errors.log.enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">errors.log.include.messages:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Kafka优化配置</span></span><br><span class="line"><span class="attr">producer:</span></span><br><span class="line">  <span class="attr">batch.size:</span> <span class="number">65536</span></span><br><span class="line">  <span class="attr">linger.ms:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">compression.type:</span> <span class="string">&quot;snappy&quot;</span></span><br><span class="line">  <span class="attr">acks:</span> <span class="number">1</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">consumer:</span></span><br><span class="line">  <span class="attr">fetch.min.bytes:</span> <span class="number">50000</span></span><br><span class="line">  <span class="attr">fetch.max.wait.ms:</span> <span class="number">500</span></span><br><span class="line">  <span class="attr">max.poll.records:</span> <span class="number">1000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CDC消费者优化</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OptimizedCdcConsumer</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, String&gt; redis;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@KafkaListener(topics = &quot;mysql-server.inventory.products&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleProductChange</span><span class="params">(ConsumerRecord&lt;String, String&gt; record)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> record.key();</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> record.value();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. 幂等性检查（使用Redis）</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">idempotentKey</span> <span class="operator">=</span> <span class="string">&quot;cdc:processed:&quot;</span> + key + <span class="string">&quot;:&quot;</span> + record.offset();</span><br><span class="line">        <span class="keyword">if</span> (redis.hasKey(idempotentKey)) &#123;</span><br><span class="line">            <span class="keyword">return</span>; <span class="comment">// 已处理过</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 2. 解析变更事件</span></span><br><span class="line">            <span class="type">ChangeEvent</span> <span class="variable">event</span> <span class="operator">=</span> parseChangeEvent(value);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 3. 批量处理相同类型的变更</span></span><br><span class="line">            <span class="keyword">if</span> (shouldBatch(event)) &#123;</span><br><span class="line">                batchProcessor.addToBatch(event);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                processImmediately(event);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 4. 标记已处理</span></span><br><span class="line">            redis.opsForValue().set(idempotentKey, <span class="string">&quot;1&quot;</span>, <span class="number">1</span>, TimeUnit.HOURS);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// 错误处理和重试</span></span><br><span class="line">            handleProcessingError(record, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 批量处理器</span></span><br><span class="line">    <span class="meta">@Component</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">BatchProcessor</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, List&lt;ChangeEvent&gt;&gt; batches = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Scheduled(fixedDelay = 1000)</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processBatches</span><span class="params">()</span> &#123;</span><br><span class="line">            batches.forEach((type, events) -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (!events.isEmpty()) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        processBatch(type, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(events));</span><br><span class="line">                        events.clear();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        log.error(<span class="string">&quot;批量处理失败: &#123;&#125;&quot;</span>, type, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="19-故障处理与容灾实践">19. 故障处理与容灾实践</h2>
<h3 id="19-1-常见故障场景与处理">19.1 常见故障场景与处理</h3>
<p><strong>场景1：TM/协调器宕机</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TM高可用配置</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransactionManagerHA</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserTransactionManager <span class="title function_">userTransactionManager</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">UserTransactionManager</span> <span class="variable">utm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserTransactionManager</span>();</span><br><span class="line">        utm.setForceShutdown(<span class="literal">false</span>);</span><br><span class="line">        utm.setStartupTransactionService(<span class="literal">true</span>);</span><br><span class="line">        utm.setTransactionTimeout(<span class="number">300</span>);</span><br><span class="line">        <span class="keyword">return</span> utm;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 集群模式配置</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AtomikosJtaPlatform <span class="title function_">jtaPlatform</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">AtomikosJtaPlatform</span> <span class="variable">platform</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomikosJtaPlatform</span>();</span><br><span class="line">        platform.setTmUniqueName(<span class="string">&quot;tm-node-&quot;</span> + getNodeId());</span><br><span class="line">        <span class="keyword">return</span> platform;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 故障检测与切换</span></span><br><span class="line">    <span class="meta">@Component</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TMFailoverDetector</span> &#123;</span><br><span class="line">        <span class="meta">@EventListener</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleTMFailure</span><span class="params">(TMFailureEvent event)</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 停止接收新事务</span></span><br><span class="line">            transactionGateway.stopAcceptingTransactions();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2. 等待现有事务完成</span></span><br><span class="line">            waitForActiveTransactions();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 3. 触发备用TM启动</span></span><br><span class="line">            backupTMService.activate();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>场景2：网络分区与脑裂</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 网络分区检测</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NetworkPartitionDetector</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(fixedDelay = 5000)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">detectPartition</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;String&gt; participants = getActiveParticipants();</span><br><span class="line">        <span class="type">int</span> <span class="variable">reachableCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (String participant : participants) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isReachable(participant)) &#123;</span><br><span class="line">                reachableCount++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 少数派停止服务</span></span><br><span class="line">        <span class="keyword">if</span> (reachableCount &lt; participants.size() / <span class="number">2</span>) &#123;</span><br><span class="line">            enterMinorityMode();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">enterMinorityMode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 停止事务协调</span></span><br><span class="line">        transactionCoordinator.shutdown();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 进入只读模式</span></span><br><span class="line">        applicationContext.setReadOnlyMode(<span class="literal">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 等待网络恢复</span></span><br><span class="line">        scheduleRecoveryCheck();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>场景3：消息丢失与重复</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 消息可靠性保障</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReliableMessageService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 发送端确认</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendWithConfirmation</span><span class="params">(String topic, Object message)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">messageId</span> <span class="operator">=</span> generateMessageId();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 预写消息日志</span></span><br><span class="line">            messageLog.preWrite(messageId, topic, message);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2. 发送消息</span></span><br><span class="line">            <span class="type">SendResult</span> <span class="variable">result</span> <span class="operator">=</span> mqProducer.send(topic, message, messageId);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (result.isSuccess()) &#123;</span><br><span class="line">                <span class="comment">// 3. 确认发送成功</span></span><br><span class="line">                messageLog.confirmSent(messageId);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 4. 标记发送失败，等待重试</span></span><br><span class="line">                messageLog.markFailed(messageId, result.getErrorMessage());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            messageLog.markFailed(messageId, e.getMessage());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MessageSendException</span>(<span class="string">&quot;消息发送失败&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 重试机制</span></span><br><span class="line">    <span class="meta">@Scheduled(fixedDelay = 10000)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">retryFailedMessages</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;MessageLog&gt; failedMessages = messageLog.getFailedMessages();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (MessageLog msg : failedMessages) &#123;</span><br><span class="line">            <span class="keyword">if</span> (msg.shouldRetry()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    sendWithConfirmation(msg.getTopic(), msg.getPayload());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    msg.incrementRetryCount();</span><br><span class="line">                    <span class="keyword">if</span> (msg.exceedsMaxRetry()) &#123;</span><br><span class="line">                        <span class="comment">// 转入死信队列</span></span><br><span class="line">                        deadLetterService.send(msg);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="19-2-数据一致性检查与修复">19.2 数据一致性检查与修复</h3>
<p><strong>自动对账系统：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsistencyChecker</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 每日对账任务</span></span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0 0 1 * * *&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">dailyReconciliation</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">LocalDate</span> <span class="variable">yesterday</span> <span class="operator">=</span> LocalDate.now().minusDays(<span class="number">1</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. 检查订单-库存一致性</span></span><br><span class="line">        checkOrderInventoryConsistency(yesterday);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 检查消息-消费一致性</span></span><br><span class="line">        checkMessageConsumptionConsistency(yesterday);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 检查账务一致性</span></span><br><span class="line">        checkAccountingConsistency(yesterday);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkOrderInventoryConsistency</span><span class="params">(LocalDate date)</span> &#123;</span><br><span class="line">        <span class="comment">// 查询当日所有已支付订单</span></span><br><span class="line">        List&lt;Order&gt; paidOrders = orderService.getPaidOrdersByDate(date);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (Order order : paidOrders) &#123;</span><br><span class="line">            <span class="comment">// 检查库存扣减记录</span></span><br><span class="line">            <span class="type">InventoryRecord</span> <span class="variable">record</span> <span class="operator">=</span> inventoryService.getRecord(order.getId());</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (record == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 发现不一致，创建修复任务</span></span><br><span class="line">                <span class="type">RepairTask</span> <span class="variable">task</span> <span class="operator">=</span> RepairTask.builder()</span><br><span class="line">                    .type(<span class="string">&quot;INVENTORY_MISSING&quot;</span>)</span><br><span class="line">                    .orderId(order.getId())</span><br><span class="line">                    .description(<span class="string">&quot;订单已支付但库存未扣减&quot;</span>)</span><br><span class="line">                    .build();</span><br><span class="line">                </span><br><span class="line">                repairService.createTask(task);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 自动修复</span></span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleRepairTask</span><span class="params">(RepairTaskEvent event)</span> &#123;</span><br><span class="line">        <span class="type">RepairTask</span> <span class="variable">task</span> <span class="operator">=</span> event.getTask();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">switch</span> (task.getType()) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;INVENTORY_MISSING&quot;</span>:</span><br><span class="line">                repairInventoryMissing(task);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;MESSAGE_NOT_CONSUMED&quot;</span>:</span><br><span class="line">                repairMessageNotConsumed(task);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;DUPLICATE_CONSUMPTION&quot;</span>:</span><br><span class="line">                repairDuplicateConsumption(task);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">repairInventoryMissing</span><span class="params">(RepairTask task)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 验证订单状态</span></span><br><span class="line">            <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> orderService.getById(task.getOrderId());</span><br><span class="line">            <span class="keyword">if</span> (!<span class="string">&quot;PAID&quot;</span>.equals(order.getStatus())) &#123;</span><br><span class="line">                task.markSkipped(<span class="string">&quot;订单状态已变更&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2. 执行库存扣减</span></span><br><span class="line">            inventoryService.deduct(order.getSku(), order.getQuantity(), </span><br><span class="line">                                  <span class="string">&quot;REPAIR_&quot;</span> + task.getId());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 3. 记录修复日志</span></span><br><span class="line">            auditService.log(<span class="string">&quot;REPAIR&quot;</span>, <span class="string">&quot;库存修复完成&quot;</span>, task);</span><br><span class="line">            </span><br><span class="line">            task.markCompleted();</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            task.markFailed(e.getMessage());</span><br><span class="line">            <span class="comment">// 转人工处理</span></span><br><span class="line">            manualTaskService.create(task);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="19-3-监控告警体系">19.3 监控告警体系</h3>
<p><strong>核心指标监控：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransactionMetrics</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MeterRegistry meterRegistry;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Counter transactionCounter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Timer transactionTimer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Gauge pendingTransactions;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TransactionMetrics</span><span class="params">(MeterRegistry meterRegistry)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.meterRegistry = meterRegistry;</span><br><span class="line">        <span class="built_in">this</span>.transactionCounter = Counter.builder(<span class="string">&quot;transaction.total&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;事务总数&quot;</span>)</span><br><span class="line">            .tag(<span class="string">&quot;type&quot;</span>, <span class="string">&quot;distributed&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">this</span>.transactionTimer = Timer.builder(<span class="string">&quot;transaction.duration&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;事务执行时间&quot;</span>)</span><br><span class="line">            .register(meterRegistry);</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">this</span>.pendingTransactions = Gauge.builder(<span class="string">&quot;transaction.pending&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;待处理事务数&quot;</span>)</span><br><span class="line">            .register(meterRegistry, <span class="built_in">this</span>, TransactionMetrics::getPendingCount);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 记录事务指标</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordTransaction</span><span class="params">(String type, Duration duration, String status)</span> &#123;</span><br><span class="line">        transactionCounter.increment(</span><br><span class="line">            Tags.of(</span><br><span class="line">                Tag.of(<span class="string">&quot;type&quot;</span>, type),</span><br><span class="line">                Tag.of(<span class="string">&quot;status&quot;</span>, status)</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        transactionTimer.record(duration);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 自定义指标</span></span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleTransactionEvent</span><span class="params">(TransactionEvent event)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (event.getType()) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;TCC_TRY_TIMEOUT&quot;</span>:</span><br><span class="line">                meterRegistry.counter(<span class="string">&quot;tcc.try.timeout&quot;</span>).increment();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;SAGA_COMPENSATION_FAILED&quot;</span>:</span><br><span class="line">                meterRegistry.counter(<span class="string">&quot;saga.compensation.failed&quot;</span>).increment();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;OUTBOX_RETRY_EXHAUSTED&quot;</span>:</span><br><span class="line">                meterRegistry.counter(<span class="string">&quot;outbox.retry.exhausted&quot;</span>).increment();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 告警规则配置</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AlertingConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AlertManager <span class="title function_">alertManager</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> AlertManager.builder()</span><br><span class="line">            .addRule(AlertRule.builder()</span><br><span class="line">                .name(<span class="string">&quot;事务失败率过高&quot;</span>)</span><br><span class="line">                .condition(<span class="string">&quot;rate(transaction_total&#123;status=&#x27;failed&#x27;&#125;[5m]) &gt; 0.1&quot;</span>)</span><br><span class="line">                .severity(Severity.CRITICAL)</span><br><span class="line">                .description(<span class="string">&quot;5分钟内事务失败率超过10%&quot;</span>)</span><br><span class="line">                .build())</span><br><span class="line">            .addRule(AlertRule.builder()</span><br><span class="line">                .name(<span class="string">&quot;TCC Try超时&quot;</span>)</span><br><span class="line">                .condition(<span class="string">&quot;tcc_try_timeout &gt; 10&quot;</span>)</span><br><span class="line">                .severity(Severity.WARNING)</span><br><span class="line">                .description(<span class="string">&quot;TCC Try阶段超时次数过多&quot;</span>)</span><br><span class="line">                .build())</span><br><span class="line">            .addRule(AlertRule.builder()</span><br><span class="line">                .name(<span class="string">&quot;消息积压&quot;</span>)</span><br><span class="line">                .condition(<span class="string">&quot;outbox_pending_messages &gt; 1000&quot;</span>)</span><br><span class="line">                .severity(Severity.WARNING)</span><br><span class="line">                .description(<span class="string">&quot;Outbox待处理消息数量过多&quot;</span>)</span><br><span class="line">                .build())</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="20-方案对比表格与选型决策树">20. 方案对比表格与选型决策树</h2>
<h3 id="20-1-详细对比表格">20.1 详细对比表格</h3>
<table>
<thead>
<tr>
<th>维度</th>
<th>XA/2PC</th>
<th>TCC</th>
<th>Saga</th>
<th>Outbox</th>
<th>事务消息</th>
<th>CDC</th>
<th>最大努力</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>一致性保证</strong></td>
<td>强一致</td>
<td>强一致</td>
<td>最终一致</td>
<td>最终一致</td>
<td>最终一致</td>
<td>最终一致</td>
<td>最终一致</td>
</tr>
<tr>
<td><strong>性能影响</strong></td>
<td>高(锁资源)</td>
<td>中(三阶段)</td>
<td>低(异步)</td>
<td>低(异步)</td>
<td>中(半消息)</td>
<td>低(异步)</td>
<td>低(异步)</td>
</tr>
<tr>
<td><strong>可用性</strong></td>
<td>低(单点)</td>
<td>中(协调器)</td>
<td>高(去中心)</td>
<td>高(本地事务)</td>
<td>中(MQ依赖)</td>
<td>高(最终一致)</td>
<td>高(容错性强)</td>
</tr>
<tr>
<td><strong>复杂度</strong></td>
<td>低(框架支持)</td>
<td>高(业务改造)</td>
<td>中(编排逻辑)</td>
<td>中(投递机制)</td>
<td>中(回查逻辑)</td>
<td>中(幂等处理)</td>
<td>低(重试机制)</td>
</tr>
<tr>
<td><strong>业务侵入性</strong></td>
<td>低</td>
<td>高</td>
<td>中</td>
<td>低</td>
<td>低</td>
<td>无</td>
<td>低</td>
</tr>
<tr>
<td><strong>开发成本</strong></td>
<td>低</td>
<td>高</td>
<td>中</td>
<td>中</td>
<td>中</td>
<td>低</td>
<td>低</td>
</tr>
<tr>
<td><strong>运维成本</strong></td>
<td>中</td>
<td>高</td>
<td>中</td>
<td>中</td>
<td>中</td>
<td>中</td>
<td>低</td>
</tr>
<tr>
<td><strong>故障恢复</strong></td>
<td>自动</td>
<td>需补偿</td>
<td>需补偿</td>
<td>自动重试</td>
<td>自动回查</td>
<td>自动重试</td>
<td>自动重试</td>
</tr>
<tr>
<td><strong>数据可见性</strong></td>
<td>立即</td>
<td>立即</td>
<td>延迟</td>
<td>延迟</td>
<td>延迟</td>
<td>延迟</td>
<td>延迟</td>
</tr>
<tr>
<td><strong>扩展性</strong></td>
<td>差</td>
<td>中</td>
<td>好</td>
<td>好</td>
<td>中</td>
<td>好</td>
<td>好</td>
</tr>
<tr>
<td><strong>技术栈要求</strong></td>
<td>JTA支持</td>
<td>HTTP接口</td>
<td>编排引擎</td>
<td>MQ+DB</td>
<td>特定MQ</td>
<td>CDC工具</td>
<td>基础设施</td>
</tr>
<tr>
<td><strong>适用场景</strong></td>
<td>内部系统</td>
<td>核心业务</td>
<td>长流程</td>
<td>跨系统</td>
<td>消息场景</td>
<td>数据同步</td>
<td>通知场景</td>
</tr>
</tbody>
</table>
<h3 id="20-2-选型决策树">20.2 选型决策树</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">开始选型</span><br><span class="line">    ↓</span><br><span class="line">是否需要强一致性？</span><br><span class="line">    ├─ 是 → 参与方是否可控且少于3个？</span><br><span class="line">    │       ├─ 是 → 是否可以接受性能损失？</span><br><span class="line">    │       │       ├─ 是 → XA/2PC</span><br><span class="line">    │       │       └─ 否 → TCC</span><br><span class="line">    │       └─ 否 → TCC</span><br><span class="line">    └─ 否 → 是否需要零业务侵入？</span><br><span class="line">            ├─ 是 → 是否主要用于数据同步？</span><br><span class="line">            │       ├─ 是 → CDC</span><br><span class="line">            │       └─ 否 → 是否有成熟MQ？</span><br><span class="line">            │               ├─ 是 → Outbox</span><br><span class="line">            │               └─ 否 → 最大努力通知</span><br><span class="line">            └─ 否 → 是否为长流程业务？</span><br><span class="line">                    ├─ 是 → Saga</span><br><span class="line">                    └─ 否 → 是否主要为消息场景？</span><br><span class="line">                            ├─ 是 → 事务消息</span><br><span class="line">                            └─ 否 → Outbox</span><br></pre></td></tr></table></figure>
<h3 id="20-3-选型建议矩阵">20.3 选型建议矩阵</h3>
<table>
<thead>
<tr>
<th>业务特征</th>
<th>推荐方案</th>
<th>备选方案</th>
<th>不推荐</th>
</tr>
</thead>
<tbody>
<tr>
<td>金融核心交易</td>
<td>TCC</td>
<td>XA/2PC</td>
<td>Saga, 最大努力</td>
</tr>
<tr>
<td>电商下单流程</td>
<td>Outbox</td>
<td>事务消息</td>
<td>XA/2PC</td>
</tr>
<tr>
<td>用户注册流程</td>
<td>最大努力通知</td>
<td>Outbox</td>
<td>TCC</td>
</tr>
<tr>
<td>数据ETL同步</td>
<td>CDC</td>
<td>Outbox</td>
<td>XA/2PC, TCC</td>
</tr>
<tr>
<td>营销活动触发</td>
<td>事务消息</td>
<td>Outbox</td>
<td>XA/2PC</td>
</tr>
<tr>
<td>长业务流程</td>
<td>Saga</td>
<td>Outbox</td>
<td>XA/2PC, TCC</td>
</tr>
<tr>
<td>遗留系统改造</td>
<td>最大努力通知</td>
<td>CDC</td>
<td>TCC</td>
</tr>
<tr>
<td>微服务协调</td>
<td>Outbox</td>
<td>Saga</td>
<td>XA/2PC</td>
</tr>
</tbody>
</table>
<h3 id="20-4-实施路径建议">20.4 实施路径建议</h3>
<p><strong>阶段1：基础建设（1-2个月）</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1. 搭建监控体系</span><br><span class="line">   - 事务成功率、耗时监控</span><br><span class="line">   - 消息积压、重试次数监控</span><br><span class="line">   - 业务一致性监控</span><br><span class="line"></span><br><span class="line">2. 建立幂等框架</span><br><span class="line">   - 统一幂等键生成规范</span><br><span class="line">   - 幂等记录表设计</span><br><span class="line">   - 幂等拦截器实现</span><br><span class="line"></span><br><span class="line">3. 完善对账机制</span><br><span class="line">   - 每日对账任务</span><br><span class="line">   - 差异自动修复</span><br><span class="line">   - 人工处理流程</span><br></pre></td></tr></table></figure>
<p><strong>阶段2：试点应用（2-3个月）</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1. 选择低风险业务试点</span><br><span class="line">   - 用户积分变更</span><br><span class="line">   - 消息通知发送</span><br><span class="line">   - 数据统计更新</span><br><span class="line"></span><br><span class="line">2. 实施最大努力通知</span><br><span class="line">   - 简单易实现</span><br><span class="line">   - 风险可控</span><br><span class="line">   - 积累经验</span><br><span class="line"></span><br><span class="line">3. 逐步引入Outbox模式</span><br><span class="line">   - 适用场景广泛</span><br><span class="line">   - 技术相对成熟</span><br><span class="line">   - 性能表现良好</span><br></pre></td></tr></table></figure>
<p><strong>阶段3：核心业务（3-6个月）</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1. 核心交易链路使用TCC</span><br><span class="line">   - 订单-库存-支付</span><br><span class="line">   - 资金转账</span><br><span class="line">   - 库存调拨</span><br><span class="line"></span><br><span class="line">2. 长流程使用Saga</span><br><span class="line">   - 订单履约流程</span><br><span class="line">   - 退款处理流程</span><br><span class="line">   - 用户注册流程</span><br><span class="line"></span><br><span class="line">3. 数据同步使用CDC</span><br><span class="line">   - 业务数据到数仓</span><br><span class="line">   - 缓存数据更新</span><br><span class="line">   - 搜索索引构建</span><br></pre></td></tr></table></figure>
<p><strong>阶段4：优化完善（持续）</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1. 性能优化</span><br><span class="line">   - 批量处理优化</span><br><span class="line">   - 连接池调优</span><br><span class="line">   - 缓存策略优化</span><br><span class="line"></span><br><span class="line">2. 可靠性提升</span><br><span class="line">   - 故障自动恢复</span><br><span class="line">   - 灾备切换演练</span><br><span class="line">   - 容量规划调整</span><br><span class="line"></span><br><span class="line">3. 运维自动化</span><br><span class="line">   - 自动扩缩容</span><br><span class="line">   - 智能告警</span><br><span class="line">   - 自动修复</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="21-总结与最佳实践">21. 总结与最佳实践</h2>
<h3 id="21-1-核心原则">21.1 核心原则</h3>
<ol>
<li><strong>没有银弹</strong>：根据业务特性、技术栈、团队能力选择合适方案</li>
<li><strong>渐进演进</strong>：从简单方案开始，逐步向复杂方案演进</li>
<li><strong>监控先行</strong>：完善的监控和对账是分布式事务的基础</li>
<li><strong>幂等为王</strong>：所有分布式操作都必须考虑幂等性</li>
<li><strong>故障即常态</strong>：设计时就要考虑各种故障场景</li>
</ol>
<h3 id="21-2-工程实践要点">21.2 工程实践要点</h3>
<ul>
<li><strong>状态机设计</strong>：明确定义状态转换规则，防止非法跃迁</li>
<li><strong>超时处理</strong>：为所有异步操作设置合理超时时间</li>
<li><strong>重试策略</strong>：指数退避+抖动，避免重试风暴</li>
<li><strong>死信处理</strong>：建立完善的死信队列处理机制</li>
<li><strong>人工介入</strong>：复杂场景下的人工处理流程</li>
</ul>
<h3 id="21-3-选型速查">21.3 选型速查</h3>
<ul>
<li><strong>强约束核心链路</strong>：TCC &gt; XA/2PC</li>
<li><strong>跨系统协同解耦</strong>：Outbox &gt; 事务消息</li>
<li><strong>数据同步汇聚</strong>：CDC &gt; Outbox</li>
<li><strong>长流程编排</strong>：Saga &gt; Outbox</li>
<li><strong>简单通知场景</strong>：最大努力通知</li>
</ul>
<p>记住：<strong>分布式事务的本质是在CAP定理约束下的工程权衡，选择适合的方案比追求完美的方案更重要。</strong></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/myblog/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/" rel="tag"># 分布式事务</a>
              <a href="/myblog/tags/XA/" rel="tag"># XA</a>
              <a href="/myblog/tags/TCC/" rel="tag"># TCC</a>
              <a href="/myblog/tags/Saga/" rel="tag"># Saga</a>
              <a href="/myblog/tags/Outbox/" rel="tag"># Outbox</a>
              <a href="/myblog/tags/%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF/" rel="tag"># 事务消息</a>
              <a href="/myblog/tags/CDC/" rel="tag"># CDC</a>
              <a href="/myblog/tags/%E5%B9%82%E7%AD%89/" rel="tag"># 幂等</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/myblog/2025/09/11/Java/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88%E5%88%86%E6%9E%90/" rel="prev" title="分布式锁实现方案与最佳实践">
                  <i class="fa fa-angle-left"></i> 分布式锁实现方案与最佳实践
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">haiqingxx8</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
