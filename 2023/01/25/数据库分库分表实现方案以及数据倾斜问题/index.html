<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/myblog/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/myblog/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/myblog/images/favicon-16x16.png">
  <link rel="mask-icon" href="/myblog/images/safari-pinned-tab.svg" color="#222">

<link rel="stylesheet" href="/myblog/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css2?family=Lato:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"haiqingxx8.github.io","root":"/myblog/","images":"/myblog/images","scheme":"Gemini","darkmode":false,"version":"8.24.0","exturl":false,"sidebar":{"position":"right","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12,"enable":true,"b2t":false,"scrollpercent":false,"onmobile":false},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":"default","show_result":true},"fold":{"enable":false,"height":500},"language":false,"highlight_theme":"normal"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":true,"nav":null,"count":true,"text":"è¯„è®º","orderby":"latest","login":"ç™»å½•","admin":"åšä¸»","page_text":"è¯„è®º","comment_placeholder":"è¯´ç‚¹ä»€ä¹ˆå§..."},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"prism":false,"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"/myblog/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false,"labels":{"input_placeholder":"æœç´¢æ–‡ç« ...","hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹: ${query}"}}}</script><script src="/myblog/js/config.js" defer></script>

    <meta name="description" content="æ·±å…¥å‰–ææ•°æ®åº“åˆ†åº“åˆ†è¡¨çš„æ ¸å¿ƒåŸç†ä¸å®ç°æ–¹æ¡ˆï¼Œè¯¦è§£ShardingSphereã€MyCatç­‰ä¸»æµä¸­é—´ä»¶çš„æ¶æ„è®¾è®¡ï¼Œæ¢è®¨ä¸HashMapæ‰©å®¹æœºåˆ¶çš„å¼‚æ›²åŒå·¥ä¹‹å¦™ï¼Œæä¾›åˆ†ç‰‡é”®é€‰æ‹©ç­–ç•¥å’Œæ•°æ®å€¾æ–œæ²»ç†æ–¹æ¡ˆ">
<meta property="og:type" content="article">
<meta property="og:title" content="æ•°æ®åº“åˆ†åº“åˆ†è¡¨å®ç°æ–¹æ¡ˆæ·±åº¦è§£æï¼šä»æ¶æ„è®¾è®¡åˆ°æ•°æ®å€¾æ–œæ²»ç†">
<meta property="og:url" content="https://haiqingxx8.github.io/2023/01/25/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88%E4%BB%A5%E5%8F%8A%E6%95%B0%E6%8D%AE%E5%80%BE%E6%96%9C%E9%97%AE%E9%A2%98/index.html">
<meta property="og:site_name" content="æˆ‘çš„æŠ€æœ¯åšå®¢">
<meta property="og:description" content="æ·±å…¥å‰–ææ•°æ®åº“åˆ†åº“åˆ†è¡¨çš„æ ¸å¿ƒåŸç†ä¸å®ç°æ–¹æ¡ˆï¼Œè¯¦è§£ShardingSphereã€MyCatç­‰ä¸»æµä¸­é—´ä»¶çš„æ¶æ„è®¾è®¡ï¼Œæ¢è®¨ä¸HashMapæ‰©å®¹æœºåˆ¶çš„å¼‚æ›²åŒå·¥ä¹‹å¦™ï¼Œæä¾›åˆ†ç‰‡é”®é€‰æ‹©ç­–ç•¥å’Œæ•°æ®å€¾æ–œæ²»ç†æ–¹æ¡ˆ">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-01-25T02:30:00.000Z">
<meta property="article:modified_time" content="2025-09-10T17:19:13.277Z">
<meta property="article:author" content="haiqingxx8">
<meta property="article:tag" content="åˆ†åº“åˆ†è¡¨">
<meta property="article:tag" content="æ•°æ®åˆ†ç‰‡">
<meta property="article:tag" content="åˆ†ç‰‡é”®è®¾è®¡">
<meta property="article:tag" content="æ•°æ®å€¾æ–œ">
<meta property="article:tag" content="ShardingSphere">
<meta property="article:tag" content="MyCat">
<meta property="article:tag" content="åˆ†å¸ƒå¼æ•°æ®åº“">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://haiqingxx8.github.io/2023/01/25/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88%E4%BB%A5%E5%8F%8A%E6%95%B0%E6%8D%AE%E5%80%BE%E6%96%9C%E9%97%AE%E9%A2%98/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://haiqingxx8.github.io/2023/01/25/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88%E4%BB%A5%E5%8F%8A%E6%95%B0%E6%8D%AE%E5%80%BE%E6%96%9C%E9%97%AE%E9%A2%98/","path":"2023/01/25/æ•°æ®åº“åˆ†åº“åˆ†è¡¨å®ç°æ–¹æ¡ˆä»¥åŠæ•°æ®å€¾æ–œé—®é¢˜/","title":"æ•°æ®åº“åˆ†åº“åˆ†è¡¨å®ç°æ–¹æ¡ˆæ·±åº¦è§£æï¼šä»æ¶æ„è®¾è®¡åˆ°æ•°æ®å€¾æ–œæ²»ç†"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>æ•°æ®åº“åˆ†åº“åˆ†è¡¨å®ç°æ–¹æ¡ˆæ·±åº¦è§£æï¼šä»æ¶æ„è®¾è®¡åˆ°æ•°æ®å€¾æ–œæ²»ç† | æˆ‘çš„æŠ€æœ¯åšå®¢</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/myblog/js/utils.js" defer></script><script src="/myblog/js/motion.js" defer></script><script src="/myblog/js/sidebar.js" defer></script><script src="/myblog/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/myblog/js/third-party/search/local-search.js" defer></script>







  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





  <noscript>
    <link rel="stylesheet" href="/myblog/css/noscript.css">
  </noscript>
<link rel="alternate" href="/myblog/atom.xml" title="æˆ‘çš„æŠ€æœ¯åšå®¢" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/myblog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">æˆ‘çš„æŠ€æœ¯åšå®¢</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">è®°å½•æŠ€æœ¯å­¦ä¹ å¿ƒå¾—ï¼Œåˆ†äº«å¼€å‘ç»éªŒ</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="æœç´¢" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/myblog/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a></li><li class="menu-item menu-item-archives"><a href="/myblog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a></li><li class="menu-item menu-item-categories"><a href="/myblog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a></li><li class="menu-item menu-item-tags"><a href="/myblog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a></li><li class="menu-item menu-item-about"><a href="/myblog/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="æœç´¢..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%F0%9F%9A%80-%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">ğŸš€ å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%9F%BA%E7%A1%80%E7%90%86%E8%AE%BA"><span class="nav-number">2.</span> <span class="nav-text">1. åˆ†åº“åˆ†è¡¨åŸºç¡€ç†è®º</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E8%A7%A3%E6%9E%90"><span class="nav-number">2.1.</span> <span class="nav-text">1.1 æ ¸å¿ƒæ¦‚å¿µè§£æ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-1-%E5%88%86%E5%BA%93%EF%BC%88Database-Sharding%EF%BC%89"><span class="nav-number">2.1.1.</span> <span class="nav-text">1.1.1 åˆ†åº“ï¼ˆDatabase Shardingï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-2-%E5%88%86%E8%A1%A8%EF%BC%88Table-Sharding%EF%BC%89"><span class="nav-number">2.1.2.</span> <span class="nav-text">1.1.2 åˆ†è¡¨ï¼ˆTable Shardingï¼‰</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E7%9A%84%E5%BF%85%E8%A6%81%E6%80%A7"><span class="nav-number">2.2.</span> <span class="nav-text">1.2 åˆ†åº“åˆ†è¡¨çš„å¿…è¦æ€§</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-1-%E6%80%A7%E8%83%BD%E7%93%B6%E9%A2%88%E5%88%86%E6%9E%90"><span class="nav-number">2.2.1.</span> <span class="nav-text">1.2.1 æ€§èƒ½ç“¶é¢ˆåˆ†æ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-2-%E5%AD%98%E5%82%A8%E5%AE%B9%E9%87%8F%E9%99%90%E5%88%B6"><span class="nav-number">2.2.2.</span> <span class="nav-text">1.2.2 å­˜å‚¨å®¹é‡é™åˆ¶</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E4%B8%BB%E6%B5%81%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">3.</span> <span class="nav-text">2. ä¸»æµåˆ†åº“åˆ†è¡¨è§£å†³æ–¹æ¡ˆ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-Apache-ShardingSphere"><span class="nav-number">3.1.</span> <span class="nav-text">2.1 Apache ShardingSphere</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-1-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="nav-number">3.1.1.</span> <span class="nav-text">2.1.1 æ¶æ„è®¾è®¡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-2-%E6%A0%B8%E5%BF%83%E7%89%B9%E6%80%A7"><span class="nav-number">3.1.2.</span> <span class="nav-text">2.1.2 æ ¸å¿ƒç‰¹æ€§</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-MyCat"><span class="nav-number">3.2.</span> <span class="nav-text">2.2 MyCat</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-1-%E6%9E%B6%E6%9E%84%E7%89%B9%E7%82%B9"><span class="nav-number">3.2.1.</span> <span class="nav-text">2.2.1 æ¶æ„ç‰¹ç‚¹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-2-%E5%88%86%E7%89%87%E8%A7%84%E5%88%99%E9%85%8D%E7%BD%AE"><span class="nav-number">3.2.2.</span> <span class="nav-text">2.2.2 åˆ†ç‰‡è§„åˆ™é…ç½®</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-%E4%B8%BB%E6%B5%81%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%94%E5%88%86%E6%9E%90"><span class="nav-number">3.3.</span> <span class="nav-text">2.3 ä¸»æµæ–¹æ¡ˆå¯¹æ¯”åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-1-%E5%8A%9F%E8%83%BD%E7%89%B9%E6%80%A7%E5%AF%B9%E6%AF%94"><span class="nav-number">3.3.1.</span> <span class="nav-text">2.3.1 åŠŸèƒ½ç‰¹æ€§å¯¹æ¯”</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-2-%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%AF%B9%E6%AF%94"><span class="nav-number">3.3.2.</span> <span class="nav-text">2.3.2 æ€§èƒ½æµ‹è¯•å¯¹æ¯”</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%88%86%E7%89%87%E7%AE%97%E6%B3%95%E4%B8%8EHashMap%E6%89%A9%E5%AE%B9%E7%9A%84%E5%BC%82%E6%9B%B2%E5%90%8C%E5%B7%A5%E4%B9%8B%E5%A6%99"><span class="nav-number">4.</span> <span class="nav-text">3. åˆ†ç‰‡ç®—æ³•ä¸HashMapæ‰©å®¹çš„å¼‚æ›²åŒå·¥ä¹‹å¦™</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-HashMap%E6%89%A9%E5%AE%B9%E6%9C%BA%E5%88%B6%E5%9B%9E%E9%A1%BE"><span class="nav-number">4.1.</span> <span class="nav-text">3.1 HashMapæ‰©å®¹æœºåˆ¶å›é¡¾</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-1-HashMap%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86"><span class="nav-number">4.1.1.</span> <span class="nav-text">3.1.1 HashMapæ ¸å¿ƒåŸç†</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-2-%E6%89%A9%E5%AE%B9%E8%BF%87%E7%A8%8B%E8%AF%A6%E8%A7%A3"><span class="nav-number">4.1.2.</span> <span class="nav-text">3.1.2 æ‰©å®¹è¿‡ç¨‹è¯¦è§£</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E4%B8%8EHashMap%E6%89%A9%E5%AE%B9%E7%9A%84%E7%9B%B8%E4%BC%BC%E6%80%A7"><span class="nav-number">4.2.</span> <span class="nav-text">3.2 åˆ†åº“åˆ†è¡¨ä¸HashMapæ‰©å®¹çš„ç›¸ä¼¼æ€§</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-1-%E6%A0%B8%E5%BF%83%E6%80%9D%E6%83%B3%E5%AF%B9%E6%AF%94"><span class="nav-number">4.2.1.</span> <span class="nav-text">3.2.1 æ ¸å¿ƒæ€æƒ³å¯¹æ¯”</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-2-%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C%E7%9A%84%E5%BA%94%E7%94%A8"><span class="nav-number">4.2.2.</span> <span class="nav-text">3.2.2 ä¸€è‡´æ€§å“ˆå¸Œçš„åº”ç”¨</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-%E5%88%86%E7%89%87%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99"><span class="nav-number">4.3.</span> <span class="nav-text">3.3 åˆ†ç‰‡ç®—æ³•è®¾è®¡åŸåˆ™</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-1-%E5%B8%B8%E8%A7%81%E5%88%86%E7%89%87%E7%AE%97%E6%B3%95%E8%AF%A6%E8%A7%A3"><span class="nav-number">4.3.1.</span> <span class="nav-text">3.3.1 å¸¸è§åˆ†ç‰‡ç®—æ³•è¯¦è§£</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-%E5%8F%96%E6%A8%A1%E5%88%86%E7%89%87%E7%AE%97%E6%B3%95%EF%BC%88Modulo-Sharding%EF%BC%89"><span class="nav-number">4.3.1.1.</span> <span class="nav-text">1. å–æ¨¡åˆ†ç‰‡ç®—æ³•ï¼ˆModulo Shardingï¼‰</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E5%88%86%E7%89%87%E9%94%AE%E9%80%89%E6%8B%A9%E4%B8%8E%E8%AE%BE%E8%AE%A1%E7%AD%96%E7%95%A5"><span class="nav-number">5.</span> <span class="nav-text">4. åˆ†ç‰‡é”®é€‰æ‹©ä¸è®¾è®¡ç­–ç•¥</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E5%88%86%E7%89%87%E9%94%AE%E9%80%89%E6%8B%A9%E5%8E%9F%E5%88%99"><span class="nav-number">5.1.</span> <span class="nav-text">4.1 åˆ†ç‰‡é”®é€‰æ‹©åŸåˆ™</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-1-%E6%A0%B8%E5%BF%83%E5%8E%9F%E5%88%99"><span class="nav-number">5.1.1.</span> <span class="nav-text">4.1.1 æ ¸å¿ƒåŸåˆ™</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-2-%E5%88%86%E7%89%87%E9%94%AE%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F"><span class="nav-number">5.1.2.</span> <span class="nav-text">4.1.2 åˆ†ç‰‡é”®è®¾è®¡æ¨¡å¼</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E5%AE%9E%E9%99%85%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF%E5%88%86%E6%9E%90"><span class="nav-number">5.2.</span> <span class="nav-text">4.2 å®é™…ä¸šåŠ¡åœºæ™¯åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-1-%E7%94%B5%E5%95%86%E7%B3%BB%E7%BB%9F%E5%88%86%E7%89%87%E8%AE%BE%E8%AE%A1"><span class="nav-number">5.2.1.</span> <span class="nav-text">4.2.1 ç”µå•†ç³»ç»Ÿåˆ†ç‰‡è®¾è®¡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-2-%E7%A4%BE%E4%BA%A4%E5%AA%92%E4%BD%93%E7%B3%BB%E7%BB%9F%E5%88%86%E7%89%87%E8%AE%BE%E8%AE%A1"><span class="nav-number">5.2.2.</span> <span class="nav-text">4.2.2 ç¤¾äº¤åª’ä½“ç³»ç»Ÿåˆ†ç‰‡è®¾è®¡</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E6%95%B0%E6%8D%AE%E5%80%BE%E6%96%9C%E9%97%AE%E9%A2%98%E8%AF%86%E5%88%AB%E4%B8%8E%E6%B2%BB%E7%90%86"><span class="nav-number">6.</span> <span class="nav-text">5. æ•°æ®å€¾æ–œé—®é¢˜è¯†åˆ«ä¸æ²»ç†</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-%E6%95%B0%E6%8D%AE%E5%80%BE%E6%96%9C%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="nav-number">6.1.</span> <span class="nav-text">5.1 æ•°æ®å€¾æ–œé—®é¢˜åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-1-%E5%80%BE%E6%96%9C%E7%B1%BB%E5%9E%8B%E8%AF%86%E5%88%AB"><span class="nav-number">6.1.1.</span> <span class="nav-text">5.1.1 å€¾æ–œç±»å‹è¯†åˆ«</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-2-%E5%80%BE%E6%96%9C%E7%9B%91%E6%8E%A7%E6%8C%87%E6%A0%87"><span class="nav-number">6.1.2.</span> <span class="nav-text">5.1.2 å€¾æ–œç›‘æ§æŒ‡æ ‡</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-%E6%95%B0%E6%8D%AE%E5%80%BE%E6%96%9C%E6%B2%BB%E7%90%86%E6%96%B9%E6%A1%88"><span class="nav-number">6.2.</span> <span class="nav-text">5.2 æ•°æ®å€¾æ–œæ²»ç†æ–¹æ¡ˆ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-2-1-%E9%A2%84%E9%98%B2%E6%80%A7%E6%8E%AA%E6%96%BD"><span class="nav-number">6.2.1.</span> <span class="nav-text">5.2.1 é¢„é˜²æ€§æªæ–½</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-2-2-%E6%B2%BB%E7%90%86%E6%80%A7%E6%8E%AA%E6%96%BD"><span class="nav-number">6.2.2.</span> <span class="nav-text">5.2.2 æ²»ç†æ€§æªæ–½</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">7.</span> <span class="nav-text">6. åˆ†åº“åˆ†è¡¨æœ€ä½³å®è·µ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">7.1.</span> <span class="nav-text">6.1 æ¶æ„è®¾è®¡æœ€ä½³å®è·µ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1-1-%E5%88%86%E7%89%87%E7%AD%96%E7%95%A5%E9%80%89%E6%8B%A9"><span class="nav-number">7.1.1.</span> <span class="nav-text">6.1.1 åˆ†ç‰‡ç­–ç•¥é€‰æ‹©</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1-2-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5"><span class="nav-number">7.1.2.</span> <span class="nav-text">6.1.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-%E8%BF%90%E7%BB%B4%E7%AE%A1%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">7.2.</span> <span class="nav-text">6.2 è¿ç»´ç®¡ç†æœ€ä½³å®è·µ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-2-1-%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6%E4%BD%93%E7%B3%BB"><span class="nav-number">7.2.1.</span> <span class="nav-text">6.2.1 ç›‘æ§å‘Šè­¦ä½“ç³»</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-2-2-%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86%E9%A2%84%E6%A1%88"><span class="nav-number">7.2.2.</span> <span class="nav-text">6.2.2 æ•…éšœå¤„ç†é¢„æ¡ˆ</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="haiqingxx8"
      src="/myblog/images/headimg.jpeg">
  <p class="site-author-name" itemprop="name">haiqingxx8</p>
  <div class="site-description" itemprop="description">ä¸ªäººæŠ€æœ¯åšå®¢ï¼Œä¸“æ³¨äºJavaåç«¯ã€å‰ç«¯å¼€å‘ã€ç³»ç»Ÿæ¶æ„ç­‰æŠ€æœ¯åˆ†äº«</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/myblog/archives/">
          <span class="site-state-item-count">33</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/myblog/categories/">
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/myblog/tags/">
        <span class="site-state-item-count">123</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://haiqingxx8.github.io/myblog/" title="GitHub â†’ https:&#x2F;&#x2F;haiqingxx8.github.io&#x2F;myblog&#x2F;" rel="noopener me"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/yourusername" title="Weibo â†’ https:&#x2F;&#x2F;weibo.com&#x2F;yourusername" rel="noopener me" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="/myblog/images/wechat-qr.png" title="WeChat â†’ &#x2F;images&#x2F;wechat-qr.png" rel="noopener me"><i class="fab fa-weixin fa-fw"></i>WeChat</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://haiqingxx8.github.io/2023/01/25/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88%E4%BB%A5%E5%8F%8A%E6%95%B0%E6%8D%AE%E5%80%BE%E6%96%9C%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/myblog/images/headimg.jpeg">
      <meta itemprop="name" content="haiqingxx8">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æˆ‘çš„æŠ€æœ¯åšå®¢">
      <meta itemprop="description" content="ä¸ªäººæŠ€æœ¯åšå®¢ï¼Œä¸“æ³¨äºJavaåç«¯ã€å‰ç«¯å¼€å‘ã€ç³»ç»Ÿæ¶æ„ç­‰æŠ€æœ¯åˆ†äº«">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="æ•°æ®åº“åˆ†åº“åˆ†è¡¨å®ç°æ–¹æ¡ˆæ·±åº¦è§£æï¼šä»æ¶æ„è®¾è®¡åˆ°æ•°æ®å€¾æ–œæ²»ç† | æˆ‘çš„æŠ€æœ¯åšå®¢">
      <meta itemprop="description" content="æ·±å…¥å‰–ææ•°æ®åº“åˆ†åº“åˆ†è¡¨çš„æ ¸å¿ƒåŸç†ä¸å®ç°æ–¹æ¡ˆï¼Œè¯¦è§£ShardingSphereã€MyCatç­‰ä¸»æµä¸­é—´ä»¶çš„æ¶æ„è®¾è®¡ï¼Œæ¢è®¨ä¸HashMapæ‰©å®¹æœºåˆ¶çš„å¼‚æ›²åŒå·¥ä¹‹å¦™ï¼Œæä¾›åˆ†ç‰‡é”®é€‰æ‹©ç­–ç•¥å’Œæ•°æ®å€¾æ–œæ²»ç†æ–¹æ¡ˆ">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          æ•°æ®åº“åˆ†åº“åˆ†è¡¨å®ç°æ–¹æ¡ˆæ·±åº¦è§£æï¼šä»æ¶æ„è®¾è®¡åˆ°æ•°æ®å€¾æ–œæ²»ç†
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2023-01-25 10:30:00" itemprop="dateCreated datePublished" datetime="2023-01-25T10:30:00+08:00">2023-01-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/myblog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">æ•°æ®åº“</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/myblog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">åˆ†å¸ƒå¼æ¶æ„</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/myblog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" itemprop="url" rel="index"><span itemprop="name">æ€§èƒ½ä¼˜åŒ–</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="é˜…è¯»æ¬¡æ•°" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

            <div class="post-description">æ·±å…¥å‰–ææ•°æ®åº“åˆ†åº“åˆ†è¡¨çš„æ ¸å¿ƒåŸç†ä¸å®ç°æ–¹æ¡ˆï¼Œè¯¦è§£ShardingSphereã€MyCatç­‰ä¸»æµä¸­é—´ä»¶çš„æ¶æ„è®¾è®¡ï¼Œæ¢è®¨ä¸HashMapæ‰©å®¹æœºåˆ¶çš„å¼‚æ›²åŒå·¥ä¹‹å¦™ï¼Œæä¾›åˆ†ç‰‡é”®é€‰æ‹©ç­–ç•¥å’Œæ•°æ®å€¾æ–œæ²»ç†æ–¹æ¡ˆ</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="ğŸš€-å‰è¨€"><a href="#ğŸš€-å‰è¨€" class="headerlink" title="ğŸš€ å‰è¨€"></a>ğŸš€ å‰è¨€</h2><p>éšç€äº’è”ç½‘ä¸šåŠ¡çš„å¿«é€Ÿå‘å±•ï¼Œå•ä¸€æ•°æ®åº“é¢ä¸´ç€å­˜å‚¨å®¹é‡ã€å¹¶å‘æ€§èƒ½ã€å¯ç”¨æ€§ç­‰å¤šé‡æŒ‘æˆ˜ã€‚åˆ†åº“åˆ†è¡¨ä½œä¸ºæ•°æ®åº“æ°´å¹³æ‰©å±•çš„æ ¸å¿ƒæŠ€æœ¯ï¼Œå·²æˆä¸ºå¤§å‹äº’è”ç½‘ç³»ç»Ÿæ¶æ„è®¾è®¡çš„å¿…å¤‡æŠ€èƒ½ã€‚æœ¬æ–‡å°†ä»ç†è®ºåŸºç¡€åˆ°å®è·µåº”ç”¨ï¼Œå…¨é¢è§£æåˆ†åº“åˆ†è¡¨çš„å®ç°æ–¹æ¡ˆå’Œæœ€ä½³å®è·µã€‚</p>
<p><strong>æ ¸å¿ƒå†…å®¹</strong>ï¼š</p>
<ul>
<li>ğŸ¯ åˆ†åº“åˆ†è¡¨æ ¸å¿ƒæ¦‚å¿µä¸æ¶æ„è®¾è®¡</li>
<li>ğŸ¯ ä¸»æµåˆ†åº“åˆ†è¡¨ä¸­é—´ä»¶æ·±åº¦å¯¹æ¯”</li>
<li>ğŸ¯ åˆ†ç‰‡ç®—æ³•ä¸HashMapæ‰©å®¹æœºåˆ¶çš„ç›¸ä¼¼æ€§</li>
<li>ğŸ¯ åˆ†ç‰‡é”®é€‰æ‹©ç­–ç•¥ä¸è®¾è®¡åŸåˆ™</li>
<li>ğŸ¯ æ•°æ®å€¾æ–œé—®é¢˜è¯†åˆ«ä¸æ²»ç†æ–¹æ¡ˆ</li>
<li>ğŸ¯ åˆ†åº“åˆ†è¡¨æœ€ä½³å®è·µä¸æ€§èƒ½ä¼˜åŒ–</li>
</ul>
<span id="more"></span>

<h2 id="1-åˆ†åº“åˆ†è¡¨åŸºç¡€ç†è®º"><a href="#1-åˆ†åº“åˆ†è¡¨åŸºç¡€ç†è®º" class="headerlink" title="1. åˆ†åº“åˆ†è¡¨åŸºç¡€ç†è®º"></a>1. åˆ†åº“åˆ†è¡¨åŸºç¡€ç†è®º</h2><h3 id="1-1-æ ¸å¿ƒæ¦‚å¿µè§£æ"><a href="#1-1-æ ¸å¿ƒæ¦‚å¿µè§£æ" class="headerlink" title="1.1 æ ¸å¿ƒæ¦‚å¿µè§£æ"></a>1.1 æ ¸å¿ƒæ¦‚å¿µè§£æ</h3><p><strong>åˆ†åº“åˆ†è¡¨</strong>æ˜¯å°†åŸæœ¬å­˜å‚¨åœ¨å•ä¸€æ•°æ®åº“ä¸­çš„æ•°æ®ï¼ŒæŒ‰ç…§ä¸€å®šè§„åˆ™åˆ†æ•£å­˜å‚¨åˆ°å¤šä¸ªæ•°æ®åº“å’Œè¡¨ä¸­çš„æŠ€æœ¯æ–¹æ¡ˆã€‚</p>
<h4 id="1-1-1-åˆ†åº“ï¼ˆDatabase-Shardingï¼‰"><a href="#1-1-1-åˆ†åº“ï¼ˆDatabase-Shardingï¼‰" class="headerlink" title="1.1.1 åˆ†åº“ï¼ˆDatabase Shardingï¼‰"></a>1.1.1 åˆ†åº“ï¼ˆDatabase Shardingï¼‰</h4><p><strong>å‚ç›´åˆ†åº“</strong>ï¼šæŒ‰ä¸šåŠ¡æ¨¡å—å°†ä¸åŒè¡¨åˆ†å¸ƒåˆ°ä¸åŒæ•°æ®åº“ä¸­ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- åŸå§‹å•åº“ç»“æ„</span></span><br><span class="line">Database: ecommerce</span><br><span class="line">â”œâ”€â”€ users          <span class="comment">-- ç”¨æˆ·è¡¨</span></span><br><span class="line">â”œâ”€â”€ products       <span class="comment">-- å•†å“è¡¨</span></span><br><span class="line">â”œâ”€â”€ orders         <span class="comment">-- è®¢å•è¡¨</span></span><br><span class="line">â”œâ”€â”€ payments       <span class="comment">-- æ”¯ä»˜è¡¨</span></span><br><span class="line">â””â”€â”€ logistics      <span class="comment">-- ç‰©æµè¡¨</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- å‚ç›´åˆ†åº“å</span></span><br><span class="line">Database: user_db</span><br><span class="line">â””â”€â”€ users</span><br><span class="line"></span><br><span class="line">Database: product_db</span><br><span class="line">â””â”€â”€ products</span><br><span class="line"></span><br><span class="line">Database: order_db</span><br><span class="line">â”œâ”€â”€ orders</span><br><span class="line">â”œâ”€â”€ payments</span><br><span class="line">â””â”€â”€ logistics</span><br></pre></td></tr></table></figure>

<p><strong>æ°´å¹³åˆ†åº“</strong>ï¼šå°†åŒä¸€å¼ è¡¨çš„æ•°æ®æŒ‰ç…§åˆ†ç‰‡è§„åˆ™åˆ†å¸ƒåˆ°å¤šä¸ªæ•°æ®åº“ä¸­ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- æ°´å¹³åˆ†åº“ç¤ºä¾‹ï¼šæŒ‰ç”¨æˆ·IDåˆ†åº“</span></span><br><span class="line">Database: user_db_0  <span class="comment">-- å­˜å‚¨ user_id % 4 = 0 çš„ç”¨æˆ·</span></span><br><span class="line">Database: user_db_1  <span class="comment">-- å­˜å‚¨ user_id % 4 = 1 çš„ç”¨æˆ·</span></span><br><span class="line">Database: user_db_2  <span class="comment">-- å­˜å‚¨ user_id % 4 = 2 çš„ç”¨æˆ·</span></span><br><span class="line">Database: user_db_3  <span class="comment">-- å­˜å‚¨ user_id % 4 = 3 çš„ç”¨æˆ·</span></span><br></pre></td></tr></table></figure>

<h4 id="1-1-2-åˆ†è¡¨ï¼ˆTable-Shardingï¼‰"><a href="#1-1-2-åˆ†è¡¨ï¼ˆTable-Shardingï¼‰" class="headerlink" title="1.1.2 åˆ†è¡¨ï¼ˆTable Shardingï¼‰"></a>1.1.2 åˆ†è¡¨ï¼ˆTable Shardingï¼‰</h4><p><strong>å‚ç›´åˆ†è¡¨</strong>ï¼šå°†ä¸€å¼ è¡¨æŒ‰å­—æ®µæ‹†åˆ†æˆå¤šå¼ è¡¨ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- åŸå§‹ç”¨æˆ·è¡¨</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users (</span><br><span class="line">    user_id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    username <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    phone <span class="type">VARCHAR</span>(<span class="number">20</span>),</span><br><span class="line">    profile_photo LONGBLOB,     <span class="comment">-- å¤§å­—æ®µ</span></span><br><span class="line">    personal_info TEXT,         <span class="comment">-- å¤§å­—æ®µ</span></span><br><span class="line">    created_at <span class="type">TIMESTAMP</span>,</span><br><span class="line">    updated_at <span class="type">TIMESTAMP</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- å‚ç›´åˆ†è¡¨å</span></span><br><span class="line"><span class="comment">-- åŸºç¡€ä¿¡æ¯è¡¨</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users_basic (</span><br><span class="line">    user_id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    username <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    phone <span class="type">VARCHAR</span>(<span class="number">20</span>),</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span>,</span><br><span class="line">    updated_at <span class="type">TIMESTAMP</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ‰©å±•ä¿¡æ¯è¡¨</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> users_profile (</span><br><span class="line">    user_id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    profile_photo LONGBLOB,</span><br><span class="line">    personal_info TEXT,</span><br><span class="line">    <span class="keyword">FOREIGN KEY</span> (user_id) <span class="keyword">REFERENCES</span> users_basic(user_id)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><strong>æ°´å¹³åˆ†è¡¨</strong>ï¼šå°†åŒä¸€å¼ è¡¨çš„æ•°æ®æŒ‰ç…§åˆ†ç‰‡è§„åˆ™åˆ†å¸ƒåˆ°å¤šå¼ è¡¨ä¸­ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- æ°´å¹³åˆ†è¡¨ç¤ºä¾‹ï¼šæŒ‰æ—¶é—´åˆ†è¡¨</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders_202301 (  <span class="comment">-- 2023å¹´1æœˆè®¢å•</span></span><br><span class="line">    order_id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    user_id <span class="type">BIGINT</span>,</span><br><span class="line">    amount <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE TABLE</span> orders_202302 (  <span class="comment">-- 2023å¹´2æœˆè®¢å•</span></span><br><span class="line">    order_id <span class="type">BIGINT</span> <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    user_id <span class="type">BIGINT</span>,</span><br><span class="line">    amount <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="1-2-åˆ†åº“åˆ†è¡¨çš„å¿…è¦æ€§"><a href="#1-2-åˆ†åº“åˆ†è¡¨çš„å¿…è¦æ€§" class="headerlink" title="1.2 åˆ†åº“åˆ†è¡¨çš„å¿…è¦æ€§"></a>1.2 åˆ†åº“åˆ†è¡¨çš„å¿…è¦æ€§</h3><h4 id="1-2-1-æ€§èƒ½ç“¶é¢ˆåˆ†æ"><a href="#1-2-1-æ€§èƒ½ç“¶é¢ˆåˆ†æ" class="headerlink" title="1.2.1 æ€§èƒ½ç“¶é¢ˆåˆ†æ"></a>1.2.1 æ€§èƒ½ç“¶é¢ˆåˆ†æ</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å•è¡¨æ€§èƒ½æµ‹è¯•æ•°æ®</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabasePerformanceAnalysis</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¸åŒæ•°æ®é‡ä¸‹çš„æŸ¥è¯¢æ€§èƒ½å¯¹æ¯”</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">performanceComparison</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * æ•°æ®é‡ä¸æŸ¥è¯¢æ€§èƒ½å…³ç³»ï¼š</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * æ•°æ®é‡     | ç´¢å¼•æŸ¥è¯¢è€—æ—¶ | å…¨è¡¨æ‰«æè€—æ—¶ | æ’å…¥æ€§èƒ½</span></span><br><span class="line"><span class="comment">         * ---------|------------|------------|--------</span></span><br><span class="line"><span class="comment">         * 100ä¸‡     | 10ms       | 2s         | æ­£å¸¸</span></span><br><span class="line"><span class="comment">         * 1000ä¸‡    | 50ms       | 20s        | è¾ƒæ…¢</span></span><br><span class="line"><span class="comment">         * 1äº¿       | 200ms      | 200s       | å¾ˆæ…¢</span></span><br><span class="line"><span class="comment">         * 10äº¿      | 1s         | 2000s      | ææ…¢</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¹¶å‘è¿æ¥æ•°é™åˆ¶</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">connectionLimits</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * MySQLé»˜è®¤é…ç½®ï¼š</span></span><br><span class="line"><span class="comment">         * max_connections = 151</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * é«˜å¹¶å‘åœºæ™¯é—®é¢˜ï¼š</span></span><br><span class="line"><span class="comment">         * - è¿æ¥æ± è€—å°½</span></span><br><span class="line"><span class="comment">         * - é”ç«äº‰æ¿€çƒˆ</span></span><br><span class="line"><span class="comment">         * - CPUå’ŒIOèµ„æºäº‰æŠ¢</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-2-å­˜å‚¨å®¹é‡é™åˆ¶"><a href="#1-2-2-å­˜å‚¨å®¹é‡é™åˆ¶" class="headerlink" title="1.2.2 å­˜å‚¨å®¹é‡é™åˆ¶"></a>1.2.2 å­˜å‚¨å®¹é‡é™åˆ¶</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- MySQLå­˜å‚¨å¼•æ“é™åˆ¶</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">MyISAM:</span></span><br><span class="line"><span class="comment">- å•è¡¨æœ€å¤§: 256TB</span></span><br><span class="line"><span class="comment">- å•è¡Œæœ€å¤§: 65535å­—èŠ‚</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">InnoDB:</span></span><br><span class="line"><span class="comment">- å•è¡¨æœ€å¤§: 256TB</span></span><br><span class="line"><span class="comment">- å•è¡Œæœ€å¤§: 65535å­—èŠ‚</span></span><br><span class="line"><span class="comment">- å•ä¸ªæ•°æ®åº“æœ€å¤§: æ— é™åˆ¶ï¼ˆå®é™…å—æ–‡ä»¶ç³»ç»Ÿé™åˆ¶ï¼‰</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">å®é™…ç”Ÿäº§ç¯å¢ƒå»ºè®®ï¼š</span></span><br><span class="line"><span class="comment">- å•è¡¨æ•°æ®é‡æ§åˆ¶åœ¨1000ä¸‡ä»¥å†…</span></span><br><span class="line"><span class="comment">- å•åº“æ•°æ®é‡æ§åˆ¶åœ¨100GBä»¥å†…</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h2 id="2-ä¸»æµåˆ†åº“åˆ†è¡¨è§£å†³æ–¹æ¡ˆ"><a href="#2-ä¸»æµåˆ†åº“åˆ†è¡¨è§£å†³æ–¹æ¡ˆ" class="headerlink" title="2. ä¸»æµåˆ†åº“åˆ†è¡¨è§£å†³æ–¹æ¡ˆ"></a>2. ä¸»æµåˆ†åº“åˆ†è¡¨è§£å†³æ–¹æ¡ˆ</h2><h3 id="2-1-Apache-ShardingSphere"><a href="#2-1-Apache-ShardingSphere" class="headerlink" title="2.1 Apache ShardingSphere"></a>2.1 Apache ShardingSphere</h3><h4 id="2-1-1-æ¶æ„è®¾è®¡"><a href="#2-1-1-æ¶æ„è®¾è®¡" class="headerlink" title="2.1.1 æ¶æ„è®¾è®¡"></a>2.1.1 æ¶æ„è®¾è®¡</h4><p><strong>ShardingSphereç”Ÿæ€</strong>ï¼š</p>
<ul>
<li><strong>Sharding-JDBC</strong>ï¼šè½»é‡çº§Javaæ¡†æ¶ï¼Œå®¢æˆ·ç«¯ç›´è¿</li>
<li><strong>Sharding-Proxy</strong>ï¼šé€æ˜åŒ–æ•°æ®åº“ä»£ç†ç«¯</li>
<li><strong>Sharding-Sidecar</strong>ï¼šKubernetesäº‘åŸç”Ÿæ•°æ®åº“ä»£ç†</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sharding-JDBCé…ç½®ç¤ºä¾‹</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShardingConfiguration</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">shardingDataSource</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="comment">// é…ç½®çœŸå®æ•°æ®æº</span></span><br><span class="line">        Map&lt;String, DataSource&gt; dataSourceMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        dataSourceMap.put(<span class="string">&quot;ds0&quot;</span>, createDataSource(<span class="string">&quot;ds0&quot;</span>));</span><br><span class="line">        dataSourceMap.put(<span class="string">&quot;ds1&quot;</span>, createDataSource(<span class="string">&quot;ds1&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é…ç½®åˆ†åº“ç­–ç•¥</span></span><br><span class="line">        <span class="type">DatabaseShardingStrategyConfiguration</span> <span class="variable">dbShardingStrategy</span> <span class="operator">=</span> </span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">DatabaseShardingStrategyConfiguration</span>(</span><br><span class="line">                <span class="string">&quot;user_id&quot;</span>, </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ModuloShardingAlgorithm</span>()</span><br><span class="line">            );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é…ç½®åˆ†è¡¨ç­–ç•¥</span></span><br><span class="line">        <span class="type">TableShardingStrategyConfiguration</span> <span class="variable">tableShardingStrategy</span> <span class="operator">=</span> </span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">TableShardingStrategyConfiguration</span>(</span><br><span class="line">                <span class="string">&quot;order_id&quot;</span>, </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ModuloShardingAlgorithm</span>()</span><br><span class="line">            );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é…ç½®åˆ†ç‰‡è§„åˆ™</span></span><br><span class="line">        <span class="type">ShardingRuleConfiguration</span> <span class="variable">shardingRuleConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShardingRuleConfiguration</span>();</span><br><span class="line">        shardingRuleConfig.setDefaultDatabaseShardingStrategyConfig(dbShardingStrategy);</span><br><span class="line">        shardingRuleConfig.setDefaultTableShardingStrategyConfig(tableShardingStrategy);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ShardingDataSourceFactory.createDataSource(dataSourceMap, shardingRuleConfig, <span class="keyword">new</span> <span class="title class_">Properties</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è‡ªå®šä¹‰åˆ†ç‰‡ç®—æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ModuloShardingAlgorithm</span> <span class="keyword">implements</span> <span class="title class_">PreciseShardingAlgorithm</span>&lt;Long&gt; &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">doSharding</span><span class="params">(Collection&lt;String&gt; availableTargetNames, </span></span><br><span class="line"><span class="params">                               PreciseShardingValue&lt;Long&gt; shardingValue)</span> &#123;</span><br><span class="line">            <span class="comment">// å–æ¨¡åˆ†ç‰‡</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">mod</span> <span class="operator">=</span> shardingValue.getValue() % availableTargetNames.size();</span><br><span class="line">            <span class="keyword">return</span> availableTargetNames.stream()</span><br><span class="line">                    .sorted()</span><br><span class="line">                    .collect(Collectors.toList())</span><br><span class="line">                    .get((<span class="type">int</span>) mod);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-1-2-æ ¸å¿ƒç‰¹æ€§"><a href="#2-1-2-æ ¸å¿ƒç‰¹æ€§" class="headerlink" title="2.1.2 æ ¸å¿ƒç‰¹æ€§"></a>2.1.2 æ ¸å¿ƒç‰¹æ€§</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ShardingSphereé…ç½®æ–‡ä»¶ç¤ºä¾‹</span></span><br><span class="line"><span class="attr">sharding:</span></span><br><span class="line">  <span class="attr">tables:</span></span><br><span class="line">    <span class="attr">t_order:</span></span><br><span class="line">      <span class="attr">actual-data-nodes:</span> <span class="string">ds$-&gt;&#123;0..1&#125;.t_order$-&gt;&#123;0..1&#125;</span></span><br><span class="line">      <span class="attr">database-strategy:</span></span><br><span class="line">        <span class="attr">inline:</span></span><br><span class="line">          <span class="attr">sharding-column:</span> <span class="string">user_id</span></span><br><span class="line">          <span class="attr">algorithm-expression:</span> <span class="string">ds$-&gt;&#123;user_id</span> <span class="string">%</span> <span class="number">2</span><span class="string">&#125;</span></span><br><span class="line">      <span class="attr">table-strategy:</span></span><br><span class="line">        <span class="attr">inline:</span></span><br><span class="line">          <span class="attr">sharding-column:</span> <span class="string">order_id</span></span><br><span class="line">          <span class="attr">algorithm-expression:</span> <span class="string">t_order$-&gt;&#123;order_id</span> <span class="string">%</span> <span class="number">2</span><span class="string">&#125;</span></span><br><span class="line">      <span class="attr">key-generator:</span></span><br><span class="line">        <span class="attr">column:</span> <span class="string">order_id</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">SNOWFLAKE</span></span><br><span class="line">        <span class="attr">props:</span></span><br><span class="line">          <span class="attr">worker.id:</span> <span class="number">123</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># ç»‘å®šè¡¨é…ç½®</span></span><br><span class="line">  <span class="attr">binding-tables:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">t_order,t_order_item</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># å¹¿æ’­è¡¨é…ç½®</span></span><br><span class="line">  <span class="attr">broadcast-tables:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">t_config</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">t_dict</span></span><br><span class="line"></span><br><span class="line"><span class="attr">datasource:</span></span><br><span class="line">  <span class="attr">ds0:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.zaxxer.hikari.HikariDataSource</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">jdbc-url:</span> <span class="string">jdbc:mysql://localhost:3306/demo_ds_0</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">ds1:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.zaxxer.hikari.HikariDataSource</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">jdbc-url:</span> <span class="string">jdbc:mysql://localhost:3306/demo_ds_1</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-MyCat"><a href="#2-2-MyCat" class="headerlink" title="2.2 MyCat"></a>2.2 MyCat</h3><h4 id="2-2-1-æ¶æ„ç‰¹ç‚¹"><a href="#2-2-1-æ¶æ„ç‰¹ç‚¹" class="headerlink" title="2.2.1 æ¶æ„ç‰¹ç‚¹"></a>2.2.1 æ¶æ„ç‰¹ç‚¹</h4><p><strong>MyCatæ ¸å¿ƒç»„ä»¶</strong>ï¼š</p>
<ul>
<li><strong>è·¯ç”±æ¨¡å—</strong>ï¼šSQLè§£æå’Œè·¯ç”±åˆ†å‘</li>
<li><strong>è¿æ¥æ± æ¨¡å—</strong>ï¼šåç«¯æ•°æ®åº“è¿æ¥ç®¡ç†</li>
<li><strong>ç¼“å­˜æ¨¡å—</strong>ï¼šæŸ¥è¯¢ç»“æœç¼“å­˜</li>
<li><strong>ç›‘æ§æ¨¡å—</strong>ï¼šæ€§èƒ½ç›‘æ§å’Œç»Ÿè®¡</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- MyCat schema.xmlé…ç½® --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;TESTDB&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;false&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- åˆ†ç‰‡è¡¨é…ç½® --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;t_order&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;order_id&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3,dn4&quot;</span> </span></span><br><span class="line"><span class="tag">               <span class="attr">rule</span>=<span class="string">&quot;mod-long&quot;</span> /&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- å…¨å±€è¡¨é…ç½® --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;t_dict&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> <span class="attr">type</span>=<span class="string">&quot;global&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3,dn4&quot;</span> /&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- ERè¡¨é…ç½® --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;t_order_item&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;item_id&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3,dn4&quot;</span> </span></span><br><span class="line"><span class="tag">               <span class="attr">rule</span>=<span class="string">&quot;mod-long&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">childTable</span> <span class="attr">name</span>=<span class="string">&quot;t_order_detail&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;detail_id&quot;</span> <span class="attr">joinKey</span>=<span class="string">&quot;item_id&quot;</span> </span></span><br><span class="line"><span class="tag">                       <span class="attr">parentKey</span>=<span class="string">&quot;item_id&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- æ•°æ®èŠ‚ç‚¹é…ç½® --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;localhost1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;db1&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn2&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;localhost1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;db2&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn3&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;localhost2&quot;</span> <span class="attr">database</span>=<span class="string">&quot;db3&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn4&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;localhost2&quot;</span> <span class="attr">database</span>=<span class="string">&quot;db4&quot;</span> /&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- æ•°æ®ä¸»æœºé…ç½® --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;localhost1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span> </span></span><br><span class="line"><span class="tag">              <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;hostM1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;localhost:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">&quot;hostS2&quot;</span> <span class="attr">url</span>=<span class="string">&quot;localhost:3307&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-2-2-åˆ†ç‰‡è§„åˆ™é…ç½®"><a href="#2-2-2-åˆ†ç‰‡è§„åˆ™é…ç½®" class="headerlink" title="2.2.2 åˆ†ç‰‡è§„åˆ™é…ç½®"></a>2.2.2 åˆ†ç‰‡è§„åˆ™é…ç½®</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- MyCat rule.xmlé…ç½® --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:rule</span> <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- å–æ¨¡åˆ†ç‰‡ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;mod-long&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">columns</span>&gt;</span>order_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>mod-long<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- èŒƒå›´åˆ†ç‰‡ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;auto-sharding-long&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>rang-long<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- æ—¶é—´åˆ†ç‰‡ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-date&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">columns</span>&gt;</span>create_time<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>partbymonth<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- åˆ†ç‰‡ç®—æ³•å®šä¹‰ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;mod-long&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByMod&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;count&quot;</span>&gt;</span>4<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;rang-long&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.AutoPartitionByLong&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapFile&quot;</span>&gt;</span>autopartition-long.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;partbymonth&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByMonth&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dateFormat&quot;</span>&gt;</span>yyyy-MM-dd<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sBeginDate&quot;</span>&gt;</span>2023-01-01<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:rule</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-ä¸»æµæ–¹æ¡ˆå¯¹æ¯”åˆ†æ"><a href="#2-3-ä¸»æµæ–¹æ¡ˆå¯¹æ¯”åˆ†æ" class="headerlink" title="2.3 ä¸»æµæ–¹æ¡ˆå¯¹æ¯”åˆ†æ"></a>2.3 ä¸»æµæ–¹æ¡ˆå¯¹æ¯”åˆ†æ</h3><h4 id="2-3-1-åŠŸèƒ½ç‰¹æ€§å¯¹æ¯”"><a href="#2-3-1-åŠŸèƒ½ç‰¹æ€§å¯¹æ¯”" class="headerlink" title="2.3.1 åŠŸèƒ½ç‰¹æ€§å¯¹æ¯”"></a>2.3.1 åŠŸèƒ½ç‰¹æ€§å¯¹æ¯”</h4><table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>ShardingSphere</th>
<th>MyCat</th>
<th>TDDL</th>
<th>Cobar</th>
</tr>
</thead>
<tbody><tr>
<td><strong>éƒ¨ç½²æ–¹å¼</strong></td>
<td>å®¢æˆ·ç«¯&#x2F;ä»£ç†</td>
<td>ä»£ç†</td>
<td>å®¢æˆ·ç«¯</td>
<td>ä»£ç†</td>
</tr>
<tr>
<td><strong>å­¦ä¹ æˆæœ¬</strong></td>
<td>ä¸­ç­‰</td>
<td>è¾ƒé«˜</td>
<td>è¾ƒé«˜</td>
<td>é«˜</td>
</tr>
<tr>
<td><strong>æ€§èƒ½æŸè€—</strong></td>
<td>ä½</td>
<td>ä¸­ç­‰</td>
<td>ä½</td>
<td>ä¸­ç­‰</td>
</tr>
<tr>
<td><strong>è¿ç»´å¤æ‚åº¦</strong></td>
<td>ä½</td>
<td>é«˜</td>
<td>ä¸­ç­‰</td>
<td>é«˜</td>
</tr>
<tr>
<td><strong>ç¤¾åŒºæ´»è·ƒåº¦</strong></td>
<td>é«˜</td>
<td>ä¸­ç­‰</td>
<td>ä½</td>
<td>ä½</td>
</tr>
<tr>
<td><strong>æ–‡æ¡£å®Œå–„åº¦</strong></td>
<td>é«˜</td>
<td>ä¸­ç­‰</td>
<td>ä½</td>
<td>ä½</td>
</tr>
<tr>
<td><strong>åˆ†å¸ƒå¼äº‹åŠ¡</strong></td>
<td>æ”¯æŒ</td>
<td>æ”¯æŒ</td>
<td>æœ‰é™æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
</tr>
<tr>
<td><strong>è¯»å†™åˆ†ç¦»</strong></td>
<td>æ”¯æŒ</td>
<td>æ”¯æŒ</td>
<td>æ”¯æŒ</td>
<td>æ”¯æŒ</td>
</tr>
<tr>
<td><strong>åœ¨çº¿æ‰©å®¹</strong></td>
<td>æ”¯æŒ</td>
<td>æœ‰é™æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
</tr>
</tbody></table>
<h4 id="2-3-2-æ€§èƒ½æµ‹è¯•å¯¹æ¯”"><a href="#2-3-2-æ€§èƒ½æµ‹è¯•å¯¹æ¯”" class="headerlink" title="2.3.2 æ€§èƒ½æµ‹è¯•å¯¹æ¯”"></a>2.3.2 æ€§èƒ½æµ‹è¯•å¯¹æ¯”</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ€§èƒ½æµ‹è¯•ç»“æœåˆ†æ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShardingPerformanceTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">performanceComparison</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * æµ‹è¯•ç¯å¢ƒï¼š</span></span><br><span class="line"><span class="comment">         * - 4æ ¸8GæœåŠ¡å™¨</span></span><br><span class="line"><span class="comment">         * - MySQL 8.0</span></span><br><span class="line"><span class="comment">         * - 4ä¸ªåˆ†ç‰‡</span></span><br><span class="line"><span class="comment">         * - 1000ä¸‡æ•°æ®é‡</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * æŸ¥è¯¢æ€§èƒ½å¯¹æ¯”ï¼ˆQPSï¼‰ï¼š</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * åœºæ™¯          | åŸç”ŸMySQL | ShardingSphere | MyCat | æ€§èƒ½æŸè€—</span></span><br><span class="line"><span class="comment">         * -------------|-----------|----------------|-------|--------</span></span><br><span class="line"><span class="comment">         * å•è¡¨æŸ¥è¯¢      | 8000      | 7200           | 6500  | 10-19%</span></span><br><span class="line"><span class="comment">         * è·¨åˆ†ç‰‡æŸ¥è¯¢    | 2000      | 1800           | 1500  | 10-25%</span></span><br><span class="line"><span class="comment">         * èšåˆæŸ¥è¯¢      | 1000      | 800            | 600   | 20-40%</span></span><br><span class="line"><span class="comment">         * äº‹åŠ¡å¤„ç†      | 3000      | 2400           | 2000  | 20-33%</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * å†…å­˜ä½¿ç”¨å¯¹æ¯”ï¼š</span></span><br><span class="line"><span class="comment">         * ShardingSphere: +50MB (å®¢æˆ·ç«¯æ¨¡å¼)</span></span><br><span class="line"><span class="comment">         * MyCat: +200MB (ä»£ç†æ¨¡å¼)</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-åˆ†ç‰‡ç®—æ³•ä¸HashMapæ‰©å®¹çš„å¼‚æ›²åŒå·¥ä¹‹å¦™"><a href="#3-åˆ†ç‰‡ç®—æ³•ä¸HashMapæ‰©å®¹çš„å¼‚æ›²åŒå·¥ä¹‹å¦™" class="headerlink" title="3. åˆ†ç‰‡ç®—æ³•ä¸HashMapæ‰©å®¹çš„å¼‚æ›²åŒå·¥ä¹‹å¦™"></a>3. åˆ†ç‰‡ç®—æ³•ä¸HashMapæ‰©å®¹çš„å¼‚æ›²åŒå·¥ä¹‹å¦™</h2><h3 id="3-1-HashMapæ‰©å®¹æœºåˆ¶å›é¡¾"><a href="#3-1-HashMapæ‰©å®¹æœºåˆ¶å›é¡¾" class="headerlink" title="3.1 HashMapæ‰©å®¹æœºåˆ¶å›é¡¾"></a>3.1 HashMapæ‰©å®¹æœºåˆ¶å›é¡¾</h3><h4 id="3-1-1-HashMapæ ¸å¿ƒåŸç†"><a href="#3-1-1-HashMapæ ¸å¿ƒåŸç†" class="headerlink" title="3.1.1 HashMapæ ¸å¿ƒåŸç†"></a>3.1.1 HashMapæ ¸å¿ƒåŸç†</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// HashMapæ‰©å®¹æœºåˆ¶æºç åˆ†æ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HashMap</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">AbstractMap</span>&lt;K,V&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é»˜è®¤åˆå§‹å®¹é‡ï¼š16</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_INITIAL_CAPACITY</span> <span class="operator">=</span> <span class="number">1</span> &lt;&lt; <span class="number">4</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é»˜è®¤è´Ÿè½½å› å­ï¼š0.75</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">float</span> <span class="variable">DEFAULT_LOAD_FACTOR</span> <span class="operator">=</span> <span class="number">0.75f</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰©å®¹é˜ˆå€¼è®¡ç®—</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">threshold</span> <span class="operator">=</span> (<span class="type">int</span>)(capacity * loadFactor);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å“ˆå¸Œå‡½æ•°ï¼šæ‰°åŠ¨å‡½æ•°</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="type">int</span> h;</span><br><span class="line">        <span class="keyword">return</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å®šä½æ•°ç»„ç´¢å¼•</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> (n - <span class="number">1</span>) &amp; hash;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰©å®¹æ“ä½œ</span></span><br><span class="line">    <span class="keyword">final</span> Node&lt;K,V&gt;[] resize() &#123;</span><br><span class="line">        Node&lt;K,V&gt;[] oldTab = table;</span><br><span class="line">        <span class="type">int</span> <span class="variable">oldCap</span> <span class="operator">=</span> (oldTab == <span class="literal">null</span>) ? <span class="number">0</span> : oldTab.length;</span><br><span class="line">        <span class="type">int</span> <span class="variable">newCap</span> <span class="operator">=</span> oldCap &lt;&lt; <span class="number">1</span>; <span class="comment">// å®¹é‡ç¿»å€</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ•°æ®è¿ç§»ï¼šrehash</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; oldCap; ++j) &#123;</span><br><span class="line">            Node&lt;K,V&gt; e = oldTab[j];</span><br><span class="line">            <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// é‡æ–°è®¡ç®—ç´¢å¼•ä½ç½®</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">newIndex</span> <span class="operator">=</span> e.hash &amp; (newCap - <span class="number">1</span>);</span><br><span class="line">                <span class="comment">// æ•°æ®è¿ç§»åˆ°æ–°ä½ç½®</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> newTab;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-1-2-æ‰©å®¹è¿‡ç¨‹è¯¦è§£"><a href="#3-1-2-æ‰©å®¹è¿‡ç¨‹è¯¦è§£" class="headerlink" title="3.1.2 æ‰©å®¹è¿‡ç¨‹è¯¦è§£"></a>3.1.2 æ‰©å®¹è¿‡ç¨‹è¯¦è§£</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// HashMapæ‰©å®¹è¿‡ç¨‹å¯è§†åŒ–</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HashMapResizeDemo</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demonstrateResize</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * æ‰©å®¹å‰ï¼ˆå®¹é‡=4ï¼‰ï¼š</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * Index | Hash &amp; 3 | Key-Value</span></span><br><span class="line"><span class="comment">         * ------|----------|----------</span></span><br><span class="line"><span class="comment">         *   0   |    0     | (key1, val1)</span></span><br><span class="line"><span class="comment">         *   1   |    1     | (key2, val2)</span></span><br><span class="line"><span class="comment">         *   2   |    2     | (key3, val3)</span></span><br><span class="line"><span class="comment">         *   3   |    3     | (key4, val4)</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * æ‰©å®¹åï¼ˆå®¹é‡=8ï¼‰ï¼š</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * Index | Hash &amp; 7 | Key-Value</span></span><br><span class="line"><span class="comment">         * ------|----------|----------</span></span><br><span class="line"><span class="comment">         *   0   |    0     | (key1, val1) -- ä½ç½®ä¸å˜</span></span><br><span class="line"><span class="comment">         *   1   |    1     | (key2, val2) -- ä½ç½®ä¸å˜</span></span><br><span class="line"><span class="comment">         *   2   |    2     | (key3, val3) -- ä½ç½®ä¸å˜</span></span><br><span class="line"><span class="comment">         *   3   |    3     | (key4, val4) -- ä½ç½®ä¸å˜</span></span><br><span class="line"><span class="comment">         *   4   |    4     | (key5, val5) -- æ–°ä½ç½®</span></span><br><span class="line"><span class="comment">         *   5   |    5     | (key6, val6) -- æ–°ä½ç½®</span></span><br><span class="line"><span class="comment">         *   6   |    6     | (key7, val7) -- æ–°ä½ç½®</span></span><br><span class="line"><span class="comment">         *   7   |    7     | (key8, val8) -- æ–°ä½ç½®</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * å…³é”®ç‰¹æ€§ï¼š</span></span><br><span class="line"><span class="comment">         * 1. å®¹é‡å¿…é¡»æ˜¯2çš„å¹‚æ¬¡æ–¹</span></span><br><span class="line"><span class="comment">         * 2. æ‰©å®¹æ—¶å®¹é‡ç¿»å€</span></span><br><span class="line"><span class="comment">         * 3. ä½¿ç”¨ä½è¿ç®—å¿«é€Ÿå®šä½</span></span><br><span class="line"><span class="comment">         * 4. æ•°æ®è¿ç§»è§„å¾‹æ€§å¼º</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-åˆ†åº“åˆ†è¡¨ä¸HashMapæ‰©å®¹çš„ç›¸ä¼¼æ€§"><a href="#3-2-åˆ†åº“åˆ†è¡¨ä¸HashMapæ‰©å®¹çš„ç›¸ä¼¼æ€§" class="headerlink" title="3.2 åˆ†åº“åˆ†è¡¨ä¸HashMapæ‰©å®¹çš„ç›¸ä¼¼æ€§"></a>3.2 åˆ†åº“åˆ†è¡¨ä¸HashMapæ‰©å®¹çš„ç›¸ä¼¼æ€§</h3><h4 id="3-2-1-æ ¸å¿ƒæ€æƒ³å¯¹æ¯”"><a href="#3-2-1-æ ¸å¿ƒæ€æƒ³å¯¹æ¯”" class="headerlink" title="3.2.1 æ ¸å¿ƒæ€æƒ³å¯¹æ¯”"></a>3.2.1 æ ¸å¿ƒæ€æƒ³å¯¹æ¯”</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ†åº“åˆ†è¡¨ä¸HashMapæ‰©å®¹çš„ç›¸ä¼¼æ€§åˆ†æ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShardingVsHashMapComparison</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. å“ˆå¸Œåˆ†ç‰‡ç®—æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HashSharding</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// HashMapç´¢å¼•è®¡ç®—</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashMapIndex</span><span class="params">(Object key, <span class="type">int</span> capacity)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> hash(key) &amp; (capacity - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆ†åº“åˆ†è¡¨ç´¢å¼•è®¡ç®—</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">shardingIndex</span><span class="params">(Long shardingKey, <span class="type">int</span> shardCount)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;shard_&quot;</span> + (shardingKey.hashCode() &amp; (shardCount - <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * ç›¸ä¼¼ç‚¹ï¼š</span></span><br><span class="line"><span class="comment">         * 1. éƒ½ä½¿ç”¨å“ˆå¸Œå‡½æ•°åˆ†æ•£æ•°æ®</span></span><br><span class="line"><span class="comment">         * 2. éƒ½ä½¿ç”¨ä½è¿ç®—æé«˜æ€§èƒ½</span></span><br><span class="line"><span class="comment">         * 3. éƒ½è¦æ±‚åˆ†ç‰‡æ•°ä¸º2çš„å¹‚æ¬¡æ–¹ï¼ˆæœ€ä¼˜æƒ…å†µï¼‰</span></span><br><span class="line"><span class="comment">         * 4. éƒ½é¢ä¸´æ•°æ®å€¾æ–œé—®é¢˜</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. æ‰©å®¹ç­–ç•¥å¯¹æ¯”</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExpansionStrategy</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// HashMapæ‰©å®¹ï¼šå®¹é‡ç¿»å€</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hashMapExpansion</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * æ‰©å®¹è§¦å‘ï¼šsize &gt; threshold</span></span><br><span class="line"><span class="comment">             * æ‰©å®¹å€æ•°ï¼š2å€</span></span><br><span class="line"><span class="comment">             * æ•°æ®è¿ç§»ï¼šå…¨é‡rehash</span></span><br><span class="line"><span class="comment">             * è¿ç§»è§„å¾‹ï¼šåŸä½ç½® æˆ– åŸä½ç½®+oldCap</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆ†åº“åˆ†è¡¨æ‰©å®¹ï¼šåˆ†ç‰‡æ•°ç¿»å€</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shardingExpansion</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * æ‰©å®¹è§¦å‘ï¼šå­˜å‚¨æˆ–æ€§èƒ½è¾¾åˆ°é˜ˆå€¼</span></span><br><span class="line"><span class="comment">             * æ‰©å®¹å€æ•°ï¼šé€šå¸¸2å€ï¼ˆä¹Ÿå¯ä»¥å…¶ä»–å€æ•°ï¼‰</span></span><br><span class="line"><span class="comment">             * æ•°æ®è¿ç§»ï¼šæŒ‰åˆ†ç‰‡è§„åˆ™é‡æ–°åˆ†å¸ƒ</span></span><br><span class="line"><span class="comment">             * è¿ç§»è§„å¾‹ï¼šæ ¹æ®æ–°çš„åˆ†ç‰‡ç®—æ³•é‡æ–°è®¡ç®—</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. æ•°æ®è¿ç§»ç­–ç•¥</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataMigrationStrategy</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// HashMapæ•°æ®è¿ç§»</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hashMapMigration</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * è¿ç§»æ—¶æœºï¼šæ‰©å®¹æ—¶åŒæ­¥è¿›è¡Œ</span></span><br><span class="line"><span class="comment">             * è¿ç§»æ–¹å¼ï¼šå…¨é‡è¿ç§»</span></span><br><span class="line"><span class="comment">             * è¿ç§»æ•ˆç‡ï¼šO(n)</span></span><br><span class="line"><span class="comment">             * æœåŠ¡å¯ç”¨æ€§ï¼šçŸ­æš‚ä¸å¯ç”¨</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆ†åº“åˆ†è¡¨æ•°æ®è¿ç§»</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shardingMigration</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * è¿ç§»æ—¶æœºï¼šå¯é€‰æ‹©åœ¨çº¿æˆ–ç¦»çº¿</span></span><br><span class="line"><span class="comment">             * è¿ç§»æ–¹å¼ï¼šå¯å¢é‡è¿ç§»</span></span><br><span class="line"><span class="comment">             * è¿ç§»æ•ˆç‡ï¼šå–å†³äºæ•°æ®é‡å’Œç½‘ç»œ</span></span><br><span class="line"><span class="comment">             * æœåŠ¡å¯ç”¨æ€§ï¼šå¯ä¿æŒåœ¨çº¿æœåŠ¡</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-2-ä¸€è‡´æ€§å“ˆå¸Œçš„åº”ç”¨"><a href="#3-2-2-ä¸€è‡´æ€§å“ˆå¸Œçš„åº”ç”¨" class="headerlink" title="3.2.2 ä¸€è‡´æ€§å“ˆå¸Œçš„åº”ç”¨"></a>3.2.2 ä¸€è‡´æ€§å“ˆå¸Œçš„åº”ç”¨</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸€è‡´æ€§å“ˆå¸Œåœ¨åˆ†åº“åˆ†è¡¨ä¸­çš„åº”ç”¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsistentHashingSharding</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SortedMap&lt;Long, String&gt; ring = <span class="keyword">new</span> <span class="title class_">TreeMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">virtualNodes</span> <span class="operator">=</span> <span class="number">150</span>; <span class="comment">// è™šæ‹ŸèŠ‚ç‚¹æ•°</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ·»åŠ åˆ†ç‰‡èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addShard</span><span class="params">(String shardName)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; virtualNodes; i++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">virtualNodeName</span> <span class="operator">=</span> shardName + <span class="string">&quot;#&quot;</span> + i;</span><br><span class="line">            <span class="type">long</span> <span class="variable">hash</span> <span class="operator">=</span> hash(virtualNodeName);</span><br><span class="line">            ring.put(hash, shardName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç§»é™¤åˆ†ç‰‡èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeShard</span><span class="params">(String shardName)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; virtualNodes; i++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">virtualNodeName</span> <span class="operator">=</span> shardName + <span class="string">&quot;#&quot;</span> + i;</span><br><span class="line">            <span class="type">long</span> <span class="variable">hash</span> <span class="operator">=</span> hash(virtualNodeName);</span><br><span class="line">            ring.remove(hash);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–æ•°æ®åº”è¯¥å­˜å‚¨çš„åˆ†ç‰‡</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getShard</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (ring.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">long</span> <span class="variable">hash</span> <span class="operator">=</span> hash(key);</span><br><span class="line">        SortedMap&lt;Long, String&gt; tailMap = ring.tailMap(hash);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ¯”hashå¤§çš„èŠ‚ç‚¹ï¼Œåˆ™ä½¿ç”¨ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">nodeHash</span> <span class="operator">=</span> tailMap.isEmpty() ? ring.firstKey() : tailMap.firstKey();</span><br><span class="line">        <span class="keyword">return</span> ring.get(nodeHash);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å“ˆå¸Œå‡½æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="title function_">hash</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨MD5æˆ–å…¶ä»–å“ˆå¸Œç®—æ³•</span></span><br><span class="line">        <span class="keyword">return</span> key.hashCode();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * ä¸€è‡´æ€§å“ˆå¸Œä¼˜åŠ¿ï¼š</span></span><br><span class="line"><span class="comment">     * 1. æ‰©å®¹æ—¶åªéœ€è¿ç§»éƒ¨åˆ†æ•°æ®</span></span><br><span class="line"><span class="comment">     * 2. èŠ‚ç‚¹æ•…éšœå½±å“èŒƒå›´æœ‰é™</span></span><br><span class="line"><span class="comment">     * 3. è´Ÿè½½åˆ†å¸ƒç›¸å¯¹å‡åŒ€</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * ä¸HashMapæ‰©å®¹å¯¹æ¯”ï¼š</span></span><br><span class="line"><span class="comment">     * HashMap: å…¨é‡æ•°æ®é‡æ–°åˆ†å¸ƒ</span></span><br><span class="line"><span class="comment">     * ä¸€è‡´æ€§å“ˆå¸Œ: åªæœ‰éƒ¨åˆ†æ•°æ®éœ€è¦è¿ç§»</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-åˆ†ç‰‡ç®—æ³•è®¾è®¡åŸåˆ™"><a href="#3-3-åˆ†ç‰‡ç®—æ³•è®¾è®¡åŸåˆ™" class="headerlink" title="3.3 åˆ†ç‰‡ç®—æ³•è®¾è®¡åŸåˆ™"></a>3.3 åˆ†ç‰‡ç®—æ³•è®¾è®¡åŸåˆ™</h3><h4 id="3-3-1-å¸¸è§åˆ†ç‰‡ç®—æ³•è¯¦è§£"><a href="#3-3-1-å¸¸è§åˆ†ç‰‡ç®—æ³•è¯¦è§£" class="headerlink" title="3.3.1 å¸¸è§åˆ†ç‰‡ç®—æ³•è¯¦è§£"></a>3.3.1 å¸¸è§åˆ†ç‰‡ç®—æ³•è¯¦è§£</h4><p>åˆ†ç‰‡ç®—æ³•æ˜¯åˆ†åº“åˆ†è¡¨çš„æ ¸å¿ƒï¼Œå†³å®šäº†æ•°æ®å¦‚ä½•åˆ†å¸ƒåˆ°ä¸åŒçš„åº“è¡¨ä¸­ã€‚ä¸‹é¢è¯¦ç»†ä»‹ç»å„ç§åˆ†ç‰‡ç®—æ³•çš„å®ç°åŸç†ã€åº“è¡¨å®šä½æ–¹å¼ä»¥åŠè®¾è®¡è€ƒé‡ã€‚</p>
<h5 id="1-å–æ¨¡åˆ†ç‰‡ç®—æ³•ï¼ˆModulo-Shardingï¼‰"><a href="#1-å–æ¨¡åˆ†ç‰‡ç®—æ³•ï¼ˆModulo-Shardingï¼‰" class="headerlink" title="1. å–æ¨¡åˆ†ç‰‡ç®—æ³•ï¼ˆModulo Shardingï¼‰"></a>1. å–æ¨¡åˆ†ç‰‡ç®—æ³•ï¼ˆModulo Shardingï¼‰</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å–æ¨¡åˆ†ç‰‡ç®—æ³•å®ç°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ModuloSharding</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> dbCount;    <span class="comment">// æ•°æ®åº“æ•°é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> tableCount; <span class="comment">// æ¯ä¸ªæ•°æ®åº“ä¸­çš„è¡¨æ•°é‡</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ModuloSharding</span><span class="params">(<span class="type">int</span> dbCount, <span class="type">int</span> tableCount)</span> &#123;</span><br><span class="line">        <span class="comment">// å»ºè®®ä½¿ç”¨2çš„å¹‚æ¬¡æ–¹ï¼Œä¾¿äºä½è¿ç®—ä¼˜åŒ–</span></span><br><span class="line">        <span class="built_in">this</span>.dbCount = dbCount;</span><br><span class="line">        <span class="built_in">this</span>.tableCount = tableCount;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç¡®å®šåº“ä½ç½®çš„æ ¸å¿ƒç®—æ³•</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardingKey åˆ†ç‰‡é”®å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æ•°æ®åº“ç´¢å¼•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getDbIndex</span><span class="params">(Long shardingKey)</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * åº“å®šä½ç®—æ³•ï¼š</span></span><br><span class="line"><span class="comment">         * 1. å¯¹åˆ†ç‰‡é”®è¿›è¡Œå“ˆå¸Œè¿ç®—ï¼ˆé¿å…è´Ÿæ•°ï¼‰</span></span><br><span class="line"><span class="comment">         * 2. å¯¹æ•°æ®åº“æ•°é‡å–æ¨¡</span></span><br><span class="line"><span class="comment">         * 3. å¾—åˆ°ç›®æ ‡æ•°æ®åº“ç´¢å¼•</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ–¹å¼1ï¼šç›´æ¥å–æ¨¡ï¼ˆå¯èƒ½äº§ç”Ÿè´Ÿæ•°ï¼‰</span></span><br><span class="line">        <span class="comment">// return (int) (shardingKey % dbCount);</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ–¹å¼2ï¼šå…ˆå–ç»å¯¹å€¼å†å–æ¨¡ï¼ˆæ¨èï¼‰</span></span><br><span class="line">        <span class="keyword">return</span> Math.abs(shardingKey.hashCode()) % dbCount;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ–¹å¼3ï¼šä½è¿ç®—ä¼˜åŒ–ï¼ˆå½“dbCountä¸º2çš„å¹‚æ¬¡æ–¹æ—¶ï¼‰</span></span><br><span class="line">        <span class="comment">// return Math.abs(shardingKey.hashCode()) &amp; (dbCount - 1);</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç¡®å®šè¡¨ä½ç½®çš„æ ¸å¿ƒç®—æ³•</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardingKey åˆ†ç‰‡é”®å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> è¡¨ç´¢å¼•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getTableIndex</span><span class="params">(Long shardingKey)</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * è¡¨å®šä½ç®—æ³•ï¼š</span></span><br><span class="line"><span class="comment">         * 1. å¯¹åˆ†ç‰‡é”®è¿›è¡Œå“ˆå¸Œè¿ç®—</span></span><br><span class="line"><span class="comment">         * 2. å¯¹è¡¨æ•°é‡å–æ¨¡</span></span><br><span class="line"><span class="comment">         * 3. å¾—åˆ°ç›®æ ‡è¡¨ç´¢å¼•</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * æ³¨æ„ï¼šè¡¨å®šä½ä¸åº“å®šä½ä½¿ç”¨ç›¸åŒçš„åˆ†ç‰‡é”®ï¼Œ</span></span><br><span class="line"><span class="comment">         * ä½†è®¡ç®—æ–¹å¼å¯ä»¥ä¸åŒï¼Œä»¥å®ç°æ›´å¥½çš„æ•°æ®åˆ†å¸ƒ</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> Math.abs(shardingKey.hashCode()) % tableCount;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å®Œæ•´çš„åˆ†ç‰‡å®šä½</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardingKey åˆ†ç‰‡é”®å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> åˆ†ç‰‡ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> ShardInfo <span class="title function_">getShard</span><span class="params">(Long shardingKey)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">dbIndex</span> <span class="operator">=</span> getDbIndex(shardingKey);</span><br><span class="line">        <span class="type">int</span> <span class="variable">tableIndex</span> <span class="operator">=</span> getTableIndex(shardingKey);</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">dbName</span> <span class="operator">=</span> <span class="string">&quot;db_&quot;</span> + dbIndex;</span><br><span class="line">        <span class="type">String</span> <span class="variable">tableName</span> <span class="operator">=</span> <span class="string">&quot;user_&quot;</span> + tableIndex;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ShardInfo</span>(dbName, tableName);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * 1. æ•°å­¦åŸç†ï¼š</span></span><br><span class="line"><span class="comment">     *    - å–æ¨¡è¿ç®—èƒ½å¤Ÿå°†ä»»æ„æ•´æ•°æ˜ å°„åˆ°å›ºå®šèŒƒå›´å†…</span></span><br><span class="line"><span class="comment">     *    - å“ˆå¸Œå‡½æ•°ä¿è¯äº†æ•°æ®çš„å‡åŒ€åˆ†å¸ƒ</span></span><br><span class="line"><span class="comment">     *    - ç±»ä¼¼HashMapçš„æ¡¶å®šä½æœºåˆ¶</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * 2. æ€§èƒ½è€ƒè™‘ï¼š</span></span><br><span class="line"><span class="comment">     *    - è®¡ç®—å¤æ‚åº¦O(1)</span></span><br><span class="line"><span class="comment">     *    - æ— éœ€é¢å¤–çš„å­˜å‚¨ç©ºé—´</span></span><br><span class="line"><span class="comment">     *    - æ”¯æŒé«˜å¹¶å‘è®¿é—®</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * 3. æ‰©å±•æ€§é—®é¢˜ï¼š</span></span><br><span class="line"><span class="comment">     *    - æ‰©å®¹æ—¶éœ€è¦é‡æ–°è®¡ç®—æ‰€æœ‰æ•°æ®çš„åˆ†ç‰‡ä½ç½®</span></span><br><span class="line"><span class="comment">     *    - æ•°æ®è¿ç§»æˆæœ¬é«˜</span></span><br><span class="line"><span class="comment">     *    - ç±»ä¼¼HashMapæ‰©å®¹æ—¶çš„rehashè¿‡ç¨‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * ä¼˜ç‚¹ï¼š</span></span><br><span class="line"><span class="comment">     * - åˆ†å¸ƒå‡åŒ€ï¼Œé¿å…çƒ­ç‚¹</span></span><br><span class="line"><span class="comment">     * - è®¡ç®—ç®€å•ï¼Œæ€§èƒ½é«˜</span></span><br><span class="line"><span class="comment">     * - å®ç°ç®€å•ï¼Œæ˜“äºç†è§£</span></span><br><span class="line"><span class="comment">     * - æ”¯æŒä»»æ„æ•°é‡çš„åˆ†ç‰‡</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * ç¼ºç‚¹ï¼š</span></span><br><span class="line"><span class="comment">     * - æ‰©å®¹éœ€è¦å…¨é‡æ•°æ®è¿ç§»</span></span><br><span class="line"><span class="comment">     * - ä¸æ”¯æŒèŒƒå›´æŸ¥è¯¢ä¼˜åŒ–</span></span><br><span class="line"><span class="comment">     * - åˆ†ç‰‡æ•°é‡å˜æ›´å½±å“æ‰€æœ‰æ•°æ®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. èŒƒå›´åˆ†ç‰‡ç®—æ³•ï¼ˆRange Shardingï¼‰</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RangeSharding</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, RangeInfo&gt; dbRanges;    <span class="comment">// æ•°æ®åº“èŒƒå›´æ˜ å°„</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, RangeInfo&gt; tableRanges; <span class="comment">// è¡¨èŒƒå›´æ˜ å°„</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">RangeSharding</span><span class="params">()</span> &#123;</span><br><span class="line">            dbRanges = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            tableRanges = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// é…ç½®æ•°æ®åº“åˆ†ç‰‡èŒƒå›´ï¼ˆæŒ‰ç”¨æˆ·IDèŒƒå›´ï¼‰</span></span><br><span class="line">            dbRanges.put(<span class="string">&quot;db_0&quot;</span>, <span class="keyword">new</span> <span class="title class_">RangeInfo</span>(<span class="number">0L</span>, <span class="number">1000000L</span>));</span><br><span class="line">            dbRanges.put(<span class="string">&quot;db_1&quot;</span>, <span class="keyword">new</span> <span class="title class_">RangeInfo</span>(<span class="number">1000001L</span>, <span class="number">2000000L</span>));</span><br><span class="line">            dbRanges.put(<span class="string">&quot;db_2&quot;</span>, <span class="keyword">new</span> <span class="title class_">RangeInfo</span>(<span class="number">2000001L</span>, <span class="number">3000000L</span>));</span><br><span class="line">            dbRanges.put(<span class="string">&quot;db_3&quot;</span>, <span class="keyword">new</span> <span class="title class_">RangeInfo</span>(<span class="number">3000001L</span>, <span class="number">4000000L</span>));</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// é…ç½®è¡¨åˆ†ç‰‡èŒƒå›´ï¼ˆæ¯ä¸ªåº“å†…æŒ‰æ—¶é—´èŒƒå›´ï¼‰</span></span><br><span class="line">            tableRanges.put(<span class="string">&quot;orders_2023&quot;</span>, <span class="keyword">new</span> <span class="title class_">RangeInfo</span>(<span class="number">20230101L</span>, <span class="number">20231231L</span>));</span><br><span class="line">            tableRanges.put(<span class="string">&quot;orders_2024&quot;</span>, <span class="keyword">new</span> <span class="title class_">RangeInfo</span>(<span class="number">20240101L</span>, <span class="number">20241231L</span>));</span><br><span class="line">            tableRanges.put(<span class="string">&quot;orders_2025&quot;</span>, <span class="keyword">new</span> <span class="title class_">RangeInfo</span>(<span class="number">20250101L</span>, <span class="number">20251231L</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ç¡®å®šåº“ä½ç½® - åŸºäºç”¨æˆ·IDèŒƒå›´</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> userId ç”¨æˆ·ID</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> æ•°æ®åº“åç§°</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getDbName</span><span class="params">(Long userId)</span> &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * åº“å®šä½ç®—æ³•ï¼š</span></span><br><span class="line"><span class="comment">             * 1. éå†é¢„å®šä¹‰çš„æ•°æ®åº“èŒƒå›´</span></span><br><span class="line"><span class="comment">             * 2. æ‰¾åˆ°åŒ…å«è¯¥ç”¨æˆ·IDçš„èŒƒå›´</span></span><br><span class="line"><span class="comment">             * 3. è¿”å›å¯¹åº”çš„æ•°æ®åº“åç§°</span></span><br><span class="line"><span class="comment">             * </span></span><br><span class="line"><span class="comment">             * ä¼˜åŒ–ï¼šå¯ä»¥ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾æé«˜æ€§èƒ½</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, RangeInfo&gt; entry : dbRanges.entrySet()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (entry.getValue().contains(userId)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> entry.getKey();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å¦‚æœè¶…å‡ºé¢„å®šä¹‰èŒƒå›´ï¼Œä½¿ç”¨é»˜è®¤åº“</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;db_default&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ç¡®å®šè¡¨ä½ç½® - åŸºäºè®¢å•åˆ›å»ºæ—¶é—´</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> createTime åˆ›å»ºæ—¶é—´ï¼ˆæ ¼å¼ï¼šyyyyMMddï¼‰</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> è¡¨åç§°</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getTableName</span><span class="params">(Long createTime)</span> &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * è¡¨å®šä½ç®—æ³•ï¼š</span></span><br><span class="line"><span class="comment">             * 1. æ ¹æ®æ—¶é—´æˆ³ç¡®å®šå¹´ä»½</span></span><br><span class="line"><span class="comment">             * 2. æ‰¾åˆ°å¯¹åº”çš„å¹´åº¦è¡¨</span></span><br><span class="line"><span class="comment">             * 3. è¿”å›è¡¨åç§°</span></span><br><span class="line"><span class="comment">             * </span></span><br><span class="line"><span class="comment">             * è¿™ç§è®¾è®¡ä¾¿äºï¼š</span></span><br><span class="line"><span class="comment">             * - æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢</span></span><br><span class="line"><span class="comment">             * - å†å²æ•°æ®å½’æ¡£</span></span><br><span class="line"><span class="comment">             * - å†·çƒ­æ•°æ®åˆ†ç¦»</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, RangeInfo&gt; entry : tableRanges.entrySet()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (entry.getValue().contains(createTime)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> entry.getKey();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// é»˜è®¤ä½¿ç”¨å½“å‰å¹´ä»½è¡¨</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;orders_&quot;</span> + getCurrentYear();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å®Œæ•´çš„åˆ†ç‰‡å®šä½</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> userId ç”¨æˆ·ID</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> createTime åˆ›å»ºæ—¶é—´</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> åˆ†ç‰‡ä¿¡æ¯</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> ShardInfo <span class="title function_">getShard</span><span class="params">(Long userId, Long createTime)</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">dbName</span> <span class="operator">=</span> getDbName(userId);</span><br><span class="line">            <span class="type">String</span> <span class="variable">tableName</span> <span class="operator">=</span> getTableName(createTime);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ShardInfo</span>(dbName, tableName);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * 1. ä¸šåŠ¡è¯­ä¹‰æ¸…æ™°ï¼š</span></span><br><span class="line"><span class="comment">         *    - æŒ‰ç”¨æˆ·IDåˆ†åº“ï¼šç”¨æˆ·ç›¸å…³æ•°æ®èšåˆ</span></span><br><span class="line"><span class="comment">         *    - æŒ‰æ—¶é—´åˆ†è¡¨ï¼šæ”¯æŒæ—¶é—´èŒƒå›´æŸ¥è¯¢</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * 2. æŸ¥è¯¢ä¼˜åŒ–ï¼š</span></span><br><span class="line"><span class="comment">         *    - èŒƒå›´æŸ¥è¯¢åªéœ€è¦è®¿é—®å°‘æ•°åˆ†ç‰‡</span></span><br><span class="line"><span class="comment">         *    - é¿å…å…¨è¡¨æ‰«æ</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * 3. æ‰©å®¹å‹å¥½ï¼š</span></span><br><span class="line"><span class="comment">         *    - åªéœ€è¦è°ƒæ•´è¾¹ç•ŒèŒƒå›´</span></span><br><span class="line"><span class="comment">         *    - æ•°æ®è¿ç§»é‡ç›¸å¯¹è¾ƒå°</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * 4. è¿ç»´ä¾¿åˆ©ï¼š</span></span><br><span class="line"><span class="comment">         *    - å†å²æ•°æ®å¯ä»¥ç‹¬ç«‹ç»´æŠ¤</span></span><br><span class="line"><span class="comment">         *    - æ”¯æŒæ•°æ®å½’æ¡£å’Œæ¸…ç†</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * ä¼˜ç‚¹ï¼š</span></span><br><span class="line"><span class="comment">         * - æ”¯æŒèŒƒå›´æŸ¥è¯¢ä¼˜åŒ–</span></span><br><span class="line"><span class="comment">         * - æ‰©å®¹æ—¶æ•°æ®è¿ç§»é‡å°</span></span><br><span class="line"><span class="comment">         * - ä¾¿äºæ•°æ®å½’æ¡£å’Œç®¡ç†</span></span><br><span class="line"><span class="comment">         * - ä¸šåŠ¡è¯­ä¹‰æ¸…æ™°</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * ç¼ºç‚¹ï¼š</span></span><br><span class="line"><span class="comment">         * - å¯èƒ½å‡ºç°çƒ­ç‚¹æ•°æ®ï¼ˆæ–°ç”¨æˆ·ã€å½“å‰æ—¶é—´ï¼‰</span></span><br><span class="line"><span class="comment">         * - æ•°æ®åˆ†å¸ƒå¯èƒ½ä¸å‡åŒ€</span></span><br><span class="line"><span class="comment">         * - éœ€è¦é¢„ä¼°æ•°æ®å¢é•¿è¶‹åŠ¿</span></span><br><span class="line"><span class="comment">         * - èŒƒå›´è¾¹ç•Œéœ€è¦äººå·¥ç»´æŠ¤</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// èŒƒå›´ä¿¡æ¯ç±»</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">RangeInfo</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Long start;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Long end;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">RangeInfo</span><span class="params">(Long start, Long end)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.start = start;</span><br><span class="line">            <span class="built_in">this</span>.end = end;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">contains</span><span class="params">(Long value)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> value &gt;= start &amp;&amp; value &lt;= end;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// getter methods...</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ç›®å½•åˆ†ç‰‡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DirectorySharding</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, String&gt; shardingMap;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">DirectorySharding</span><span class="params">()</span> &#123;</span><br><span class="line">            shardingMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            <span class="comment">// é¢„å®šä¹‰åˆ†ç‰‡æ˜ å°„</span></span><br><span class="line">            shardingMap.put(<span class="string">&quot;user_type_vip&quot;</span>, <span class="string">&quot;shard_vip&quot;</span>);</span><br><span class="line">            shardingMap.put(<span class="string">&quot;user_type_normal&quot;</span>, <span class="string">&quot;shard_normal&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getShard</span><span class="params">(String shardingKey)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> shardingMap.getOrDefault(shardingKey, <span class="string">&quot;shard_default&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * ä¼˜ç‚¹ï¼š</span></span><br><span class="line"><span class="comment">         * - çµæ´»æ€§é«˜</span></span><br><span class="line"><span class="comment">         * - å¯ä»¥å®ç°å¤æ‚çš„åˆ†ç‰‡é€»è¾‘</span></span><br><span class="line"><span class="comment">         * - ä¾¿äºç‰¹æ®Šä¸šåŠ¡å¤„ç†</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * ç¼ºç‚¹ï¼š</span></span><br><span class="line"><span class="comment">         * - ç»´æŠ¤å¤æ‚</span></span><br><span class="line"><span class="comment">         * - éœ€è¦é¢å¤–å­˜å‚¨æ˜ å°„å…³ç³»</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. æ—¶é—´åˆ†ç‰‡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TimeBasedSharding</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String dateFormat;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">TimeBasedSharding</span><span class="params">(String dateFormat)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.dateFormat = dateFormat;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getShard</span><span class="params">(Date shardingKey)</span> &#123;</span><br><span class="line">            <span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(dateFormat);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;shard_&quot;</span> + sdf.format(shardingKey);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * ä¼˜ç‚¹ï¼š</span></span><br><span class="line"><span class="comment">         * - å¤©ç„¶æ”¯æŒæ•°æ®å½’æ¡£</span></span><br><span class="line"><span class="comment">         * - ä¾¿äºæŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢</span></span><br><span class="line"><span class="comment">         * - å†å²æ•°æ®å¯ä»¥ç‹¬ç«‹ç»´æŠ¤</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * ç¼ºç‚¹ï¼š</span></span><br><span class="line"><span class="comment">         * - å¯èƒ½å‡ºç°çƒ­ç‚¹ï¼ˆå½“å‰æ—¶é—´åˆ†ç‰‡ï¼‰</span></span><br><span class="line"><span class="comment">         * - è·¨æ—¶é—´èŒƒå›´æŸ¥è¯¢å¤æ‚</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ä¸€è‡´æ€§å“ˆå¸Œåˆ†ç‰‡ç®—æ³•ï¼ˆConsistent Hashingï¼‰</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsistentHashSharding</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> TreeMap&lt;Long, String&gt; ring = <span class="keyword">new</span> <span class="title class_">TreeMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> virtualNodes; <span class="comment">// è™šæ‹ŸèŠ‚ç‚¹æ•°é‡ï¼ŒåŠ¨æ€é…ç½®</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">ConsistentHashSharding</span><span class="params">(List&lt;String&gt; nodes)</span> &#123;</span><br><span class="line">            <span class="comment">// æ ¹æ®ç‰©ç†èŠ‚ç‚¹æ•°é‡åŠ¨æ€è®¡ç®—è™šæ‹ŸèŠ‚ç‚¹æ•°</span></span><br><span class="line">            <span class="comment">// å»ºè®®æ¯ä¸ªç‰©ç†èŠ‚ç‚¹å¯¹åº”150-200ä¸ªè™šæ‹ŸèŠ‚ç‚¹ä»¥ä¿è¯è´Ÿè½½å‡è¡¡</span></span><br><span class="line">            <span class="built_in">this</span>.virtualNodes = Math.max(<span class="number">150</span>, <span class="number">300</span> / nodes.size());</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (String node : nodes) &#123;</span><br><span class="line">                addNode(node);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ”¯æŒè‡ªå®šä¹‰è™šæ‹ŸèŠ‚ç‚¹æ•°çš„æ„é€ å‡½æ•°</span></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">ConsistentHashSharding</span><span class="params">(List&lt;String&gt; nodes, <span class="type">int</span> virtualNodes)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.virtualNodes = virtualNodes;</span><br><span class="line">            <span class="keyword">for</span> (String node : nodes) &#123;</span><br><span class="line">                addNode(node);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * æ·»åŠ èŠ‚ç‚¹åˆ°å“ˆå¸Œç¯</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> node èŠ‚ç‚¹åç§°</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addNode</span><span class="params">(String node)</span> &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * ä¸ºæ¯ä¸ªç‰©ç†èŠ‚ç‚¹åˆ›å»ºå¤šä¸ªè™šæ‹ŸèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">             * ç›®çš„ï¼šè§£å†³æ•°æ®åˆ†å¸ƒä¸å‡åŒ€é—®é¢˜</span></span><br><span class="line"><span class="comment">             * åŸç†ï¼šå¢åŠ èŠ‚ç‚¹åœ¨å“ˆå¸Œç¯ä¸Šçš„åˆ†å¸ƒç‚¹</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; virtualNodes; i++) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">virtualNodeName</span> <span class="operator">=</span> node + <span class="string">&quot;#&quot;</span> + i;</span><br><span class="line">                <span class="type">long</span> <span class="variable">hash</span> <span class="operator">=</span> hash(virtualNodeName);</span><br><span class="line">                ring.put(hash, node);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ä»å“ˆå¸Œç¯ä¸­ç§»é™¤èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> node èŠ‚ç‚¹åç§°</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeNode</span><span class="params">(String node)</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; virtualNodes; i++) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">virtualNodeName</span> <span class="operator">=</span> node + <span class="string">&quot;#&quot;</span> + i;</span><br><span class="line">                <span class="type">long</span> <span class="variable">hash</span> <span class="operator">=</span> hash(virtualNodeName);</span><br><span class="line">                ring.remove(hash);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ç¡®å®šæ•°æ®åº”è¯¥å­˜å‚¨åœ¨å“ªä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> key åˆ†ç‰‡é”®</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> èŠ‚ç‚¹åç§°</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getNode</span><span class="params">(String key)</span> &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * å®šä½ç®—æ³•ï¼š</span></span><br><span class="line"><span class="comment">             * 1. è®¡ç®—keyçš„å“ˆå¸Œå€¼</span></span><br><span class="line"><span class="comment">             * 2. åœ¨å“ˆå¸Œç¯ä¸Šé¡ºæ—¶é’ˆæŸ¥æ‰¾ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">             * 3. è¿”å›å¯¹åº”çš„ç‰©ç†èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">             * </span></span><br><span class="line"><span class="comment">             * ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ</span></span><br><span class="line"><span class="comment">             * - ä¿è¯æ•°æ®åˆ†å¸ƒçš„ä¸€è‡´æ€§</span></span><br><span class="line"><span class="comment">             * - èŠ‚ç‚¹å¢å‡æ—¶åªå½±å“ç›¸é‚»èŠ‚ç‚¹çš„æ•°æ®</span></span><br><span class="line"><span class="comment">             * - é¿å…å…¨é‡æ•°æ®è¿ç§»</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (ring.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="type">long</span> <span class="variable">hash</span> <span class="operator">=</span> hash(key);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// æŸ¥æ‰¾é¡ºæ—¶é’ˆæ–¹å‘ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">            Map.Entry&lt;Long, String&gt; entry = ring.ceilingEntry(hash);</span><br><span class="line">            <span class="keyword">if</span> (entry == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœæ²¡æ‰¾åˆ°ï¼Œè¯´æ˜åº”è¯¥åˆ†é…ç»™ç¯ä¸Šçš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">                entry = ring.firstEntry();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> entry.getValue();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * åˆ†åº“åˆ†è¡¨çš„å®Œæ•´å®šä½</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> userId ç”¨æˆ·ID</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> tableCount æ¯ä¸ªåº“çš„è¡¨æ•°é‡</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> åˆ†ç‰‡ä¿¡æ¯</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> ShardInfo <span class="title function_">getShardInfo</span><span class="params">(Long userId, <span class="type">int</span> tableCount)</span> &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * ä¸¤å±‚åˆ†ç‰‡ç­–ç•¥ï¼š</span></span><br><span class="line"><span class="comment">             * 1. å…ˆç”¨ä¸€è‡´æ€§å“ˆå¸Œç¡®å®šæ•°æ®åº“</span></span><br><span class="line"><span class="comment">             * 2. å†ç”¨å–æ¨¡ç®—æ³•ç¡®å®šè¡¨</span></span><br><span class="line"><span class="comment">             * </span></span><br><span class="line"><span class="comment">             * è¿™æ ·è®¾è®¡çš„å¥½å¤„ï¼š</span></span><br><span class="line"><span class="comment">             * - æ•°æ®åº“å±‚é¢æ”¯æŒå¹³æ»‘æ‰©å®¹</span></span><br><span class="line"><span class="comment">             * - è¡¨å±‚é¢ä¿æŒç®€å•é«˜æ•ˆ</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            </span><br><span class="line">            <span class="type">String</span> <span class="variable">dbName</span> <span class="operator">=</span> getNode(String.valueOf(userId));</span><br><span class="line">            <span class="type">String</span> <span class="variable">tableName</span> <span class="operator">=</span> <span class="string">&quot;user_&quot;</span> + (userId % tableCount);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ShardInfo</span>(dbName, tableName);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å“ˆå¸Œå‡½æ•°ï¼ˆä½¿ç”¨FNV-1aç®—æ³•ï¼‰</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">long</span> <span class="title function_">hash</span><span class="params">(String key)</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">long</span> <span class="variable">FNV_64_INIT</span> <span class="operator">=</span> <span class="number">0xcbf29ce484222325L</span>;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">long</span> <span class="variable">FNV_64_PRIME</span> <span class="operator">=</span> <span class="number">0x100000001b3L</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="type">long</span> <span class="variable">hash</span> <span class="operator">=</span> FNV_64_INIT;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">byte</span> b : key.getBytes()) &#123;</span><br><span class="line">                hash ^= b;</span><br><span class="line">                hash *= FNV_64_PRIME;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> hash;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ä¸ºä»€ä¹ˆé€‰æ‹©ä¸€è‡´æ€§å“ˆå¸Œï¼Ÿ</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * 1. æ‰©å®¹å‹å¥½ï¼š</span></span><br><span class="line"><span class="comment">         *    - æ–°å¢èŠ‚ç‚¹åªå½±å“ç›¸é‚»èŠ‚ç‚¹çš„æ•°æ®</span></span><br><span class="line"><span class="comment">         *    - æ•°æ®è¿ç§»é‡æœ€å°åŒ–</span></span><br><span class="line"><span class="comment">         *    - ç±»ä¼¼HashMapçš„ä¼˜åŒ–ç‰ˆæœ¬</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * 2. è´Ÿè½½å‡è¡¡ï¼š</span></span><br><span class="line"><span class="comment">         *    - è™šæ‹ŸèŠ‚ç‚¹è§£å†³æ•°æ®åˆ†å¸ƒä¸å‡é—®é¢˜</span></span><br><span class="line"><span class="comment">         *    - èŠ‚ç‚¹æ•…éšœæ—¶è´Ÿè½½è‡ªåŠ¨åˆ†æ•£</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * 3. é«˜å¯ç”¨æ€§ï¼š</span></span><br><span class="line"><span class="comment">         *    - èŠ‚ç‚¹æ•…éšœä¸å½±å“æ•´ä½“æœåŠ¡</span></span><br><span class="line"><span class="comment">         *    - æ”¯æŒåŠ¨æ€å¢å‡èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * 4. ä¸HashMapæ‰©å®¹çš„å¯¹æ¯”ï¼š</span></span><br><span class="line"><span class="comment">         *    - HashMapæ‰©å®¹ï¼šéœ€è¦rehashæ‰€æœ‰æ•°æ®</span></span><br><span class="line"><span class="comment">         *    - ä¸€è‡´æ€§å“ˆå¸Œï¼šåªéœ€è¦è¿ç§»éƒ¨åˆ†æ•°æ®</span></span><br><span class="line"><span class="comment">         *    - ä¸€è‡´æ€§å“ˆå¸Œæ˜¯HashMapæ‰©å®¹é—®é¢˜çš„ä¼˜åŒ–è§£å†³æ–¹æ¡ˆ</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * ä¼˜ç‚¹ï¼š</span></span><br><span class="line"><span class="comment">         * - æ‰©å®¹æ—¶æ•°æ®è¿ç§»é‡æœ€å°</span></span><br><span class="line"><span class="comment">         * - æ”¯æŒåŠ¨æ€å¢å‡èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">         * - è´Ÿè½½åˆ†å¸ƒç›¸å¯¹å‡åŒ€</span></span><br><span class="line"><span class="comment">         * - é«˜å¯ç”¨æ€§å¥½</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * ç¼ºç‚¹ï¼š</span></span><br><span class="line"><span class="comment">         * - å®ç°å¤æ‚åº¦è¾ƒé«˜</span></span><br><span class="line"><span class="comment">         * - éœ€è¦é¢å¤–çš„è™šæ‹ŸèŠ‚ç‚¹ç®¡ç†</span></span><br><span class="line"><span class="comment">         * - ä¸æ”¯æŒèŒƒå›´æŸ¥è¯¢ä¼˜åŒ–</span></span><br><span class="line"><span class="comment">         * - èŠ‚ç‚¹æ•°é‡å˜åŒ–æ—¶ä»éœ€è¦æ•°æ®è¿ç§»</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">##### <span class="number">3.3</span><span class="number">.2</span> é¢„åˆ†ç‰‡æ–¹å¼è¯¦è§£</span><br><span class="line"></span><br><span class="line">é¢„åˆ†ç‰‡æ˜¯ä¸€ç§æå‰è§„åˆ’åˆ†ç‰‡ç­–ç•¥çš„æ–¹æ³•ï¼Œå¯ä»¥æœ‰æ•ˆé¿å…åæœŸæ‰©å®¹æ—¶çš„æ•°æ®è¿ç§»é—®é¢˜ã€‚</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line"><span class="comment">// é¢„åˆ†ç‰‡å®ç°ç­–ç•¥</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PreShardingStrategy</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1. é¢„åˆ†åº“ç­–ç•¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PreDatabaseSharding</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">initialDbCount</span> <span class="operator">=</span> <span class="number">8</span>;   <span class="comment">// åˆå§‹æ•°æ®åº“æ•°é‡</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">maxDbCount</span> <span class="operator">=</span> <span class="number">64</span>;      <span class="comment">// æœ€å¤§æ•°æ®åº“æ•°é‡</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">expansionFactor</span> <span class="operator">=</span> <span class="number">2</span>;  <span class="comment">// æ‰©å®¹å› å­</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * é¢„åˆ†åº“çš„æ ¸å¿ƒæ€æƒ³ï¼š</span></span><br><span class="line"><span class="comment">         * 1. ä¸€æ¬¡æ€§åˆ›å»ºè¶³å¤Ÿå¤šçš„æ•°æ®åº“</span></span><br><span class="line"><span class="comment">         * 2. åˆæœŸåªä½¿ç”¨éƒ¨åˆ†æ•°æ®åº“</span></span><br><span class="line"><span class="comment">         * 3. éšç€æ•°æ®å¢é•¿é€æ­¥å¯ç”¨æ›´å¤šæ•°æ®åº“</span></span><br><span class="line"><span class="comment">         * 4. é¿å…åæœŸçš„æ•°æ®è¿ç§»</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getDbName</span><span class="params">(Long userId)</span> &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * é¢„åˆ†åº“ç®—æ³•ï¼š</span></span><br><span class="line"><span class="comment">             * 1. ä½¿ç”¨æœ€å¤§æ•°æ®åº“æ•°é‡è¿›è¡Œå–æ¨¡</span></span><br><span class="line"><span class="comment">             * 2. ä¿è¯æœªæ¥æ‰©å®¹æ—¶è·¯ç”±è§„åˆ™ä¸å˜</span></span><br><span class="line"><span class="comment">             * 3. é€šè¿‡é…ç½®æ§åˆ¶å®é™…ä½¿ç”¨çš„æ•°æ®åº“æ•°é‡</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            </span><br><span class="line">            <span class="type">int</span> <span class="variable">dbIndex</span> <span class="operator">=</span> (<span class="type">int</span>) (userId % maxDbCount);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// æ ¹æ®å½“å‰å¯ç”¨çš„æ•°æ®åº“æ•°é‡è¿›è¡Œæ˜ å°„</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">activeDbIndex</span> <span class="operator">=</span> dbIndex % getCurrentActiveDbCount();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;db_&quot;</span> + activeDbIndex;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * æ‰©å®¹æ“ä½œï¼šå¯ç”¨æ›´å¤šæ•°æ®åº“</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">expandDatabases</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * æ‰©å®¹æ­¥éª¤ï¼š</span></span><br><span class="line"><span class="comment">             * 1. å¢åŠ æ´»è·ƒæ•°æ®åº“æ•°é‡é…ç½®</span></span><br><span class="line"><span class="comment">             * 2. æ•°æ®ä¼šè‡ªåŠ¨è·¯ç”±åˆ°æ–°çš„æ•°æ®åº“</span></span><br><span class="line"><span class="comment">             * 3. æ— éœ€è¿ç§»ç°æœ‰æ•°æ®</span></span><br><span class="line"><span class="comment">             * </span></span><br><span class="line"><span class="comment">             * æ³¨æ„ï¼šè¿™ç§æ–¹å¼é€‚åˆæ•°æ®å¢é•¿å¯é¢„æœŸçš„åœºæ™¯</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            </span><br><span class="line">            <span class="type">int</span> <span class="variable">currentCount</span> <span class="operator">=</span> getCurrentActiveDbCount();</span><br><span class="line">            <span class="type">int</span> <span class="variable">newCount</span> <span class="operator">=</span> Math.min(currentCount * expansionFactor, maxDbCount);</span><br><span class="line">            </span><br><span class="line">            updateActiveDbCount(newCount);</span><br><span class="line">            </span><br><span class="line">            System.out.println(<span class="string">&quot;æ•°æ®åº“æ‰©å®¹å®Œæˆï¼š&quot;</span> + currentCount + <span class="string">&quot; -&gt; &quot;</span> + newCount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 2. é¢„åˆ†è¡¨ç­–ç•¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PreTableSharding</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">tablesPerDb</span> <span class="operator">=</span> <span class="number">1024</span>;  <span class="comment">// æ¯ä¸ªåº“çš„è¡¨æ•°é‡</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * é¢„åˆ†è¡¨çš„è®¾è®¡åŸåˆ™ï¼š</span></span><br><span class="line"><span class="comment">         * 1. æ¯ä¸ªåº“é¢„åˆ›å»ºè¶³å¤Ÿå¤šçš„è¡¨</span></span><br><span class="line"><span class="comment">         * 2. è¡¨æ•°é‡é€‰æ‹©2çš„å¹‚æ¬¡æ–¹ï¼ˆä¾¿äºä½è¿ç®—ä¼˜åŒ–ï¼‰</span></span><br><span class="line"><span class="comment">         * 3. è€ƒè™‘å•è¡¨æ•°æ®é‡ä¸Šé™</span></span><br><span class="line"><span class="comment">         * 4. é¢„ç•™è¶³å¤Ÿçš„æ‰©å±•ç©ºé—´</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getTableName</span><span class="params">(Long userId)</span> &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * é¢„åˆ†è¡¨ç®—æ³•ï¼š</span></span><br><span class="line"><span class="comment">             * 1. ä½¿ç”¨ä½è¿ç®—æé«˜æ€§èƒ½</span></span><br><span class="line"><span class="comment">             * 2. ä¿è¯æ•°æ®åˆ†å¸ƒå‡åŒ€</span></span><br><span class="line"><span class="comment">             * 3. è¡¨åè§„åˆ™å›ºå®šï¼Œä¾¿äºè¿ç»´</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// ä½¿ç”¨ä½è¿ç®—æ›¿ä»£å–æ¨¡æ“ä½œï¼ˆæ€§èƒ½æ›´å¥½ï¼‰</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">tableIndex</span> <span class="operator">=</span> (<span class="type">int</span>) (userId &amp; (tablesPerDb - <span class="number">1</span>));</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;user_&quot;</span> + String.format(<span class="string">&quot;%04d&quot;</span>, tableIndex);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * æ‰¹é‡åˆ›å»ºè¡¨çš„SQLç”Ÿæˆ</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">generateCreateTableSql</span><span class="params">(String dbName)</span> &#123;</span><br><span class="line">            List&lt;String&gt; sqlList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; tablesPerDb; i++) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">tableName</span> <span class="operator">=</span> <span class="string">&quot;user_&quot;</span> + String.format(<span class="string">&quot;%04d&quot;</span>, i);</span><br><span class="line">                <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> String.format(</span><br><span class="line">                    <span class="string">&quot;CREATE TABLE %s.%s (&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;  id BIGINT PRIMARY KEY,&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;  user_id BIGINT NOT NULL,&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;  username VARCHAR(50),&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;  created_time TIMESTAMP,&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;  INDEX idx_user_id (user_id)&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;) ENGINE=InnoDB&quot;</span>, </span><br><span class="line">                    dbName, tableName</span><br><span class="line">                );</span><br><span class="line">                sqlList.add(sql);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> sqlList;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 3. æ··åˆé¢„åˆ†ç‰‡ç­–ç•¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HybridPreSharding</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ç»“åˆå¤šç§åˆ†ç‰‡ç®—æ³•çš„é¢„åˆ†ç‰‡ç­–ç•¥</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * åœºæ™¯ï¼šç”µå•†è®¢å•ç³»ç»Ÿ</span></span><br><span class="line"><span class="comment">         * - æŒ‰ç”¨æˆ·IDé¢„åˆ†åº“ï¼ˆç”¨æˆ·ç»´åº¦èšåˆï¼‰</span></span><br><span class="line"><span class="comment">         * - æŒ‰æ—¶é—´é¢„åˆ†è¡¨ï¼ˆä¾¿äºå½’æ¡£å’ŒæŸ¥è¯¢ï¼‰</span></span><br><span class="line"><span class="comment">         * - é¢„ç•™æ‰©å®¹ç©ºé—´</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> ShardInfo <span class="title function_">getOrderShard</span><span class="params">(Long userId, Date createTime)</span> &#123;</span><br><span class="line">            <span class="comment">// 1. æŒ‰ç”¨æˆ·IDç¡®å®šæ•°æ®åº“</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">dbName</span> <span class="operator">=</span> getDbByUserId(userId);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 2. æŒ‰æ—¶é—´ç¡®å®šè¡¨</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">tableName</span> <span class="operator">=</span> getTableByTime(createTime);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ShardInfo</span>(dbName, tableName);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span> String <span class="title function_">getDbByUserId</span><span class="params">(Long userId)</span> &#123;</span><br><span class="line">            <span class="comment">// é¢„åˆ†64ä¸ªåº“ï¼ŒåˆæœŸä½¿ç”¨8ä¸ª</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">dbIndex</span> <span class="operator">=</span> (<span class="type">int</span>) (userId % <span class="number">64</span>) % getCurrentActiveDbCount();</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;order_db_&quot;</span> + dbIndex;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span> String <span class="title function_">getTableByTime</span><span class="params">(Date createTime)</span> &#123;</span><br><span class="line">            <span class="comment">// æŒ‰å¹´æœˆåˆ†è¡¨ï¼Œé¢„åˆ›å»ºæœªæ¥3å¹´çš„è¡¨</span></span><br><span class="line">            <span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyyMM&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;orders_&quot;</span> + sdf.format(createTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é¢„åˆ†ç‰‡çš„ä¼˜åŠ¿ï¼š</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * 1. é¿å…æ•°æ®è¿ç§»ï¼š</span></span><br><span class="line"><span class="comment">     *    - æå‰è§„åˆ’å¥½åˆ†ç‰‡è§„åˆ™</span></span><br><span class="line"><span class="comment">     *    - æ‰©å®¹æ—¶æ— éœ€ç§»åŠ¨æ•°æ®</span></span><br><span class="line"><span class="comment">     *    - é™ä½è¿ç»´å¤æ‚åº¦</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * 2. æ€§èƒ½ç¨³å®šï¼š</span></span><br><span class="line"><span class="comment">     *    - é¿å…æ‰©å®¹æœŸé—´çš„æ€§èƒ½æŠ–åŠ¨</span></span><br><span class="line"><span class="comment">     *    - è·¯ç”±è§„åˆ™å›ºå®šä¸å˜</span></span><br><span class="line"><span class="comment">     *    - ç¼“å­˜å‘½ä¸­ç‡ç¨³å®š</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * 3. è¿ç»´å‹å¥½ï¼š</span></span><br><span class="line"><span class="comment">     *    - åˆ†ç‰‡è§„åˆ™æ¸…æ™°æ˜ç¡®</span></span><br><span class="line"><span class="comment">     *    - ä¾¿äºç›‘æ§å’Œç®¡ç†</span></span><br><span class="line"><span class="comment">     *    - æ”¯æŒè‡ªåŠ¨åŒ–è¿ç»´</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * 4. æˆæœ¬å¯æ§ï¼š</span></span><br><span class="line"><span class="comment">     *    - åˆæœŸèµ„æºæŠ•å…¥å¯æ§</span></span><br><span class="line"><span class="comment">     *    - æŒ‰éœ€å¯ç”¨åˆ†ç‰‡èµ„æº</span></span><br><span class="line"><span class="comment">     *    - é¿å…ç´§æ€¥æ‰©å®¹æˆæœ¬</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é¢„åˆ†ç‰‡çš„æ³¨æ„äº‹é¡¹ï¼š</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * 1. å®¹é‡è§„åˆ’ï¼š</span></span><br><span class="line"><span class="comment">     *    - éœ€è¦å‡†ç¡®é¢„ä¼°ä¸šåŠ¡å¢é•¿</span></span><br><span class="line"><span class="comment">     *    - é¢„ç•™è¶³å¤Ÿçš„æ‰©å±•ç©ºé—´</span></span><br><span class="line"><span class="comment">     *    - è€ƒè™‘ç¡¬ä»¶èµ„æºé™åˆ¶</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * 2. èµ„æºåˆ©ç”¨ï¼š</span></span><br><span class="line"><span class="comment">     *    - åˆæœŸå¯èƒ½å­˜åœ¨èµ„æºæµªè´¹</span></span><br><span class="line"><span class="comment">     *    - éœ€è¦å¹³è¡¡é¢„ç•™ç©ºé—´å’Œæˆæœ¬</span></span><br><span class="line"><span class="comment">     *    - è€ƒè™‘äº‘èµ„æºçš„å¼¹æ€§ç‰¹æ€§</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * 3. ç›‘æ§å‘Šè­¦ï¼š</span></span><br><span class="line"><span class="comment">     *    - ç›‘æ§å„åˆ†ç‰‡çš„ä½¿ç”¨æƒ…å†µ</span></span><br><span class="line"><span class="comment">     *    - è®¾ç½®å®¹é‡å‘Šè­¦é˜ˆå€¼</span></span><br><span class="line"><span class="comment">     *    - åŠæ—¶å¯ç”¨æ–°çš„åˆ†ç‰‡èµ„æº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-åˆ†ç‰‡é”®é€‰æ‹©ä¸è®¾è®¡ç­–ç•¥"><a href="#4-åˆ†ç‰‡é”®é€‰æ‹©ä¸è®¾è®¡ç­–ç•¥" class="headerlink" title="4. åˆ†ç‰‡é”®é€‰æ‹©ä¸è®¾è®¡ç­–ç•¥"></a>4. åˆ†ç‰‡é”®é€‰æ‹©ä¸è®¾è®¡ç­–ç•¥</h2><h3 id="4-1-åˆ†ç‰‡é”®é€‰æ‹©åŸåˆ™"><a href="#4-1-åˆ†ç‰‡é”®é€‰æ‹©åŸåˆ™" class="headerlink" title="4.1 åˆ†ç‰‡é”®é€‰æ‹©åŸåˆ™"></a>4.1 åˆ†ç‰‡é”®é€‰æ‹©åŸåˆ™</h3><h4 id="4-1-1-æ ¸å¿ƒåŸåˆ™"><a href="#4-1-1-æ ¸å¿ƒåŸåˆ™" class="headerlink" title="4.1.1 æ ¸å¿ƒåŸåˆ™"></a>4.1.1 æ ¸å¿ƒåŸåˆ™</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ†ç‰‡é”®é€‰æ‹©çš„æ ¸å¿ƒåŸåˆ™</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShardingKeyPrinciples</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 1. æ•°æ®åˆ†å¸ƒå‡åŒ€æ€§</span></span><br><span class="line"><span class="comment">     * - é¿å…æ•°æ®å€¾æ–œ</span></span><br><span class="line"><span class="comment">     * - ç¡®ä¿å„åˆ†ç‰‡è´Ÿè½½å‡è¡¡</span></span><br><span class="line"><span class="comment">     * - è€ƒè™‘ä¸šåŠ¡å¢é•¿è¶‹åŠ¿</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">dataDistributionPrinciple</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// å¥½çš„åˆ†ç‰‡é”®ç¤ºä¾‹</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">goodShardingKey</span> <span class="operator">=</span> <span class="string">&quot;user_id&quot;</span>;  <span class="comment">// ç”¨æˆ·IDé€šå¸¸åˆ†å¸ƒå‡åŒ€</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä¸å¥½çš„åˆ†ç‰‡é”®ç¤ºä¾‹</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">badShardingKey</span> <span class="operator">=</span> <span class="string">&quot;status&quot;</span>;    <span class="comment">// çŠ¶æ€å­—æ®µå€¼åŸŸæœ‰é™ï¼Œå®¹æ˜“å€¾æ–œ</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 2. æŸ¥è¯¢è·¯ç”±æ•ˆç‡</span></span><br><span class="line"><span class="comment">     * - å¤§éƒ¨åˆ†æŸ¥è¯¢èƒ½å¤Ÿè·¯ç”±åˆ°å•ä¸ªåˆ†ç‰‡</span></span><br><span class="line"><span class="comment">     * - é¿å…è·¨åˆ†ç‰‡æŸ¥è¯¢</span></span><br><span class="line"><span class="comment">     * - æ”¯æŒä¸»è¦ä¸šåŠ¡åœºæ™¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryRoutingPrinciple</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// ç”µå•†ç³»ç»Ÿåˆ†ç‰‡é”®é€‰æ‹©</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * è®¢å•è¡¨ï¼šorder_idï¼ˆæ”¯æŒè®¢å•è¯¦æƒ…æŸ¥è¯¢ï¼‰</span></span><br><span class="line"><span class="comment">         * ç”¨æˆ·è¡¨ï¼šuser_idï¼ˆæ”¯æŒç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢ï¼‰</span></span><br><span class="line"><span class="comment">         * å•†å“è¡¨ï¼šproduct_idï¼ˆæ”¯æŒå•†å“è¯¦æƒ…æŸ¥è¯¢ï¼‰</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 3. ä¸šåŠ¡å…³è”æ€§</span></span><br><span class="line"><span class="comment">     * - ç›¸å…³è”çš„æ•°æ®å°½é‡åœ¨åŒä¸€åˆ†ç‰‡</span></span><br><span class="line"><span class="comment">     * - å‡å°‘åˆ†å¸ƒå¼äº‹åŠ¡</span></span><br><span class="line"><span class="comment">     * - æ”¯æŒä¸šåŠ¡èšåˆæŸ¥è¯¢</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">businessCorrelationPrinciple</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// è®¢å•ç›¸å…³è¡¨ä½¿ç”¨ç›¸åŒåˆ†ç‰‡é”®</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * orders: åˆ†ç‰‡é”® user_id</span></span><br><span class="line"><span class="comment">         * order_items: åˆ†ç‰‡é”® user_idï¼ˆè€Œä¸æ˜¯item_idï¼‰</span></span><br><span class="line"><span class="comment">         * order_payments: åˆ†ç‰‡é”® user_id</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * è¿™æ ·ç”¨æˆ·çš„æ‰€æœ‰è®¢å•ç›¸å…³æ•°æ®éƒ½åœ¨åŒä¸€åˆ†ç‰‡</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 4. æ‰©å±•æ€§è€ƒè™‘</span></span><br><span class="line"><span class="comment">     * - åˆ†ç‰‡é”®å€¼åŸŸè¦è¶³å¤Ÿå¤§</span></span><br><span class="line"><span class="comment">     * - æ”¯æŒæœªæ¥çš„æ‰©å®¹éœ€æ±‚</span></span><br><span class="line"><span class="comment">     * - é¿å…çƒ­ç‚¹æ•°æ®é—®é¢˜</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">scalabilityPrinciple</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// æ—¶é—´ç›¸å…³çš„åˆ†ç‰‡é”®è®¾è®¡</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * ä¸æ¨èï¼šåªæŒ‰å¹´åˆ†ç‰‡ï¼ˆå€¼åŸŸå¤ªå°ï¼‰</span></span><br><span class="line"><span class="comment">         * æ¨èï¼šæŒ‰å¹´æœˆåˆ†ç‰‡ï¼Œæˆ–è€…æ—¶é—´+å…¶ä»–å­—æ®µç»„åˆ</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-1-2-åˆ†ç‰‡é”®è®¾è®¡æ¨¡å¼"><a href="#4-1-2-åˆ†ç‰‡é”®è®¾è®¡æ¨¡å¼" class="headerlink" title="4.1.2 åˆ†ç‰‡é”®è®¾è®¡æ¨¡å¼"></a>4.1.2 åˆ†ç‰‡é”®è®¾è®¡æ¨¡å¼</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ†ç‰‡é”®è®¾è®¡æ¨¡å¼</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShardingKeyPatterns</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. å•å­—æ®µåˆ†ç‰‡é”®</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SingleFieldSharding</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * é€‚ç”¨åœºæ™¯ï¼š</span></span><br><span class="line"><span class="comment">         * - æ•°æ®è®¿é—®æ¨¡å¼å•ä¸€</span></span><br><span class="line"><span class="comment">         * - åˆ†ç‰‡å­—æ®µåˆ†å¸ƒå‡åŒ€</span></span><br><span class="line"><span class="comment">         * - ä¸šåŠ¡é€»è¾‘ç®€å•</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        </span><br><span class="line">        <span class="meta">@ShardingKey</span></span><br><span class="line">        <span class="keyword">private</span> Long userId;  <span class="comment">// ç”¨æˆ·IDä½œä¸ºåˆ†ç‰‡é”®</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getShardingSuffix</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> String.valueOf(userId % <span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. å¤åˆåˆ†ç‰‡é”®</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CompositeSharding</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * é€‚ç”¨åœºæ™¯ï¼š</span></span><br><span class="line"><span class="comment">         * - å•å­—æ®µåˆ†å¸ƒä¸å‡åŒ€</span></span><br><span class="line"><span class="comment">         * - éœ€è¦æ›´ç»†ç²’åº¦çš„åˆ†ç‰‡</span></span><br><span class="line"><span class="comment">         * - å¤šç»´åº¦æŸ¥è¯¢éœ€æ±‚</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        </span><br><span class="line">        <span class="meta">@ShardingKey</span></span><br><span class="line">        <span class="keyword">private</span> Long userId;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@ShardingKey</span></span><br><span class="line">        <span class="keyword">private</span> String region;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getShardingSuffix</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">// ç»„åˆå¤šä¸ªå­—æ®µè®¡ç®—åˆ†ç‰‡</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">combined</span> <span class="operator">=</span> userId + <span class="string">&quot;_&quot;</span> + region;</span><br><span class="line">            <span class="keyword">return</span> String.valueOf(combined.hashCode() % <span class="number">8</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. è®¡ç®—åˆ†ç‰‡é”®</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CalculatedSharding</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * é€‚ç”¨åœºæ™¯ï¼š</span></span><br><span class="line"><span class="comment">         * - åŸå§‹å­—æ®µä¸é€‚åˆç›´æ¥åˆ†ç‰‡</span></span><br><span class="line"><span class="comment">         * - éœ€è¦ç‰¹æ®Šçš„åˆ†ç‰‡é€»è¾‘</span></span><br><span class="line"><span class="comment">         * - å…¼å®¹å†å²æ•°æ®</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span> String phoneNumber;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getShardingSuffix</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">// ä½¿ç”¨æ‰‹æœºå·å4ä½ä½œä¸ºåˆ†ç‰‡ä¾æ®</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">suffix</span> <span class="operator">=</span> phoneNumber.substring(phoneNumber.length() - <span class="number">4</span>);</span><br><span class="line">            <span class="keyword">return</span> String.valueOf(Integer.parseInt(suffix) % <span class="number">16</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. æ—¶é—´çª—å£åˆ†ç‰‡é”®</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TimeWindowSharding</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * é€‚ç”¨åœºæ™¯ï¼š</span></span><br><span class="line"><span class="comment">         * - æ—¶åºæ•°æ®</span></span><br><span class="line"><span class="comment">         * - éœ€è¦æ•°æ®å½’æ¡£</span></span><br><span class="line"><span class="comment">         * - æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span> Date createTime;</span><br><span class="line">        <span class="keyword">private</span> Long userId;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getShardingSuffix</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">// æŒ‰æœˆåˆ†ç‰‡ï¼ŒåŒæ—¶è€ƒè™‘ç”¨æˆ·IDé¿å…çƒ­ç‚¹</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">month</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyyMM&quot;</span>).format(createTime);</span><br><span class="line">            <span class="type">int</span> <span class="variable">userMod</span> <span class="operator">=</span> (<span class="type">int</span>) (userId % <span class="number">4</span>);</span><br><span class="line">            <span class="keyword">return</span> month + <span class="string">&quot;_&quot;</span> + userMod;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-å®é™…ä¸šåŠ¡åœºæ™¯åˆ†æ"><a href="#4-2-å®é™…ä¸šåŠ¡åœºæ™¯åˆ†æ" class="headerlink" title="4.2 å®é™…ä¸šåŠ¡åœºæ™¯åˆ†æ"></a>4.2 å®é™…ä¸šåŠ¡åœºæ™¯åˆ†æ</h3><h4 id="4-2-1-ç”µå•†ç³»ç»Ÿåˆ†ç‰‡è®¾è®¡"><a href="#4-2-1-ç”µå•†ç³»ç»Ÿåˆ†ç‰‡è®¾è®¡" class="headerlink" title="4.2.1 ç”µå•†ç³»ç»Ÿåˆ†ç‰‡è®¾è®¡"></a>4.2.1 ç”µå•†ç³»ç»Ÿåˆ†ç‰‡è®¾è®¡</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç”µå•†ç³»ç»Ÿåˆ†ç‰‡é”®è®¾è®¡æ¡ˆä¾‹</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EcommerceShardingDesign</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç”¨æˆ·ç›¸å…³è¡¨</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserSharding</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * è¡¨ï¼šusers, user_profiles, user_addresses</span></span><br><span class="line"><span class="comment">         * åˆ†ç‰‡é”®ï¼šuser_id</span></span><br><span class="line"><span class="comment">         * åˆ†ç‰‡ç®—æ³•ï¼šuser_id % 16</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * ä¼˜åŠ¿ï¼š</span></span><br><span class="line"><span class="comment">         * - ç”¨æˆ·ç›¸å…³æ•°æ®èšåˆåœ¨ä¸€èµ·</span></span><br><span class="line"><span class="comment">         * - æ”¯æŒç”¨æˆ·ç»´åº¦çš„æŸ¥è¯¢å’Œç»Ÿè®¡</span></span><br><span class="line"><span class="comment">         * - é¿å…è·¨åˆ†ç‰‡çš„ç”¨æˆ·æ“ä½œ</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Table(name = &quot;users&quot;)</span></span><br><span class="line">        <span class="meta">@ShardingKey(&quot;user_id&quot;)</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">            <span class="keyword">private</span> Long userId;</span><br><span class="line">            <span class="keyword">private</span> String username;</span><br><span class="line">            <span class="keyword">private</span> String email;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¢å•ç›¸å…³è¡¨</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderSharding</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * è¡¨ï¼šorders, order_items, order_payments</span></span><br><span class="line"><span class="comment">         * åˆ†ç‰‡é”®ï¼šuser_idï¼ˆè€Œä¸æ˜¯order_idï¼‰</span></span><br><span class="line"><span class="comment">         * åˆ†ç‰‡ç®—æ³•ï¼šuser_id % 16</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * è®¾è®¡è€ƒè™‘ï¼š</span></span><br><span class="line"><span class="comment">         * - ç”¨æˆ·çš„æ‰€æœ‰è®¢å•åœ¨åŒä¸€åˆ†ç‰‡</span></span><br><span class="line"><span class="comment">         * - æ”¯æŒç”¨æˆ·è®¢å•å†å²æŸ¥è¯¢</span></span><br><span class="line"><span class="comment">         * - ä¾¿äºç”¨æˆ·ç»´åº¦çš„æ•°æ®åˆ†æ</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Table(name = &quot;orders&quot;)</span></span><br><span class="line">        <span class="meta">@ShardingKey(&quot;user_id&quot;)</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Order</span> &#123;</span><br><span class="line">            <span class="keyword">private</span> Long orderId;</span><br><span class="line">            <span class="keyword">private</span> Long userId;  <span class="comment">// åˆ†ç‰‡é”®</span></span><br><span class="line">            <span class="keyword">private</span> BigDecimal totalAmount;</span><br><span class="line">            <span class="keyword">private</span> Date createTime;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Table(name = &quot;order_items&quot;)</span></span><br><span class="line">        <span class="meta">@ShardingKey(&quot;user_id&quot;)</span>  <span class="comment">// ä¸è®¢å•è¡¨ä¿æŒä¸€è‡´</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderItem</span> &#123;</span><br><span class="line">            <span class="keyword">private</span> Long itemId;</span><br><span class="line">            <span class="keyword">private</span> Long orderId;</span><br><span class="line">            <span class="keyword">private</span> Long userId;  <span class="comment">// å†—ä½™åˆ†ç‰‡é”®</span></span><br><span class="line">            <span class="keyword">private</span> Long productId;</span><br><span class="line">            <span class="keyword">private</span> Integer quantity;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å•†å“ç›¸å…³è¡¨</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductSharding</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * è¡¨ï¼šproducts, product_details, product_reviews</span></span><br><span class="line"><span class="comment">         * åˆ†ç‰‡é”®ï¼šproduct_id</span></span><br><span class="line"><span class="comment">         * åˆ†ç‰‡ç®—æ³•ï¼šproduct_id % 8</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * ç‰¹æ®Šå¤„ç†ï¼š</span></span><br><span class="line"><span class="comment">         * - çƒ­é—¨å•†å“å¯èƒ½å¯¼è‡´çƒ­ç‚¹</span></span><br><span class="line"><span class="comment">         * - è€ƒè™‘ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œ</span></span><br><span class="line"><span class="comment">         * - çƒ­é—¨å•†å“æ•°æ®å¯ä»¥ç¼“å­˜</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Table(name = &quot;products&quot;)</span></span><br><span class="line">        <span class="meta">@ShardingKey(&quot;product_id&quot;)</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Product</span> &#123;</span><br><span class="line">            <span class="keyword">private</span> Long productId;</span><br><span class="line">            <span class="keyword">private</span> String productName;</span><br><span class="line">            <span class="keyword">private</span> BigDecimal price;</span><br><span class="line">            <span class="keyword">private</span> Integer stock;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·¨åˆ†ç‰‡æŸ¥è¯¢å¤„ç†</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CrossShardQuery</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è®¢å•ç»Ÿè®¡æŸ¥è¯¢ï¼ˆæŒ‰æ—¶é—´èŒƒå›´ï¼‰</span></span><br><span class="line">        <span class="keyword">public</span> OrderStatistics <span class="title function_">getOrderStatistics</span><span class="params">(Date startDate, Date endDate)</span> &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * æŒ‘æˆ˜ï¼šéœ€è¦æŸ¥è¯¢æ‰€æœ‰åˆ†ç‰‡çš„è®¢å•æ•°æ®</span></span><br><span class="line"><span class="comment">             * è§£å†³æ–¹æ¡ˆï¼š</span></span><br><span class="line"><span class="comment">             * 1. å¹¶è¡ŒæŸ¥è¯¢æ‰€æœ‰åˆ†ç‰‡</span></span><br><span class="line"><span class="comment">             * 2. åº”ç”¨å±‚èšåˆç»“æœ</span></span><br><span class="line"><span class="comment">             * 3. ä½¿ç”¨åˆ†å¸ƒå¼è®¡ç®—æ¡†æ¶</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            </span><br><span class="line">            List&lt;CompletableFuture&lt;OrderStatistics&gt;&gt; futures = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å¹¶è¡ŒæŸ¥è¯¢æ‰€æœ‰åˆ†ç‰‡</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">16</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> <span class="variable">shardIndex</span> <span class="operator">=</span> i;</span><br><span class="line">                CompletableFuture&lt;OrderStatistics&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">                    <span class="keyword">return</span> queryOrderStatisticsFromShard(shardIndex, startDate, endDate);</span><br><span class="line">                &#125;);</span><br><span class="line">                futures.add(future);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// èšåˆç»“æœ</span></span><br><span class="line">            <span class="keyword">return</span> futures.stream()</span><br><span class="line">                    .map(CompletableFuture::join)</span><br><span class="line">                    .reduce(<span class="keyword">new</span> <span class="title class_">OrderStatistics</span>(), OrderStatistics::merge);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span> OrderStatistics <span class="title function_">queryOrderStatisticsFromShard</span><span class="params">(<span class="type">int</span> shardIndex, Date startDate, Date endDate)</span> &#123;</span><br><span class="line">            <span class="comment">// æŸ¥è¯¢å…·ä½“åˆ†ç‰‡çš„ç»Ÿè®¡æ•°æ®</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-2-2-ç¤¾äº¤åª’ä½“ç³»ç»Ÿåˆ†ç‰‡è®¾è®¡"><a href="#4-2-2-ç¤¾äº¤åª’ä½“ç³»ç»Ÿåˆ†ç‰‡è®¾è®¡" class="headerlink" title="4.2.2 ç¤¾äº¤åª’ä½“ç³»ç»Ÿåˆ†ç‰‡è®¾è®¡"></a>4.2.2 ç¤¾äº¤åª’ä½“ç³»ç»Ÿåˆ†ç‰‡è®¾è®¡</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¤¾äº¤åª’ä½“ç³»ç»Ÿåˆ†ç‰‡é”®è®¾è®¡æ¡ˆä¾‹</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SocialMediaShardingDesign</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç”¨æˆ·åŠ¨æ€è¡¨</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserFeedSharding</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * æŒ‘æˆ˜ï¼š</span></span><br><span class="line"><span class="comment">         * - ç”¨æˆ·å‘å¸ƒçš„åŠ¨æ€éœ€è¦æ¨é€ç»™ç²‰ä¸</span></span><br><span class="line"><span class="comment">         * - ç²‰ä¸æŸ¥çœ‹å…³æ³¨äººçš„åŠ¨æ€</span></span><br><span class="line"><span class="comment">         * - çƒ­é—¨ç”¨æˆ·çš„åŠ¨æ€è®¿é—®é‡å¤§</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * åˆ†ç‰‡ç­–ç•¥ï¼š</span></span><br><span class="line"><span class="comment">         * 1. æŒ‰å‘å¸ƒè€…IDåˆ†ç‰‡ï¼ˆå†™æ‰©æ•£ï¼‰</span></span><br><span class="line"><span class="comment">         * 2. æŒ‰æ¥æ”¶è€…IDåˆ†ç‰‡ï¼ˆè¯»æ‰©æ•£ï¼‰</span></span><br><span class="line"><span class="comment">         * 3. æ··åˆç­–ç•¥</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ–¹æ¡ˆ1ï¼šæŒ‰å‘å¸ƒè€…åˆ†ç‰‡</span></span><br><span class="line">        <span class="meta">@Table(name = &quot;user_feeds&quot;)</span></span><br><span class="line">        <span class="meta">@ShardingKey(&quot;author_id&quot;)</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserFeedByAuthor</span> &#123;</span><br><span class="line">            <span class="keyword">private</span> Long feedId;</span><br><span class="line">            <span class="keyword">private</span> Long authorId;  <span class="comment">// åˆ†ç‰‡é”®</span></span><br><span class="line">            <span class="keyword">private</span> String content;</span><br><span class="line">            <span class="keyword">private</span> Date publishTime;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * ä¼˜åŠ¿ï¼š</span></span><br><span class="line"><span class="comment">             * - ç”¨æˆ·çš„æ‰€æœ‰åŠ¨æ€åœ¨ä¸€ä¸ªåˆ†ç‰‡</span></span><br><span class="line"><span class="comment">             * - ä¾¿äºç”¨æˆ·åŠ¨æ€ç®¡ç†</span></span><br><span class="line"><span class="comment">             * </span></span><br><span class="line"><span class="comment">             * åŠ£åŠ¿ï¼š</span></span><br><span class="line"><span class="comment">             * - ç²‰ä¸æŸ¥çœ‹åŠ¨æ€éœ€è¦è·¨åˆ†ç‰‡æŸ¥è¯¢</span></span><br><span class="line"><span class="comment">             * - çƒ­é—¨ç”¨æˆ·å¯èƒ½æˆä¸ºçƒ­ç‚¹</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ–¹æ¡ˆ2ï¼šæŒ‰æ¥æ”¶è€…åˆ†ç‰‡ï¼ˆæ¨æ¨¡å¼ï¼‰</span></span><br><span class="line">        <span class="meta">@Table(name = &quot;user_timeline&quot;)</span></span><br><span class="line">        <span class="meta">@ShardingKey(&quot;user_id&quot;)</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserTimeline</span> &#123;</span><br><span class="line">            <span class="keyword">private</span> Long timelineId;</span><br><span class="line">            <span class="keyword">private</span> Long userId;    <span class="comment">// åˆ†ç‰‡é”®ï¼ˆæ¥æ”¶è€…ï¼‰</span></span><br><span class="line">            <span class="keyword">private</span> Long feedId;</span><br><span class="line">            <span class="keyword">private</span> Long authorId;</span><br><span class="line">            <span class="keyword">private</span> Date receiveTime;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * ä¼˜åŠ¿ï¼š</span></span><br><span class="line"><span class="comment">             * - ç”¨æˆ·æŸ¥çœ‹æ—¶é—´çº¿æ— éœ€è·¨åˆ†ç‰‡</span></span><br><span class="line"><span class="comment">             * - è¯»å–æ€§èƒ½å¥½</span></span><br><span class="line"><span class="comment">             * </span></span><br><span class="line"><span class="comment">             * åŠ£åŠ¿ï¼š</span></span><br><span class="line"><span class="comment">             * - å†™å…¥æ—¶éœ€è¦æ¨é€åˆ°å¤šä¸ªåˆ†ç‰‡</span></span><br><span class="line"><span class="comment">             * - å­˜å‚¨å†—ä½™</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å…³æ³¨å…³ç³»è¡¨</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FollowRelationSharding</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * å…³æ³¨å…³ç³»çš„åŒå‘æŸ¥è¯¢éœ€æ±‚ï¼š</span></span><br><span class="line"><span class="comment">         * - æŸ¥è¯¢Aå…³æ³¨äº†è°</span></span><br><span class="line"><span class="comment">         * - æŸ¥è¯¢è°å…³æ³¨äº†A</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å…³æ³¨è¡¨ï¼ˆæˆ‘å…³æ³¨çš„äººï¼‰</span></span><br><span class="line">        <span class="meta">@Table(name = &quot;user_following&quot;)</span></span><br><span class="line">        <span class="meta">@ShardingKey(&quot;follower_id&quot;)</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserFollowing</span> &#123;</span><br><span class="line">            <span class="keyword">private</span> Long relationId;</span><br><span class="line">            <span class="keyword">private</span> Long followerId;  <span class="comment">// åˆ†ç‰‡é”®ï¼ˆå…³æ³¨è€…ï¼‰</span></span><br><span class="line">            <span class="keyword">private</span> Long followeeId;  <span class="comment">// è¢«å…³æ³¨è€…</span></span><br><span class="line">            <span class="keyword">private</span> Date followTime;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ç²‰ä¸è¡¨ï¼ˆå…³æ³¨æˆ‘çš„äººï¼‰</span></span><br><span class="line">        <span class="meta">@Table(name = &quot;user_followers&quot;)</span></span><br><span class="line">        <span class="meta">@ShardingKey(&quot;followee_id&quot;)</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserFollowers</span> &#123;</span><br><span class="line">            <span class="keyword">private</span> Long relationId;</span><br><span class="line">            <span class="keyword">private</span> Long followeeId;  <span class="comment">// åˆ†ç‰‡é”®ï¼ˆè¢«å…³æ³¨è€…ï¼‰</span></span><br><span class="line">            <span class="keyword">private</span> Long followerId;  <span class="comment">// å…³æ³¨è€…</span></span><br><span class="line">            <span class="keyword">private</span> Date followTime;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * æ•°æ®å†—ä½™ç­–ç•¥ï¼š</span></span><br><span class="line"><span class="comment">         * - åŒä¸€ä¸ªå…³æ³¨å…³ç³»å­˜å‚¨ä¸¤ä»½</span></span><br><span class="line"><span class="comment">         * - åˆ†åˆ«æ”¯æŒä¸åŒçš„æŸ¥è¯¢åœºæ™¯</span></span><br><span class="line"><span class="comment">         * - éœ€è¦ä¿è¯æ•°æ®ä¸€è‡´æ€§</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-æ•°æ®å€¾æ–œé—®é¢˜è¯†åˆ«ä¸æ²»ç†"><a href="#5-æ•°æ®å€¾æ–œé—®é¢˜è¯†åˆ«ä¸æ²»ç†" class="headerlink" title="5. æ•°æ®å€¾æ–œé—®é¢˜è¯†åˆ«ä¸æ²»ç†"></a>5. æ•°æ®å€¾æ–œé—®é¢˜è¯†åˆ«ä¸æ²»ç†</h2><h3 id="5-1-æ•°æ®å€¾æ–œé—®é¢˜åˆ†æ"><a href="#5-1-æ•°æ®å€¾æ–œé—®é¢˜åˆ†æ" class="headerlink" title="5.1 æ•°æ®å€¾æ–œé—®é¢˜åˆ†æ"></a>5.1 æ•°æ®å€¾æ–œé—®é¢˜åˆ†æ</h3><h4 id="5-1-1-å€¾æ–œç±»å‹è¯†åˆ«"><a href="#5-1-1-å€¾æ–œç±»å‹è¯†åˆ«" class="headerlink" title="5.1.1 å€¾æ–œç±»å‹è¯†åˆ«"></a>5.1.1 å€¾æ–œç±»å‹è¯†åˆ«</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ•°æ®å€¾æ–œç±»å‹åˆ†æ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSkewAnalysis</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. æ•°æ®é‡å€¾æ–œ</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataVolumeSkew</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * ç°è±¡ï¼šæŸäº›åˆ†ç‰‡çš„æ•°æ®é‡è¿œå¤§äºå…¶ä»–åˆ†ç‰‡</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * åŸå› ï¼š</span></span><br><span class="line"><span class="comment">         * - åˆ†ç‰‡é”®é€‰æ‹©ä¸å½“</span></span><br><span class="line"><span class="comment">         * - ä¸šåŠ¡æ•°æ®åˆ†å¸ƒä¸å‡åŒ€</span></span><br><span class="line"><span class="comment">         * - å†å²æ•°æ®ç§¯ç´¯</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">detectVolumeSkew</span><span class="params">()</span> &#123;</span><br><span class="line">            Map&lt;String, Long&gt; shardDataCount = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// ç»Ÿè®¡å„åˆ†ç‰‡æ•°æ®é‡</span></span><br><span class="line">            <span class="keyword">for</span> (String shard : getAllShards()) &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> getDataCountFromShard(shard);</span><br><span class="line">                shardDataCount.put(shard, count);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// è®¡ç®—å€¾æ–œåº¦</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">maxCount</span> <span class="operator">=</span> Collections.max(shardDataCount.values());</span><br><span class="line">            <span class="type">long</span> <span class="variable">minCount</span> <span class="operator">=</span> Collections.min(shardDataCount.values());</span><br><span class="line">            <span class="type">double</span> <span class="variable">skewRatio</span> <span class="operator">=</span> (<span class="type">double</span>) maxCount / minCount;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (skewRatio &gt; <span class="number">2.0</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;æ£€æµ‹åˆ°æ•°æ®é‡å€¾æ–œï¼Œå€¾æ–œæ¯”ä¾‹: &quot;</span> + skewRatio);</span><br><span class="line">                <span class="comment">// è§¦å‘æ•°æ®é‡å¹³è¡¡</span></span><br><span class="line">                triggerDataRebalance(shardDataCount);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. è®¿é—®çƒ­ç‚¹å€¾æ–œ</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccessHotspotSkew</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * ç°è±¡ï¼šæŸäº›åˆ†ç‰‡çš„è®¿é—®é‡è¿œå¤§äºå…¶ä»–åˆ†ç‰‡</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * åŸå› ï¼š</span></span><br><span class="line"><span class="comment">         * - çƒ­é—¨æ•°æ®é›†ä¸­åœ¨æŸä¸ªåˆ†ç‰‡</span></span><br><span class="line"><span class="comment">         * - ä¸šåŠ¡è®¿é—®æ¨¡å¼ä¸å‡åŒ€</span></span><br><span class="line"><span class="comment">         * - æ—¶é—´ç›¸å…³çš„è®¿é—®çƒ­ç‚¹</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, AtomicLong&gt; shardAccessCount = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordAccess</span><span class="params">(String shard)</span> &#123;</span><br><span class="line">            shardAccessCount.computeIfAbsent(shard, k -&gt; <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">0</span>)).incrementAndGet();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Scheduled(fixedRate = 60000)</span> <span class="comment">// æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">detectAccessSkew</span><span class="params">()</span> &#123;</span><br><span class="line">            Map&lt;String, Long&gt; currentAccess = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// è·å–å½“å‰è®¿é—®ç»Ÿè®¡</span></span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, AtomicLong&gt; entry : shardAccessCount.entrySet()) &#123;</span><br><span class="line">                currentAccess.put(entry.getKey(), entry.getValue().getAndSet(<span class="number">0</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (currentAccess.isEmpty()) <span class="keyword">return</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="type">long</span> <span class="variable">maxAccess</span> <span class="operator">=</span> Collections.max(currentAccess.values());</span><br><span class="line">            <span class="type">long</span> <span class="variable">avgAccess</span> <span class="operator">=</span> currentAccess.values().stream().mapToLong(Long::longValue).sum() / currentAccess.size();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (maxAccess &gt; avgAccess * <span class="number">3</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;æ£€æµ‹åˆ°è®¿é—®çƒ­ç‚¹å€¾æ–œï¼Œæœ€å¤§è®¿é—®é‡: &quot;</span> + maxAccess + <span class="string">&quot;, å¹³å‡è®¿é—®é‡: &quot;</span> + avgAccess);</span><br><span class="line">                <span class="comment">// è§¦å‘çƒ­ç‚¹æ•°æ®ç¼“å­˜æˆ–è¿ç§»</span></span><br><span class="line">                handleHotspotData(currentAccess);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. æ—¶é—´å€¾æ–œ</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TemporalSkew</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * ç°è±¡ï¼šæŒ‰æ—¶é—´åˆ†ç‰‡æ—¶ï¼Œå½“å‰æ—¶é—´åˆ†ç‰‡å‹åŠ›è¿‡å¤§</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * åŸå› ï¼š</span></span><br><span class="line"><span class="comment">         * - æ–°æ•°æ®éƒ½å†™å…¥å½“å‰æ—¶é—´åˆ†ç‰‡</span></span><br><span class="line"><span class="comment">         * - å†å²æ•°æ®æŸ¥è¯¢è¾ƒå°‘</span></span><br><span class="line"><span class="comment">         * - ä¸šåŠ¡å…·æœ‰æ˜æ˜¾çš„æ—¶é—´ç‰¹å¾</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">analyzeTemporalSkew</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">// åˆ†ææœ€è¿‘ä¸€å‘¨å„æ—¶é—´åˆ†ç‰‡çš„è´Ÿè½½</span></span><br><span class="line">            Map&lt;String, ShardMetrics&gt; timeShardMetrics = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            </span><br><span class="line">            <span class="type">Calendar</span> <span class="variable">cal</span> <span class="operator">=</span> Calendar.getInstance();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">7</span>; i++) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">timeShard</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyyMMdd&quot;</span>).format(cal.getTime());</span><br><span class="line">                <span class="type">ShardMetrics</span> <span class="variable">metrics</span> <span class="operator">=</span> getShardMetrics(timeShard);</span><br><span class="line">                timeShardMetrics.put(timeShard, metrics);</span><br><span class="line">                cal.add(Calendar.DAY_OF_MONTH, -<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// æ£€æŸ¥å½“å‰åˆ†ç‰‡æ˜¯å¦è´Ÿè½½è¿‡é«˜</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">currentShard</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyyMMdd&quot;</span>).format(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">            <span class="type">ShardMetrics</span> <span class="variable">currentMetrics</span> <span class="operator">=</span> timeShardMetrics.get(currentShard);</span><br><span class="line">            </span><br><span class="line">            <span class="type">double</span> <span class="variable">avgLoad</span> <span class="operator">=</span> timeShardMetrics.values().stream()</span><br><span class="line">                    .mapToDouble(ShardMetrics::getLoadScore)</span><br><span class="line">                    .average().orElse(<span class="number">0.0</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (currentMetrics.getLoadScore() &gt; avgLoad * <span class="number">2</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;æ£€æµ‹åˆ°æ—¶é—´å€¾æ–œï¼Œå½“å‰åˆ†ç‰‡è´Ÿè½½è¿‡é«˜&quot;</span>);</span><br><span class="line">                <span class="comment">// è€ƒè™‘æŒ‰å°æ—¶è¿›ä¸€æ­¥åˆ†ç‰‡æˆ–ä½¿ç”¨å¤åˆåˆ†ç‰‡é”®</span></span><br><span class="line">                suggestTimeShardingOptimization();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-1-2-å€¾æ–œç›‘æ§æŒ‡æ ‡"><a href="#5-1-2-å€¾æ–œç›‘æ§æŒ‡æ ‡" class="headerlink" title="5.1.2 å€¾æ–œç›‘æ§æŒ‡æ ‡"></a>5.1.2 å€¾æ–œç›‘æ§æŒ‡æ ‡</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ•°æ®å€¾æ–œç›‘æ§æŒ‡æ ‡</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SkewMonitoringMetrics</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ†ç‰‡è´Ÿè½½æŒ‡æ ‡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShardLoadMetrics</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> String shardName;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">long</span> dataCount;        <span class="comment">// æ•°æ®é‡</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">long</span> storageSize;      <span class="comment">// å­˜å‚¨å¤§å°</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">double</span> cpuUsage;       <span class="comment">// CPUä½¿ç”¨ç‡</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">double</span> memoryUsage;    <span class="comment">// å†…å­˜ä½¿ç”¨ç‡</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">long</span> qps;              <span class="comment">// æ¯ç§’æŸ¥è¯¢æ•°</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">double</span> avgResponseTime; <span class="comment">// å¹³å‡å“åº”æ—¶é—´</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è®¡ç®—ç»¼åˆè´Ÿè½½åˆ†æ•°</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">calculateLoadScore</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">// æƒé‡é…ç½®</span></span><br><span class="line">            <span class="type">double</span> <span class="variable">dataWeight</span> <span class="operator">=</span> <span class="number">0.2</span>;</span><br><span class="line">            <span class="type">double</span> <span class="variable">storageWeight</span> <span class="operator">=</span> <span class="number">0.2</span>;</span><br><span class="line">            <span class="type">double</span> <span class="variable">cpuWeight</span> <span class="operator">=</span> <span class="number">0.3</span>;</span><br><span class="line">            <span class="type">double</span> <span class="variable">memoryWeight</span> <span class="operator">=</span> <span class="number">0.2</span>;</span><br><span class="line">            <span class="type">double</span> <span class="variable">qpsWeight</span> <span class="operator">=</span> <span class="number">0.1</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å½’ä¸€åŒ–å¤„ç†ï¼ˆå‡è®¾æœ€å¤§å€¼ï¼‰</span></span><br><span class="line">            <span class="type">double</span> <span class="variable">normalizedData</span> <span class="operator">=</span> Math.min(dataCount / <span class="number">10000000.0</span>, <span class="number">1.0</span>);</span><br><span class="line">            <span class="type">double</span> <span class="variable">normalizedStorage</span> <span class="operator">=</span> Math.min(storageSize / (<span class="number">100</span> * <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">1024L</span>), <span class="number">1.0</span>);</span><br><span class="line">            <span class="type">double</span> <span class="variable">normalizedCpu</span> <span class="operator">=</span> cpuUsage / <span class="number">100.0</span>;</span><br><span class="line">            <span class="type">double</span> <span class="variable">normalizedMemory</span> <span class="operator">=</span> memoryUsage / <span class="number">100.0</span>;</span><br><span class="line">            <span class="type">double</span> <span class="variable">normalizedQps</span> <span class="operator">=</span> Math.min(qps / <span class="number">10000.0</span>, <span class="number">1.0</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> normalizedData * dataWeight +</span><br><span class="line">                   normalizedStorage * storageWeight +</span><br><span class="line">                   normalizedCpu * cpuWeight +</span><br><span class="line">                   normalizedMemory * memoryWeight +</span><br><span class="line">                   normalizedQps * qpsWeight;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å€¾æ–œåº¦è®¡ç®—</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SkewCalculator</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åŸºå°¼ç³»æ•°è®¡ç®—ï¼ˆè¡¡é‡åˆ†å¸ƒä¸å‡åŒ€ç¨‹åº¦ï¼‰</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">calculateGiniCoefficient</span><span class="params">(List&lt;Double&gt; values)</span> &#123;</span><br><span class="line">            Collections.sort(values);</span><br><span class="line">            <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> values.size();</span><br><span class="line">            <span class="type">double</span> <span class="variable">sum</span> <span class="operator">=</span> values.stream().mapToDouble(Double::doubleValue).sum();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (sum == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="type">double</span> <span class="variable">gini</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">                gini += (<span class="number">2</span> * (i + <span class="number">1</span>) - n - <span class="number">1</span>) * values.get(i);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> gini / (n * sum);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å˜å¼‚ç³»æ•°è®¡ç®—</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">calculateCoefficientOfVariation</span><span class="params">(List&lt;Double&gt; values)</span> &#123;</span><br><span class="line">            <span class="type">double</span> <span class="variable">mean</span> <span class="operator">=</span> values.stream().mapToDouble(Double::doubleValue).average().orElse(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (mean == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="type">double</span> <span class="variable">variance</span> <span class="operator">=</span> values.stream()</span><br><span class="line">                    .mapToDouble(v -&gt; Math.pow(v - mean, <span class="number">2</span>))</span><br><span class="line">                    .average().orElse(<span class="number">0</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="type">double</span> <span class="variable">stdDev</span> <span class="operator">=</span> Math.sqrt(variance);</span><br><span class="line">            <span class="keyword">return</span> stdDev / mean;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å€¾æ–œåº¦è¯„ä¼°ï¼ˆæ”¯æŒè‡ªå®šä¹‰é˜ˆå€¼ï¼‰</span></span><br><span class="line">        <span class="keyword">public</span> SkewLevel <span class="title function_">assessSkewLevel</span><span class="params">(List&lt;Double&gt; loadScores)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> assessSkewLevel(loadScores, <span class="keyword">new</span> <span class="title class_">SkewThresholds</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> SkewLevel <span class="title function_">assessSkewLevel</span><span class="params">(List&lt;Double&gt; loadScores, SkewThresholds thresholds)</span> &#123;</span><br><span class="line">            <span class="type">double</span> <span class="variable">gini</span> <span class="operator">=</span> calculateGiniCoefficient(loadScores);</span><br><span class="line">            <span class="type">double</span> <span class="variable">cv</span> <span class="operator">=</span> calculateCoefficientOfVariation(loadScores);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (gini &gt; thresholds.getSevereGiniThreshold() || cv &gt; thresholds.getSevereCvThreshold()) &#123;</span><br><span class="line">                <span class="keyword">return</span> SkewLevel.SEVERE;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (gini &gt; thresholds.getModerateGiniThreshold() || cv &gt; thresholds.getModerateCvThreshold()) &#123;</span><br><span class="line">                <span class="keyword">return</span> SkewLevel.MODERATE;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> SkewLevel.MILD;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å€¾æ–œåº¦é˜ˆå€¼é…ç½®ç±»</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SkewThresholds</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">double</span> <span class="variable">severeGiniThreshold</span> <span class="operator">=</span> <span class="number">0.4</span>;    <span class="comment">// ä¸¥é‡å€¾æ–œåŸºå°¼ç³»æ•°é˜ˆå€¼</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">double</span> <span class="variable">moderateGiniThreshold</span> <span class="operator">=</span> <span class="number">0.2</span>;  <span class="comment">// ä¸­ç­‰å€¾æ–œåŸºå°¼ç³»æ•°é˜ˆå€¼</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">double</span> <span class="variable">severeCvThreshold</span> <span class="operator">=</span> <span class="number">0.5</span>;      <span class="comment">// ä¸¥é‡å€¾æ–œå˜å¼‚ç³»æ•°é˜ˆå€¼</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">double</span> <span class="variable">moderateCvThreshold</span> <span class="operator">=</span> <span class="number">0.3</span>;    <span class="comment">// ä¸­ç­‰å€¾æ–œå˜å¼‚ç³»æ•°é˜ˆå€¼</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ ¹æ®ä¸šåŠ¡åœºæ™¯è°ƒæ•´é˜ˆå€¼</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> SkewThresholds <span class="title function_">forHighTrafficScenario</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">SkewThresholds</span> <span class="variable">thresholds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkewThresholds</span>();</span><br><span class="line">            thresholds.severeGiniThreshold = <span class="number">0.3</span>;   <span class="comment">// é«˜æµé‡åœºæ™¯æ›´ä¸¥æ ¼</span></span><br><span class="line">            thresholds.moderateGiniThreshold = <span class="number">0.15</span>;</span><br><span class="line">            thresholds.severeCvThreshold = <span class="number">0.4</span>;</span><br><span class="line">            thresholds.moderateCvThreshold = <span class="number">0.25</span>;</span><br><span class="line">            <span class="keyword">return</span> thresholds;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> SkewThresholds <span class="title function_">forLowTrafficScenario</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">SkewThresholds</span> <span class="variable">thresholds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkewThresholds</span>();</span><br><span class="line">            thresholds.severeGiniThreshold = <span class="number">0.5</span>;   <span class="comment">// ä½æµé‡åœºæ™¯æ›´å®½æ¾</span></span><br><span class="line">            thresholds.moderateGiniThreshold = <span class="number">0.3</span>;</span><br><span class="line">            thresholds.severeCvThreshold = <span class="number">0.6</span>;</span><br><span class="line">            thresholds.moderateCvThreshold = <span class="number">0.4</span>;</span><br><span class="line">            <span class="keyword">return</span> thresholds;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// getterå’Œsetteræ–¹æ³•</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">getSevereGiniThreshold</span><span class="params">()</span> &#123; <span class="keyword">return</span> severeGiniThreshold; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">getModerateGiniThreshold</span><span class="params">()</span> &#123; <span class="keyword">return</span> moderateGiniThreshold; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">getSevereCvThreshold</span><span class="params">()</span> &#123; <span class="keyword">return</span> severeCvThreshold; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">getModerateCvThreshold</span><span class="params">()</span> &#123; <span class="keyword">return</span> moderateCvThreshold; &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSevereGiniThreshold</span><span class="params">(<span class="type">double</span> threshold)</span> &#123; <span class="built_in">this</span>.severeGiniThreshold = threshold; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setModerateGiniThreshold</span><span class="params">(<span class="type">double</span> threshold)</span> &#123; <span class="built_in">this</span>.moderateGiniThreshold = threshold; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSevereCvThreshold</span><span class="params">(<span class="type">double</span> threshold)</span> &#123; <span class="built_in">this</span>.severeCvThreshold = threshold; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setModerateCvThreshold</span><span class="params">(<span class="type">double</span> threshold)</span> &#123; <span class="built_in">this</span>.moderateCvThreshold = threshold; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">SkewLevel</span> &#123;</span><br><span class="line">        MILD,      <span class="comment">// è½»å¾®å€¾æ–œ</span></span><br><span class="line">        MODERATE,  <span class="comment">// ä¸­ç­‰å€¾æ–œ</span></span><br><span class="line">        SEVERE     <span class="comment">// ä¸¥é‡å€¾æ–œ</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-æ•°æ®å€¾æ–œæ²»ç†æ–¹æ¡ˆ"><a href="#5-2-æ•°æ®å€¾æ–œæ²»ç†æ–¹æ¡ˆ" class="headerlink" title="5.2 æ•°æ®å€¾æ–œæ²»ç†æ–¹æ¡ˆ"></a>5.2 æ•°æ®å€¾æ–œæ²»ç†æ–¹æ¡ˆ</h3><h4 id="5-2-1-é¢„é˜²æ€§æªæ–½"><a href="#5-2-1-é¢„é˜²æ€§æªæ–½" class="headerlink" title="5.2.1 é¢„é˜²æ€§æªæ–½"></a>5.2.1 é¢„é˜²æ€§æªæ–½</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ•°æ®å€¾æ–œé¢„é˜²æªæ–½</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SkewPreventionStrategies</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. åˆ†ç‰‡é”®ä¼˜åŒ–</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShardingKeyOptimization</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¤åˆåˆ†ç‰‡é”®è®¾è®¡</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">generateCompositeShardingKey</span><span class="params">(Long userId, String region, Date timestamp)</span> &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * è®¾è®¡æ€è·¯ï¼š</span></span><br><span class="line"><span class="comment">             * - ä¸»åˆ†ç‰‡é”®ï¼šuserIdï¼ˆä¿è¯ç”¨æˆ·æ•°æ®èšåˆï¼‰</span></span><br><span class="line"><span class="comment">             * - è¾…åŠ©åˆ†ç‰‡é”®ï¼šregionï¼ˆåœ°åŸŸåˆ†æ•£ï¼‰</span></span><br><span class="line"><span class="comment">             * - æ—¶é—´å› å­ï¼štimestampï¼ˆæ—¶é—´åˆ†æ•£ï¼‰</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            </span><br><span class="line">            <span class="type">String</span> <span class="variable">timeFactor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyyMM&quot;</span>).format(timestamp);</span><br><span class="line">            <span class="type">String</span> <span class="variable">composite</span> <span class="operator">=</span> userId + <span class="string">&quot;_&quot;</span> + region + <span class="string">&quot;_&quot;</span> + timeFactor;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// ä½¿ç”¨å“ˆå¸Œå‡½æ•°è¿›ä¸€æ­¥åˆ†æ•£</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> composite.hashCode();</span><br><span class="line">            <span class="keyword">return</span> String.valueOf(Math.abs(hash) % <span class="number">64</span>); <span class="comment">// 64ä¸ªåˆ†ç‰‡</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆ†ç‰‡é”®å€¼åŸŸæ‰©å±•</span></span><br><span class="line">         <span class="keyword">public</span> String <span class="title function_">expandShardingKeyRange</span><span class="params">(String originalKey)</span> &#123;</span><br><span class="line">             <span class="comment">/*</span></span><br><span class="line"><span class="comment">              * å¯¹äºå€¼åŸŸè¾ƒå°çš„åˆ†ç‰‡é”®ï¼Œé€šè¿‡å“ˆå¸Œæ‰©å±•å€¼åŸŸ</span></span><br><span class="line"><span class="comment">              */</span></span><br><span class="line">             </span><br><span class="line">             <span class="comment">// æ·»åŠ éšæœºå› å­</span></span><br><span class="line">             <span class="type">String</span> <span class="variable">expandedKey</span> <span class="operator">=</span> originalKey + <span class="string">&quot;_&quot;</span> + System.nanoTime() % <span class="number">1000</span>;</span><br><span class="line">             <span class="keyword">return</span> String.valueOf(expandedKey.hashCode() % <span class="number">32</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         </span><br><span class="line">         <span class="comment">// çƒ­ç‚¹æ•°æ®åˆ†æ•£ç­–ç•¥</span></span><br><span class="line">         <span class="keyword">public</span> String <span class="title function_">disperseHotData</span><span class="params">(String hotKey)</span> &#123;</span><br><span class="line">             <span class="comment">/*</span></span><br><span class="line"><span class="comment">              * å¯¹äºå·²çŸ¥çš„çƒ­ç‚¹æ•°æ®ï¼Œé€šè¿‡æ·»åŠ éšæœºåç¼€åˆ†æ•£åˆ°å¤šä¸ªåˆ†ç‰‡</span></span><br><span class="line"><span class="comment">              */</span></span><br><span class="line">             </span><br><span class="line">             <span class="comment">// ä¸ºçƒ­ç‚¹æ•°æ®ç”Ÿæˆå¤šä¸ªå‰¯æœ¬</span></span><br><span class="line">             <span class="type">int</span> <span class="variable">randomSuffix</span> <span class="operator">=</span> ThreadLocalRandom.current().nextInt(<span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">             <span class="keyword">return</span> hotKey + <span class="string">&quot;_hot_&quot;</span> + randomSuffix;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     <span class="comment">// 2. è´Ÿè½½å‡è¡¡ç­–ç•¥</span></span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoadBalancingStrategy</span> &#123;</span><br><span class="line">         </span><br><span class="line">         <span class="comment">// åŠ¨æ€æƒé‡åˆ†ç‰‡</span></span><br><span class="line">         <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WeightedSharding</span> &#123;</span><br><span class="line">             <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Integer&gt; shardWeights;</span><br><span class="line">             <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">             </span><br><span class="line">             <span class="keyword">public</span> <span class="title function_">WeightedSharding</span><span class="params">()</span> &#123;</span><br><span class="line">                 shardWeights = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                 <span class="comment">// æ ¹æ®åˆ†ç‰‡æ€§èƒ½é…ç½®æƒé‡</span></span><br><span class="line">                 shardWeights.put(<span class="string">&quot;shard_0&quot;</span>, <span class="number">100</span>);  <span class="comment">// é«˜æ€§èƒ½åˆ†ç‰‡</span></span><br><span class="line">                 shardWeights.put(<span class="string">&quot;shard_1&quot;</span>, <span class="number">80</span>);   <span class="comment">// ä¸­ç­‰æ€§èƒ½åˆ†ç‰‡</span></span><br><span class="line">                 shardWeights.put(<span class="string">&quot;shard_2&quot;</span>, <span class="number">60</span>);   <span class="comment">// ä½æ€§èƒ½åˆ†ç‰‡</span></span><br><span class="line">             &#125;</span><br><span class="line">             </span><br><span class="line">             <span class="keyword">public</span> String <span class="title function_">selectShard</span><span class="params">(String key)</span> &#123;</span><br><span class="line">                 <span class="type">int</span> <span class="variable">totalWeight</span> <span class="operator">=</span> shardWeights.values().stream().mapToInt(Integer::intValue).sum();</span><br><span class="line">                 <span class="type">int</span> <span class="variable">randomWeight</span> <span class="operator">=</span> random.nextInt(totalWeight);</span><br><span class="line">                 </span><br><span class="line">                 <span class="type">int</span> <span class="variable">currentWeight</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                 <span class="keyword">for</span> (Map.Entry&lt;String, Integer&gt; entry : shardWeights.entrySet()) &#123;</span><br><span class="line">                     currentWeight += entry.getValue();</span><br><span class="line">                     <span class="keyword">if</span> (randomWeight &lt; currentWeight) &#123;</span><br><span class="line">                         <span class="keyword">return</span> entry.getKey();</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;</span><br><span class="line">                 </span><br><span class="line">                 <span class="keyword">return</span> shardWeights.keySet().iterator().next();</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         </span><br><span class="line">         <span class="comment">// ä¸€è‡´æ€§å“ˆå¸Œè´Ÿè½½å‡è¡¡</span></span><br><span class="line">         <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsistentHashLoadBalancer</span> &#123;</span><br><span class="line">             <span class="keyword">private</span> <span class="keyword">final</span> ConsistentHashingSharding consistentHash;</span><br><span class="line">             </span><br><span class="line">             <span class="keyword">public</span> <span class="title function_">ConsistentHashLoadBalancer</span><span class="params">()</span> &#123;</span><br><span class="line">                 <span class="built_in">this</span>.consistentHash = <span class="keyword">new</span> <span class="title class_">ConsistentHashingSharding</span>();</span><br><span class="line">                 <span class="comment">// åˆå§‹åŒ–åˆ†ç‰‡èŠ‚ç‚¹</span></span><br><span class="line">                 consistentHash.addShard(<span class="string">&quot;shard_0&quot;</span>);</span><br><span class="line">                 consistentHash.addShard(<span class="string">&quot;shard_1&quot;</span>);</span><br><span class="line">                 consistentHash.addShard(<span class="string">&quot;shard_2&quot;</span>);</span><br><span class="line">                 consistentHash.addShard(<span class="string">&quot;shard_3&quot;</span>);</span><br><span class="line">             &#125;</span><br><span class="line">             </span><br><span class="line">             <span class="keyword">public</span> String <span class="title function_">route</span><span class="params">(String key)</span> &#123;</span><br><span class="line">                 <span class="keyword">return</span> consistentHash.getShard(key);</span><br><span class="line">             &#125;</span><br><span class="line">             </span><br><span class="line">             <span class="comment">// åŠ¨æ€æ·»åŠ åˆ†ç‰‡èŠ‚ç‚¹</span></span><br><span class="line">             <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addShardNode</span><span class="params">(String shardName)</span> &#123;</span><br><span class="line">                 consistentHash.addShard(shardName);</span><br><span class="line">                 System.out.println(<span class="string">&quot;æ·»åŠ åˆ†ç‰‡èŠ‚ç‚¹: &quot;</span> + shardName);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-2-2-æ²»ç†æ€§æªæ–½"><a href="#5-2-2-æ²»ç†æ€§æªæ–½" class="headerlink" title="5.2.2 æ²»ç†æ€§æªæ–½"></a>5.2.2 æ²»ç†æ€§æªæ–½</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ•°æ®å€¾æ–œæ²»ç†æªæ–½</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SkewMitigationStrategies</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. æ•°æ®é‡å¹³è¡¡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataRebalancing</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åœ¨çº¿æ•°æ®è¿ç§»</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OnlineDataMigration</span> &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">migrateData</span><span class="params">(String sourceShard, String targetShard, String migrationKey)</span> &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * åœ¨çº¿æ•°æ®è¿ç§»æ­¥éª¤ï¼š</span></span><br><span class="line"><span class="comment">                 * 1. åŒå†™é˜¶æ®µï¼šæ–°æ•°æ®åŒæ—¶å†™å…¥æºåˆ†ç‰‡å’Œç›®æ ‡åˆ†ç‰‡</span></span><br><span class="line"><span class="comment">                 * 2. æ•°æ®åŒæ­¥ï¼šå°†å†å²æ•°æ®ä»æºåˆ†ç‰‡è¿ç§»åˆ°ç›®æ ‡åˆ†ç‰‡</span></span><br><span class="line"><span class="comment">                 * 3. è¯»åˆ‡æ¢ï¼šé€æ­¥å°†è¯»è¯·æ±‚åˆ‡æ¢åˆ°ç›®æ ‡åˆ†ç‰‡</span></span><br><span class="line"><span class="comment">                 * 4. æ¸…ç†é˜¶æ®µï¼šåˆ é™¤æºåˆ†ç‰‡ä¸­çš„è¿ç§»æ•°æ®</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                </span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// é˜¶æ®µ1ï¼šå¼€å¯åŒå†™</span></span><br><span class="line">                    enableDualWrite(sourceShard, targetShard, migrationKey);</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// é˜¶æ®µ2ï¼šå†å²æ•°æ®è¿ç§»</span></span><br><span class="line">                    migrateHistoricalData(sourceShard, targetShard, migrationKey);</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// é˜¶æ®µ3ï¼šè¯»åˆ‡æ¢</span></span><br><span class="line">                    switchReadTraffic(sourceShard, targetShard, migrationKey);</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// é˜¶æ®µ4ï¼šåœæ­¢åŒå†™ï¼Œæ¸…ç†æºæ•°æ®</span></span><br><span class="line">                    disableDualWrite(sourceShard, migrationKey);</span><br><span class="line">                    </span><br><span class="line">                    System.out.println(<span class="string">&quot;æ•°æ®è¿ç§»å®Œæˆ: &quot;</span> + migrationKey + <span class="string">&quot; from &quot;</span> + sourceShard + <span class="string">&quot; to &quot;</span> + targetShard);</span><br><span class="line">                    </span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="comment">// è¿ç§»å¤±è´¥ï¼Œå›æ»šæ“ä½œ</span></span><br><span class="line">                    rollbackMigration(sourceShard, targetShard, migrationKey);</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;æ•°æ®è¿ç§»å¤±è´¥&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">rollbackMigration</span><span class="params">(String sourceShard, String targetShard, String migrationKey)</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;å¼€å§‹å›æ»šæ•°æ®è¿ç§»: &quot;</span> + migrationKey);</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 1. åœæ­¢åŒå†™ï¼Œæ¢å¤å•å†™åˆ°æºåˆ†ç‰‡</span></span><br><span class="line">                    disableDualWrite(sourceShard, migrationKey);</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 2. å°†è¯»æµé‡åˆ‡å›æºåˆ†ç‰‡</span></span><br><span class="line">                    switchReadTraffic(targetShard, sourceShard, migrationKey);</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 3. æ¸…ç†ç›®æ ‡åˆ†ç‰‡ä¸­çš„è¿ç§»æ•°æ®</span></span><br><span class="line">                    cleanupMigratedData(targetShard, migrationKey);</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 4. è®°å½•å›æ»šæ—¥å¿—</span></span><br><span class="line">                    logMigrationRollback(sourceShard, targetShard, migrationKey);</span><br><span class="line">                    </span><br><span class="line">                    System.out.println(<span class="string">&quot;æ•°æ®è¿ç§»å›æ»šå®Œæˆ: &quot;</span> + migrationKey);</span><br><span class="line">                    </span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception rollbackException) &#123;</span><br><span class="line">                    System.err.println(<span class="string">&quot;å›æ»šæ“ä½œå¤±è´¥: &quot;</span> + rollbackException.getMessage());</span><br><span class="line">                    <span class="comment">// å‘é€ç´§æ€¥å‘Šè­¦ï¼Œéœ€è¦äººå·¥ä»‹å…¥</span></span><br><span class="line">                    sendEmergencyAlert(<span class="string">&quot;æ•°æ®è¿ç§»å›æ»šå¤±è´¥&quot;</span>, sourceShard, targetShard, migrationKey);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">cleanupMigratedData</span><span class="params">(String shard, String migrationKey)</span> &#123;</span><br><span class="line">                <span class="comment">// åˆ é™¤ç›®æ ‡åˆ†ç‰‡ä¸­çš„è¿ç§»æ•°æ®</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">deleteSql</span> <span class="operator">=</span> <span class="string">&quot;DELETE FROM target_table WHERE migration_key = ?&quot;</span>;</span><br><span class="line">                executeUpdate(shard, deleteSql, migrationKey);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">logMigrationRollback</span><span class="params">(String sourceShard, String targetShard, String migrationKey)</span> &#123;</span><br><span class="line">                <span class="comment">// è®°å½•å›æ»šæ“ä½œåˆ°å®¡è®¡æ—¥å¿—</span></span><br><span class="line">                <span class="type">AuditLog</span> <span class="variable">auditLog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuditLog</span>();</span><br><span class="line">                auditLog.setOperation(<span class="string">&quot;MIGRATION_ROLLBACK&quot;</span>);</span><br><span class="line">                auditLog.setSourceShard(sourceShard);</span><br><span class="line">                auditLog.setTargetShard(targetShard);</span><br><span class="line">                auditLog.setMigrationKey(migrationKey);</span><br><span class="line">                auditLog.setTimestamp(System.currentTimeMillis());</span><br><span class="line">                </span><br><span class="line">                auditLogService.save(auditLog);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendEmergencyAlert</span><span class="params">(String message, String sourceShard, String targetShard, String migrationKey)</span> &#123;</span><br><span class="line">                <span class="comment">// å‘é€ç´§æ€¥å‘Šè­¦é€šçŸ¥</span></span><br><span class="line">                <span class="type">AlertMessage</span> <span class="variable">alert</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlertMessage</span>();</span><br><span class="line">                alert.setLevel(<span class="string">&quot;CRITICAL&quot;</span>);</span><br><span class="line">                alert.setMessage(message);</span><br><span class="line">                alert.addDetail(<span class="string">&quot;sourceShard&quot;</span>, sourceShard);</span><br><span class="line">                alert.addDetail(<span class="string">&quot;targetShard&quot;</span>, targetShard);</span><br><span class="line">                alert.addDetail(<span class="string">&quot;migrationKey&quot;</span>, migrationKey);</span><br><span class="line">                </span><br><span class="line">                alertService.sendEmergencyAlert(alert);</span><br><span class="line">            &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">enableDualWrite</span><span class="params">(String sourceShard, String targetShard, String migrationKey)</span> &#123;</span><br><span class="line">                <span class="comment">// é…ç½®åŒå†™è§„åˆ™</span></span><br><span class="line">                <span class="type">DualWriteConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DualWriteConfig</span>();</span><br><span class="line">                config.setSourceShard(sourceShard);</span><br><span class="line">                config.setTargetShard(targetShard);</span><br><span class="line">                config.setMigrationKey(migrationKey);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// å¯ç”¨åŒå†™</span></span><br><span class="line">                ShardingConfigManager.enableDualWrite(config);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">migrateHistoricalData</span><span class="params">(String sourceShard, String targetShard, String migrationKey)</span> &#123;</span><br><span class="line">                <span class="comment">// åˆ†æ‰¹è¿ç§»å†å²æ•°æ®</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">batchSize</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line">                <span class="type">int</span> <span class="variable">offset</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    List&lt;DataRecord&gt; batch = queryDataBatch(sourceShard, migrationKey, offset, batchSize);</span><br><span class="line">                    <span class="keyword">if</span> (batch.isEmpty()) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// å†™å…¥ç›®æ ‡åˆ†ç‰‡</span></span><br><span class="line">                    insertDataBatch(targetShard, batch);</span><br><span class="line">                    </span><br><span class="line">                    offset += batchSize;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// é™æµï¼Œé¿å…å½±å“æ­£å¸¸ä¸šåŠ¡</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        Thread.currentThread().interrupt();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆ†ç‰‡æ‹†åˆ†ç­–ç•¥</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShardSplitting</span> &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">splitShard</span><span class="params">(String originalShard, String newShard1, String newShard2)</span> &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * åˆ†ç‰‡æ‹†åˆ†ç­–ç•¥ï¼š</span></span><br><span class="line"><span class="comment">                 * 1. åˆ›å»ºæ–°çš„åˆ†ç‰‡èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">                 * 2. é‡æ–°è®¡ç®—æ•°æ®åˆ†å¸ƒ</span></span><br><span class="line"><span class="comment">                 * 3. è¿ç§»éƒ¨åˆ†æ•°æ®åˆ°æ–°åˆ†ç‰‡</span></span><br><span class="line"><span class="comment">                 * 4. æ›´æ–°è·¯ç”±è§„åˆ™</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment">// åˆ›å»ºæ–°åˆ†ç‰‡</span></span><br><span class="line">                createNewShard(newShard1);</span><br><span class="line">                createNewShard(newShard2);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// è®¡ç®—æ•°æ®åˆ†å¸ƒç­–ç•¥</span></span><br><span class="line">                <span class="type">DataDistributionPlan</span> <span class="variable">plan</span> <span class="operator">=</span> calculateDistributionPlan(originalShard, newShard1, newShard2);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// æ‰§è¡Œæ•°æ®è¿ç§»</span></span><br><span class="line">                executeDataMigration(plan);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// æ›´æ–°è·¯ç”±é…ç½®</span></span><br><span class="line">                updateRoutingRules(originalShard, newShard1, newShard2);</span><br><span class="line">                </span><br><span class="line">                System.out.println(<span class="string">&quot;åˆ†ç‰‡æ‹†åˆ†å®Œæˆ: &quot;</span> + originalShard + <span class="string">&quot; -&gt; &quot;</span> + newShard1 + <span class="string">&quot;, &quot;</span> + newShard2);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. çƒ­ç‚¹æ•°æ®å¤„ç†</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HotDataHandling</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// çƒ­ç‚¹æ•°æ®ç¼“å­˜</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HotDataCache</span> &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">final</span> Cache&lt;String, Object&gt; hotDataCache;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">public</span> <span class="title function_">HotDataCache</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.hotDataCache = Caffeine.newBuilder()</span><br><span class="line">                        .maximumSize(<span class="number">10000</span>)</span><br><span class="line">                        .expireAfterWrite(Duration.ofMinutes(<span class="number">30</span>))</span><br><span class="line">                        .recordStats()</span><br><span class="line">                        .build();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">public</span> Object <span class="title function_">getHotData</span><span class="params">(String key)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> hotDataCache.getIfPresent(key);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cacheHotData</span><span class="params">(String key, Object data)</span> &#123;</span><br><span class="line">                hotDataCache.put(key, data);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// çƒ­ç‚¹æ•°æ®è¯†åˆ«</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isHotData</span><span class="params">(String key, <span class="type">long</span> accessCount)</span> &#123;</span><br><span class="line">                <span class="comment">// è®¿é—®æ¬¡æ•°è¶…è¿‡é˜ˆå€¼è®¤ä¸ºæ˜¯çƒ­ç‚¹æ•°æ®</span></span><br><span class="line">                <span class="keyword">return</span> accessCount &gt; <span class="number">1000</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// çƒ­ç‚¹æ•°æ®åˆ†æ•£</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HotDataDispersion</span> &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">disperseHotData</span><span class="params">(String hotKey, Object hotData)</span> &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * çƒ­ç‚¹æ•°æ®åˆ†æ•£ç­–ç•¥ï¼š</span></span><br><span class="line"><span class="comment">                 * 1. å°†çƒ­ç‚¹æ•°æ®å¤åˆ¶åˆ°å¤šä¸ªåˆ†ç‰‡</span></span><br><span class="line"><span class="comment">                 * 2. ä½¿ç”¨éšæœºè·¯ç”±åˆ†æ•£è¯»è¯·æ±‚</span></span><br><span class="line"><span class="comment">                 * 3. å®šæœŸæ¸…ç†å†·æ•°æ®å‰¯æœ¬</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment">// è®¡ç®—éœ€è¦å¤åˆ¶çš„åˆ†ç‰‡æ•°é‡</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">replicationCount</span> <span class="operator">=</span> calculateReplicationCount(hotKey);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// é€‰æ‹©ç›®æ ‡åˆ†ç‰‡</span></span><br><span class="line">                List&lt;String&gt; targetShards = selectTargetShards(replicationCount);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// å¤åˆ¶æ•°æ®åˆ°ç›®æ ‡åˆ†ç‰‡</span></span><br><span class="line">                <span class="keyword">for</span> (String shard : targetShards) &#123;</span><br><span class="line">                    replicateDataToShard(shard, hotKey, hotData);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// æ›´æ–°è·¯ç”±ç­–ç•¥ï¼Œæ”¯æŒéšæœºè¯»å–</span></span><br><span class="line">                updateHotDataRouting(hotKey, targetShards);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">calculateReplicationCount</span><span class="params">(String hotKey)</span> &#123;</span><br><span class="line">                <span class="comment">// æ ¹æ®çƒ­ç‚¹ç¨‹åº¦å†³å®šå¤åˆ¶æ•°é‡</span></span><br><span class="line">                <span class="type">long</span> <span class="variable">accessCount</span> <span class="operator">=</span> getAccessCount(hotKey);</span><br><span class="line">                <span class="keyword">if</span> (accessCount &gt; <span class="number">10000</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">4</span>;  <span class="comment">// è¶…çƒ­ç‚¹æ•°æ®ï¼Œå¤åˆ¶4ä»½</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (accessCount &gt; <span class="number">5000</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">2</span>;  <span class="comment">// çƒ­ç‚¹æ•°æ®ï¼Œå¤åˆ¶2ä»½</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">1</span>;  <span class="comment">// æ™®é€šæ•°æ®ï¼Œä¸å¤åˆ¶</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. åŠ¨æ€æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicScaling</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è‡ªåŠ¨æ‰©å®¹è§¦å‘å™¨</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AutoScalingTrigger</span> &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ScheduledExecutorService</span> <span class="variable">scheduler</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startMonitoring</span><span class="params">()</span> &#123;</span><br><span class="line">                scheduler.scheduleAtFixedRate(<span class="built_in">this</span>::checkScalingConditions, <span class="number">0</span>, <span class="number">5</span>, TimeUnit.MINUTES);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkScalingConditions</span><span class="params">()</span> &#123;</span><br><span class="line">                Map&lt;String, ShardMetrics&gt; shardMetrics = collectShardMetrics();</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">for</span> (Map.Entry&lt;String, ShardMetrics&gt; entry : shardMetrics.entrySet()) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">shard</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">                    <span class="type">ShardMetrics</span> <span class="variable">metrics</span> <span class="operator">=</span> entry.getValue();</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰©å®¹</span></span><br><span class="line">                    <span class="keyword">if</span> (shouldScaleOut(metrics)) &#123;</span><br><span class="line">                        triggerScaleOut(shard);</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// æ£€æŸ¥æ˜¯å¦éœ€è¦ç¼©å®¹</span></span><br><span class="line">                    <span class="keyword">if</span> (shouldScaleIn(metrics)) &#123;</span><br><span class="line">                        triggerScaleIn(shard);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">shouldScaleOut</span><span class="params">(ShardMetrics metrics)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> metrics.getCpuUsage() &gt; <span class="number">80</span> || </span><br><span class="line">                       metrics.getMemoryUsage() &gt; <span class="number">85</span> || </span><br><span class="line">                       metrics.getQps() &gt; <span class="number">5000</span> ||</span><br><span class="line">                       metrics.getAvgResponseTime() &gt; <span class="number">1000</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">shouldScaleIn</span><span class="params">(ShardMetrics metrics)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> metrics.getCpuUsage() &lt; <span class="number">20</span> &amp;&amp; </span><br><span class="line">                       metrics.getMemoryUsage() &lt; <span class="number">30</span> &amp;&amp; </span><br><span class="line">                       metrics.getQps() &lt; <span class="number">500</span> &amp;&amp;</span><br><span class="line">                       metrics.getAvgResponseTime() &lt; <span class="number">100</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-åˆ†åº“åˆ†è¡¨æœ€ä½³å®è·µ"><a href="#6-åˆ†åº“åˆ†è¡¨æœ€ä½³å®è·µ" class="headerlink" title="6. åˆ†åº“åˆ†è¡¨æœ€ä½³å®è·µ"></a>6. åˆ†åº“åˆ†è¡¨æœ€ä½³å®è·µ</h2><h3 id="6-1-æ¶æ„è®¾è®¡æœ€ä½³å®è·µ"><a href="#6-1-æ¶æ„è®¾è®¡æœ€ä½³å®è·µ" class="headerlink" title="6.1 æ¶æ„è®¾è®¡æœ€ä½³å®è·µ"></a>6.1 æ¶æ„è®¾è®¡æœ€ä½³å®è·µ</h3><h4 id="6-1-1-åˆ†ç‰‡ç­–ç•¥é€‰æ‹©"><a href="#6-1-1-åˆ†ç‰‡ç­–ç•¥é€‰æ‹©" class="headerlink" title="6.1.1 åˆ†ç‰‡ç­–ç•¥é€‰æ‹©"></a>6.1.1 åˆ†ç‰‡ç­–ç•¥é€‰æ‹©</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ†ç‰‡ç­–ç•¥é€‰æ‹©æŒ‡å—</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShardingStrategyGuide</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * ä¸šåŠ¡åœºæ™¯ä¸åˆ†ç‰‡ç­–ç•¥åŒ¹é…ï¼š</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * 1. ç”¨æˆ·ç›¸å…³ä¸šåŠ¡ï¼ˆç¤¾äº¤ã€ç”µå•†ï¼‰</span></span><br><span class="line"><span class="comment">     *    - æ¨èï¼šæŒ‰ç”¨æˆ·IDåˆ†ç‰‡</span></span><br><span class="line"><span class="comment">     *    - ä¼˜åŠ¿ï¼šç”¨æˆ·æ•°æ®èšåˆï¼Œæ”¯æŒç”¨æˆ·ç»´åº¦æŸ¥è¯¢</span></span><br><span class="line"><span class="comment">     *    - æ³¨æ„ï¼šé¿å…å¤§Vç”¨æˆ·æˆä¸ºçƒ­ç‚¹</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * 2. æ—¶åºæ•°æ®ä¸šåŠ¡ï¼ˆæ—¥å¿—ã€ç›‘æ§ï¼‰</span></span><br><span class="line"><span class="comment">     *    - æ¨èï¼šæŒ‰æ—¶é—´åˆ†ç‰‡</span></span><br><span class="line"><span class="comment">     *    - ä¼˜åŠ¿ï¼šæ”¯æŒæ—¶é—´èŒƒå›´æŸ¥è¯¢ï¼Œä¾¿äºæ•°æ®å½’æ¡£</span></span><br><span class="line"><span class="comment">     *    - æ³¨æ„ï¼šå½“å‰æ—¶é—´åˆ†ç‰‡å¯èƒ½æˆä¸ºçƒ­ç‚¹</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * 3. åœ°ç†ä½ç½®ä¸šåŠ¡ï¼ˆO2Oã€ç‰©æµï¼‰</span></span><br><span class="line"><span class="comment">     *    - æ¨èï¼šæŒ‰åœ°ç†åŒºåŸŸåˆ†ç‰‡</span></span><br><span class="line"><span class="comment">     *    - ä¼˜åŠ¿ï¼šæ”¯æŒåœ°ç†ä½ç½®æŸ¥è¯¢ï¼Œå‡å°‘è·¨åŒºåŸŸæŸ¥è¯¢</span></span><br><span class="line"><span class="comment">     *    - æ³¨æ„ï¼šçƒ­é—¨åŸå¸‚å¯èƒ½æˆä¸ºçƒ­ç‚¹</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * 4. å†…å®¹åˆ†å‘ä¸šåŠ¡ï¼ˆCDNã€åª’ä½“ï¼‰</span></span><br><span class="line"><span class="comment">     *    - æ¨èï¼šæŒ‰å†…å®¹å“ˆå¸Œåˆ†ç‰‡</span></span><br><span class="line"><span class="comment">     *    - ä¼˜åŠ¿ï¼šå†…å®¹åˆ†å¸ƒå‡åŒ€ï¼Œæ”¯æŒå†…å®¹å»é‡</span></span><br><span class="line"><span class="comment">     *    - æ³¨æ„ï¼šçƒ­é—¨å†…å®¹å¯èƒ½æˆä¸ºçƒ­ç‚¹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ShardingStrategy <span class="title function_">selectStrategy</span><span class="params">(BusinessType businessType, DataCharacteristics characteristics)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (businessType) &#123;</span><br><span class="line">            <span class="keyword">case</span> USER_CENTRIC:</span><br><span class="line">                <span class="keyword">if</span> (characteristics.hasHotUsers()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CompositeShardingStrategy</span>(<span class="string">&quot;user_id&quot;</span>, <span class="string">&quot;region&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashShardingStrategy</span>(<span class="string">&quot;user_id&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> TIME_SERIES:</span><br><span class="line">                <span class="keyword">if</span> (characteristics.hasHighWriteVolume()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TimeHashShardingStrategy</span>(<span class="string">&quot;timestamp&quot;</span>, <span class="string">&quot;user_id&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TimeShardingStrategy</span>(<span class="string">&quot;timestamp&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> GEO_LOCATION:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">GeoShardingStrategy</span>(<span class="string">&quot;latitude&quot;</span>, <span class="string">&quot;longitude&quot;</span>);</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> CONTENT_DISTRIBUTION:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ConsistentHashShardingStrategy</span>(<span class="string">&quot;content_hash&quot;</span>);</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashShardingStrategy</span>(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6-1-2-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥"><a href="#6-1-2-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="6.1.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥"></a>6.1.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PerformanceOptimization</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. æŸ¥è¯¢ä¼˜åŒ–</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueryOptimization</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é¿å…è·¨åˆ†ç‰‡æŸ¥è¯¢</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">avoidCrossShardQueries</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * ç­–ç•¥ï¼š</span></span><br><span class="line"><span class="comment">             * 1. åˆç†è®¾è®¡åˆ†ç‰‡é”®ï¼Œè®©ç›¸å…³æ•°æ®åœ¨åŒä¸€åˆ†ç‰‡</span></span><br><span class="line"><span class="comment">             * 2. ä½¿ç”¨ç»‘å®šè¡¨ï¼ˆBinding Tableï¼‰</span></span><br><span class="line"><span class="comment">             * 3. æ•°æ®å†—ä½™ï¼Œé¿å…JOINæŸ¥è¯¢</span></span><br><span class="line"><span class="comment">             * 4. ä½¿ç”¨å…¨å±€è¡¨å­˜å‚¨å­—å…¸æ•°æ®</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–</span></span><br><span class="line">        <span class="keyword">public</span> PageResult&lt;Order&gt; <span class="title function_">optimizedPagination</span><span class="params">(Long userId, <span class="type">int</span> pageNum, <span class="type">int</span> pageSize)</span> &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * ä¼ ç»Ÿåˆ†é¡µé—®é¢˜ï¼š</span></span><br><span class="line"><span class="comment">             * SELECT * FROM orders WHERE user_id = ? ORDER BY create_time DESC LIMIT ?, ?</span></span><br><span class="line"><span class="comment">             * </span></span><br><span class="line"><span class="comment">             * è·¨åˆ†ç‰‡åˆ†é¡µéœ€è¦ï¼š</span></span><br><span class="line"><span class="comment">             * 1. æŸ¥è¯¢æ‰€æœ‰åˆ†ç‰‡</span></span><br><span class="line"><span class="comment">             * 2. åº”ç”¨å±‚æ’åº</span></span><br><span class="line"><span class="comment">             * 3. æˆªå–åˆ†é¡µæ•°æ®</span></span><br><span class="line"><span class="comment">             * </span></span><br><span class="line"><span class="comment">             * ä¼˜åŒ–ç­–ç•¥ï¼š</span></span><br><span class="line"><span class="comment">             * 1. ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µï¼ˆåŸºäºIDæˆ–æ—¶é—´æˆ³ï¼‰</span></span><br><span class="line"><span class="comment">             * 2. é¢„è®¡ç®—çƒ­é—¨æ•°æ®çš„åˆ†é¡µç»“æœ</span></span><br><span class="line"><span class="comment">             * 3. ä½¿ç”¨æœç´¢å¼•æ“ï¼ˆElasticsearchï¼‰</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// æ¸¸æ ‡åˆ†é¡µç¤ºä¾‹</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">shard</span> <span class="operator">=</span> getShardByUserId(userId);</span><br><span class="line">            <span class="keyword">return</span> queryOrdersWithCursor(shard, userId, pageNum, pageSize);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// èšåˆæŸ¥è¯¢ä¼˜åŒ–</span></span><br><span class="line">        <span class="keyword">public</span> OrderStatistics <span class="title function_">optimizedAggregation</span><span class="params">(Date startDate, Date endDate)</span> &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * èšåˆæŸ¥è¯¢æŒ‘æˆ˜ï¼š</span></span><br><span class="line"><span class="comment">             * - éœ€è¦æŸ¥è¯¢æ‰€æœ‰åˆ†ç‰‡</span></span><br><span class="line"><span class="comment">             * - æ•°æ®é‡å¤§ï¼Œæ€§èƒ½å·®</span></span><br><span class="line"><span class="comment">             * </span></span><br><span class="line"><span class="comment">             * ä¼˜åŒ–ç­–ç•¥ï¼š</span></span><br><span class="line"><span class="comment">             * 1. é¢„èšåˆï¼šå®šæ—¶è®¡ç®—ç»Ÿè®¡æ•°æ®</span></span><br><span class="line"><span class="comment">             * 2. å®æ—¶è®¡ç®— + é¢„èšåˆç»“åˆ</span></span><br><span class="line"><span class="comment">             * 3. ä½¿ç”¨OLAPå¼•æ“ï¼ˆClickHouseã€Druidï¼‰</span></span><br><span class="line"><span class="comment">             * 4. åˆ†å±‚èšåˆï¼šå…ˆåˆ†ç‰‡èšåˆï¼Œå†å…¨å±€èšåˆ</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å¹¶è¡Œèšåˆç¤ºä¾‹</span></span><br><span class="line">            List&lt;CompletableFuture&lt;OrderStatistics&gt;&gt; futures = getAllShards().stream()</span><br><span class="line">                    .map(shard -&gt; CompletableFuture.supplyAsync(() -&gt; </span><br><span class="line">                            aggregateOrdersFromShard(shard, startDate, endDate)))</span><br><span class="line">                    .collect(Collectors.toList());</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> futures.stream()</span><br><span class="line">                    .map(CompletableFuture::join)</span><br><span class="line">                    .reduce(<span class="keyword">new</span> <span class="title class_">OrderStatistics</span>(), OrderStatistics::merge);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. è¿æ¥æ± ä¼˜åŒ–</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConnectionPoolOptimization</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="keyword">public</span> DataSource <span class="title function_">optimizedDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">HikariConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HikariConfig</span>();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// è¿æ¥æ± å¤§å°é…ç½®</span></span><br><span class="line">            config.setMaximumPoolSize(<span class="number">20</span>);  <span class="comment">// æœ€å¤§è¿æ¥æ•°</span></span><br><span class="line">            config.setMinimumIdle(<span class="number">5</span>);       <span class="comment">// æœ€å°ç©ºé—²è¿æ¥æ•°</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// è¿æ¥è¶…æ—¶é…ç½®</span></span><br><span class="line">            config.setConnectionTimeout(<span class="number">30000</span>);    <span class="comment">// 30ç§’</span></span><br><span class="line">            config.setIdleTimeout(<span class="number">600000</span>);         <span class="comment">// 10åˆ†é’Ÿ</span></span><br><span class="line">            config.setMaxLifetime(<span class="number">1800000</span>);        <span class="comment">// 30åˆ†é’Ÿ</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// æ€§èƒ½ä¼˜åŒ–é…ç½®</span></span><br><span class="line">            config.setLeakDetectionThreshold(<span class="number">60000</span>); <span class="comment">// è¿æ¥æ³„æ¼æ£€æµ‹</span></span><br><span class="line">            config.addDataSourceProperty(<span class="string">&quot;cachePrepStmts&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">            config.addDataSourceProperty(<span class="string">&quot;prepStmtCacheSize&quot;</span>, <span class="string">&quot;250&quot;</span>);</span><br><span class="line">            config.addDataSourceProperty(<span class="string">&quot;prepStmtCacheSqlLimit&quot;</span>, <span class="string">&quot;2048&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HikariDataSource</span>(config);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ç¼“å­˜ç­–ç•¥</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CachingStrategy</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¤šçº§ç¼“å­˜æ¶æ„</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiLevelCache</span> &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">final</span> Cache&lt;String, Object&gt; l1Cache;  <span class="comment">// æœ¬åœ°ç¼“å­˜</span></span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">final</span> RedisTemplate&lt;String, Object&gt; l2Cache;  <span class="comment">// åˆ†å¸ƒå¼ç¼“å­˜</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(String key)</span> &#123;</span><br><span class="line">                <span class="comment">// L1ç¼“å­˜æŸ¥è¯¢</span></span><br><span class="line">                <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> l1Cache.getIfPresent(key);</span><br><span class="line">                <span class="keyword">if</span> (value != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> value;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// L2ç¼“å­˜æŸ¥è¯¢</span></span><br><span class="line">                value = l2Cache.opsForValue().get(key);</span><br><span class="line">                <span class="keyword">if</span> (value != <span class="literal">null</span>) &#123;</span><br><span class="line">                    l1Cache.put(key, value);</span><br><span class="line">                    <span class="keyword">return</span> value;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// æ•°æ®åº“æŸ¥è¯¢</span></span><br><span class="line">                value = queryFromDatabase(key);</span><br><span class="line">                <span class="keyword">if</span> (value != <span class="literal">null</span>) &#123;</span><br><span class="line">                    l1Cache.put(key, value);</span><br><span class="line">                    l2Cache.opsForValue().set(key, value, Duration.ofHours(<span class="number">1</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ç¼“å­˜ä¸€è‡´æ€§ç­–ç•¥</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheConsistency</span> &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å†™å…¥æ—¶æ›´æ–°ç¼“å­˜</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateWithCache</span><span class="params">(String key, Object value)</span> &#123;</span><br><span class="line">                <span class="comment">// 1. æ›´æ–°æ•°æ®åº“</span></span><br><span class="line">                updateDatabase(key, value);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 2. æ›´æ–°ç¼“å­˜</span></span><br><span class="line">                updateCache(key, value);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 3. å‘é€ç¼“å­˜å¤±æ•ˆæ¶ˆæ¯</span></span><br><span class="line">                sendCacheInvalidationMessage(key);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å»¶è¿ŸåŒåˆ ç­–ç•¥</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delayedDoubleDelete</span><span class="params">(String key, Object value)</span> &#123;</span><br><span class="line">                <span class="comment">// 1. åˆ é™¤ç¼“å­˜</span></span><br><span class="line">                deleteCache(key);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 2. æ›´æ–°æ•°æ®åº“</span></span><br><span class="line">                updateDatabase(key, value);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 3. å»¶è¿Ÿåˆ é™¤ç¼“å­˜ï¼ˆé˜²æ­¢è„è¯»ï¼‰</span></span><br><span class="line">                CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">1000</span>);  <span class="comment">// å»¶è¿Ÿ1ç§’</span></span><br><span class="line">                        deleteCache(key);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        Thread.currentThread().interrupt();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-è¿ç»´ç®¡ç†æœ€ä½³å®è·µ"><a href="#6-2-è¿ç»´ç®¡ç†æœ€ä½³å®è·µ" class="headerlink" title="6.2 è¿ç»´ç®¡ç†æœ€ä½³å®è·µ"></a>6.2 è¿ç»´ç®¡ç†æœ€ä½³å®è·µ</h3><h4 id="6-2-1-ç›‘æ§å‘Šè­¦ä½“ç³»"><a href="#6-2-1-ç›‘æ§å‘Šè­¦ä½“ç³»" class="headerlink" title="6.2.1 ç›‘æ§å‘Šè­¦ä½“ç³»"></a>6.2.1 ç›‘æ§å‘Šè­¦ä½“ç³»</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç›‘æ§å‘Šè­¦æœ€ä½³å®è·µ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MonitoringBestPractices</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ ¸å¿ƒç›‘æ§æŒ‡æ ‡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CoreMetrics</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ€§èƒ½æŒ‡æ ‡ç›‘æ§</span></span><br><span class="line">        <span class="meta">@Component</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PerformanceMetrics</span> &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">final</span> MeterRegistry meterRegistry;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">public</span> <span class="title function_">PerformanceMetrics</span><span class="params">(MeterRegistry meterRegistry)</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.meterRegistry = meterRegistry;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// QPSç›‘æ§</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordQPS</span><span class="params">(String shard, String operation)</span> &#123;</span><br><span class="line">                Counter.builder(<span class="string">&quot;sharding.qps&quot;</span>)</span><br><span class="line">                        .tag(<span class="string">&quot;shard&quot;</span>, shard)</span><br><span class="line">                        .tag(<span class="string">&quot;operation&quot;</span>, operation)</span><br><span class="line">                        .register(meterRegistry)</span><br><span class="line">                        .increment();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å“åº”æ—¶é—´ç›‘æ§</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordResponseTime</span><span class="params">(String shard, String operation, <span class="type">long</span> duration)</span> &#123;</span><br><span class="line">                Timer.builder(<span class="string">&quot;sharding.response.time&quot;</span>)</span><br><span class="line">                        .tag(<span class="string">&quot;shard&quot;</span>, shard)</span><br><span class="line">                        .tag(<span class="string">&quot;operation&quot;</span>, operation)</span><br><span class="line">                        .register(meterRegistry)</span><br><span class="line">                        .record(duration, TimeUnit.MILLISECONDS);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// é”™è¯¯ç‡ç›‘æ§</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recordError</span><span class="params">(String shard, String operation, String errorType)</span> &#123;</span><br><span class="line">                Counter.builder(<span class="string">&quot;sharding.errors&quot;</span>)</span><br><span class="line">                        .tag(<span class="string">&quot;shard&quot;</span>, shard)</span><br><span class="line">                        .tag(<span class="string">&quot;operation&quot;</span>, operation)</span><br><span class="line">                        .tag(<span class="string">&quot;error.type&quot;</span>, errorType)</span><br><span class="line">                        .register(meterRegistry)</span><br><span class="line">                        .increment();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// èµ„æºä½¿ç”¨ç›‘æ§</span></span><br><span class="line">        <span class="meta">@Component</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResourceMetrics</span> &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// è¿æ¥æ± ç›‘æ§</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">monitorConnectionPool</span><span class="params">(String shard, HikariDataSource dataSource)</span> &#123;</span><br><span class="line">                <span class="type">HikariPoolMXBean</span> <span class="variable">poolBean</span> <span class="operator">=</span> dataSource.getHikariPoolMXBean();</span><br><span class="line">                </span><br><span class="line">                Gauge.builder(<span class="string">&quot;sharding.connection.active&quot;</span>)</span><br><span class="line">                        .tag(<span class="string">&quot;shard&quot;</span>, shard)</span><br><span class="line">                        .register(meterRegistry, poolBean, HikariPoolMXBean::getActiveConnections);</span><br><span class="line">                </span><br><span class="line">                Gauge.builder(<span class="string">&quot;sharding.connection.idle&quot;</span>)</span><br><span class="line">                        .tag(<span class="string">&quot;shard&quot;</span>, shard)</span><br><span class="line">                        .register(meterRegistry, poolBean, HikariPoolMXBean::getIdleConnections);</span><br><span class="line">                </span><br><span class="line">                Gauge.builder(<span class="string">&quot;sharding.connection.total&quot;</span>)</span><br><span class="line">                        .tag(<span class="string">&quot;shard&quot;</span>, shard)</span><br><span class="line">                        .register(meterRegistry, poolBean, HikariPoolMXBean::getTotalConnections);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// æ•°æ®é‡ç›‘æ§</span></span><br><span class="line">            <span class="meta">@Scheduled(fixedRate = 300000)</span> <span class="comment">// æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">monitorDataVolume</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (String shard : getAllShards()) &#123;</span><br><span class="line">                    <span class="type">long</span> <span class="variable">dataCount</span> <span class="operator">=</span> getDataCountFromShard(shard);</span><br><span class="line">                    <span class="type">long</span> <span class="variable">storageSize</span> <span class="operator">=</span> getStorageSizeFromShard(shard);</span><br><span class="line">                    </span><br><span class="line">                    Gauge.builder(<span class="string">&quot;sharding.data.count&quot;</span>)</span><br><span class="line">                            .tag(<span class="string">&quot;shard&quot;</span>, shard)</span><br><span class="line">                            .register(meterRegistry, () -&gt; dataCount);</span><br><span class="line">                    </span><br><span class="line">                    Gauge.builder(<span class="string">&quot;sharding.storage.size&quot;</span>)</span><br><span class="line">                            .tag(<span class="string">&quot;shard&quot;</span>, shard)</span><br><span class="line">                            .register(meterRegistry, () -&gt; storageSize);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å‘Šè­¦è§„åˆ™é…ç½®</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AlertingRules</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å‘Šè­¦æ¢å¤æœºåˆ¶</span></span><br><span class="line">        <span class="meta">@Component</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AlertRecoveryManager</span> &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, AlertState&gt; alertStates = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å‘Šè­¦çŠ¶æ€è·Ÿè¸ª</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">trackAlert</span><span class="params">(String alertKey, AlertLevel level, String message)</span> &#123;</span><br><span class="line">                <span class="type">AlertState</span> <span class="variable">currentState</span> <span class="operator">=</span> alertStates.get(alertKey);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (currentState == <span class="literal">null</span> || currentState.getLevel() != level) &#123;</span><br><span class="line">                    <span class="comment">// æ–°å‘Šè­¦æˆ–å‘Šè­¦çº§åˆ«å˜åŒ–</span></span><br><span class="line">                    <span class="type">AlertState</span> <span class="variable">newState</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlertState</span>(alertKey, level, message, System.currentTimeMillis());</span><br><span class="line">                    alertStates.put(alertKey, newState);</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> (level == AlertLevel.RESOLVED) &#123;</span><br><span class="line">                        handleAlertResolution(alertKey, currentState, newState);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        sendAlert(newState);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å‘Šè­¦æ¢å¤å¤„ç†</span></span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleAlertResolution</span><span class="params">(String alertKey, AlertState oldState, AlertState newState)</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (oldState != <span class="literal">null</span> &amp;&amp; oldState.getLevel() != AlertLevel.RESOLVED) &#123;</span><br><span class="line">                    <span class="comment">// è®¡ç®—å‘Šè­¦æŒç»­æ—¶é—´</span></span><br><span class="line">                    <span class="type">long</span> <span class="variable">duration</span> <span class="operator">=</span> newState.getTimestamp() - oldState.getTimestamp();</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// å‘é€æ¢å¤é€šçŸ¥</span></span><br><span class="line">                    <span class="type">AlertRecoveryNotification</span> <span class="variable">recovery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlertRecoveryNotification</span>();</span><br><span class="line">                    recovery.setAlertKey(alertKey);</span><br><span class="line">                    recovery.setOriginalLevel(oldState.getLevel());</span><br><span class="line">                    recovery.setDuration(duration);</span><br><span class="line">                    recovery.setRecoveryTime(newState.getTimestamp());</span><br><span class="line">                    recovery.setRecoveryMessage(newState.getMessage());</span><br><span class="line">                    </span><br><span class="line">                    sendRecoveryNotification(recovery);</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// è®°å½•æ¢å¤æ—¥å¿—</span></span><br><span class="line">                    logAlertRecovery(alertKey, oldState, duration);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// è‡ªåŠ¨æ¢å¤æ£€æµ‹</span></span><br><span class="line">            <span class="meta">@Scheduled(fixedRate = 60000)</span> <span class="comment">// æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkAutoRecovery</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (Map.Entry&lt;String, AlertState&gt; entry : alertStates.entrySet()) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">alertKey</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">                    <span class="type">AlertState</span> <span class="variable">state</span> <span class="operator">=</span> entry.getValue();</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> (state.getLevel() != AlertLevel.RESOLVED) &#123;</span><br><span class="line">                        <span class="comment">// æ£€æŸ¥å‘Šè­¦æ¡ä»¶æ˜¯å¦å·²æ¢å¤</span></span><br><span class="line">                        <span class="keyword">if</span> (isAlertConditionResolved(alertKey)) &#123;</span><br><span class="line">                            trackAlert(alertKey, AlertLevel.RESOLVED, <span class="string">&quot;ç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹åˆ°å‘Šè­¦æ¡ä»¶å·²æ¢å¤&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isAlertConditionResolved</span><span class="params">(String alertKey)</span> &#123;</span><br><span class="line">                <span class="comment">// æ ¹æ®å‘Šè­¦ç±»å‹æ£€æŸ¥æ¢å¤æ¡ä»¶</span></span><br><span class="line">                <span class="keyword">if</span> (alertKey.contains(<span class="string">&quot;high_cpu&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> getCurrentCpuUsage() &lt; <span class="number">70</span>; <span class="comment">// CPUä½¿ç”¨ç‡ä½äº70%</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (alertKey.contains(<span class="string">&quot;high_response_time&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> getAverageResponseTime() &lt; <span class="number">1000</span>; <span class="comment">// å“åº”æ—¶é—´ä½äº1ç§’</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (alertKey.contains(<span class="string">&quot;connection_pool_exhausted&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> getAvailableConnections() &gt; <span class="number">5</span>; <span class="comment">// å¯ç”¨è¿æ¥æ•°å¤§äº5</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendRecoveryNotification</span><span class="params">(AlertRecoveryNotification recovery)</span> &#123;</span><br><span class="line">                <span class="comment">// å‘é€æ¢å¤é€šçŸ¥åˆ°å„ä¸ªæ¸ é“</span></span><br><span class="line">                notificationService.sendRecoveryNotification(recovery);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">logAlertRecovery</span><span class="params">(String alertKey, AlertState oldState, <span class="type">long</span> duration)</span> &#123;</span><br><span class="line">                System.out.println(String.format(</span><br><span class="line">                    <span class="string">&quot;å‘Šè­¦æ¢å¤: %s, åŸå§‹çº§åˆ«: %s, æŒç»­æ—¶é—´: %d ms&quot;</span>,</span><br><span class="line">                    alertKey, oldState.getLevel(), duration</span><br><span class="line">                ));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å‘Šè­¦çŠ¶æ€ç±»</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AlertState</span> &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">final</span> String alertKey;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">final</span> AlertLevel level;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">final</span> String message;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> timestamp;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">public</span> <span class="title function_">AlertState</span><span class="params">(String alertKey, AlertLevel level, String message, <span class="type">long</span> timestamp)</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.alertKey = alertKey;</span><br><span class="line">                <span class="built_in">this</span>.level = level;</span><br><span class="line">                <span class="built_in">this</span>.message = message;</span><br><span class="line">                <span class="built_in">this</span>.timestamp = timestamp;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// getteræ–¹æ³•</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">getAlertKey</span><span class="params">()</span> &#123; <span class="keyword">return</span> alertKey; &#125;</span><br><span class="line">            <span class="keyword">public</span> AlertLevel <span class="title function_">getLevel</span><span class="params">()</span> &#123; <span class="keyword">return</span> level; &#125;</span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">getMessage</span><span class="params">()</span> &#123; <span class="keyword">return</span> message; &#125;</span><br><span class="line">            <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getTimestamp</span><span class="params">()</span> &#123; <span class="keyword">return</span> timestamp; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å‘Šè­¦çº§åˆ«æšä¸¾</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">AlertLevel</span> &#123;</span><br><span class="line">            INFO, WARNING, CRITICAL, RESOLVED</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * å‘Šè­¦è§„åˆ™ç¤ºä¾‹ï¼ˆPrometheus + AlertManagerï¼‰ï¼š</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * # QPSå¼‚å¸¸å‘Šè­¦</span></span><br><span class="line"><span class="comment">         * - alert: HighQPS</span></span><br><span class="line"><span class="comment">         *   expr: rate(sharding_qps_total[5m]) &gt; 1000</span></span><br><span class="line"><span class="comment">         *   for: 2m</span></span><br><span class="line"><span class="comment">         *   labels:</span></span><br><span class="line"><span class="comment">         *     severity: warning</span></span><br><span class="line"><span class="comment">         *   annotations:</span></span><br><span class="line"><span class="comment">         *     summary: &quot;åˆ†ç‰‡QPSè¿‡é«˜&quot;</span></span><br><span class="line"><span class="comment">         *     description: &quot;åˆ†ç‰‡ &#123;&#123; $labels.shard &#125;&#125; QPSè¶…è¿‡1000ï¼Œå½“å‰å€¼: &#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * # å“åº”æ—¶é—´å‘Šè­¦</span></span><br><span class="line"><span class="comment">         * - alert: HighResponseTime</span></span><br><span class="line"><span class="comment">         *   expr: histogram_quantile(0.95, rate(sharding_response_time_bucket[5m])) &gt; 1000</span></span><br><span class="line"><span class="comment">         *   for: 3m</span></span><br><span class="line"><span class="comment">         *   labels:</span></span><br><span class="line"><span class="comment">         *     severity: critical</span></span><br><span class="line"><span class="comment">         *   annotations:</span></span><br><span class="line"><span class="comment">         *     summary: &quot;åˆ†ç‰‡å“åº”æ—¶é—´è¿‡é•¿&quot;</span></span><br><span class="line"><span class="comment">         *     description: &quot;åˆ†ç‰‡ &#123;&#123; $labels.shard &#125;&#125; 95%å“åº”æ—¶é—´è¶…è¿‡1ç§’&quot;</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * # é”™è¯¯ç‡å‘Šè­¦</span></span><br><span class="line"><span class="comment">         * - alert: HighErrorRate</span></span><br><span class="line"><span class="comment">         *   expr: rate(sharding_errors_total[5m]) / rate(sharding_qps_total[5m]) &gt; 0.05</span></span><br><span class="line"><span class="comment">         *   for: 1m</span></span><br><span class="line"><span class="comment">         *   labels:</span></span><br><span class="line"><span class="comment">         *     severity: critical</span></span><br><span class="line"><span class="comment">         *   annotations:</span></span><br><span class="line"><span class="comment">         *     summary: &quot;åˆ†ç‰‡é”™è¯¯ç‡è¿‡é«˜&quot;</span></span><br><span class="line"><span class="comment">         *     description: &quot;åˆ†ç‰‡ &#123;&#123; $labels.shard &#125;&#125; é”™è¯¯ç‡è¶…è¿‡5%&quot;</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * # æ•°æ®å€¾æ–œå‘Šè­¦</span></span><br><span class="line"><span class="comment">         * - alert: DataSkew</span></span><br><span class="line"><span class="comment">         *   expr: (max(sharding_data_count) - min(sharding_data_count)) / avg(sharding_data_count) &gt; 2</span></span><br><span class="line"><span class="comment">         *   for: 5m</span></span><br><span class="line"><span class="comment">         *   labels:</span></span><br><span class="line"><span class="comment">         *     severity: warning</span></span><br><span class="line"><span class="comment">         *   annotations:</span></span><br><span class="line"><span class="comment">         *     summary: &quot;æ£€æµ‹åˆ°æ•°æ®å€¾æ–œ&quot;</span></span><br><span class="line"><span class="comment">         *     description: &quot;åˆ†ç‰‡é—´æ•°æ®é‡å·®å¼‚è¿‡å¤§ï¼Œå¯èƒ½å­˜åœ¨æ•°æ®å€¾æ–œé—®é¢˜&quot;</span></span><br><span class="line"><span class="comment">         * </span></span><br><span class="line"><span class="comment">         * # è¿æ¥æ± è€—å°½å‘Šè­¦</span></span><br><span class="line"><span class="comment">         * - alert: ConnectionPoolExhaustion</span></span><br><span class="line"><span class="comment">         *   expr: sharding_connection_active / sharding_connection_total &gt; 0.9</span></span><br><span class="line"><span class="comment">         *   for: 1m</span></span><br><span class="line"><span class="comment">         *   labels:</span></span><br><span class="line"><span class="comment">         *     severity: critical</span></span><br><span class="line"><span class="comment">         *   annotations:</span></span><br><span class="line"><span class="comment">         *     summary: &quot;è¿æ¥æ± å³å°†è€—å°½&quot;</span></span><br><span class="line"><span class="comment">         *     description: &quot;åˆ†ç‰‡ &#123;&#123; $labels.shard &#125;&#125; è¿æ¥æ± ä½¿ç”¨ç‡è¶…è¿‡90%&quot;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6-2-2-æ•…éšœå¤„ç†é¢„æ¡ˆ"><a href="#6-2-2-æ•…éšœå¤„ç†é¢„æ¡ˆ" class="headerlink" title="6.2.2 æ•…éšœå¤„ç†é¢„æ¡ˆ"></a>6.2.2 æ•…éšœå¤„ç†é¢„æ¡ˆ</h4><pre><code class="language-java">// æ•…éšœå¤„ç†é¢„æ¡ˆ
public class DisasterRecoveryPlan &#123;
    
    // åˆ†ç‰‡æ•…éšœå¤„ç†
    public class ShardFailureHandling &#123;
        
        // è‡ªåŠ¨æ•…éšœè½¬ç§»
        public class AutoFailover &#123;
            private final Map&lt;String, String&gt; shardBackupMapping;
            
            public AutoFailover() &#123;
                shardBackupMapping = new HashMap&lt;&gt;();
                shardBackupMapping.put(&quot;shard_0&quot;, &quot;shard_0_backup&quot;);
                shardBackupMapping.put(&quot;shard_1&quot;, &quot;shard_1_backup&quot;);
            &#125;
            
            @EventListener
            public void handleShardFailure(ShardFailureEvent event) &#123;
                String failedShard = event.getShardName();
                String backupShard = shardBackupMapping.get(failedShard);
                
                if (backupShard != null) &#123;
                    // 1. åˆ‡æ¢æµé‡åˆ°å¤‡ä»½åˆ†ç‰‡
                    switchTrafficToBackup(failedShard, backupShard);
                    
                    // 2. å‘é€å‘Šè­¦é€šçŸ¥
                    sendFailureAlert(failedShard, backupShard);
                    
                    // 3. å¯åŠ¨æ•…éšœåˆ†ç‰‡æ¢å¤æµç¨‹
                    startShardRecovery(failedShard);
                &#125;
            &#125;
            
            private void switchTrafficToBackup(String failedShard, String backupShard) &#123;
                // æ›´æ–°è·¯ç”±é…ç½®
                ShardingConfigManager.updateShardMapping(failedShard, backupShard);
                
                // åˆ·æ–°è¿æ¥æ± 
                DataSourceManager.refreshDataSource(failedShard, backupShard);
                
                System.out.println(&quot;æµé‡å·²åˆ‡æ¢: &quot; + failedShard + &quot; -&gt; &quot; + backupShard);
            &#125;
        &#125;
        
        // æ•°æ®æ¢å¤ç­–ç•¥
        public class DataRecoveryStrategy &#123;
            
            // åŸºäºbinlogçš„æ•°æ®æ¢å¤
            public void recoverFromBinlog(String failedShard, Date failureTime) &#123;
                /*
                 * Binlogæ¢å¤æ­¥éª¤ï¼š
                 * 1. ä»æœ€è¿‘çš„å…¨é‡å¤‡ä»½å¼€å§‹æ¢å¤
                 * 2. åº”ç”¨æ•…éšœæ—¶é—´ç‚¹ä¹‹å‰çš„binlog
                 * 3. éªŒè¯æ•°æ®ä¸€è‡´æ€§
                 * 4. åˆ‡æ¢å›ä¸»åˆ†ç‰‡
                 */
                
                try &#123;
                    // 1. æ¢å¤å…¨é‡å¤‡ä»½
                    restoreFullBackup(failedShard);
                    
                    // 2. åº”ç”¨å¢é‡binlog
                    applyBinlogToFailurePoint(failedShard, failureTime);
                    
                    // 3. æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
                    if (verifyDataConsistency(failedShard)) &#123;
                        // 4. åˆ‡æ¢å›ä¸»åˆ†ç‰‡
                        switchBackToPrimary(failedShard);
                        System.out.println(&quot;åˆ†ç‰‡æ¢å¤æˆåŠŸ: &quot; + failedShard);
                    &#125; else &#123;
                        throw new RuntimeException(&quot;æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥&quot;);
                    &#125;
                    
                &#125; catch (Exception e) &#123;
                    System.err.println(&quot;åˆ†ç‰‡æ¢å¤å¤±è´¥: &quot; + failedShard + &quot;, é”™è¯¯: &quot; + e.getMessage());
                    // ç»§ç»­ä½¿ç”¨å¤‡ä»½åˆ†ç‰‡ï¼Œäººå·¥ä»‹å…¥å¤„ç†
                &#125;
            &#125;
        &#125;
    &#125;
    
    // æ€§èƒ½é™çº§ç­–ç•¥
    public class PerformanceDegradation &#123;
        
        // é™æµé™çº§
        public class RateLimitingDegradation &#123;
            private final RateLimiter rateLimiter;
            
            public RateLimitingDegradation() &#123;
                this.rateLimiter = RateLimiter.create(1000); // æ¯ç§’1000ä¸ªè¯·æ±‚
            &#125;
            
            public boolean allowRequest(String operation) &#123;
                if (isSystemOverloaded()) &#123;
                    // ç³»ç»Ÿè¿‡è½½æ—¶å¯ç”¨é™æµ
                    return rateLimiter.tryAcquire();
                &#125;
                return true;
            &#125;
            
            private boolean isSystemOverloaded() &#123;
                // æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½æŒ‡æ ‡
                double avgCpuUsage = getAverageCpuUsage();
                double avgResponseTime = getAverageResponseTime();
                
                return avgCpuUsage &gt; 80 || avgResponseTime &gt; 1000;
            &#125;
        &#125;
        
        // åŠŸèƒ½é™çº§
        public class FeatureDegradation &#123;
            
            public Object handleRequest(String operation, Object request) &#123;
                if (isSystemUnderPressure()) &#123;
                    // ç³»ç»Ÿå‹åŠ›å¤§æ—¶ï¼Œé™çº§å¤„ç†
                    switch (operation) &#123;
                        case &quot;complex_query&quot;:
                            return handleSimplifiedQuery(request);
                        case &quot;real_time_analytics&quot;:
                            return getCachedAnalytics(request);
                        case &quot;recommendation&quot;:
                            return getDefaultRecommendation(request);
                        default:
                            return handleNormalRequest(operation, request);
                    &#125;
                &#125; else &#123;
                    return handleNormalRequest(operation, request);
                &#125;
            &#125;
        &#125;
    &#125;
&#125;
</code></pre>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/myblog/tags/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/" rel="tag"># åˆ†åº“åˆ†è¡¨</a>
              <a href="/myblog/tags/%E6%95%B0%E6%8D%AE%E5%88%86%E7%89%87/" rel="tag"># æ•°æ®åˆ†ç‰‡</a>
              <a href="/myblog/tags/%E5%88%86%E7%89%87%E9%94%AE%E8%AE%BE%E8%AE%A1/" rel="tag"># åˆ†ç‰‡é”®è®¾è®¡</a>
              <a href="/myblog/tags/%E6%95%B0%E6%8D%AE%E5%80%BE%E6%96%9C/" rel="tag"># æ•°æ®å€¾æ–œ</a>
              <a href="/myblog/tags/ShardingSphere/" rel="tag"># ShardingSphere</a>
              <a href="/myblog/tags/MyCat/" rel="tag"># MyCat</a>
              <a href="/myblog/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag"># åˆ†å¸ƒå¼æ•°æ®åº“</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/myblog/2023/01/20/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1%E4%BB%A5%E5%8F%8AMVCC/" rel="prev" title="æ•°æ®åº“äº‹åŠ¡ä¸MVCCæœºåˆ¶æ·±åº¦è§£æï¼šä»ACIDåŸç†åˆ°å¹¶å‘æ§åˆ¶ä¼˜åŒ–">
                  <i class="fa fa-angle-left"></i> æ•°æ®åº“äº‹åŠ¡ä¸MVCCæœºåˆ¶æ·±åº¦è§£æï¼šä»ACIDåŸç†åˆ°å¹¶å‘æ§åˆ¶ä¼˜åŒ–
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/myblog/2023/06/15/%E4%BC%81%E4%B8%9A%E7%BA%A7CRM%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%AC%AC%E4%B8%80%E6%AC%A1%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91%EF%BC%9A%E9%9C%80%E6%B1%82%E5%88%B0%E8%90%BD%E5%9C%B0/" rel="next" title="ä¼ä¸šçº§CRMç³»ç»Ÿçš„ç¬¬ä¸€æ¬¡æ¨¡å—å¼€å‘ï¼šéœ€æ±‚åˆ°è½åœ°">
                  ä¼ä¸šçº§CRMç³»ç»Ÿçš„ç¬¬ä¸€æ¬¡æ¨¡å—å¼€å‘ï¼šéœ€æ±‚åˆ°è½åœ° <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">haiqingxx8</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="è¿”å›é¡¶éƒ¨">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
